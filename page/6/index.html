<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Suche
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'uSvyVbAJs-5jfXFawgQ3','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/03/rspec-capybara/" itemprop="url">
                  RSpec, Capybara, FactoryGirl的使用方法介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-03-03T08:05:33+08:00" content="2015-03-03">
              2015-03-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在阅读本文前你需要对RSpec有一个基本的了解, 本文会对 Model, Controller, Feature 等测试写法进行总结.</p>
</blockquote>
<h2 id="环境及gem版本"><a href="#环境及gem版本" class="headerlink" title="环境及gem版本"></a>环境及gem版本</h2><ul>
<li>Mac OS X 10</li>
<li>Ruby 2.1</li>
<li>Rails 4.1</li>
<li>rspec-rails 3.1.0</li>
<li>shoulda-matchers 2.6.2</li>
<li>factory_girl_rails 4.4.1</li>
<li>capybara 2.4.1</li>
<li>capybara-webkit 1.3.0</li>
<li>database_cleaner 1.3.0</li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><blockquote>
<p>新建一个rails项目, 在Gemfile中添加以下gem:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">group :development, :test do</span><br><span class="line"></span><br><span class="line">  # Debug相关gem</span><br><span class="line">  gem &apos;pry-rails&apos;</span><br><span class="line">  gem &apos;pry-doc&apos;</span><br><span class="line">  gem &apos;pry-byebug&apos;</span><br><span class="line">  gem &apos;pry-stack_explorer&apos;</span><br><span class="line"></span><br><span class="line">  # RSpec所需Gem</span><br><span class="line">  gem &apos;rspec-rails&apos;</span><br><span class="line">  gem &apos;shoulda-matchers&apos;</span><br><span class="line">  gem &apos;factory_girl_rails&apos;</span><br><span class="line"></span><br><span class="line">  # 模拟用户行为</span><br><span class="line">  gem &apos;capybara&apos;</span><br><span class="line">end</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>安装gem, 然后生成rspec的配置文件:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bundle install</span><br><span class="line"></span><br><span class="line">rails g rspec:install</span><br><span class="line"># 生成</span><br><span class="line">create  .rspec</span><br><span class="line">create  spec</span><br><span class="line">create  spec/spec_helper.rb</span><br><span class="line">create  spec/rails_helper.rb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>添加设定:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># spec/rails_helper.rb</span><br><span class="line">...</span><br><span class="line"># Add additional requires below this line. Rails is not loaded until this point!</span><br><span class="line">require &apos;capybara/rails&apos;</span><br><span class="line">require &apos;capybara/rspec&apos;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">RSpec.configure do |config|</span><br><span class="line">  # 添加FactoryGirl语法</span><br><span class="line">  # 比如: FactoryGirl.create(:post) =&gt; create(:post)</span><br><span class="line">  config.include FactoryGirl::Syntax::Methods</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="Model的测试"><a href="#Model的测试" class="headerlink" title="Model的测试"></a>Model的测试</h2><h3 id="生成针对post-Model的测试"><a href="#生成针对post-Model的测试" class="headerlink" title="生成针对post Model的测试"></a>生成针对post Model的测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rails g rspec:model post</span><br><span class="line"></span><br><span class="line">  create  spec/models/post_spec.rb</span><br><span class="line">  invoke  factory_girl</span><br><span class="line">  create    spec/factories/posts.rb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然, 由于我已经做了配置, 直接生成post Model也会生成相应的测试文件.</p>
</blockquote>
<h3 id="写测试"><a href="#写测试" class="headerlink" title="写测试"></a>写测试</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spec/models/post_spec.rb</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'rails_helper'</span></span><br><span class="line"></span><br><span class="line">RSpec.describe Post, <span class="symbol">type:</span> <span class="symbol">:model</span> <span class="keyword">do</span></span><br><span class="line">  describe <span class="string">"#title"</span> <span class="keyword">do</span></span><br><span class="line">    it &#123; is_expected.to validate_presence_of(<span class="symbol">:title</span>)  &#125;</span><br><span class="line">    it &#123; is_expected.to validate_uniqueness_of(<span class="symbol">:title</span>)  &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">"#content"</span> <span class="keyword">do</span></span><br><span class="line">    it &#123; is_expected.to validate_presence_of(<span class="symbol">:content</span>)  &#125;</span><br><span class="line">    it &#123; is_expected.to validate_length_of(<span class="symbol">:content</span>)  &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="测试失败-生成post-Model并添加相应的验证"><a href="#测试失败-生成post-Model并添加相应的验证" class="headerlink" title="测试失败, 生成post Model并添加相应的验证"></a>测试失败, 生成post Model并添加相应的验证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ rails g model post title content:text</span><br><span class="line">$ rake db:migrate</span><br><span class="line"></span><br><span class="line"># app/models/post.rb</span><br><span class="line">class Post &lt; ActiveRecord::Base</span><br><span class="line">  validates :title, presence: true, uniqueness: true</span><br><span class="line">  validates :content, presence: true, length: &#123; maximum: 500  &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="Controller的测试"><a href="#Controller的测试" class="headerlink" title="Controller的测试"></a>Controller的测试</h2><h3 id="相关知识点"><a href="#相关知识点" class="headerlink" title="相关知识点"></a>相关知识点</h3><h4 id="响应状态"><a href="#响应状态" class="headerlink" title="响应状态"></a>响应状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(response).to be_success</span><br><span class="line">expect(response[&apos;Content-Type&apos;]).to =~ %r^text/html!</span><br></pre></td></tr></table></figure>
<h4 id="assigns-方法"><a href="#assigns-方法" class="headerlink" title="assigns()方法"></a><code>assigns()</code>方法</h4><blockquote>
<p><code>assigns</code>声明实例变量(@), 共享给视图</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expect(assigns(:entries)).to == Entry.all</span><br></pre></td></tr></table></figure>
<h4 id="模拟渲染视图和重定向"><a href="#模拟渲染视图和重定向" class="headerlink" title="模拟渲染视图和重定向"></a>模拟渲染视图和重定向</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(response).to render_template(&apos;index&apos;)</span><br><span class="line">expect(response).to redirect_to(entries_url)</span><br></pre></td></tr></table></figure>
<h3 id="生成Controller测试文件"><a href="#生成Controller测试文件" class="headerlink" title="生成Controller测试文件"></a>生成Controller测试文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rails g rspec:controller posts</span><br><span class="line">  create  spec/controllers/posts_controller_spec.rb</span><br></pre></td></tr></table></figure>
<h3 id="写测试代码"><a href="#写测试代码" class="headerlink" title="写测试代码"></a>写测试代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># spec/controllers/posts_controller_spec.rb</span><br><span class="line">require &apos;rails_helper&apos;</span><br><span class="line"></span><br><span class="line">RSpec.describe PostsController, :type =&gt; :controller do</span><br><span class="line"></span><br><span class="line">  def valid_attributes</span><br><span class="line">    &#123; title: &quot;title&quot;, content: &quot;content&quot;  &#125;</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def invalid_attributes</span><br><span class="line">    &#123; title: &quot;&quot;, content: &quot;&quot;  &#125;</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  describe &quot;POST create&quot; do</span><br><span class="line">    describe &quot;with valid params&quot; do</span><br><span class="line">      it &quot;creates a new Post&quot; do</span><br><span class="line">        expect &#123;</span><br><span class="line">          post :create, &#123;:post =&gt; valid_attributes&#125;</span><br><span class="line"></span><br><span class="line">        &#125;.to change(Post, :count).by(1)</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;assigns a newly created post as @post&quot; do</span><br><span class="line">        post :create, &#123;:post =&gt; valid_attributes&#125;</span><br><span class="line">        expect(assigns(:post)).to be_a(Post)</span><br><span class="line">        expect(assigns(:post)).to be_persisted</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;redirects to the created post&quot; do</span><br><span class="line">        post :create, &#123;:post =&gt; valid_attributes&#125;</span><br><span class="line">        expect(response).to redirect_to(Post.last)</span><br><span class="line">      end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">    describe &quot;with invalid params&quot; do</span><br><span class="line">      it &quot;assigns a newly created but unsaved post as @post&quot; do</span><br><span class="line">        post :create, &#123;:post =&gt; invalid_attributes&#125;</span><br><span class="line">        expect(assigns(:post)).to be_a_new(Post)</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;re-renders the &apos;new&apos; template&quot; do</span><br><span class="line">        post :create, &#123;:post =&gt; invalid_attributes&#125;</span><br><span class="line">        expect(response).to render_template(&quot;new&quot;)</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="完成Controller代码"><a href="#完成Controller代码" class="headerlink" title="完成Controller代码"></a>完成Controller代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/posts_controller.rb</span><br><span class="line"></span><br><span class="line"># POST /posts</span><br><span class="line"># POST /posts.json</span><br><span class="line">def create</span><br><span class="line">@post = Post.new(post_params)</span><br><span class="line"></span><br><span class="line">respond_to do |format|</span><br><span class="line">    if @post.save</span><br><span class="line">      format.html &#123; redirect_to @post, notice: &apos;Post was successfully created.&apos;  &#125;</span><br><span class="line">      format.json &#123; render :show, status: :created, location: @post  &#125;</span><br><span class="line">    else</span><br><span class="line">      format.html &#123; render :new  &#125;</span><br><span class="line">      format.json &#123; render json: @post.errors, status: :unprocessable_entity  &#125;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="Helper的测试"><a href="#Helper的测试" class="headerlink" title="Helper的测试"></a>Helper的测试</h2><h3 id="生成helper-spec"><a href="#生成helper-spec" class="headerlink" title="生成helper_spec"></a>生成helper_spec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g rspec:helper application</span><br><span class="line">  create  spec/helpers/application_helper_spec.rb</span><br></pre></td></tr></table></figure>
<h3 id="编写测试-实现helper代码"><a href="#编写测试-实现helper代码" class="headerlink" title="编写测试, 实现helper代码"></a>编写测试, 实现helper代码</h3><blockquote>
<p><strong><em> 注意<code>helper</code>对象包含了ApplicationHelper </em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># spec/helpers/application_helper_spec.rb</span><br><span class="line">RSpec.describe ApplicationHelper, type: :helper do</span><br><span class="line">  describe &quot;active_if_current&quot; do</span><br><span class="line">    subject &#123; helper.active_if_current(&quot;/any_path&quot;)  &#125;</span><br><span class="line"></span><br><span class="line">    context &quot;current page path equals to &apos;/any_path&apos;&quot; do</span><br><span class="line">      it do</span><br><span class="line">        allow(helper).to receive(:current_page?).and_return(true)</span><br><span class="line">        expect(subject).to eq &apos;active&apos;</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    context &quot;current page path does not equal to &apos;/any_path&apos;&quot; do</span><br><span class="line">      it do</span><br><span class="line">        allow(helper).to receive(:current_page?).and_return(false)</span><br><span class="line">        expect(subject).to be_nil</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/helpers/application_helper.rb</span><br><span class="line">module ApplicationHelper</span><br><span class="line">  def active_if_current(path)</span><br><span class="line">    &apos;active&apos; if current_page?(path)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="Features的测试"><a href="#Features的测试" class="headerlink" title="Features的测试"></a>Features的测试</h2><blockquote>
<p>Features测试将route, Controller, View, Model结合在一起进行测试, 比如: 用户创建了一个新的post.</p>
</blockquote>
<h3 id="生成Feature-Spec"><a href="#生成Feature-Spec" class="headerlink" title="生成Feature Spec"></a>生成Feature Spec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g rspec:feature posts</span><br><span class="line">   create  spec/features/posts_spec.rb</span><br></pre></td></tr></table></figure>
<h3 id="写feature-spec"><a href="#写feature-spec" class="headerlink" title="写feature spec"></a>写feature spec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">require &apos;rails_helper&apos;</span><br><span class="line"></span><br><span class="line">RSpec.feature &quot;Posts&quot;, type: :feature do</span><br><span class="line">  describe &quot;Create a Post&quot; do</span><br><span class="line">    before do</span><br><span class="line">    visit posts_path</span><br><span class="line">    click_link &quot;New Post&quot;</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  it &quot;gets to new post page&quot; do</span><br><span class="line">    expect(page.current_path).to eq new_post_path</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  it &quot;creates new post&quot; do</span><br><span class="line">    # Fill in the form</span><br><span class="line">    fill_in &quot;Title&quot;, with: &quot;Title1&quot;</span><br><span class="line">    fill_in &quot;Content&quot;, with: &quot;Content1&quot;</span><br><span class="line">    click_button &quot;Create Post&quot;</span><br><span class="line"></span><br><span class="line">    expect(page).to have_content &quot;Post was successfully created.&quot;</span><br><span class="line">    expect(page).to have_content &quot;Title1&quot;</span><br><span class="line">    expect(page).to have_content &quot;Content1&quot;</span><br><span class="line"></span><br><span class="line">    # Make sure data is stored into db.</span><br><span class="line">    post = Post.last</span><br><span class="line">    expect(post.title).to eq &quot;Title1&quot;</span><br><span class="line">    expect(post.content).to eq &quot;Content1&quot;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="JavaScript测试"><a href="#JavaScript测试" class="headerlink" title="JavaScript测试"></a>JavaScript测试</h2><blockquote>
<p>简单介绍一下javascript的测试.<br>需要添加测试js测试驱动 Capybara-Webkit 到Gemfile中. 还需要添加用于清理数据库的gem Database Cleaner</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line">group :test do</span><br><span class="line">  gem &apos;capybara-webkit&apos;</span><br><span class="line">  gem &apos;database_cleaner&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后<code>$ bundle install</code>, 如果出现错误:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    /Users/daniel/.rvm/rubies/ruby-2.2.0/bin/ruby -r ./siteconf20150303-33956-1xk6nvy.rb extconf.rb</span><br><span class="line">    sh: qmake: command not found</span><br><span class="line">    *** extconf.rb failed ***</span><br><span class="line">    Could not create Makefile due to some reason, probably lack of necessary</span><br><span class="line">    libraries and/or headers.  Check the mkmf.log file for more details.  You may</span><br><span class="line">    need configuration options.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>那么很有可能是没有安装qt</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">如果你使用Mac, 那么:</span><br><span class="line">brew install qt</span><br><span class="line">如果使用Ubuntu Linux, 那么</span><br><span class="line">sudo apt-get install qt4-dev-tools libqt4-dev libqt4-core libqt4-gui</span><br><span class="line"></span><br><span class="line">其他情况请Google</span><br></pre></td></tr></table></figure>
<blockquote>
<p>也可参加这篇文章 <a href="https://github.com/thoughtbot/capybara-webkit/wiki/Installing-Qt-and-compiling-capybara-webkit" target="_blank" rel="external">https://github.com/thoughtbot/capybara-webkit/wiki/Installing-Qt-and-compiling-capybara-webkit</a></p>
<p>接下来修改设置文件, 添加DatabaseCleaner的相关设定</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">RSpec.configure do |config|</span><br><span class="line">  ...</span><br><span class="line">    </span><br><span class="line">  # DatabaseCleaner设定</span><br><span class="line">  # suite: 以RSpec的一个命令作为单位</span><br><span class="line">  # all: 一个RSpec测试文件作为单位</span><br><span class="line">  # each: 一个测试用例(it)作为一个单位</span><br><span class="line">  config.before(:suite) do</span><br><span class="line">    DatabaseCleaner.clean_with :truncation # 测试开始时(执行一个测试命令时)清空数据库</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # js除外的其他测试使用transaction策略清除数据</span><br><span class="line">  config.before(:each) do</span><br><span class="line">    DatabaseCleaner.strategy = :transaction</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # js测试时使用truncation策略清空数据</span><br><span class="line">  config.before(:each, js: true) do</span><br><span class="line">    DatabaseCleaner.strategy = truncation</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # 开启transaction策略</span><br><span class="line">  config.before(:each) do</span><br><span class="line">    DatabaseCleaner.start</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # 测试完了使用transaction策略清理数据库(我根据的是before/after的参数判断何种策略的)</span><br><span class="line">  config.after(:each) do</span><br><span class="line">    DatabaseCleaner.clean</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # 每个测试文件执行完后使用truncation策略清理数据</span><br><span class="line">  config.after(:all) do</span><br><span class="line">    DatabaseCleaner.clean_with :truncation </span><br><span class="line">  end</span><br><span class="line">  ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在测试文件中添加<code>js: true</code>就会使用javascript 驱动来测试</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;JS TEST&quot;, js: true do</span><br><span class="line">  # js test</span><br><span class="line">  ...</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">it &quot;JS TEST&quot;, js: true do</span><br><span class="line">  # js test case</span><br><span class="line">  ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/02/rails-test-samples/" itemprop="url">
                  在实际开发中使用RSpec和Cucumber进行TDD/BDD测试
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-03-02T12:25:54+08:00" content="2015-03-02">
              2015-03-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h2><blockquote>
<p>请参见我的上一篇文章: <a href="/2015/03/02/rails-test-install/">在Rails中使用Cucumber和RSpec搭建BDD/TDD测试环境</a>.</p>
</blockquote>
<h2 id="Cucumber-和-RSpec的区别"><a href="#Cucumber-和-RSpec的区别" class="headerlink" title="Cucumber 和 RSpec的区别"></a>Cucumber 和 RSpec的区别</h2><h3 id="Cucumber的特点"><a href="#Cucumber的特点" class="headerlink" title="Cucumber的特点"></a>Cucumber的特点</h3><blockquote>
<p>由于使用了更自然的语言来描述, 所以阅读代码时更容易理解. 更加适合整体测试.</p>
</blockquote>
<h3 id="RSpec的特点"><a href="#RSpec的特点" class="headerlink" title="RSpec的特点"></a>RSpec的特点</h3><blockquote>
<p>读起来像英语一样, 适合测试View, Controller, Model这些单独的组件.</p>
</blockquote>
<h2 id="结合RSpec和Cucumber"><a href="#结合RSpec和Cucumber" class="headerlink" title="结合RSpec和Cucumber"></a>结合RSpec和Cucumber</h2><blockquote>
<p>不能看出, Cucumber读起来简单但是写起来麻烦, 而RSpec恰恰相反, 所以可以将二者结合进行测试. 具体来讲:</p>
</blockquote>
<ul>
<li>单元测试(View, Controller, Model各个各个组件的测试)使用RSpec</li>
<li>结合测试(将View, Controller, Model结合, 页面之间跳转这样的测试)使用Cucumber</li>
<li>整体测试(页面跳转后是否会达到预期效果这样的测试)使用Cucumber</li>
</ul>
<h2 id="测试流程"><a href="#测试流程" class="headerlink" title="测试流程"></a>测试流程</h2><h3 id="生成User-story"><a href="#生成User-story" class="headerlink" title="生成User story"></a>生成User story</h3><blockquote>
<p>为了便于说明问题, 我目的的创建一个对于User进行增删改查的Rails应用, 我先来描述一下我想要的效果:</p>
</blockquote>
<ul>
<li>在User 列表页面, 有以下可以跳转到的页面:<ul>
<li>新建和编辑User的页面</li>
<li>列出用户详细信息的页面</li>
</ul>
</li>
<li>有如下功能:<ul>
<li>管理员可以查看展示所有用户的信息</li>
<li>管理员可以新建, 编辑和删除用户</li>
<li>管理员可以查看某一用户的详细信息</li>
</ul>
</li>
</ul>
<h3 id="使用cucumber生成scenario-场景"><a href="#使用cucumber生成scenario-场景" class="headerlink" title="使用cucumber生成scenario(场景)"></a>使用cucumber生成scenario(场景)</h3><blockquote>
<p>接下来描述”管理员可以查看展示所有用户的信息”这个场景.<br>Cucumber规定, 在features/目录下创建<code>.feature</code>文件(feature file), 在文件中使用自然语言来定义scenario ; 然后, 在<code>features/step_definitions</code>目录下定义<code>.rb</code>文件用于将自然语言和实际的代码匹配.</p>
</blockquote>
<h3 id="feature-file的语法"><a href="#feature-file的语法" class="headerlink" title="feature file的语法"></a>feature file的语法</h3><blockquote>
<p>首先看看feature file如果定义, 可以选择除了英语之外的其他语言, 不过我还是会使用英语, 如果使用其他语言需要在文件开头写上 <code># language cn</code>.<br>一个feature 文件中可以定义多个scenario, scenario中必须有”Given”, “When”和”Then”, 分别表示前提, 如果 和 那么. 看下面的例子:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Feature: [描述功能]</span><br><span class="line">  [可以随便写, 也可以不写]</span><br><span class="line"></span><br><span class="line">  # 注释</span><br><span class="line">  Scenario: [一个前提的情况下]</span><br><span class="line">    Given [描述前提]</span><br><span class="line">    When [描述一个动作(action)]</span><br><span class="line">    Then [描述结果]</span><br><span class="line"></span><br><span class="line">  Scenario: [两个前提条件情况]</span><br><span class="line">    Given [前提描述]</span><br><span class="line">    And [另一个前提]</span><br><span class="line">    When [一个action]</span><br><span class="line">    And [另一个action]</span><br><span class="line">    Then [结果]</span><br><span class="line"></span><br><span class="line">  Scenario Outline: [需要输入的情况]</span><br><span class="line">    Given [前提]</span><br><span class="line">    When 输入&lt;input&gt;</span><br><span class="line">    Then 显示&lt;result&gt;</span><br><span class="line">  Example:</span><br><span class="line">    | input | result |</span><br><span class="line">    |     0 |     0  |</span><br><span class="line">    |     1 |     1  |</span><br><span class="line">    |     2 |     10 |</span><br><span class="line">    |     3 |    100 |</span><br></pre></td></tr></table></figure>
<h3 id="生成feature-file"><a href="#生成feature-file" class="headerlink" title="生成feature file"></a>生成feature file</h3><blockquote>
<p>创建User story的feature file</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ vim feature/user_index.feature</span><br><span class="line"></span><br><span class="line">Feature: Listing all users&apos; info for admin</span><br><span class="line"></span><br><span class="line">  Scenario Outline: List all users</span><br><span class="line">    Given There are &lt;user_number&gt; users in the db</span><br><span class="line">    When the index page is displayed</span><br><span class="line">    Then I should see &lt;user_number&gt; users</span><br><span class="line">    Examples:</span><br><span class="line">      | user_number |</span><br><span class="line">      | 0 |</span><br><span class="line">      | 1 |</span><br><span class="line"></span><br><span class="line"># 执行测试返回结果:</span><br><span class="line">➜  test_rspec_cucumber_rails  cucumber features/user_index.feature</span><br><span class="line">Using the default profile...</span><br><span class="line">Feature: Listing all users&apos; info for admin</span><br><span class="line"></span><br><span class="line">Scenario Outline: List all users                # features/user_index.feature:3</span><br><span class="line">Given There are &lt;user_number&gt; users in the db # features/user_index.feature:4</span><br><span class="line">When the index page is displayed              # features/user_index.feature:5</span><br><span class="line">Then I should see &lt;user_number&gt; users         # features/user_index.feature:6</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">| user_number |</span><br><span class="line">| 0           |</span><br><span class="line">Undefined step: &quot;There are 0 users in the db&quot; (Cucumber::Undefined)</span><br><span class="line">features/user_index.feature:4:in `Given There are &lt;user_number&gt; users in the db&apos;</span><br><span class="line">| 1           |</span><br><span class="line">Undefined step: &quot;There are 1 users in the db&quot; (Cucumber::Undefined)</span><br><span class="line">features/user_index.feature:4:in `Given There are &lt;user_number&gt; users in the db&apos;</span><br><span class="line"></span><br><span class="line">2 scenarios (2 undefined)</span><br><span class="line">6 steps (6 undefined)</span><br><span class="line">0m0.055s</span><br><span class="line"></span><br><span class="line">You can implement step definitions for undefined steps with these snippets:</span><br><span class="line"></span><br><span class="line">Given(/^There are (\d+) users in the db$/) do |arg1|</span><br><span class="line">pending # express the regexp above with the code you wish you had</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">When(/^the index page is displayed$/) do</span><br><span class="line">pending # express the regexp above with the code you wish you had</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">Then(/^I should see (\d+) users$/) do |arg1|</span><br><span class="line">pending # express the regexp above with the code you wish you had</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="实现step定义"><a href="#实现step定义" class="headerlink" title="实现step定义"></a>实现step定义</h3><blockquote>
<p>其实上面的错误信息已经提示如何实现step文件.我们需要让自然语言和代码进行匹配时, 相比于方法的设计我们考虑更多的是实际问题, 这样更加利于理解.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># user_steps.rb</span><br><span class="line"></span><br><span class="line">Given(/^There are (\d+) users in the db$/) do |num|</span><br><span class="line">  num.to_i.times do |i|</span><br><span class="line">    User.create(name: &quot;User#&#123;i&#125;&quot;, email: &quot;user#&#123;i&#125;@example.com&quot;)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">When(/^the index page is displayed$/) do</span><br><span class="line">  visit users_path # 跳转到index页面, visit方法来自于Capybara</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">Then(/^I should see (\d+) users$/) do |num|</span><br><span class="line">  # 判断所期待的内容是否存在</span><br><span class="line">  num.to_i.times do |i|</span><br><span class="line">    expect(page).to have_content(&quot;user#&#123;i&#125;@example.com&quot;)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="再次测试"><a href="#再次测试" class="headerlink" title="再次测试"></a>再次测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">test_rspec_cucumber_rails  cucumber features/user_index.feature</span><br><span class="line">Using the default profile...</span><br><span class="line">Feature: Listing all users&apos; info for admin</span><br><span class="line"></span><br><span class="line">Scenario Outline: List all users                # features/user_index.feature:3</span><br><span class="line">Given There are &lt;user_number&gt; users in the db # features/step_definitions/users_steps.rb:1</span><br><span class="line">When the index page is displayed              # features/step_definitions/users_steps.rb:7</span><br><span class="line">Then I should see &lt;user_number&gt; users         # features/step_definitions/users_steps.rb:11</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">| user_number |</span><br><span class="line">| 0           |</span><br><span class="line">undefined local variable or method `users_path&apos; for #&lt;Cucumber::Rails::World:0x007fc3100576b8&gt; (NameError)</span><br><span class="line">./features/step_definitions/users_steps.rb:8:in `/^the index page is displayed$/&apos;</span><br><span class="line">features/user_index.feature:5:in `When the index page is displayed&apos;</span><br><span class="line">| 1           |</span><br><span class="line">uninitialized constant User (NameError)</span><br><span class="line">./features/step_definitions/users_steps.rb:3:in `block (2 levels) in &lt;top (required)&gt;&apos;</span><br><span class="line">./features/step_definitions/users_steps.rb:2:in `times&apos;</span><br><span class="line">./features/step_definitions/users_steps.rb:2:in `/^There are (\d+) users in the db$/&apos;</span><br><span class="line">features/user_index.feature:4:in `Given There are &lt;user_number&gt; users in the db&apos;</span><br><span class="line"></span><br><span class="line">Failing Scenarios:</span><br><span class="line">cucumber features/user_index.feature:3 # Scenario: List all users</span><br><span class="line">cucumber features/user_index.feature:3 # Scenario: List all users</span><br><span class="line"></span><br><span class="line">2 scenarios (2 failed)</span><br><span class="line">6 steps (2 failed, 3 skipped, 1 passed)</span><br><span class="line">0m0.025s`</span><br></pre></td></tr></table></figure>
<blockquote>
<p>users_path 没有定义, 接下来使用RSpec来实现MVC各个单元测试和开发</p>
</blockquote>
<h2 id="使用RSpec实现单元测试"><a href="#使用RSpec实现单元测试" class="headerlink" title="使用RSpec实现单元测试"></a>使用RSpec实现单元测试</h2><h3 id="Rspec的基本语法"><a href="#Rspec的基本语法" class="headerlink" title="Rspec的基本语法"></a>Rspec的基本语法</h3><blockquote>
<p>首先介绍一下RSpec的相关知识:</p>
</blockquote>
<ul>
<li>文件名: xxx_spec.rb 表示是rspec的测试文件</li>
<li>describe: 对于测试用例的描述.</li>
<li>context: describe分情况讨论的描述.</li>
<li>subject: 设置it所指代的对象</li>
<li>it / specify : 测试的对象</li>
<li>expect : 需要在it block中使用</li>
<li>异常: raise_error(RuntimeError, ‘msg…’)</li>
</ul>
<blockquote>
<p>基本形式:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">describe &quot;Array&quot; do</span><br><span class="line">  before &#123; @arr = Array.new &#125;</span><br><span class="line"></span><br><span class="line">  it &quot;should be empty&quot; do</span><br><span class="line">    expect(:arr).to be_empty</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="Controller的测试"><a href="#Controller的测试" class="headerlink" title="Controller的测试"></a>Controller的测试</h3><blockquote>
<p>由于我已经安装了RSpec, 所以我在创建Controller的时候会自动创建相应的rspec测试文件:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g controller Users </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试文件:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">require &apos;rails_helper&apos;</span><br><span class="line"></span><br><span class="line">RSpec.describe UsersController, type: :controller do</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  describe &quot;GET #index&quot; do</span><br><span class="line"></span><br><span class="line">    # Test responsing HTTP 200 status code</span><br><span class="line">    it &quot;should respond successfully with an HTTP 200 status code&quot; do</span><br><span class="line">      get :index</span><br><span class="line">      expect(response).to be_success</span><br><span class="line">      expect(response).to have_http_status(200)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    # Test Rendering index template</span><br><span class="line">    it &quot;should render index template&quot; do</span><br><span class="line">      get :index</span><br><span class="line">      expect(response).to render_template(&quot;index&quot;)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    # Test loading all users into @users</span><br><span class="line">    it &quot;should load all users into @users&quot; do</span><br><span class="line">      user1 = User.create!(name: &quot;test user1&quot;, email: &quot;user1@example.com&quot;)</span><br><span class="line">      user2 = User.create!(name: &quot;test user2&quot;, email: &quot;user2@example.com&quot;)</span><br><span class="line">      get :index</span><br><span class="line"></span><br><span class="line">      expect(assigns(:users)).to match_array([user1, user2])</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>运行测试</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ rspec --color --format doc spec/</span><br><span class="line"></span><br><span class="line">UsersController</span><br><span class="line">GET #index</span><br><span class="line">responds successfully with an HTTP 200 status code (FAILED - 1)</span><br><span class="line">renders the index template (FAILED - 2)</span><br><span class="line">loads all of the users into @users (FAILED - 3)</span><br><span class="line"></span><br><span class="line">Failures:</span><br><span class="line"></span><br><span class="line">1) UsersController GET #index responds successfully with an HTTP 200 status code</span><br><span class="line">Failure/Error: get :index</span><br><span class="line">ActionController::UrlGenerationError:</span><br><span class="line">No route matches &#123;:action=&gt;&quot;index&quot;, :controller=&gt;&quot;users&quot;&#125;</span><br><span class="line"># ./spec/controllers/users_controller_spec.rb:11:in `block (3 levels) in &lt;top (required)&gt;&apos;</span><br><span class="line"></span><br><span class="line">2) UsersController GET #index renders the index template</span><br><span class="line">Failure/Error: get :index</span><br><span class="line">ActionController::UrlGenerationError:</span><br><span class="line">No route matches &#123;:action=&gt;&quot;index&quot;, :controller=&gt;&quot;users&quot;&#125;</span><br><span class="line"># ./spec/controllers/users_controller_spec.rb:18:in `block (3 levels) in &lt;top (required)&gt;&apos;</span><br><span class="line"></span><br><span class="line">3) UsersController GET #index loads all of the users into @users</span><br><span class="line">Failure/Error: user1 = User.create!(name: &quot;test user1&quot;, email: &quot;user1@example.com&quot;)</span><br><span class="line">NameError:</span><br><span class="line">uninitialized constant User</span><br><span class="line"># ./spec/controllers/users_controller_spec.rb:24:in `block (3 levels) in &lt;top (required)&gt;&apos;</span><br><span class="line"></span><br><span class="line">Finished in 0.00799 seconds (files took 1.93 seconds to load)</span><br><span class="line">3 examples, 3 failures</span><br><span class="line"></span><br><span class="line">Failed examples:</span><br><span class="line"></span><br><span class="line">rspec ./spec/controllers/users_controller_spec.rb:10 # UsersController GET #index responds successfully with an HTTP 200 status code</span><br><span class="line">rspec ./spec/controllers/users_controller_spec.rb:17 # UsersController GET #index renders the index template</span><br><span class="line">rspec ./spec/controllers/users_controller_spec.rb:23 # UsersController GET #index loads all of the users into @usersZ</span><br></pre></td></tr></table></figure>
<h3 id="RSpec设置options"><a href="#RSpec设置options" class="headerlink" title="RSpec设置options"></a>RSpec设置options</h3><blockquote>
<p>顺便说一句, 如果觉得每次都指定<code>--color</code>和<code>--format doc</code>麻烦, 那么可以修改<code>.rspec</code>文件, 添加默认option</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim .rspec</span><br><span class="line">--color</span><br><span class="line">--format doc</span><br></pre></td></tr></table></figure>
<h3 id="添加Routing"><a href="#添加Routing" class="headerlink" title="添加Routing"></a>添加Routing</h3><blockquote>
<p>从刚刚的结果看以判断, 首先需要添加routing:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># config/route.rb</span><br><span class="line"></span><br><span class="line">Rails.application.routes.draw do</span><br><span class="line">  get &apos;users&apos; =&gt; &apos;users#index&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="实现UsersController"><a href="#实现UsersController" class="headerlink" title="实现UsersController"></a>实现UsersController</h3><blockquote>
<p>执行<code>rspec</code>, 这回返回的错误信息是<code>The action &#39;index&#39; could not be found for UsersController</code>, 所以我需要在<code>UsersController</code>中实现index方法, 在index方法中, 我需要从数据库中取出所有的user赋给实例变量@users, 进而可以在index.html.erb中显示这些用户.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class UsersController &lt; ApplicationController</span><br><span class="line"></span><br><span class="line">  def index</span><br><span class="line">    @users = User.all</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="创建User-model"><a href="#创建User-model" class="headerlink" title="创建User model"></a>创建User model</h3><blockquote>
<p>继续执行测试, 这时发生的错误是 <code>uninitialized constant UsersController::User</code>, 所以我应该创建User Model了.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ rails g model User name:string email:string</span><br><span class="line">  invoke  active_record</span><br><span class="line">  create    db/migrate/20150302123110_create_users.rb</span><br><span class="line">  create    app/models/user.rb</span><br><span class="line">  invoke    rspec</span><br><span class="line">  create      spec/models/user_spec.rb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后, 我来实现User的测试代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># spec/models/user_spec.rb</span><br><span class="line"></span><br><span class="line">require &apos;rails_helper&apos;</span><br><span class="line"></span><br><span class="line">RSpec.describe User, type: :model do</span><br><span class="line">  # before()在测试执行前执行</span><br><span class="line">  before &#123; @user = User.new(name: &quot;test user&quot;, email: &quot;user@example.com&quot;)  &#125;</span><br><span class="line"></span><br><span class="line">  # it = @user</span><br><span class="line">  subject &#123; @user  &#125;</span><br><span class="line"></span><br><span class="line">  # respond_to 测试的是对象能否调用某个方法</span><br><span class="line">  # 在本例中, 测试的是@user.email 和 @user.name是否可以成功调用</span><br><span class="line">  it &#123; should respond_to :name  &#125;</span><br><span class="line">  it &#123; should respond_to :email  &#125;</span><br><span class="line"></span><br><span class="line">  # be_valid测试数据是否可以正确调用</span><br><span class="line">  it &#123; should be_valid  &#125;</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>执行 migrate, <code>$ rake db:migrate</code></p>
<p>然后, 单独测试model</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ rspec spec/models/user_spec.rb</span><br><span class="line">  User</span><br><span class="line">  should respond to #name</span><br><span class="line">  should respond to #email</span><br><span class="line">  should be valid</span><br><span class="line"></span><br><span class="line">  Finished in 0.00976 seconds (files took 1.97 seconds to load)</span><br><span class="line">  3 examples, 0 failures</span><br></pre></td></tr></table></figure>
<h3 id="实现视图"><a href="#实现视图" class="headerlink" title="实现视图"></a>实现视图</h3><blockquote>
<p>这时候再执行 Controller的测试:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ rspec spec/controllers/users_controller_spec.rb</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">Failures:</span><br><span class="line"></span><br><span class="line">1) UsersController GET #index responds successfully with an HTTP 200 status code</span><br><span class="line">Failure/Error: get :index</span><br><span class="line">ActionView::MissingTemplate:</span><br><span class="line">Missing template users/index, application/index with ...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我来创建<code>index.html.erb</code>并实现其代码.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;List Users&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;% @users.each do |user| %&gt;</span><br><span class="line">    &lt;li&gt;</span><br><span class="line">      &lt;%= user.name %&gt;</span><br><span class="line">      &lt;%= user.email %&gt;</span><br><span class="line">    &lt;/li&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<h3 id="启动server-观察页面"><a href="#启动server-观察页面" class="headerlink" title="启动server, 观察页面"></a>启动server, 观察页面</h3><blockquote>
<p>执行所有测试<code>rspec spec/</code>, 全都通过:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ rspec spec/</span><br><span class="line"></span><br><span class="line">  UsersController</span><br><span class="line">  GET #index</span><br><span class="line">  should respond successfully with an HTTP 200 status code</span><br><span class="line">  should render index template</span><br><span class="line">  should load all users into @users</span><br><span class="line"></span><br><span class="line">  User</span><br><span class="line">  should respond to #name</span><br><span class="line">  should respond to #email</span><br><span class="line">  should be valid</span><br><span class="line"></span><br><span class="line">  Finished in 0.03626 seconds (files took 1.41 seconds to load)</span><br><span class="line">  6 examples, 0 failures</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后我通过rails console新建一条数据</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rails console</span><br><span class="line"></span><br><span class="line">001:0&gt; User.create(name: &quot;test user&quot;, email: &quot;user@example.com&quot;)</span><br><span class="line">002:0&gt; User.all.count #=&gt; 1</span><br><span class="line">003:0&gt; exit</span><br></pre></td></tr></table></figure>
<blockquote>
<p>效果图:</p>
</blockquote>
<p><img src="http://i3.tietuku.com/024da538e47035a4.png" alt=""></p>
<h2 id="通过Cucumber测试"><a href="#通过Cucumber测试" class="headerlink" title="通过Cucumber测试"></a>通过Cucumber测试</h2><blockquote>
<p>这时cucumber的测试也可以通过了</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$  cucumber features/user_index.feature</span><br><span class="line">Using the default profile...</span><br><span class="line"><span class="symbol">Feature:</span> Listing all users<span class="string">' info for admin</span><br><span class="line"></span><br><span class="line">Scenario Outline: List all users                # features/user_index.feature:3</span><br><span class="line">Given There are &lt;user_number&gt; users in the db # features/step_definitions/users_steps.rb:1</span><br><span class="line">When the index page is displayed              # features/step_definitions/users_steps.rb:7</span><br><span class="line">Then I should see &lt;user_number&gt; users         # features/step_definitions/users_steps.rb:11</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">| user_number |</span><br><span class="line">| 0           |</span><br><span class="line">| 1           |</span><br><span class="line"></span><br><span class="line">2 scenarios (2 passed)</span><br><span class="line">6 steps (6 passed)</span><br><span class="line">0m0.982s</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>重构代码, 可以将公共的视图代码抽取到局部视图(app/views/users/_user.html.erb)中:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># app/views/users/index.html.erb</span><br><span class="line">&lt;h1&gt;List Users&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;% @users.each do |user| %&gt;</span><br><span class="line">    &lt;%= render @users %&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># app/views/users/_user.html.erb</span><br><span class="line"></span><br><span class="line">&lt;li&gt;</span><br><span class="line">  &lt;%= user.name&gt; %&gt;</span><br><span class="line">  &lt;%= user.email %&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>重构之后再分别进行cucumber和rspec的测试, 保证通过.</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>通过以上的例子不难发现, cucumber着重于整体的页面测试, 而RSpec着重于MVC这三个组件这样的细节测试.<br>具体的步骤, 先使用cucumber生成一个失败的测试, 因为没有MVC这三个组件, 我必须要通过RSpec来实现各个细节, 最后在RSpec开始测试到View时, 需要考虑让Cucumber测试也可以通过.</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/02/rails-test-install/" itemprop="url">
                  在Rails中使用Cucumber和RSpec搭建BDD/TDD测试环境
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-03-02T09:57:46+08:00" content="2015-03-02">
              2015-03-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是TDD"><a href="#什么是TDD" class="headerlink" title="什么是TDD ?"></a>什么是TDD ?</h2><blockquote>
<p>TDD就是测试驱动开发, 也就是说先写测试代码, 然后运行, 测试不会通过, 然后为了通过测试而实现代码. 最后需要重构重复代码, 而且需要保证重构代码后测试还可以通过.<br>从设计而言, 由于先写了测试, 从测试的角度去定义实现方法要比仅仅去实现功能而定义方法要好. TDD可以消除更多的重复代码, 使结构更加清晰, 但是也有人不同意这种开发手法, 认为浪费时间.<br>使用TDD需要注意:  一开始的测试必须要写, 测试需要覆盖到每一个要实现的功能, 但是需要灵活运用TDD, 比如在不确定一个问题的解决方法时, 先不要忙着写测试, 而是先试着去写实现代码, 得到正确的结果后再去写测试会更加清晰.</p>
</blockquote>
<h2 id="本文使用的环境"><a href="#本文使用的环境" class="headerlink" title="本文使用的环境"></a>本文使用的环境</h2><ul>
<li>Mac OSX 10.10</li>
<li>ruby 2.2.0p0</li>
<li>Rails 4.2.0</li>
<li>cucumber-rails 1.4.2</li>
<li>rspec-rails 3.2.1</li>
</ul>
<h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><h3 id="创建rails项目"><a href="#创建rails项目" class="headerlink" title="创建rails项目"></a>创建rails项目</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rails new test_rspec_cucumber --skip-test-unit </span><br><span class="line"># --skip-test-unit 不使用Rails默认提供的test unit</span><br></pre></td></tr></table></figure>
<h3 id="添加gem"><a href="#添加gem" class="headerlink" title="添加gem"></a>添加gem</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">group :development, :test do</span><br><span class="line">  gem &apos;sqlite3&apos;</span><br><span class="line">  gem &apos;rspec-rails&apos;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">group :test do</span><br><span class="line">  gem &apos;selenium-webdriver&apos;</span><br><span class="line">  gem &apos;capybara&apos;</span><br><span class="line">  gem &apos;factory_girl_rails&apos;</span><br><span class="line">  gem &apos;cucumber-rails&apos;, :require =&gt; false</span><br><span class="line">  gem &apos;database_cleaner&apos;, github: &apos;bmabey/database_cleaner&apos;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">group :production do</span><br><span class="line">  gem &apos;pg&apos;</span><br><span class="line">  gem &apos;rails_12factor&apos;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><blockquote>
<p>bundle install –without production</p>
</blockquote>
<h3 id="在项目中安装RSpec"><a href="#在项目中安装RSpec" class="headerlink" title="在项目中安装RSpec"></a>在项目中安装RSpec</h3><blockquote>
<p>生成RSpec相关的文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rails g rspec:install</span><br><span class="line">  create  .rspec</span><br><span class="line">  create  spec</span><br><span class="line">  create  spec/spec_helper.rb</span><br><span class="line">  create  spec/rails_helper.rb</span><br></pre></td></tr></table></figure>
<h3 id="安装cucumber"><a href="#安装cucumber" class="headerlink" title="安装cucumber"></a>安装cucumber</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ rails generate cucumber:install</span><br><span class="line">  create  config/cucumber.yml</span><br><span class="line">  create  script/cucumber</span><br><span class="line">  chmod  script/cucumber</span><br><span class="line">  create  features/step_definitions</span><br><span class="line">  create  features/step_definitions/.gitkeep</span><br><span class="line">  create  features/support</span><br><span class="line">  create  features/support/env.rb</span><br><span class="line">  exist  lib/tasks</span><br><span class="line">  create  lib/tasks/cucumber.rake</span><br><span class="line">  gsub  config/database.yml</span><br><span class="line">  gsub  config/database.yml</span><br><span class="line">  force  config/database.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>本文只介绍安装过程, 下篇文章会总结关于RSpec和Cucumber的具体使用方法.</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/25/log-logger/" itemprop="url">
                  Rails log 总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-25T09:17:00+08:00" content="2015-02-25">
              2015-02-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本文总结一下rails中的日志相关知识点, 如日志输出, 设置日志等级, 创建新日志, 设置日志格式的方法.</p>
</blockquote>
<h2 id="输出日志"><a href="#输出日志" class="headerlink" title="输出日志"></a>输出日志</h2><blockquote>
<p>通过使用<code>logger</code>对象从Controller, Model, View输出日志到输出目的地:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logger.debug &quot;输出debug级别的日志&quot;</span><br><span class="line">logger.fatal &quot;输出致命错误信息&quot;</span><br><span class="line">logger.error &quot;输出错误信息&quot;</span><br><span class="line">logger.warn &quot;输出警告&quot;</span><br><span class="line">logger.info &quot;输出通知信息&quot;</span><br></pre></td></tr></table></figure>
<h2 id="设定日志级别"><a href="#设定日志级别" class="headerlink" title="设定日志级别"></a>设定日志级别</h2><h3 id="5种日志的意义"><a href="#5种日志的意义" class="headerlink" title="5种日志的意义"></a>5种日志的意义</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fatal # 程序错误, 无法进行错误处理的</span><br><span class="line">error # 可以处理的错误</span><br><span class="line">warn # 警告</span><br><span class="line">info # 系统运行信息</span><br><span class="line">debug # 方便开发者的详细信息</span><br></pre></td></tr></table></figure>
<h3 id="显示日志"><a href="#显示日志" class="headerlink" title="显示日志"></a>显示日志</h3><blockquote>
<p>以上几种日志的优先级 <code>fatal &gt; error &gt; warn &gt; info &gt; debug</code></p>
<p>rails中可以在<code>config/development.rb</code>, <code>config/test.rb</code>, <code>config/production.rb</code>中针对这三种不同的环境设定日志级别.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># fatal &gt; error &gt; warn &gt; info &gt; debug</span><br><span class="line"># 优先级低于warn的不会被显示</span><br><span class="line">config.log_level = :warn</span><br></pre></td></tr></table></figure>
<h3 id="改变显示显示日志的级别"><a href="#改变显示显示日志的级别" class="headerlink" title="改变显示显示日志的级别"></a>改变显示显示日志的级别</h3><blockquote>
<p>如果临时需要显示warn以下等级的日志info debug等, 可以这样:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class UsersController &lt; ApplicationController</span><br><span class="line">  def index</span><br><span class="line">    Rails.logger.level = Logger::DEBUG   # Rails.logger.level = 0 也行</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="各个环境默认显示日志的级别"><a href="#各个环境默认显示日志的级别" class="headerlink" title="各个环境默认显示日志的级别"></a>各个环境默认显示日志的级别</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">development # =&gt; debug</span><br><span class="line">test        # =&gt; debug</span><br><span class="line">production  # =&gt; info</span><br></pre></td></tr></table></figure>
<h2 id="生成新logger"><a href="#生成新logger" class="headerlink" title="生成新logger"></a>生成新logger</h2><blockquote>
<p>可以指定日志输出文件, 可以在<code>config/development.rb、config/test.rb、config/production.rb</code>进行如下配置:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 输出日志到log/development.log.yyyyMMdd 中, 每天的日志输出到当日的文件中</span><br><span class="line">config.logger = Logger.new(&apos;log/development.log&apos;, &apos;daily&apos;)</span><br><span class="line"></span><br><span class="line"># 配置第二个输出文件</span><br><span class="line">config.special_logger = Logger.new(&apos;log/development_specail.log&apos;, &apos;daily&apos;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>日志的输出:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logger.debug &quot;log/development.log&quot;</span><br><span class="line"></span><br><span class="line">Rails.application.config.special_logger.debug &quot;log/development_special.log输出&quot;</span><br></pre></td></tr></table></figure>
<h2 id="设定日志格式"><a href="#设定日志格式" class="headerlink" title="设定日志格式"></a>设定日志格式</h2><blockquote>
<p>默认的日志格式</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># config/RAILS_ENV.rb</span><br><span class="line">config.logger.formatter = ::Logger::Formatter.new</span><br><span class="line"></span><br><span class="line"># 输出</span><br><span class="line">D, [2015-02-25T14:24:39.780844 #24934] DEBUG -- :</span><br></pre></td></tr></table></figure>
<blockquote>
<p>自定义日志格式:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config.logger.formatter = proc do |severity, datetime, progname, msg|</span><br><span class="line">  &quot;[#&#123;severity&#125;]#&#123;datetime&#125;: #&#123;progname&#125; ---- #&#123;msg&#125;\n&quot;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 日志内容</span><br><span class="line">[INFO]2015-02-25 14:33:59 +0800:  ---- Started GET &quot;/assets/application-0019&quot;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/23/action-mailer/" itemprop="url">
                  发送邮件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-23T20:40:08+08:00" content="2015-02-23">
              2015-02-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails应用ActionMailer来发送和接收邮件, 我会参照官方文档总结这部分知识</p>
</blockquote>
<h2 id="生成Rails项目"><a href="#生成Rails项目" class="headerlink" title="生成Rails项目"></a>生成Rails项目</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 创建项目</span><br><span class="line">$ rails new mail_basis</span><br><span class="line"></span><br><span class="line">$ cd mail_basis</span><br><span class="line"></span><br><span class="line"># 生成Post scaffold 具备CRUD功能</span><br><span class="line">$ rails g scaffold Post title:string content:text</span><br><span class="line"></span><br><span class="line"># 移植数据库</span><br><span class="line">$ rake db:migrate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样就可以对Post进行增删改查操作.</p>
</blockquote>
<h2 id="发信"><a href="#发信" class="headerlink" title="发信"></a>发信</h2><blockquote>
<p>那么就来实现每当创建一个新的Post的时候就会发送一个邮件</p>
</blockquote>
<h3 id="生成Mailer"><a href="#生成Mailer" class="headerlink" title="生成Mailer"></a>生成Mailer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ rails g mailer PostMailer</span><br><span class="line">  create  app/mailers/post_mailer.rb</span><br><span class="line">  invoke  erb</span><br><span class="line">  create    app/views/post_mailer</span><br><span class="line">  invoke  test_unit</span><br><span class="line">  create    test/mailers/post_mailer_test.rb</span><br><span class="line">  create    test/mailers/previews/post_mailer_preview.rb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>类似于Controller, Mailer生成了以下比较重要的文件:</p>
</blockquote>
<ul>
<li>处理邮件的<code>app/mailers/xxx_mailer.rb</code></li>
<li>处理邮件显示的 <code>app/views/post_mailer.html.xxx</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># app/mailers/post_mailer.rb</span><br><span class="line"></span><br><span class="line">class PostMailer &lt; ActionMailer::Base</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>同Controller和Model一样, 全部的mailer必须继承<code>ActiveMailer::Base</code>.<br>而且, 其中的action(方法)也会对应app/views/xxx_mailer/目录下的视图文件</p>
</blockquote>
<h3 id="实现发送邮件的方法"><a href="#实现发送邮件的方法" class="headerlink" title="实现发送邮件的方法"></a>实现发送邮件的方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class PostMailer &lt; ApplicationMailer</span><br><span class="line">  default from: &quot;from@ex.com&quot;</span><br><span class="line"></span><br><span class="line">  def post_email(user, post)</span><br><span class="line">    @title = post.title</span><br><span class="line">    mail to: user.email, subject: &quot;发帖成功&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li><code>default</code>方法设置发送方的地址, 相当于设置config.action_mailer.default(from: “from@ex.com”)</li>
<li><code>mail</code>方法是实际发送邮件的方法, <code>to</code>选项设定了实际发送的地址</li>
</ul>
<h3 id="邮件模板视图"><a href="#邮件模板视图" class="headerlink" title="邮件模板视图"></a>邮件模板视图</h3><blockquote>
<p>我们可以使用HTML或纯文本(TEXT)两种格式来生成邮件模板</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># HTML模板</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;ja&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;发布了新的博客&lt;%= @title %&gt;. &lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;</span><br><span class="line">恭喜你, 发布成功!</span><br><span class="line">&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"># TEXT</span><br><span class="line">==============================</span><br><span class="line">&lt;%= @title %&gt;发布成功!</span><br><span class="line">=============================</span><br><span class="line"></span><br><span class="line">恭喜!</span><br></pre></td></tr></table></figure>
<h3 id="在Controller中实现创建post并发送"><a href="#在Controller中实现创建post并发送" class="headerlink" title="在Controller中实现创建post并发送"></a>在Controller中实现创建post并发送</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/post_controller.rb</span><br><span class="line">def create</span><br><span class="line">  @post = Post.new(post_params)</span><br><span class="line"></span><br><span class="line">  respond_to do |format|</span><br><span class="line">  if @post.save</span><br><span class="line"></span><br><span class="line">  user = User.new(&quot;name&quot;, &quot;shangrenzhidao@126.com&quot;)</span><br><span class="line">  PostMailer.post_email(user, @post).deliver_now</span><br><span class="line"></span><br><span class="line">  format.html &#123; redirect_to @post, notice: &apos;Post was successfully created.&apos;  &#125;</span><br><span class="line">  format.json &#123; render :show, status: :created, location: @post  &#125;</span><br><span class="line">  else</span><br><span class="line">  format.html &#123; render :new  &#125;</span><br><span class="line">  format.json &#123; render json: @post.errors, status: :unprocessable_entity  &#125;</span><br><span class="line">  end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="设定SMTP邮件服务器"><a href="#设定SMTP邮件服务器" class="headerlink" title="设定SMTP邮件服务器"></a>设定SMTP邮件服务器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># config/environments/development.rb</span><br><span class="line"></span><br><span class="line">config.action_mailer.delivery_method = :smtp</span><br><span class="line">config.action_mailer.smtp_settings = &#123;</span><br><span class="line">  address:               &apos;smtp.gmail.com&apos;,</span><br><span class="line">  port:                  587,</span><br><span class="line">  domain:                &apos;example.com&apos;,</span><br><span class="line">  user_name:             &apos;&lt;Gmail用户名&gt;&apos;,</span><br><span class="line">  password:              &apos;&lt;Gmail密码&gt;&apos;,</span><br><span class="line">  authentication:        &apos;plain&apos;,</span><br><span class="line">  enable_starttls_auto:  true</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/23/json-xml-yaml/" itemprop="url">
                  读取和输出JSON, XML, YAML
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-23T17:06:17+08:00" content="2015-02-23">
              2015-02-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><code>ActiveSupport</code>为Array, Hash, Model和JSON, XML, YAML提供了互相转换的方法</p>
</blockquote>
<h2 id="读取JSON-ActiveSupport-JSON-decode"><a href="#读取JSON-ActiveSupport-JSON-decode" class="headerlink" title="读取JSON (ActiveSupport::JSON.decode)"></a>读取JSON (ActiveSupport::JSON.decode)</h2><blockquote>
<p>使用<code>ActiveSupport::JSON.decode</code>方法可以解析JSON形式的字符串, 将其转换为Hash.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ActiveSupport::JSON.decode(&quot;&#123;\&quot;id\&quot;: 1, \&quot;name\&quot;: \&quot;daniel\&quot;&#125;&quot;)</span><br><span class="line">=&gt; &#123;&quot;id&quot;=&gt;1, &quot;name&quot;=&gt;&quot;daniel&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 转换是发生的异常处理</span><br><span class="line"></span><br><span class="line">begin</span><br><span class="line">  obj = ActiveSupport::JSON.decode(json_string)</span><br><span class="line">rescue ActiveSupport::JSON.parse_error</span><br><span class="line">  Rails.logger.warn(&quot;非法JSON字符串: #&#123;json_string&#125;&quot;)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="以JSON格式输出-to-json"><a href="#以JSON格式输出-to-json" class="headerlink" title="以JSON格式输出 (to_json)"></a>以JSON格式输出 (to_json)</h2><blockquote>
<p>使用<code>Object#to_json</code>方法可以将Array, Hash, ActiveRecord等以json格式输出:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[1, 2, 3].to_json</span><br><span class="line"># =&gt; &quot;[1,2,3]&quot;</span><br><span class="line"></span><br><span class="line">&#123; &quot;hash&quot; =&gt; &#123; &quot;foo&quot; =&gt; 1, &quot;bar&quot; =&gt; 2  &#125;  &#125;.to_json</span><br><span class="line"># =&gt; &quot;&#123;\&quot;hash\&quot;:&#123;\&quot;foo\&quot;:1,\&quot;bar\&quot;:2&#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">User.first.to_json</span><br><span class="line"> =&gt; &quot;&#123;\&quot;id\&quot;:1,\&quot;name\&quot;:\&quot;daniel\&quot;,\&quot;created_at\&quot;:\&quot;2015-02-23T18:35:01.069+08:00\&quot;,\&quot;updated_at\&quot;:\&quot;2015-02-23T18:35:23.611+08:00\&quot;,\&quot;time_zone\&quot;:null&#125;&quot;</span><br></pre></td></tr></table></figure>
<h2 id="读取XML-from-xml"><a href="#读取XML-from-xml" class="headerlink" title="读取XML (from_xml)"></a>读取XML (from_xml)</h2><blockquote>
<p>使用Hash.from_xml可以将XML文件(字符串)转换为hash</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">xml = &lt;&lt;-XML</span><br><span class="line">  &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">    &lt;hash&gt;</span><br><span class="line">      &lt;foo type=&quot;integer&quot;&gt;1&lt;/foo&gt;</span><br><span class="line">      &lt;bar type=&quot;integer&quot;&gt;2&lt;/bar&gt;</span><br><span class="line">    &lt;/hash&gt;</span><br><span class="line">XML</span><br><span class="line"></span><br><span class="line">hash = Hash.from_xml(xml)</span><br><span class="line"></span><br><span class="line">#=&gt; &#123;&quot;hash&quot;=&gt;&#123;&quot;foo&quot;=&gt;1, &quot;bar&quot;=&gt;2&#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="输出XML-to-xml"><a href="#输出XML-to-xml" class="headerlink" title="输出XML (to_xml)"></a>输出XML (to_xml)</h2><blockquote>
<p>将Array, Hash, ActiveRecord转化为XML</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[1, 2, 3].to_xml</span><br><span class="line"># =&gt; &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&lt;fixnums type=\&quot;array\&quot;&gt;\n  &lt;fixnum type=\&quot;integer\&quot;&gt;1&lt;/fixnum&gt;\n  &lt;fixnum type=\&quot;integer\&quot;&gt;2&lt;/fixnum&gt;\n  &lt;fixnum type=\&quot;integer\&quot;&gt;3&lt;/fixnum&gt;\n&lt;/fixnums&gt;\n&quot;</span><br><span class="line"></span><br><span class="line">&#123; &quot;hash&quot; =&gt; &#123; &quot;foo&quot; =&gt; 1, &quot;bar&quot; =&gt; 2  &#125;  &#125;.to_xml</span><br><span class="line"># =&gt; &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&lt;hash&gt;\n  &lt;hash&gt;\n    &lt;foo type=\&quot;integer\&quot;&gt;1&lt;/foo&gt;\n    &lt;bar type=\&quot;integer\&quot;&gt;2&lt;/bar&gt;\n  &lt;/hash&gt;\n&lt;/hash&gt;\n&quot;</span><br><span class="line"></span><br><span class="line">User.last.to_xml</span><br><span class="line">=&gt; &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&lt;user&gt;\n  &lt;id type=\&quot;integer\&quot;&gt;1&lt;/id&gt;\n  &lt;name&gt;daniel&lt;/name&gt;\n  &lt;created-at type=\&quot;dateTime\&quot;&gt;2015-02-23T18:35:01+08:00&lt;/created-at&gt;\n  &lt;updated-at type=\&quot;dateTime\&quot;&gt;2015-02-23T18:35:23+08:00&lt;/updated-at&gt;\n  &lt;time-zone nil=\&quot;true\&quot;/&gt;\n&lt;/user&gt;\n&quot;</span><br></pre></td></tr></table></figure>
<h2 id="读取YAML-YAML-load"><a href="#读取YAML-YAML-load" class="headerlink" title="读取YAML (YAML.load)"></a>读取YAML (YAML.load)</h2><blockquote>
<p>YAML.load可以读取yml格式的文件(字符串)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yaml = &lt;&lt;TEXT</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">:id: 1</span><br><span class="line">:username: &quot;Daniel&quot;</span><br><span class="line">:age: 30</span><br><span class="line">TEXT</span><br><span class="line"></span><br><span class="line">YAML.load(yaml)</span><br><span class="line">=&gt; &#123;:id=&gt;3, :username=&gt;&quot;Daniel&quot;, :age=&gt;30&#125;</span><br><span class="line"></span><br><span class="line"># 文件中读取</span><br><span class="line">YAML.laod(File.open(&quot;test.yml&quot;))</span><br></pre></td></tr></table></figure>
<h2 id="输出YAML-to-yaml"><a href="#输出YAML-to-yaml" class="headerlink" title="输出YAML (to_yaml)"></a>输出YAML (to_yaml)</h2><blockquote>
<p><code>Object#to_yaml</code>可以把Array, Hash, ActiveRecord转为YAML形式输出</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[&quot;abc&quot;, &quot;def&quot;, &quot;zxy&quot;].to_yaml</span><br><span class="line"># =&gt; &quot;---\n- abc\n- def\n- zxy\n&quot;</span><br><span class="line"></span><br><span class="line">&#123;:id=&gt;3, :username=&gt;&quot;Daniel&quot;, :age=&gt;30&#125;.to_yaml</span><br><span class="line"> =&gt; &quot;---\n:id: 3\n:username: Daniel\n:age: 30\n&quot;</span><br><span class="line"></span><br><span class="line">User.last.to_yaml</span><br><span class="line"># =&gt; &quot;--- !ruby/object:User\nattributes:\n  id: 2\n  name: \&quot;Daniel\&quot;\n  created_at: 2014-11-29 09:02:30.449449000 Z\n  updated_at: 2014-11-29 09:02:30.449449000 Z\n&quot;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/23/name-conversion/" itemprop="url">
                  Rails中类名, 表名, 文件名之间互相转换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-23T09:46:59+08:00" content="2015-02-23">
              2015-02-23
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails有一些命名约定, 比如某个Model Post, 对应的数据库表名为posts, Controller为PostsController, 文件名为<code>posts_controller.rb</code> … ActiveSupport通过扩展ruby原生的String类来使这些名字互相转换变得简单.</p>
</blockquote>
<h2 id="单数-gt-复数-pluralize"><a href="#单数-gt-复数-pluralize" class="headerlink" title="单数 -&gt; 复数 (pluralize)"></a>单数 -&gt; 复数 (pluralize)</h2><blockquote>
<p>String类的pluralize方法可以将单数形式变为复数形式:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 单数变为复数</span><br><span class="line">&quot;post&quot;.pluralize     #=&gt; &quot;posts&quot;</span><br><span class="line">&quot;the post&quot;.pluralize #=&gt; &quot;the posts&quot;</span><br><span class="line"></span><br><span class="line"># 已经是复数形式原样返回</span><br><span class="line">&quot;posts&quot;.pluralize #=&gt; &quot;posts&quot;</span><br><span class="line"></span><br><span class="line"># 不规则变化</span><br><span class="line">&quot;person&quot;.pluralize # =&gt; &quot;people&quot;</span><br><span class="line"></span><br><span class="line"># 汉语词无复数, 需指定locale参数</span><br><span class="line">&quot;人&quot;.pluralize # =&gt; &quot;人s&quot;</span><br><span class="line">人&quot;.pluralize(locale = :zh) # =&gt; &quot;人&quot;</span><br></pre></td></tr></table></figure>
<h2 id="复数-gt-单数-singularize"><a href="#复数-gt-单数-singularize" class="headerlink" title="复数 -&gt; 单数 (singularize)"></a>复数 -&gt; 单数 (singularize)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 复数变为单数</span><br><span class="line">&quot;posts&quot;.singularize # =&gt; &quot;post&quot;</span><br><span class="line">&quot;the posts&quot;.singularize # =&gt; &quot;the post&quot;</span><br><span class="line"></span><br><span class="line"># 本来就是单数原样输出</span><br><span class="line">&quot;post&quot;.singularize #=&gt; &quot;post&quot;</span><br><span class="line"></span><br><span class="line"># 不规则变化</span><br><span class="line">&quot;people&quot;.singularize #=&gt; &quot;person&quot;</span><br></pre></td></tr></table></figure>
<h2 id="类名-gt-文件名-underscore"><a href="#类名-gt-文件名-underscore" class="headerlink" title="类名 -&gt; 文件名 (underscore)"></a>类名 -&gt; 文件名 (underscore)</h2><blockquote>
<p>String#underscore方法可以把对于的类名转换成文件名:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;UsersControlller&quot;.underscore         #=&gt; &quot;users_controlller&quot;</span><br><span class="line">&quot;#&#123;&quot;UsersControlller&quot;.underscore&#125;.rb&quot; #=&gt; &quot;users_controlller.rb&quot;</span><br><span class="line"></span><br><span class="line">&quot;User&quot;.underscore          #=&gt; &quot;user&quot;</span><br><span class="line">&quot;User&quot;.underscore &lt;&lt; &quot;.rb&quot; #=&gt; &quot;user.rb&quot;</span><br><span class="line"></span><br><span class="line"># :: 转化为 /</span><br><span class="line"></span><br><span class="line">&quot;ActiveModel::Errors&quot;.underscore #=&gt; &quot;active_model/errors&quot;</span><br></pre></td></tr></table></figure>
<h2 id="文件名变为类名-camelcase"><a href="#文件名变为类名-camelcase" class="headerlink" title="文件名变为类名 (camelcase)"></a>文件名变为类名 (camelcase)</h2><blockquote>
<p>String#camelcase 方法可以把文件名(下划线形式)转化为类名:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;users_controller&quot;.camelcase    #=&gt; &quot;UsersController&quot;</span><br><span class="line">&quot;users_controller.rb&quot;.camelcase #=&gt; &quot;UsersController.rb&quot;</span><br><span class="line"></span><br><span class="line">&quot;user&quot;.camelcase #=&gt; &quot;User&quot;</span><br><span class="line"></span><br><span class="line"># / 转化为 ::</span><br><span class="line"></span><br><span class="line">&quot;active_model/errors&quot;.camelcase #=&gt; &quot;ActiveModel::Errors&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Model名变为表名-tableize"><a href="#Model名变为表名-tableize" class="headerlink" title="Model名变为表名 (tableize)"></a>Model名变为表名 (tableize)</h2><blockquote>
<p>String#tableize 方法可以将Model(User) 变为对于的数据库表名(users):</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;User&quot;.tableize     #=&gt; &quot;users&quot;</span><br><span class="line">&quot;LineItem&quot;.tableize #=&gt; &quot;line_items&quot;</span><br></pre></td></tr></table></figure>
<h2 id="表名转化为Model名-classify"><a href="#表名转化为Model名-classify" class="headerlink" title="表名转化为Model名 (classify)"></a>表名转化为Model名 (classify)</h2><blockquote>
<p>String#classify 方法可以把数据库表名(users)转化为对应的类名:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;users&quot;.classify      #=&gt; &quot;User&quot;</span><br><span class="line">&quot;line_items&quot;.classify #=&gt; &quot;LineItem&quot;</span><br></pre></td></tr></table></figure>
<h2 id="由类名-字符串-获取类对象-constantize"><a href="#由类名-字符串-获取类对象-constantize" class="headerlink" title="由类名(字符串)获取类对象 (constantize)"></a>由类名(字符串)获取类对象 (constantize)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;User&quot;.constantize            #=&gt; User</span><br><span class="line">&quot;UsersController&quot;.constantize #=&gt; UsersController</span><br><span class="line"></span><br><span class="line">&quot;User&quot;.constantize.new</span><br><span class="line">#=&gt; #&lt;User id: nil, name: nil, created_at: nil, updated_at: nil&gt;</span><br><span class="line"></span><br><span class="line"># 如果类不存在则抛异常</span><br><span class="line"></span><br><span class="line">&quot;Hoge&quot;.constantize #=&gt; NameError: uninitialized constant Hoge</span><br></pre></td></tr></table></figure>
<h2 id="修改默认设置"><a href="#修改默认设置" class="headerlink" title="修改默认设置"></a>修改默认设置</h2><blockquote>
<p>如果想要更改默认变形, 可以修改<code>config/initializers/inflections.rb</code></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/22/timecop/" itemprop="url">
                  Rails使用Timecop处理时间日期
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-22T22:17:09+08:00" content="2015-02-22">
              2015-02-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>有一个叫做<a href="https://github.com/travisjeffery/timecop" target="_blank" rel="external">timecop</a>的gem可以将时间移动到你想要的时刻, 暂停时刻等, 这个功能在与时间相关的测试中是很有用的, 比如说闰年测试, 税率变更, 有效期测试等等.</p>
</blockquote>
<h2 id="安装Timecop"><a href="#安装Timecop" class="headerlink" title="安装Timecop"></a>安装Timecop</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line">group :test do</span><br><span class="line">  gem &apos;timecop&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="移动时间"><a href="#移动时间" class="headerlink" title="移动时间"></a>移动时间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Time.now</span><br><span class="line">=&gt; 2015-02-22 22:38:25 +0800</span><br><span class="line">Timecop.travel(10.days.ago)</span><br><span class="line">=&gt; 2015-02-12 22:39:01 +0800</span><br><span class="line">Time.now</span><br><span class="line">=&gt; 2015-02-12 22:39:15 +0800</span><br><span class="line">Timecop.return</span><br><span class="line">=&gt; nil</span><br><span class="line">Time.now</span><br><span class="line">=&gt; 2015-02-22 22:39:40 +0800</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>Timecop.travel</code>可以指定一个block作为参数, 那么移动的时间只在block中有效</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">puts Time.now # =&gt; 2015-02-22 22:51:43 +0800</span><br><span class="line">Timecop.travel(10.days.ago) do</span><br><span class="line">  puts Time.now # =&gt; 2015-02-12 22:51:43 +0800</span><br><span class="line">end</span><br><span class="line">puts Time.now # =&gt; 2015-02-22 22:51:45 +0800</span><br></pre></td></tr></table></figure>
<h2 id="冻结时间"><a href="#冻结时间" class="headerlink" title="冻结时间"></a>冻结时间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 时间静止在此刻</span><br><span class="line">Timecop.freeze(10.days.ago)</span><br><span class="line"> =&gt; 2015-02-12 22:58:58 +0800</span><br><span class="line"></span><br><span class="line">puts Time.zone.now</span><br><span class="line"> 2015-02-12 22:58:58 +0800</span><br><span class="line"></span><br><span class="line"># 经过10秒</span><br><span class="line">sleep 10</span><br><span class="line"></span><br><span class="line"># 时间无变化</span><br><span class="line">puts Time.zone.now</span><br><span class="line"> =&gt; 2015-02-12 22:58:58 +0800</span><br><span class="line"></span><br><span class="line"> # 解冻时间</span><br><span class="line">Timecop.return</span><br></pre></td></tr></table></figure>
<blockquote>
<p>同样, freeze方法也可以追加一个block作为参数, 时间停止的作用范围只在block中有效:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Timecop.freeze(10.days.ago) do</span><br><span class="line">  puts Time.now</span><br><span class="line">  sleep 10</span><br><span class="line">  puts Time.now</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># =&gt;</span><br><span class="line">  2015-02-12 23:07:58 +0800</span><br><span class="line">  2015-02-12 23:07:58 +0800</span><br><span class="line"></span><br><span class="line">Timecop.return</span><br></pre></td></tr></table></figure>
<h2 id="时间加速"><a href="#时间加速" class="headerlink" title="时间加速"></a>时间加速</h2><blockquote>
<p>所谓加速就是现实经过1秒当做x秒: Timecop.scale(x)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Timecop.scale(60) do</span><br><span class="line">  puts Time.now</span><br><span class="line">  sleep(10) # 1秒当做60秒, 那么就过了10分钟</span><br><span class="line">  puts Time.now</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># =&gt; </span><br><span class="line">  2015-02-22 23:15:27 +0800</span><br><span class="line">  2015-02-22 23:25:27 +0800</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上的三种方法, 如果不使用block, 需要将时间调整回来 <code>Timecop.return</code></p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a href="https://github.com/travisjeffery/timecop" target="_blank" rel="external">https://github.com/travisjeffery/timecop</a></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/22/time-related/" itemprop="url">
                  Rails中时间日期等处理的总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-22T08:39:28+08:00" content="2015-02-22">
              2015-02-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails为了处理日期定义了<code>Date</code>类, 处理时刻定义了<code>Time</code>类. 为了更加容易处理时间日期等rails在ActiveSupport组件中扩展了timezone等功能, 接下来我就对Rails时间相关的处理进行总结.</p>
</blockquote>
<h2 id="设定时区"><a href="#设定时区" class="headerlink" title="设定时区"></a>设定时区</h2><blockquote>
<p>Rails中在<code>application.rb</code>设置时区:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># config/application.rb</span><br><span class="line"># 默认是UTC (0:00)</span><br><span class="line"></span><br><span class="line"># 北美时间</span><br><span class="line"># config.time_zone = &apos;Central Time (US &amp; Canada)&apos;</span><br><span class="line"></span><br><span class="line"># 北京时间</span><br><span class="line"># config.time_zone = &apos;Beijing&apos;</span><br></pre></td></tr></table></figure>
<h2 id="时区一览"><a href="#时区一览" class="headerlink" title="时区一览"></a>时区一览</h2><h3 id="显示所有时区"><a href="#显示所有时区" class="headerlink" title="显示所有时区"></a>显示所有时区</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rake time:zones:all</span><br><span class="line">* UTC -11:00 *</span><br><span class="line">* American Samoa</span><br><span class="line">* International Date Line West</span><br><span class="line">* Midway Island</span><br><span class="line">* Samoa</span><br><span class="line">*</span><br><span class="line">* * UTC -10:00 *</span><br><span class="line">* Hawaii</span><br><span class="line">*</span><br><span class="line">* * UTC -09:00 *</span><br><span class="line">* Alaska</span><br><span class="line">* ...</span><br></pre></td></tr></table></figure>
<h3 id="操作系统所在时区"><a href="#操作系统所在时区" class="headerlink" title="操作系统所在时区"></a>操作系统所在时区</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rake time:zones:local</span><br><span class="line">* UTC +08:00 *</span><br><span class="line">* Beijing</span><br><span class="line">* Chongqing</span><br><span class="line">* Hong Kong</span><br><span class="line">* Irkutsk</span><br><span class="line">* Kuala Lumpur</span><br><span class="line">* Perth</span><br><span class="line">* Singapore</span><br><span class="line">* Taipei</span><br><span class="line">* Ulaanbaatar</span><br></pre></td></tr></table></figure>
<h2 id="获取当前日期"><a href="#获取当前日期" class="headerlink" title="获取当前日期"></a>获取当前日期</h2><blockquote>
<p><code>Date.today</code> : 获取当前日期<br><code>Date.current</code> : 获取时区相关的当前日期, 相当于<code>Time.zone.today</code></p>
</blockquote>
<h2 id="获取当前时间"><a href="#获取当前时间" class="headerlink" title="获取当前时间"></a>获取当前时间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 获取现在时间(操作系统时间, 时区不相关)</span><br><span class="line">Time.now</span><br><span class="line"></span><br><span class="line"># 获取时区相关时间</span><br><span class="line">Time.zone.now</span><br><span class="line"></span><br><span class="line">Time.current # 如果设置了 config.time_zone 返回Time.zone.now, 否则返回Time.now</span><br><span class="line"></span><br><span class="line">Time.current</span><br><span class="line"> =&gt; Sun, 22 Feb 2015 15:02:24 CST +08:00</span><br><span class="line"></span><br><span class="line">Time.zone.now</span><br><span class="line"> =&gt; Sun, 22 Feb 2015 15:02:28 CST +08:00</span><br><span class="line"></span><br><span class="line"># 不设置config.time_zone, 返回的是UTC(协调世界时间)</span><br><span class="line">Time.current</span><br><span class="line"> =&gt; Sun, 22 Feb 2015 07:12:54 UTC +00:00</span><br><span class="line"></span><br><span class="line">Time.zone.now</span><br><span class="line"> =&gt; Sun, 22 Feb 2015 07:12:59 UTC +00:00</span><br></pre></td></tr></table></figure>
<h2 id="生成指定的时间"><a href="#生成指定的时间" class="headerlink" title="生成指定的时间"></a>生成指定的时间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Time.local # 获取指定的时间</span><br><span class="line"> Time.local(2014, 11, 29, 11, 22, 33)</span><br><span class="line">  =&gt; 2014-11-29 11:22:33 +0800</span><br><span class="line"></span><br><span class="line">Time.zone.local # 获取指定时区相关时间</span><br><span class="line">Time.zone.local(2014, 11, 29, 11, 22, 33)</span><br><span class="line"> =&gt; Sat, 29 Nov 2014 11:22:33 UTC +00:00</span><br></pre></td></tr></table></figure>
<h2 id="昨天-明天"><a href="#昨天-明天" class="headerlink" title="昨天, 明天"></a>昨天, 明天</h2><blockquote>
<p><code>Time#yesterday</code> : 昨天. <code>Time.tomorrow</code> : 明天.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">t = Time.local(2014, 11, 30)</span><br><span class="line">=&gt; 2014-11-30 00:00:00 +0800</span><br><span class="line"></span><br><span class="line">t.tomorrow</span><br><span class="line">=&gt; 2014-12-01 00:00:00 +0800</span><br><span class="line"></span><br><span class="line">t.yesterday</span><br><span class="line">=&gt; 2014-12-01 00:00:00 +0800</span><br><span class="line"></span><br><span class="line"># 时区相关</span><br><span class="line">t2 = Time.zone.local(2014, 11, 29)</span><br><span class="line"> =&gt; Sat, 29 Nov 2014 00:00:00 CST +08:00</span><br><span class="line"></span><br><span class="line">t2.yesterday</span><br><span class="line"> =&gt; Fri, 28 Nov 2014 00:00:00 CST +08:00</span><br><span class="line"></span><br><span class="line">t2.tomorrow</span><br><span class="line"> =&gt; Sun, 30 Nov 2014 00:00:00 CST +08:00</span><br></pre></td></tr></table></figure>
<h2 id="前-后-1年-月-prev-xxx-next-xxx"><a href="#前-后-1年-月-prev-xxx-next-xxx" class="headerlink" title="前(后)1年(月) (prev_xxx, next_xxx)"></a>前(后)1年(月) (prev_xxx, next_xxx)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Time#prev_month, Date#prev_month</span><br><span class="line">Time#next_month, Date#next_month</span><br><span class="line">Time#prev_year, Date#prev_year</span><br><span class="line">Time#next_year, Date#next_year</span><br></pre></td></tr></table></figure>
<h2 id="相对时间"><a href="#相对时间" class="headerlink" title="相对时间"></a>相对时间</h2><blockquote>
<p>Numeric类与下列方法组合可表示相对时间:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">years(年)</span><br><span class="line">months (月)</span><br><span class="line">weeks (周)</span><br><span class="line">days (日)</span><br><span class="line">hours (小时)</span><br><span class="line">minutes (分)</span><br><span class="line">seconds (秒)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>继续调用下面表示时间前后的方法:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">后: from_now 或者 since</span><br><span class="line">前: until 或者 ago</span><br><span class="line"></span><br><span class="line">Time.current</span><br><span class="line"> =&gt; Sun, 22 Feb 2015 15:51:46 CST +08:00</span><br><span class="line"></span><br><span class="line"> # 默认时间就是当前时间</span><br><span class="line">1.weeks.ago</span><br><span class="line"> =&gt; Sun, 15 Feb 2015 15:52:08 CST +08:00</span><br><span class="line"></span><br><span class="line">1.days.since</span><br><span class="line"> =&gt; Mon, 23 Feb 2015 15:52:41 CST +08:00</span><br><span class="line"></span><br><span class="line"># 不使用当前时间作为默认时间</span><br><span class="line">t = Time.local(2014, 11, 1)</span><br><span class="line"> =&gt; 2014-11-01 00:00:00 +0800</span><br><span class="line"></span><br><span class="line">1.days.since t</span><br><span class="line"> =&gt; 2014-11-02 00:00:00 +0800</span><br></pre></td></tr></table></figure>
<h2 id="获取开始和结束的时间点"><a href="#获取开始和结束的时间点" class="headerlink" title="获取开始和结束的时间点"></a>获取开始和结束的时间点</h2><blockquote>
<p>我们可以获得某个时间以何为单位的开始和结束:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">now = Time.current</span><br><span class="line"> =&gt; Sun, 22 Feb 2015 15:58:21 CST +08:00</span><br><span class="line"></span><br><span class="line">now.beginning_of_hour</span><br><span class="line">=&gt; Sun, 22 Feb 2015 15:00:00 CST +08:00  # 从15:00:00开始</span><br><span class="line"></span><br><span class="line">now.beginning_of_month</span><br><span class="line">=&gt; Sun, 01 Feb 2015 00:00:00 CST +08:00 # 从01 Feb开始</span><br><span class="line"></span><br><span class="line"># 其他类似方法有</span><br><span class="line">beginning_of_hour, end_of_hour</span><br><span class="line">beginning_of_day, end_of_day</span><br><span class="line">beginning_of_week, end_of_week</span><br><span class="line">beginning_of_month, end_of_month</span><br><span class="line">beginning_of_quarter, end_of_quarter # 季度(3个月)</span><br><span class="line">beginning_of_year, end_of_year</span><br></pre></td></tr></table></figure>
<blockquote>
<p>获取一个月的订单记录:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">now = Time.current #=&gt; Sat, 29 Nov 2014 02:26:53 CST -06:00</span><br><span class="line">Order.where(order_at: now.beginning_of_month..now.end_of_month)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/21/multi-form-submit/" itemprop="url">
                  一个表单中配置多个Submit
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-21T10:16:04+08:00" content="2015-02-21">
              2015-02-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>不要被标题所困惑, 举个例子, 比如你写完一篇博客, 在发布前, 我需要预览一下文章, 那么这个表单就有2个提交, 一个是发布, 一个是预览.</p>
</blockquote>
<p><img src="http://i2.tietuku.com/a7ac8d496d7f8dfb.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_for(@article) do |f| %&gt;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  &lt;%= submit_tag &quot;Post&quot; %&gt;</span><br><span class="line">  &lt;%= submit_tag &quot;Preview&quot;, name: &quot;preview_button&quot; %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="点击Submit时的params"><a href="#点击Submit时的params" class="headerlink" title="点击Submit时的params"></a>点击Submit时的params</h2><blockquote>
<p>我们在分别点击”Post”和”Preview”按钮以后params参数情况:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># Post</span><br><span class="line"></span><br><span class="line">Parameters:</span><br><span class="line">&#123;</span><br><span class="line">  &quot;utf8&quot;=&gt;&quot;✓&quot;, &quot;authenticity_token&quot;=&gt;&quot;5Du...&quot;,</span><br><span class="line">  &quot;article&quot; =&gt; &#123;</span><br><span class="line">      &quot;title&quot;   =&gt; &quot;&quot;,</span><br><span class="line">          &quot;content&quot; =&gt; &quot;&quot;</span><br><span class="line">            </span><br><span class="line">  &#125;,</span><br><span class="line">    &quot;commit&quot; =&gt; &quot;Post&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Parameters:</span><br><span class="line">&#123;</span><br><span class="line">  &quot;utf8&quot;=&gt;&quot;✓&quot;, &quot;authenticity_token&quot;=&gt;&quot;5Du...&quot;,</span><br><span class="line">  &quot;article&quot; =&gt; &#123;</span><br><span class="line">      &quot;title&quot;   =&gt; &quot;&quot;,</span><br><span class="line">          &quot;content&quot; =&gt; &quot;&quot;</span><br><span class="line">            </span><br><span class="line">  &#125;,</span><br><span class="line">    &quot;commit&quot; =&gt; &quot;Preview&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>目前来看, 这两个按钮没有什么区别, 我们需要在Controller中对其提交的内容做不同的处理.</p>
</blockquote>
<h2 id="设定Submit按钮的name属性"><a href="#设定Submit按钮的name属性" class="headerlink" title="设定Submit按钮的name属性"></a>设定Submit按钮的name属性</h2><blockquote>
<p>我可以通过修改submit的name属性来改变params中的commit KEY:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= submit_tag &quot;Preview&quot;, name: &quot;preview_button&quot; %&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>点击按钮之后, params中是这样的:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Parameters:</span><br><span class="line">&#123;</span><br><span class="line">  &quot;utf8&quot;=&gt;&quot;✓&quot;, &quot;authenticity_token&quot;=&gt;&quot;5Du...&quot;,</span><br><span class="line">  &quot;article&quot; =&gt; &#123;</span><br><span class="line">      &quot;title&quot;   =&gt; &quot;&quot;,</span><br><span class="line">          &quot;content&quot; =&gt; &quot;&quot;</span><br><span class="line">            </span><br><span class="line">  &#125;,</span><br><span class="line">    # commit 变成了 preview_button</span><br><span class="line">    &quot;preview_button&quot; =&gt; &quot;Preview&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Controller中分开处理"><a href="#Controller中分开处理" class="headerlink" title="Controller中分开处理"></a>Controller中分开处理</h2><blockquote>
<p>由于刚刚添加<code>preview_button</code> key, 我需要在Controller中加入针对<code>preview_button</code>这个key的判断, 再做出相应的处理:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/articles_controller.rb</span><br><span class="line"></span><br><span class="line">def create</span><br><span class="line">  @article = Article.new(article_params)</span><br><span class="line"></span><br><span class="line">  # params[:preview_button] 这个key存在, 或者, article无法保存(无法通过验证等等)</span><br><span class="line">  # 再一次渲染new视图(错误回显)</span><br><span class="line">  if params[:preview_button] || !@article.save</span><br><span class="line">    render :new</span><br><span class="line">  else</span><br><span class="line">    redirect_to @article, notice: &quot;Article was successfully created.&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="视图表示"><a href="#视图表示" class="headerlink" title="视图表示"></a>视图表示</h2><blockquote>
<p>填写完表单, 点击preview时, 需要在<code>_form.html.erb</code>中显示刚才填写的内容</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># app/views/articles/_form.html.erb</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&lt;% if params[:preview_button] %&gt;</span><br><span class="line">  &lt;div class=&quot;preview&quot;&gt;</span><br><span class="line">    &lt;!-- 再显示一遍 --&gt;</span><br><span class="line">    &lt;div class=&quot;title&quot;&gt;</span><br><span class="line">      &lt;%= @article.title %&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;content&quot;&gt;</span><br><span class="line">      &lt;%= simple_format @article.content %&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><blockquote>
<p>点击<code>Preview</code>后:</p>
</blockquote>
<p><img src="http://i2.tietuku.com/808589a08f69107a.png" alt=""></p>
<blockquote>
<p>点击<code>Post</code>提交到服务器</p>
</blockquote>
<p><img src="http://i2.tietuku.com/7fdfdf0114d37872.png" alt=""></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a href="http://railscasts.com/episodes/38-multibutton-form" target="_blank" rel="external">http://railscasts.com/episodes/38-multibutton-form</a></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/default_avatar.jpg"
               alt="John Doe" />
          <p class="site-author-name" itemprop="name">John Doe</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">106</span>
              <span class="site-state-item-name">Artikel</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">Kategorien</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">104</span>
                <span class="site-state-item-name">Tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>

<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  

</body>
</html>
