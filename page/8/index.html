<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'uSvyVbAJs-5jfXFawgQ3','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/10/one-to-one/" itemprop="url">
                  Rails 中实现model的一对一关系映射
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-10T16:32:42+08:00" content="2015-02-10">
              2015-02-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/10/one-to-one/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/10/one-to-one/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="何谓一对一"><a href="#何谓一对一" class="headerlink" title="何谓一对一"></a>何谓一对一</h2><blockquote>
<p>看 ER 图:<br><img src="http://i2.tietuku.com/93bcd2a5efd818f4.png" alt=""></p>
<p>比如我们在京东(京东不逃税)买东西下订单后, 就会针对该订单生成一张发票, 从订单的角度来看, 发票是[1]<br>每张发票又必然会对应[1]个订单. 所以说这种关系是1对1</p>
<p>那么是订单属于发票更贴切还是反过来说更贴切, 个人认为后者更为合适, 所以我在订单这边使用<code>has_one</code>, 发票一边使用<code>belongs_to</code>.</p>
</blockquote>
<h2 id="添加引用的外键"><a href="#添加引用的外键" class="headerlink" title="添加引用的外键"></a>添加引用的外键</h2><blockquote>
<p>首先, 我们在belongs_to这边的表(invoices表)添加 order_id</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 生成Order model和orders表</span><br><span class="line">rails g model Order order_date:date</span><br><span class="line">rake db:migrate</span><br><span class="line"></span><br><span class="line"># 生成Invoice model 和 invoices表</span><br><span class="line">rails g model Invoice order_id:integer</span><br><span class="line">rake db:migrate</span><br><span class="line"></span><br><span class="line"># 如果已经存在了 Invoice model 和 invoices 表, 可以添加外键order_id</span><br><span class="line">rails g migration add_order_id_to_invoices order_id:integer</span><br><span class="line">rake migrate</span><br></pre></td></tr></table></figure>
<h2 id="使用-has-one和-belongs-to-处理-model-的对应关系"><a href="#使用-has-one和-belongs-to-处理-model-的对应关系" class="headerlink" title="使用 has_one和 belongs_to 处理 model 的对应关系"></a>使用 has_one和 belongs_to 处理 model 的对应关系</h2><blockquote>
<p>完成了参加数据库, 然后处理 model 直接的关联关系</p>
<p>向订单中添加<code>has_one</code>, 读作”Order has_one :invoice”, 并且, 还可以添加<code>dependent: :destroy</code>选项, 如果删除了订单, 那么与之关联的发票也一起删除.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Order &lt; ActiveRecord::Base</span><br><span class="line">  has_one :invoice, dependent: :destroy</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>想发票中添加<code>belongs_to</code>, 读作: “发票属于订单”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Invoice &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :order</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="可以使用的方法"><a href="#可以使用的方法" class="headerlink" title="可以使用的方法"></a>可以使用的方法</h2><blockquote>
<p>model 中具备了以上关系, 我们就可以使用以下的方法了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 新建对象</span><br><span class="line">order = Order.create(order_date: Time.now)</span><br><span class="line">invoice = Invoice.create</span><br><span class="line"></span><br><span class="line">order.invoice # =&gt; nil</span><br><span class="line">invoice.order # =&gt; nil</span><br><span class="line"></span><br><span class="line"># 关联到一起</span><br><span class="line">order.invoice = invoice</span><br><span class="line"></span><br><span class="line">order.invoice # =&gt; 返回 invoice</span><br><span class="line">invoice.order # =&gt; 返回 order</span><br><span class="line"></span><br><span class="line"># 删除</span><br><span class="line"></span><br><span class="line">Invoice.count # =&gt; 1</span><br><span class="line">order.destroy # =&gt; 由于设置了 dependent: :destroy, invoice也被删掉了</span><br><span class="line">Invoice.count # =&gt; 0</span><br></pre></td></tr></table></figure></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/10/many2many/" itemprop="url">
                  Rails 中实现model的多对多关系映射
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-10T13:16:34+08:00" content="2015-02-10">
              2015-02-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/10/many2many/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/10/many2many/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在 rails 中我们可以使用ActiveRecord的 <code>has_many</code>或<code>has_and_belongs_to_many</code> 在 model 中实现数据库表的多对多的关联关系.</p>
<p>那么 <code>has_many</code> 和 <code>has_and_belongs_to_many</code> 有什么不同呢?<br>在多对多关系中, 必须要有一个中间表.<br>如果使用<code>has_many</code>, 我们必须要创建中间表所对应的model, 可以向中间表加入属性, 验证等等.<br>如果使用<code>has_and_belongs_to_many</code>, 这个中间表所对应的model创建与否都无所谓, 那么也就不能加入验证之类的来定制化这个表了.<br>综上, <code>has_many</code> 更加灵活一些, 因为你可以自定义一些属性和验证.</p>
</blockquote>
<h2 id="何谓多对多"><a href="#何谓多对多" class="headerlink" title="何谓多对多?"></a>何谓多对多?</h2><blockquote>
<p>为了便于说明, 我们看一下下面的 ER 图:<br><img src="http://i2.tietuku.com/87e05cf9a2501acc.png" alt=""><br>[1] 个商品属于[多]个种类, 从”商品”的角度来看, 种类就是[多]<br>[1] 个”种类”可以有[多]个”商品”, 从”种类”来看, 商品就是[多]<br>此乃[多对多]. </p>
</blockquote>
<h2 id="移植到数据库"><a href="#移植到数据库" class="headerlink" title="移植到数据库"></a>移植到数据库</h2><blockquote>
<p>我们先分别创建每个 model 对应的表, 最后使用前面两个表的 id 作为外键创建中间表.</p>
</blockquote>
<ul>
<li><p>创建 Category model 和categories表.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g model Category name:string</span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建Product model 和 products 表.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g model Product name:string price:integer</span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>下面就有分情况讨论了:</p>
</blockquote>
<ul>
<li><p>使用 has_many, 我们需要创建CategoryProduct model和categories_products 数据库表.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g model CategoryProduct category_id:integer product_id:integer</span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>has_and_belongs_to_many</code>, 我们只需要创建categories_products表, 这里为了区别上面的表, 我改成 categories_products2.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g migration create_categories_products2 category_id:integer product_id:integer</span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="使用-has-many和-belongs-to-处理-model-的对应关系"><a href="#使用-has-many和-belongs-to-处理-model-的对应关系" class="headerlink" title="使用 has_many和 belongs_to 处理 model 的对应关系"></a>使用 has_many和 belongs_to 处理 model 的对应关系</h2><blockquote>
<p>创建完数据库的表, 接下来就有处理 model 中的关联关系.</p>
</blockquote>
<ul>
<li><p>使用<code>has_many</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># app/models/category.rb</span><br><span class="line"></span><br><span class="line">class Category &lt; ActiveRecord::Base</span><br><span class="line">  has_many :category_products</span><br><span class="line">  has_many :products, through: :category_products</span><br><span class="line"></span><br><span class="line">  # through 选项意思是Category 经过 category_products 可以访问到products</span><br><span class="line">  # 具体来说就是: category.products 获取某 category 的所有products</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/models/category_product.rb</span><br><span class="line"></span><br><span class="line">class CategoryProduct &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :category</span><br><span class="line">  belongs_to :products</span><br><span class="line"></span><br><span class="line">  # 这是&quot;中间人&quot;, 就是通过它, 才建立起了 Category 和Product 的关系.</span><br><span class="line">  # 它对两边都属于 1对多的关系</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/models/product.rb</span><br><span class="line"></span><br><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line">  has_many :categroy_products</span><br><span class="line">  has_many :categories, through: :category_products</span><br><span class="line"></span><br><span class="line">  # product.categories 获取某 product的所有所属种类</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>  <code>has_many</code> 方法有一些选项<code>class_name</code>, <code>foreign_key</code>, <code>dependent</code>, <code>delete_all</code>, <code>as</code>, <code>through</code> 这里就不细说了.</p>
</li>
<li><p>使用<code>has_and_belongs_to_many</code></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># app/models/category.rb</span><br><span class="line"></span><br><span class="line">class Category &lt; ActiveRecord::Base</span><br><span class="line">  has_and_belongs_to_many :products</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/models/product.rb</span><br><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line">  has_and_belongs_to_many :categories</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="可以使用的方法"><a href="#可以使用的方法" class="headerlink" title="可以使用的方法"></a>可以使用的方法</h2><blockquote>
<p>model 中这样设置以后, 我们就可以使用一些方法来对两只 model 互相操作. 同样, 我们还需要分组讨论:</p>
</blockquote>
<ul>
<li><p><code>has_many</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 创建</span><br><span class="line"></span><br><span class="line">category1 = Category.create(name: &quot;Cate1&quot;) # 创建游离的Category 对象</span><br><span class="line">product1 = Product.create(name: &quot;Product1&quot;, price: 100) # 游离的 Product对象</span><br><span class="line"></span><br><span class="line">product2 = category1.products.create(name: &quot;Product2&quot;, price: 300) </span><br><span class="line"># 创建了与 category1 存在关系的 product2</span><br><span class="line"></span><br><span class="line"># 关系</span><br><span class="line">category1.products.count # =&gt; 2</span><br><span class="line">category1.products &lt;&lt; product1</span><br><span class="line">category1.products.count # =&gt; 3</span><br><span class="line"></span><br><span class="line">product1.categories # =&gt; product1 关联的 category的数组集合</span><br><span class="line"></span><br><span class="line"># 中间表</span><br><span class="line">CategoryProduct.all # 获取全部的 category_products记录.</span><br><span class="line"># 由于CategoryProduct model存在, 所以我们可以通过它向中间表中添加验证和属性</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>has_and_belongs_to_many</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 创建</span><br><span class="line"></span><br><span class="line">category1 = Category.create(name: &quot;Cate1&quot;) # 创建游离的Category 对象</span><br><span class="line">product1 = Product.create(name: &quot;Product1&quot;, price: 100) # 游离的 Product对象</span><br><span class="line"></span><br><span class="line">product2 = category1.products.create(name: &quot;Product2&quot;, price: 300) </span><br><span class="line"># 创建了与 category1 存在关系的 product2</span><br><span class="line"></span><br><span class="line"># 关系</span><br><span class="line">category1.products.count # =&gt; 2</span><br><span class="line">category1.products &lt;&lt; product1</span><br><span class="line">category1.products.count # =&gt; 3</span><br><span class="line"></span><br><span class="line">product1.categories # =&gt; product1 关联的 category的数组集合</span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/09/one-to-many/" itemprop="url">
                  Rails 中实现model的一对多关系映射
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-09T21:19:58+08:00" content="2015-02-09">
              2015-02-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/09/one-to-many/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/09/one-to-many/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails 中, 通过在 model 中调用ActiveRecord 的<code>has_many</code> 和<code>belongs_to</code> 实现数据库表之间的一对多关系.</p>
</blockquote>
<h2 id="何谓一对多关系"><a href="#何谓一对多关系" class="headerlink" title="何谓一对多关系?"></a>何谓一对多关系?</h2><blockquote>
<p>为了便于解释, 请看下方的 ER 图:</p>
</blockquote>
<p><img src="http://i2.tietuku.com/bf76de985b972c6e.png" alt=""></p>
<blockquote>
<p>1个顾客可以下多个订单, 从顾客的角度来看, 订单就是”多”. 再又, 一个订单只能属于一个顾客, 从订单的角度来看, 顾客就是 “1”</p>
<p>故称作 “1对多”</p>
</blockquote>
<h2 id="添加引用外键"><a href="#添加引用外键" class="headerlink" title="添加引用外键"></a>添加引用外键</h2><blockquote>
<p>首先需要向[多] (这里是orders)添加xxx_id外键. 这里<code>xxx</code> 应该是引用外部的 model的名称, 这里就是Customer, 所以外键的名称是<code>customer_id</code>.</p>
<p>生成 Customer model和customers 表(数据库)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rails g model Customer name:string</span><br><span class="line"></span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure></p>
<p>生成Order model 和 orders 表</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g model Order customer_id:integer order_date:date</span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果model 和对应的表已经存在, 我们可以使用 migration 向 orders中只加入外键customer_id.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g migration add_customer_id_to_orders customer_id:integer</span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="使用-hash-many和-belongs-to-处理-model-的对应关系"><a href="#使用-hash-many和-belongs-to-处理-model-的对应关系" class="headerlink" title="使用 hash_many和 belongs_to 处理 model 的对应关系"></a>使用 hash_many和 belongs_to 处理 model 的对应关系</h2><blockquote>
<p>我们还需要在相关的 model 中声明关联关系 </p>
</blockquote>
<ul>
<li><p>[1]的一侧加入 <code>has_many</code>.<br>  并且在英文语法上也说得通”Customer has_many orders”, “顾客有多个订单”</p>
<p>  我们还需要加入<code>dependent: :destroy</code>选项, 它的作用是”依赖删除”, 也就是说我们删除了某一条customer, 与之相关联的order 都会被删除.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Customer &lt; ActiveRecord::Base</span><br><span class="line">  has_many :orders, dependent: :destroy</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>   <code>has_many</code>方法的 option:</p>
<ul>
<li><code>class_name</code> 指定相关联的model类名, 本例不设定该选项会默认Order 类, 如果真正的类名是SpecialOrder, 那么就必须设定该选项了.</li>
<li><code>foreign_key</code>指定引用的外键名称, 默认使用<code>引用model_id</code>, 如果你想要换成其他的字段可以通过该选项来指定.(<strong><em>本例中, Customer没有外键</em></strong>)</li>
<li><code>dependent</code>选项指定当[1]被删除后, 与之相关联的[多]的一方该怎么处理. 我可以设置<code>destroy</code>或者<code>delete_all</code>(直接删除数据库记录)</li>
<li><code>as</code>定义<code>polymorphic</code>(多态), 在多态关联中, 一个 model 可以属于多个model, 可以理解为多个不同的实体都引用了同一实体的同一属性, 比如员工和产品都引用了照片中的imageable</li>
<li><code>through</code>可以经常用于多对多的关系中, 其被设定为中间model.</li>
</ul>
</blockquote>
<ul>
<li>[多]的一边使用<code>belongs_to</code>方法<br>  读作: “Order belongs_to customer”, “订单属于一个顾客”.  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Order &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :customer</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>同样, belongs_to 也可以指定一些option:</p>
<ul>
<li><code>class_name</code> 指定相关model 类名.</li>
<li><code>foreign_key</code> 指定引用的外键的名称, 默认是<code>customer_id</code>.如果想换成别的字段, 通过该选项来指定</li>
<li><code>dependent</code> 略</li>
<li><code>polymorphic</code> 指定多态.</li>
</ul>
<p>比如说我们想把customer换成 user 就需要这样写:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Order &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :user, class_name: &quot;Customer&quot;, foreign_key: &quot;customer_id&quot;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 如果想取出某订单的用户, 就要这样:</span><br><span class="line"></span><br><span class="line">order.user</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="可以使用的方法"><a href="#可以使用的方法" class="headerlink" title="可以使用的方法"></a>可以使用的方法</h2><blockquote>
<p>像我们上面这样设定, 我们就可以使用下面这些方法了:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">## 新建对象</span><br><span class="line"></span><br><span class="line"># 删除顾客 customer_daniel, 存入数据库</span><br><span class="line">customer_daniel = Customer.create(name: &quot;Daniel&quot;)</span><br><span class="line"></span><br><span class="line"># 生成customer_daniel 顾客的订单 order1, 代替Order.new</span><br><span class="line">order1 = customer_daniel.orders.build(order_date: Time.now)</span><br><span class="line">order1.save # 存入数据库</span><br><span class="line"></span><br><span class="line"># 生成并保持到数据库</span><br><span class="line">order2 = customer_daniel.orders.create(order_date: Time.now)</span><br><span class="line"></span><br><span class="line">## 关系</span><br><span class="line"></span><br><span class="line">customer_daniel.orders # =&gt; 以一个数组形式返回 customer_daniel 的所有订单.</span><br><span class="line">customer_daniel.orders.exists? </span><br><span class="line">customer_daniel.orders.empty?</span><br><span class="line">order1.customer</span><br><span class="line"></span><br><span class="line">## 用户订单的查询</span><br><span class="line"></span><br><span class="line">customer_daniel.find()</span><br><span class="line">customer_daniel.find_by()</span><br><span class="line">customer_daniel.find_all()</span><br><span class="line">customer_daniel.where()</span><br><span class="line"></span><br><span class="line">## 删除</span><br><span class="line">Order.count # =&gt; 2</span><br><span class="line">customer_daniel.destroy()</span><br><span class="line">Order.count # =&gt; 0</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/09/crud/" itemprop="url">
                  Rails Model 增删改查常用方法总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-09T15:39:30+08:00" content="2015-02-09">
              2015-02-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/09/crud/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/09/crud/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本文主要对开发中 Active Record 的增删改查使用到的常用方法做一个总结(p.s. 这里我建议使用 <code>rails c -s</code>, 这是在沙盒中运行, 退出后数据库回到之前的状态^^)</p>
</blockquote>
<h2 id="model-的创建和保存"><a href="#model-的创建和保存" class="headerlink" title="model 的创建和保存"></a>model 的创建和保存</h2><h3 id="创建对象时直接赋值-new"><a href="#创建对象时直接赋值-new" class="headerlink" title="创建对象时直接赋值( new )"></a>创建对象时直接赋值( new )</h3><blockquote>
<p>我们可以在new 方法中直接传入一个含有键值对的 hash 来创建对象.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post = Post.new(title: &apos;greetings&apos;, body: &quot;nihaoxxx&quot;)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="hash-赋值"><a href="#hash-赋值" class="headerlink" title="hash 赋值"></a>hash 赋值</h3><blockquote>
<p>还可以创建一个对象, 然后为对象的<code>attributes</code>赋给一个 hash, 该 hash 含有该对象的属性和值.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post = Post.new</span><br><span class="line">post.attributes = &#123; title: &apos;greetings&apos;, body: &quot;nihaoxxx&quot; &#125;</span><br></pre></td></tr></table></figure>
<h3 id="保存对象"><a href="#保存对象" class="headerlink" title="保存对象"></a>保存对象</h3><blockquote>
<p>使用 save 方法保存对象. 保存成功会返回true, 数据库增加一条记录. 发生了验证错误会返回 false, 错误信息会被设定到<code>errors.full_messages</code> 中:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">post.save</span><br><span class="line"># =&gt; true</span><br><span class="line"></span><br><span class="line">post.save</span><br><span class="line"># =&gt; false</span><br><span class="line"></span><br><span class="line">post.errors.full_messages</span><br><span class="line"># =&gt; [&quot;Title can&apos;t be blank&quot;]</span><br></pre></td></tr></table></figure></p>
<p>使用<code>save!</code>保持对象, 如果验证错误发生会抛出<code>ActiveRecord::RecordInvalid</code> 异常, 而不是返回 false</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">post.save!</span><br><span class="line"># =&gt; ActiveRecord::RecordInvalid: Validation failed: Title can&apos;t be blank</span><br><span class="line"></span><br><span class="line"># 错误消息还是会被保存起来</span><br><span class="line">post.errors.full_messages</span><br><span class="line"># =&gt; [&quot;Title can&apos;t be blank&quot;]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们可以传入 validate: false 参数来跳过验证, 直接保存到数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post.save(validate: false)</span><br><span class="line">post.save!(validate: false)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="model创建保存一并完成-create"><a href="#model创建保存一并完成-create" class="headerlink" title="model创建保存一并完成(create)"></a>model创建保存一并完成(create)</h3><blockquote>
<p>如果使用create 方法就相当于new 和 save 一起使用</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 创建保存 model</span><br><span class="line">Post.create(title: &quot;fnfdnfjfjfj&quot;, body: &quot;fnierfe&quot;)</span><br><span class="line">=&gt; #&lt;Post id: 36, title: &quot;fnfdnfjfjfj&quot;, body: &quot;fnierfe&quot;, created_at: &quot;2015-02-09 08:58:49&quot;, updated_at: &quot;2015-02-09 08:58:49&quot;&gt;</span><br><span class="line"></span><br><span class="line"># 无论是否发生验证错误, 都会返回Post对象</span><br><span class="line">Post.create(title: nil, body: nil)</span><br><span class="line">=&gt; #&lt;Post id: nil, title: nil, body: nil, created_at: nil, updated_at: nil&gt;</span><br><span class="line"></span><br><span class="line">Post.create!(title: nil, body: nil)</span><br><span class="line">=&gt; ActiveRecord::RecordInvalid: Validation failed: Title can&apos;t be blank</span><br></pre></td></tr></table></figure>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><h3 id="获取所有记录-all"><a href="#获取所有记录-all" class="headerlink" title="获取所有记录(all)"></a>获取所有记录(all)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">posts = Post.all</span><br></pre></td></tr></table></figure>
<h3 id="获取第一条-最后一条记录-first-last"><a href="#获取第一条-最后一条记录-first-last" class="headerlink" title="获取第一条/最后一条记录(first/last)"></a>获取第一条/最后一条记录(first/last)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">first_post = Post.first</span><br><span class="line">last_post = Post.last</span><br></pre></td></tr></table></figure>
<h3 id="通过id-查找-find"><a href="#通过id-查找-find" class="headerlink" title="通过id 查找(find)"></a>通过id 查找(find)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">post = Post.find(1)</span><br><span class="line"></span><br><span class="line"># 传入数组查找的多个对象</span><br><span class="line">posts = Post.find([1, 2, 3])</span><br><span class="line"></span><br><span class="line"># 如果查询不到, 则抛异常</span><br><span class="line">ActiveRecord::RecordNotFound: Couldn&apos;t find Post with &apos;id&apos;=1</span><br></pre></td></tr></table></figure>
<h3 id="通过其他列名查找-find-by"><a href="#通过其他列名查找-find-by" class="headerlink" title="通过其他列名查找( find_by )"></a>通过其他列名查找( find_by )</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Post.find_by(title: &quot;fdsfsdf&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="指定条件查询-where"><a href="#指定条件查询-where" class="headerlink" title="指定条件查询(where)"></a>指定条件查询(where)</h3><blockquote>
<p>像 SQL where这样的查询, <strong><em> 小心 SQL 注入</em></strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># rails会将其传入的参数进行处理, 去掉 `,`, 空字符和换行符, 然后再赋给 `?`处</span><br><span class="line"># where 其实 内置了过滤器</span><br><span class="line">user = User.where(&quot;name = ?&quot;, &quot;test&quot;)</span><br><span class="line"></span><br><span class="line"># 为了可读性, 可以像下面这么写</span><br><span class="line">user = User.where(&quot;name = :name&quot;, name: &quot;test&quot;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>where方法也可以进行链调用(连续调用)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user = User.where(&quot;name = :name&quot;, name: &quot;test&quot;).where(active: true)</span><br><span class="line"></span><br><span class="line"># 我们不使用链调用也是可以的, 下面的写法是等价的:</span><br><span class="line"></span><br><span class="line">user = User.where(&quot;name = :name and active: :active&quot;, name: &quot;test&quot;, active: true)</span><br></pre></td></tr></table></figure>
<h3 id="模糊查询-like"><a href="#模糊查询-like" class="headerlink" title="模糊查询(like)"></a>模糊查询(like)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">users = User.where(&quot;email like ?&quot;, &quot;%&quot; + &quot;gmail.com&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="按-xxx-排序-order"><a href="#按-xxx-排序-order" class="headerlink" title="按 xxx 排序(order)"></a>按 xxx 排序(order)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 按 pay_type 升序, shipped_at 的降序获取</span><br><span class="line"></span><br><span class="line">orders = Order.where(name: &apos;Ruby on Rails&apos;).order(&quot;pay_type, shipped_at DESC&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="指定取出结果的数量-limit"><a href="#指定取出结果的数量-limit" class="headerlink" title="指定取出结果的数量( limit )"></a>指定取出结果的数量( limit )</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 取出最新的5个订单</span><br><span class="line"></span><br><span class="line">orders = Order.order(:created_at).limit(5)</span><br></pre></td></tr></table></figure>
<h3 id="分组-group"><a href="#分组-group" class="headerlink" title="分组(group)"></a>分组(group)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">group_body = Post.select(&quot;title, body&quot;).group(&quot;body&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="取得指定的列的值-select"><a href="#取得指定的列的值-select" class="headerlink" title="取得指定的列的值(select)"></a>取得指定的列的值(select)</h3><blockquote>
<p>Rails 默认是<code>select * from ...</code>进行查找的, 可是如果列中有图片这种比较大的原始数据我们就不能把所有的列都取出来了.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">videos = Video.select(&quot;title, speaker, created_at&quot;)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="表连接-joins"><a href="#表连接-joins" class="headerlink" title="表连接(joins)"></a>表连接(joins)</h3><blockquote>
<p>使用 joins方法其实数据库是进行的内连接查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Blog.joins(:entries)</span><br><span class="line"># =&gt; SELECT blogs.* FROM blogs INNER JOIN entries ON entries.blog_id = blogs.id</span><br></pre></td></tr></table></figure></p>
<p>我们还可以追加查询条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">entries = Entry.joins(:blogs).where(&quot;blogs.name LIKE ?&quot;, &quot;%me%&quot;)</span><br></pre></td></tr></table></figure></p>
<p>甚至, joins 可以接受 SQL 语句来进行连接查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User.joins(&quot;LEFT JOIN bookmarks ON bookmarks.bookmarkable_type = &apos;Post&apos; AND bookmarks.user_id = users.id&quot;)</span><br><span class="line">=&gt; SELECT &quot;users&quot;.* FROM &quot;users&quot; LEFT JOIN bookmarks ON bookmarks.bookmarkable_type = &apos;Post&apos; AND bookmarks.user_id = users.id</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="列上统计"><a href="#列上统计" class="headerlink" title="列上统计"></a>列上统计</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">average = Order.average(:amount)</span><br><span class="line">max      = Order.maximum(:amount)</span><br><span class="line">min       = Order.minimum(:amount)</span><br><span class="line">total      = Order.sum(:amount)</span><br><span class="line">number = Order.count</span><br></pre></td></tr></table></figure>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><h3 id="实例方法"><a href="#实例方法" class="headerlink" title="实例方法"></a>实例方法</h3><h4 id="覆盖原值再保存"><a href="#覆盖原值再保存" class="headerlink" title="覆盖原值再保存"></a>覆盖原值再保存</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user.name</span><br><span class="line"># =&gt; &quot;Mike&quot;</span><br><span class="line">user.name = &quot;Daniel&quot;</span><br><span class="line">user.save</span><br></pre></td></tr></table></figure>
<h4 id="多列更新-update"><a href="#多列更新-update" class="headerlink" title="多列更新(update)"></a>多列更新(update)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user.update(name: &quot;Daniel&quot;, email: &quot;cnfdsf@gmail.com&quot;)</span><br><span class="line"># =&gt; 成功 true 失败 false</span><br></pre></td></tr></table></figure>
<h4 id="更新某一列-update-attribute"><a href="#更新某一列-update-attribute" class="headerlink" title="更新某一列(update_attribute)"></a>更新某一列(update_attribute)</h4><blockquote>
<p><code>update_attribute</code> 不会执行验证, 所以需要注意:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user.update_attribute(:name, &quot;Daniel&quot;)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="reload方法"><a href="#reload方法" class="headerlink" title="reload方法"></a>reload方法</h4><blockquote>
<p>让数据库的值覆盖掉当前对象的属性值, Unit Test 的时候使用过:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user.email #=&gt; daniel@gmail.com</span><br><span class="line">user.email =  libai@126.com</span><br><span class="line">user.email #=&gt; libai@126.com</span><br><span class="line"></span><br><span class="line">user.reload.email</span><br><span class="line">user.email #=&gt; daniel@gmail.com</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="类方法"><a href="#类方法" class="headerlink" title="类方法"></a>类方法</h3><h4 id="update-id-attributes"><a href="#update-id-attributes" class="headerlink" title="update(id, attributes)"></a>update(id, attributes)</h4><blockquote>
<p>指定 id( 或 id 数组 )对应的记录, 更新为 attributes(hash). <strong><em>注意: 不会被验证 </em></strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 把id 为1, 3, 5对应的记录的sale属性改为 true, discount_rate改为0.2</span><br><span class="line">Porduct.update([1, 3, 5], [&#123;sale: true&#125;, &#123;discount_rate: 0.2&#125;])</span><br></pre></td></tr></table></figure>
<h4 id="update-all-updates"><a href="#update-all-updates" class="headerlink" title="update_all(updates)"></a>update_all(updates)</h4><blockquote>
<p>本质就是指定SQL 的 update 的 set语句和where 语句, <strong><em>注意:不会被验证</em></strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Post.update_all(&quot;price = 1.1*price&quot;, &quot;title like &apos;shirt&apos;&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><h3 id="实例方法-1"><a href="#实例方法-1" class="headerlink" title="实例方法"></a>实例方法</h3><h4 id="删除记录-destroy"><a href="#删除记录-destroy" class="headerlink" title="删除记录(destroy)"></a>删除记录(destroy)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user.destroy # 从数据库中删除</span><br></pre></td></tr></table></figure>
<h3 id="类方法-1"><a href="#类方法-1" class="headerlink" title="类方法"></a>类方法</h3><h4 id="删除全部记录-delete-all"><a href="#删除全部记录-delete-all" class="headerlink" title="删除全部记录(delete_all)"></a>删除全部记录(delete_all)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User.delete_all</span><br><span class="line">#=&gt; 10 (返回删除的记录数)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/09/request-head/" itemprop="url">
                  Rails 中request header 和 response header的获取
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-09T14:54:55+08:00" content="2015-02-09">
              2015-02-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/09/request-head/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/09/request-head/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails 中, 我们可以通过在 controller 中这样两个方法来获取请求header 和response header</p>
</blockquote>
<h2 id="获取请求header"><a href="#获取请求header" class="headerlink" title="获取请求header"></a>获取请求header</h2><blockquote>
<p>我们可以通过 accessor(url, method, user_agent) 来获取 request 中的数据:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request.url</span><br><span class="line">#=&gt; &quot;http://localhost:3000/flashes/index&quot;</span><br><span class="line"></span><br><span class="line">request.method</span><br><span class="line">#=&gt; &quot;GET&quot;</span><br><span class="line"></span><br><span class="line">request.user_agent</span><br><span class="line">#=&gt; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.94 Safari/537.36&quot;</span><br></pre></td></tr></table></figure></p>
<p>以上的这些header 信息都有对应的方法, 还有一些header没有对应的accessor, 那么我们可以使用hash 的方式取值, 比如:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.env[&quot;GATEWAY_INTERFACE&quot;]</span><br><span class="line"># =&gt; &quot;CGI/1.1&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>不难推断, Rails 会将这些header 信息存入一个 hash 结构的对象中.</p>
</blockquote>
<h2 id="获取响应-header"><a href="#获取响应-header" class="headerlink" title="获取响应 header"></a>获取响应 header</h2><blockquote>
<p>我们可以在 controller 中使用<code>response.headers</code>, 设置或者获取响应 header 信息:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">response.headers[&apos;Content-Type&apos;] = &apos;application/json&apos;</span><br><span class="line"></span><br><span class="line">response.headers</span><br><span class="line"></span><br><span class="line">#=&gt; &#123;&quot;X-Frame-Options&quot;=&gt;&quot;SAMEORIGIN&quot;, &quot;X-XSS-Protection&quot;=&gt;&quot;1; mode=block&quot;, &quot;X-Content-Type-Options&quot;=&gt;&quot;nosniff&quot;, &quot;Content-Type&quot;=&gt;&quot;application/json&quot;&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/09/sessions/" itemprop="url">
                  Rails session
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-09T12:54:12+08:00" content="2015-02-09">
              2015-02-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/09/sessions/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/09/sessions/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails 默认把 session信息保存在了浏览器的 cookies 中, 接着在controller 中可以通过使用 session 对象 向 session中设定值取值. session 也是类 hash 结构的.</p>
</blockquote>
<h2 id="向-session-中设定值"><a href="#向-session-中设定值" class="headerlink" title="向 session 中设定值"></a>向 session 中设定值</h2><blockquote>
<p>我们可以像为 hash 赋值那样给 通过使用<code>session</code> 对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/logins_controller.rb</span><br><span class="line"></span><br><span class="line">class LoginsController &lt; ApplicationController</span><br><span class="line">  def create</span><br><span class="line">    if user.authenticate(params[:username], params[:password])</span><br><span class="line">      # 认证成功, 把以后的 id存入 session 中</span><br><span class="line">      session[:user_id] = user.id</span><br><span class="line">      redirect_to root_url</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="从-session-中取值"><a href="#从-session-中取值" class="headerlink" title="从 session 中取值"></a>从 session 中取值</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/application_controller.rb</span><br><span class="line"></span><br><span class="line">class ApplicationController &lt; ActionController::Base</span><br><span class="line">  </span><br><span class="line">  private</span><br><span class="line">    # 获取当前用户</span><br><span class="line">    # 如果 @_current_user为空, 从 session 中获取用户id, 再到数据库中取出用户</span><br><span class="line">    def current_user</span><br><span class="line">      @_current_user ||= User.find_by(id: session[:user_id])</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="删除已经设定的值"><a href="#删除已经设定的值" class="headerlink" title="删除已经设定的值"></a>删除已经设定的值</h2><blockquote>
<p>我们要想删除 session 中的某个值也很简单, 只需设置为 nil 即可:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class LoginsController &lt; ApplicationController</span><br><span class="line">  # 退出登录( logout )</span><br><span class="line">  def destroy</span><br><span class="line">    # 把@_current_user 和session[:user_id]的值设置为 nil</span><br><span class="line">    @_current_user = session[:user_id] = nil</span><br><span class="line">    redirect_to root_url</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然我们也可以清空 session<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def destroy</span><br><span class="line">  @_current_user = nil</span><br><span class="line">  reset_session</span><br><span class="line">  redirect_to root_url</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="使用-session-注意事项"><a href="#使用-session-注意事项" class="headerlink" title="使用 session 注意事项"></a>使用 session 注意事项</h2><h3 id="不要存隐私数据"><a href="#不要存隐私数据" class="headerlink" title="不要存隐私数据"></a>不要存隐私数据</h3><blockquote>
<p>默认来说 session 数据都是保存在本地 cookie 中的, 因此, 即便是有防止篡改机制, 我们还需要去检查数据内容是否有变化, 这就带来了不必要的麻烦, 所以还是不要把很隐私的数据保存到 session 中.(数据一旦保存在本地就会有很大安全问题, 你无法保障用户的计算机是安全的)</p>
</blockquote>
<h3 id="不要保存太大的对象"><a href="#不要保存太大的对象" class="headerlink" title="不要保存太大的对象"></a>不要保存太大的对象</h3><blockquote>
<p>cookie 只能保存小于4KB 的数据, 一般来讲我们推荐保存类似于 user_id, flash 消息这种小数据.</p>
</blockquote>
<h3 id="不要存放无法写入文件的对象"><a href="#不要存放无法写入文件的对象" class="headerlink" title="不要存放无法写入文件的对象"></a>不要存放无法写入文件的对象</h3><blockquote>
<p>session 保存数据的原理是利用<code>Marshal#dump</code> 方法把对象序列化保存到硬盘文件上. 如果对象本身(如 IO 对象, Proc 对象) 不支持序列化, 那么我们也就不能将这些对象存入 session 中.</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/09/flash-messages/" itemprop="url">
                  Rails 给用户友好的消息提示
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-09T10:51:03+08:00" content="2015-02-09">
              2015-02-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/09/flash-messages/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/09/flash-messages/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>我们在登录后, 或者注册完新用户后一般会有一条友好的消息在页面上显示比如, 登录成功等. rails 提供了flash 来做这件事. </p>
</blockquote>
<h2 id="设定和显示-flash-消息"><a href="#设定和显示-flash-消息" class="headerlink" title="设定和显示 flash 消息"></a>设定和显示 flash 消息</h2><blockquote>
<p>我们需要在 controller 里面设置 flash 消息, 它很像 hash, 我们可以设置K-V, 然后在view 中获取. 并且无需特意去销毁flash, 因为它一经被设定, 被现实完成之后, 就自动销毁了.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 设定 flash</span><br><span class="line">def index</span><br><span class="line">  flash[:notice] = &quot;显示成功&quot;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 为了给所有模板可以显示消息, 我讲flash的内容放在布局文件中</span><br><span class="line"></span><br><span class="line"># app/views/layouts/application.html.erb</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">  &lt;title&gt;ControllerTest&lt;/title&gt;</span><br><span class="line">  &lt;%= stylesheet_link_tag    &apos;application&apos;, media: &apos;all&apos;, &apos;data-turbolinks-track&apos; =&gt; true %&gt;</span><br><span class="line">  &lt;%= javascript_include_tag &apos;application&apos;, &apos;data-turbolinks-track&apos; =&gt; true %&gt;</span><br><span class="line">  &lt;%= csrf_meta_tags %&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line"></span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;!-- 遍历 flash 中的 key 和 value  --&gt;</span><br><span class="line">  &lt;% flash.each do |key, value| %&gt;</span><br><span class="line">  &lt;%= content_tag(:div, value, class: &quot;#&#123;key&#125;&quot;) %&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;%= yield %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="请求内有效的-flash-消息"><a href="#请求内有效的-flash-消息" class="headerlink" title="请求内有效的 flash 消息"></a>请求内有效的 flash 消息</h2><blockquote>
<p>通常 flash 消息的生命周期到下一次请求为止, 比如我在一个action 中设置了 flash 消息, 然后有调用了<code>redirect_to</code> 方法, 让浏览器再一次发送请求, 然后在重定向的页面显示 flash 消息, 有时候我们需要让 flash 消息仅在一个 action 之内有效, action 执行完 flash 消息就被销毁, 可以这样做:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def index</span><br><span class="line">  flash.now[:notices] = &quot;I can available in ONE action!!!&quot;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="重定向时的-flash-消息"><a href="#重定向时的-flash-消息" class="headerlink" title="重定向时的 flash 消息"></a>重定向时的 flash 消息</h2><blockquote>
<p><code>redirect_to</code> 方法为我们提供更为简洁的方法来设置 flash 消息:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 等价于:</span><br><span class="line"># flash[notice] = &apos;成功&apos;</span><br><span class="line"># redirect_to login_url</span><br><span class="line">redirect_to login_url, notice: &apos;成功&apos;</span><br></pre></td></tr></table></figure></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/09/action-filter/" itemprop="url">
                  Rails action的过滤器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-09T08:18:21+08:00" content="2015-02-09">
              2015-02-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/09/action-filter/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/09/action-filter/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在 rails4中我们可以在 controller 中声明 <code>after_action, before_action, around_action</code>, 在 action 的前后对请求进行处理. 在 rails3中使用的是<code>xxx_filter</code>.</p>
</blockquote>
<h2 id="before-action-after-action使用方法"><a href="#before-action-after-action使用方法" class="headerlink" title="before_action, after_action使用方法"></a>before_action, after_action使用方法</h2><blockquote>
<p>before_action会在action 执行前被执行, 我们来看看如何使用:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/users_controller.rb</span><br><span class="line"></span><br><span class="line">class UsersController &lt; ApplicationController</span><br><span class="line">  # action 执行前, 执行对用户的认证</span><br><span class="line">  before_action :authenticate_user!</span><br><span class="line"></span><br><span class="line">  # 上面的代码会在每一个 action 被执行前进行预处理, </span><br><span class="line">  # 如果你希望仅对一些 action 进行处理或者不对一些 action进行处理, </span><br><span class="line">  # 可以设置 `only:`, `except:` 选项.</span><br><span class="line">  # before_action :authenticate_user!, only: [:show, :edit, :update, :destroy]</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">    def authenticate_user!</span><br><span class="line">      # 对用户进行认证处理</span><br><span class="line">      # ...</span><br><span class="line">      # 如果认证失败, 让浏览器重定向到登陆页面</span><br><span class="line">      redirect_to login_url</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p><code>after_action</code> 道理相同, 在 action 执行之后被调用.</p>
</blockquote>
<h2 id="around-action-使用方法"><a href="#around-action-使用方法" class="headerlink" title="around_action 使用方法"></a>around_action 使用方法</h2><blockquote>
<p>around_action 像是 before_action 和 after_action 的综合体, 在其方法体内, 我们可以使用 yield 让外部的 action 执行, action 执行完以后再回到around_action 中继续执行方法剩下的部分:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/users_controller.rb</span><br><span class="line"></span><br><span class="line">class UsersController &lt; ApplicationController</span><br><span class="line">  around_action :hoge</span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">    def hoge</span><br><span class="line">      logger.debug &quot;action 预处理&quot;</span><br><span class="line">      yield</span><br><span class="line">      logger.debug &quot;action 后处理&quot;</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="跳过-before-action-after-action-around-action"><a href="#跳过-before-action-after-action-around-action" class="headerlink" title="跳过 before_action, after_action, around_action"></a>跳过 before_action, after_action, around_action</h2><blockquote>
<p> 假设我在ApplicationController中设置了一个 before_action, 那么其他 controller(ApplicationController 的子类) 中的 action 在被执行前都会去执行父类中的 before_action, 如果子类中的某个 action 不想在被执行前去执行父类中的 before_action, 那么就可以使用skip_before_action.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class ApplicationController &lt; ActionController::Base</span><br><span class="line">  before_action :app_filter</span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">    def app_filter</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class StaticPagesController &lt; ApplicationController</span><br><span class="line">  skip_before_action :app_filter</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="多个-controllers-共享同一-action"><a href="#多个-controllers-共享同一-action" class="headerlink" title="多个 controllers 共享同一 action"></a>多个 controllers 共享同一 action</h2><blockquote>
<p>还有一个问题, 如果我有很多的 controller, 并且它们中许多的过滤器都是相同的, 这时我们可以将这些相同的过滤器抽取到一个类中, 减少代码的冗余</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/concerns/my_action.rb</span><br><span class="line"></span><br><span class="line">class MyAction</span><br><span class="line"></span><br><span class="line">  # before_action 被执行时执行</span><br><span class="line">  def before(controller)</span><br><span class="line">  ¦ controller.logger.debug &quot;before: #&#123;controller.action_name&#125;&quot;</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # after_action 被执行时执行</span><br><span class="line">  def after(controller)</span><br><span class="line">  ¦ controller.logger.debug &quot;after: #&#123;controller.action_name&#125;&quot;</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # around_action 被执行时执行</span><br><span class="line">  def around(controller)</span><br><span class="line">  ¦ before(controller)</span><br><span class="line">  ¦ yield</span><br><span class="line">  ¦ after(controller)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/controllers/users_controller.rb</span><br><span class="line"></span><br><span class="line">class UsersController &lt; ApplicationController</span><br><span class="line">  before_action MyAction.new</span><br><span class="line">  after_action MyAction.new</span><br><span class="line">  around_action  MyAction.new</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/08/rails-strong-parameters/" itemprop="url">
                  Rails Strong Parameters
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-08T20:27:54+08:00" content="2015-02-08">
              2015-02-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/08/rails-strong-parameters/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/08/rails-strong-parameters/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails4开始, 在获取表单的值时加入了params 方法和 StrongParameters 机制.</p>
</blockquote>
<h2 id="Rails-params-方法"><a href="#Rails-params-方法" class="headerlink" title="Rails params 方法"></a>Rails params 方法</h2><blockquote>
<p>比如我们现在有一个对象 product, 它有 name 属性, 为了像下面这种形式对参数进行约定, 在 controller 的内部, 使用<code>params</code> 方法取出被嵌套在 hash 里面的值.</p>
<ul>
<li>像product[name] 这样,  对于 name 属性来说[]里面不是空的, 会被当做嵌套的 hash来取值.</li>
<li>像product[category_ids][] 这样, 对于 name 属性来说是<code>[复数][]</code>, 会被当做数组来取值.</li>
</ul>
<p>拿下面的例子来说吧, 这是个商品新建的输入表单<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;/products&quot; method=&quot;post&quot;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div style=&quot;display:none&quot;&gt;</span><br><span class="line">    &lt;input name=&quot;utf8&quot; type=&quot;hidden&quot; value=&quot;✓&quot;&gt;</span><br><span class="line">    &lt;input name=&quot;authenticity_token&quot; type=&quot;hidden&quot; value=&quot;gpATAhefgIhzK7cuGsWVuKGZCE4gJeEbrMv+a/wOJ+I=&quot;&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">    &lt;label for=&quot;product_name&quot;&gt;Name&lt;/label&gt;&lt;br&gt;</span><br><span class="line">    &lt;input id=&quot;product_name&quot; name=&quot;product[name]&quot; type=&quot;text&quot;&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">    &lt;label for=&quot;product_description&quot;&gt;Description&lt;/label&gt;&lt;br&gt;</span><br><span class="line">    &lt;textarea id=&quot;product_description&quot; name=&quot;product[description]&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">    &lt;label for=&quot;product_price&quot;&gt;Price&lt;/label&gt;&lt;br&gt;</span><br><span class="line">    &lt;input id=&quot;product_price&quot; name=&quot;product[price]&quot; type=&quot;number&quot;&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">    &lt;label for=&quot;product_category&quot;&gt;Category&lt;/label&gt;&lt;br&gt;</span><br><span class="line">    &lt;input id=&quot;product_category_idx_1&quot; name=&quot;product[category_ids][]&quot; type=&quot;checkbox&quot; value=&quot;1&quot;&gt; CATA1</span><br><span class="line">    &lt;input id=&quot;product_category_idx_2&quot; name=&quot;product[category_ids][]&quot; type=&quot;checkbox&quot; value=&quot;2&quot;&gt; CATA2</span><br><span class="line">    &lt;input id=&quot;product_category_idx_3&quot; name=&quot;product[category_ids][]&quot; type=&quot;checkbox&quot; value=&quot;3&quot;&gt; CATA3</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">    &lt;input name=&quot;commit&quot; type=&quot;submit&quot; value=&quot;Create Product&quot;&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure></p>
<p>这时, params 方法返回下面的值:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">params</span><br><span class="line">#=&gt; &#123;</span><br><span class="line">#     &quot;utf8&quot;=&gt;&quot;✓&quot;,</span><br><span class="line">#     &quot;authenticity_token&quot;=&gt;&quot;gpATAhefgIhzK7cuGsWVuKGZCE4gJeEbrMv+a/wOJ+I=&quot;,</span><br><span class="line">#     &quot;product&quot; =&gt; &#123;</span><br><span class="line">#         &quot;name&quot;=&gt;&quot;XBOX&quot;,</span><br><span class="line">#         &quot;description&quot;=&gt;&quot;A great console from microsoft&quot;,</span><br><span class="line">#         &quot;price&quot;=&gt;&quot;100&quot;</span><br><span class="line">#         &quot;category_ids&quot; =&gt; [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;]</span><br><span class="line">#     </span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">#     &quot;commit&quot;=&gt;&quot;Create Product&quot;,</span><br><span class="line">#     &quot;action&quot;=&gt;&quot;create&quot;,</span><br><span class="line">#     &quot;controller&quot;=&gt;&quot;products&quot;</span><br><span class="line">#   </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="StrongParameters"><a href="#StrongParameters" class="headerlink" title="StrongParameters"></a>StrongParameters</h2><blockquote>
<p>当 hash接收到了输入的参数, model很可能直接调用 <code>new</code> <code>update</code> 方法直接传入这些参数的值, 添加到数据库.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">params # =&gt; &#123; &quot;name&quot; =&gt; &quot;daniel&quot;, &quot;email&quot; =&gt; &quot;taro@test.com&quot;, password&quot; =&gt; &quot;password&quot;&#125;</span><br><span class="line"></span><br><span class="line">User.create(params)</span><br></pre></td></tr></table></figure></p>
<p>但是这会引发安全问题, 如果一些邪恶用户在parameter 中加入一些不可以被更新的属性, 比如添加管理员权限:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">params # =&gt; &#123; &quot;name&quot; =&gt; &quot;daniel&quot;, &quot;email&quot; =&gt; &quot;taro@test.com&quot;, password&quot; =&gt; &quot;password&quot;, &quot;admin&quot; =&gt; &quot;true&quot;  &#125;</span><br><span class="line"></span><br><span class="line">User.create(params) # 该用户有管理员权限, 很危险.</span><br></pre></td></tr></table></figure></p>
<p>在 Rails3中是这样处理的, 在 model 中加入attr_accessiable 方法, 明确指出可以被更新的属性:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#rails3</span><br><span class="line"></span><br><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line">  attr_accessiable :name, :email, :password</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>但是这种默认许可更新的做法还是不好的, rails4做了改变, 默认是不可以更新的, 若想更新需要对该属性进行许可. 这就是StrongParameter的机制, 在 controller 中明确 params中可以被更新的属性.</p>
<p>使用require和 permit方法对 params内部的属性进行许可更新设置</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">def create</span><br><span class="line">@product = Product.new(product_params)</span><br><span class="line"></span><br><span class="line">if @product.save</span><br><span class="line">redirect_to @product, notice: &apos;Product was successfully created.&apos;</span><br><span class="line">else</span><br><span class="line">render :new</span><br><span class="line">end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private</span><br><span class="line"># StrongParameter</span><br><span class="line"># product的name, description, price 被允许修改</span><br><span class="line">#</span><br><span class="line"># params的内容</span><br><span class="line"># =&gt; &#123;</span><br><span class="line">#      &quot;utf8&quot;=&gt;&quot;✓&quot;,</span><br><span class="line">#      &quot;authenticity_token&quot; =&gt; &quot;gpATAhefgIhzK7cuGsWVuKGZCE4gJeEbrMv+a/wOJ+I=&quot;,</span><br><span class="line">#      &quot;product&quot;=&gt;</span><br><span class="line">#         &#123; &quot;name&quot;=&gt;&quot;111&quot;,</span><br><span class="line">#           &quot;description&quot;=&gt;&quot;22&quot;,</span><br><span class="line">#           &quot;price&quot;=&gt;&quot;100&quot;,</span><br><span class="line">#           &quot;category_ids&quot;=&gt;[&quot;1&quot;, &quot;2&quot;]</span><br><span class="line">#         &#125;,</span><br><span class="line">#      &quot;commit&quot;=&gt;&quot;Create Product&quot;,</span><br><span class="line">#      &quot;action&quot;=&gt;&quot;create&quot;,</span><br><span class="line">#      &quot;controller&quot;=&gt;&quot;products&quot;</span><br><span class="line">#     </span><br><span class="line">&#125;</span><br><span class="line">#</span><br><span class="line"># 返回值</span><br><span class="line"># =&gt; &#123;&quot;name&quot;=&gt;&quot;Xbox&quot;, &quot;description&quot;=&gt;&quot;good console&quot;, &quot;price&quot;=&gt;&quot;100&quot;&#125;</span><br><span class="line">def product_params</span><br><span class="line">params.require(:product).permit(:name, :description, :price)</span><br><span class="line"></span><br><span class="line"># 也可以对数组进行许可</span><br><span class="line"># params.require(:product)</span><br><span class="line">#       .permit(:name, :description, :price, :category_ids =&gt; [])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/08/rails-redirect/" itemprop="url">
                  Rails 重定向(redirect_to)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-08T15:30:15+08:00" content="2015-02-08">
              2015-02-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/08/rails-redirect/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/08/rails-redirect/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails controller 使用 redirect_to() 跳转到其他 url.</p>
</blockquote>
<h2 id="什么是重定向"><a href="#什么是重定向" class="headerlink" title="什么是重定向?"></a>什么是重定向?</h2><blockquote>
<p>HTTP 重定向: 服务器无法处理浏览器发送来的请求(request), 服务器告诉浏览器跳转到可以处理请求的 url 上.</p>
<p>具体来讲, 对于服务器响应给浏览器这个过程来说, 服务器把要跳转的URL地址和状态码返回给浏览器, 浏览器会自动访问该 URL 地址. 以至于用户几乎无法分辨是否重定向了.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class SomeController &lt; ApplicationController</span><br><span class="line">  redirect_to(some_url, status: 301)</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="何时用-redirect-to-何时用-render"><a href="#何时用-redirect-to-何时用-render" class="headerlink" title="何时用 redirect_to, 何时用 render?"></a>何时用 redirect_to, 何时用 render?</h2><blockquote>
<p>基本上:</p>
<ul>
<li>对数据进行添加, 更新, 删除时, <code>redirect_to</code></li>
<li>取得数据, 然后我们要想将数据表示出来时, 使用<code>render</code></li>
</ul>
<p>看下面的代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># POST /products</span><br><span class="line"># 你现在在产品的新建页面, 点击创建按钮会触发下面的方法.</span><br><span class="line">def create</span><br><span class="line">  @product = Product.new(product_params)</span><br><span class="line"></span><br><span class="line">  if @product.save # product 保存成功, redirect 到查看商品页面</span><br><span class="line">    redirect_to @product, notice: &apos;Created successfully.&apos;</span><br><span class="line">  else # product 保存失败, 渲染新建页面</span><br><span class="line">    render :new</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>如果我把 redirect_to 换作 render, 点击 create 按钮后, 浏览器地址栏不会变化, 也就是说, 你要是继续按 F5, 那么浏览器还会请求 create 这个 action, 就会反复创建, 如果要是在电商系统中, 比如你将一件商品加入购物车, 再次刷新, … 最后, 购物车就会重复加入很多商品, 会带来很多不便. 如果要是 redirect_to 方法就不同了, 前后浏览器发送了两次请求, 第二次请求就是显示购物车页面(比如说), 所以, 无论用户如何按刷新键, 都不会调用 create 方法. (p.s. 这个问题很经典, 记得当前学习j2ee 时, 就讨论过什么时候使用请求转发, 什么时候使用重定向^^)</p>
</blockquote>
<h2 id="redirect-to-方法的使用方法"><a href="#redirect-to-方法的使用方法" class="headerlink" title="redirect_to 方法的使用方法"></a><code>redirect_to</code> 方法的使用方法</h2><h3 id="向-URL重定向"><a href="#向-URL重定向" class="headerlink" title="向 URL重定向"></a>向 URL重定向</h3><blockquote>
<p>重定向到指定的路径. 这时, 我们一个使用 <em>_url 而不是</em>_path, 而且, 我们还可以设置:notice, alert: 选项来设置相应的flash消息.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redirect_to products_url, notice: &apos;blabla...&apos;</span><br></pre></td></tr></table></figure>
<h3 id="重定向到HTTP-REFERER"><a href="#重定向到HTTP-REFERER" class="headerlink" title="重定向到HTTP_REFERER"></a>重定向到HTTP_REFERER</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 从哪个页面请求过来, 再回到那个页面去.</span><br><span class="line">redirect_to(:back)</span><br></pre></td></tr></table></figure>
<h3 id="永久重定向"><a href="#永久重定向" class="headerlink" title="永久重定向"></a>永久重定向</h3><blockquote>
<p>默认来讲, 重定向都是临时性重定向, 状态码为307, 如果需要永久重定向就需要显示指定状态码 301</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redirect_to(&apos;http://www.google.com&apos;, status: 301)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Daniel Zhang" />
          <p class="site-author-name" itemprop="name">Daniel Zhang</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">104</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">104</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Daniel Zhang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"danielhexo"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
