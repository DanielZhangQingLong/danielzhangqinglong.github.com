<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/11/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Suche
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'uSvyVbAJs-5jfXFawgQ3','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/30/rails-data-read-write-seperate/" itemprop="url">
                  Rails 实现数据库读写分离
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-01-30T12:44:17+08:00" content="2015-01-30">
              2015-01-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>我厂领导突然产生了一个奇妙的想法, 他想让我把美国master 的数据库在中国的 slave 做成读写分离的模式, 但是网站跑起来就会产生日志, 一样会修改本地的 slave. 从而阻止 master 同步, 数据库一旦停止同步, 美国那边就得重新来弄. sigh … </p>
<p>废话少说, 这就是命令, 顺便也能学到一些知识:</p>
<h3 id="所使用环境："><a href="#所使用环境：" class="headerlink" title="所使用环境："></a>所使用环境：</h3><ul>
<li>Ubuntu Linux，Mac，Rails 3.2.18 ，MySQL数据库。还有这个 gem, octopus gem <a href="https://github.com/tchandy/octopus" target="_blank" rel="external">https://github.com/tchandy/octopus</a> 。</li>
</ul>
</blockquote>
<ol>
<li><p>MySQL分别安装在了Mac和Linux上，Mac的MySQL作为写入数据库，而Linux的作为读取数据库，这两个数据库并未同步。</p>
</li>
<li><p>在Rails 项目的config目录下新建文件 shards.xml,该文件用于保存Linux下MySQL read数据库, 该文件长成这个样子：</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">octopus:</span></span><br><span class="line"><span class="attr">  replicated:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  fully_replicated:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  environments:</span></span><br><span class="line"><span class="bullet">   -</span> development</span><br><span class="line"><span class="bullet">   -</span> production</span><br><span class="line"></span><br><span class="line"><span class="attr">  development:</span></span><br><span class="line"><span class="attr">    slave1:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="number">159.226</span><span class="number">.67</span><span class="number">.89</span></span><br><span class="line"><span class="attr">      adapter:</span> mysql2</span><br><span class="line"><span class="attr">      database:</span> testmirror</span><br><span class="line"><span class="attr">      username:</span> root</span><br><span class="line"><span class="attr">      password:</span> root</span><br><span class="line"><span class="attr">  production:</span></span><br><span class="line"><span class="attr">    slave1:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="number">159.226</span><span class="number">.67</span><span class="number">.89</span></span><br><span class="line"><span class="attr">      adapter:</span> mysql2</span><br><span class="line"><span class="attr">      database:</span> testmirror</span><br><span class="line"><span class="attr">      username:</span> root</span><br><span class="line"><span class="attr">      password:</span> root</span><br></pre></td></tr></table></figure>
<ol>
<li><p>rails c （指定开发环境）</p>
<blockquote>
<p>Post.using(:slave1).count 指定读取的数据库查询</p>
</blockquote>
</li>
<li><p>需说明一点：rails 会将database.yml中配置的数据库作为写数据库 查询使用 Post.using(:master).count</p>
</li>
</ol>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/24/postgresql-with-rails/" itemprop="url">
                  Postgresql with Rails on OSX
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-01-24T12:50:41+08:00" content="2015-01-24">
              2015-01-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Postgresql/" itemprop="url" rel="index">
                    <span itemprop="name">Postgresql</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>一直都对Postgresql不理解, 今天在YouTube上找了一个视频, 学习了一下, 原视频地址<a href="https://www.youtube.com/watch?v=pf5jPUJAeU4" target="_blank" rel="external">https://www.youtube.com/watch?v=pf5jPUJAeU4</a></p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><blockquote>
<p>使用Homebrew 安装:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install postgres</span><br></pre></td></tr></table></figure>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><blockquote>
<p>等安装完成之后, 我们来初始化数据库:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ initdb /usr/local/var/postgres</span><br></pre></td></tr></table></figure>
<h2 id="使用lunchy-简单地开关数据库"><a href="#使用lunchy-简单地开关数据库" class="headerlink" title="使用lunchy 简单地开关数据库"></a>使用lunchy 简单地开关数据库</h2><blockquote>
<p>安装完成之后, 你会看到postgres启动关闭服务相关的帮助信息:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres -D /usr/local/var/postgres</span><br></pre></td></tr></table></figure>
<blockquote>
<p>但是比较麻烦, 能不能像在Linux下service命令简单地开关服务呢? OSX下可以使用lunchy实现类似的效果, 我们来安装并配置它.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gem install lunchy</span><br></pre></td></tr></table></figure>
<blockquote>
<p>新建自动启动代理目录:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ~/Library/LaunchAgents</span><br></pre></td></tr></table></figure>
<blockquote>
<p>把postgres的plist拷贝到该目录中:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/Cellar/postgresql/9.4.1/homebrew.mxcl.postgresql.plist ~/Library/LaunchAgents</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以后, 我们就可以简单地使用lunchy来启动, 关闭 postgres服务了:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ lunchy start postgres</span><br><span class="line">$ lunchy stop postgres</span><br></pre></td></tr></table></figure>
<h2 id="创建数据库用户-角色-和-数据库实例"><a href="#创建数据库用户-角色-和-数据库实例" class="headerlink" title="创建数据库用户(角色) 和 数据库实例"></a>创建数据库用户(角色) 和 数据库实例</h2><blockquote>
<p>事实上, postgres有一个默认的用户就是当前Mac OSX的用户, 该用户是一个超级用户, 拥有下面的权限:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List of roles</span><br><span class="line"> Role name |                   Attributes                   | Member of</span><br><span class="line"> -----------+------------------------------------------------+-----------</span><br><span class="line">  daniel    | Superuser, Create role, Create DB, Replication | &#123;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从安全的角度考虑, 我们可以创建一个新的普通用户, 只赋予其必要的权限:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ createuser -d -r -l user1</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>-d</code> 表示允许该用户创建数据库, <code>-r</code> 表示可以创建新的用户(角色), <code>-l</code> 表示允许登录, 具体帮助请查阅帮助文档<code>man createuser</code></p>
<p>这时候如果查看数据库用户, 发现多了一个user1的用户以及它的相关的权限:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List of roles</span><br><span class="line"> Role name |                   Attributes                   | Member of</span><br><span class="line"> -----------+------------------------------------------------+-----------</span><br><span class="line">  daniel    | Superuser, Create role, Create DB, Replication | &#123;&#125;</span><br><span class="line">   user1     | Create role, Create DB                         | &#123;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其实这里面用户和角色是等价的, 可能说成角色更准确一些.<br>这里在多提一个内容: 原视频中是采用命令行创建数据库的, 包括相应的编码, 以及所属角色. 使用的命令时<code>createdb</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">createdb -Ouser1 -Eutf8 emptyapp_development</span><br><span class="line">createdb -Ouser1 -Eutf8 emptyapp_test</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后可以访问数据库:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ psql -U user1 emptyapp_development</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样做固然可以, 但是如果要和Rails集成, 那么直接配置Rails中<code>config/database.yml</code>就可以了, 然后rake命令什么都帮你做完了, 下面就介绍一下具体方法:</p>
</blockquote>
<h2 id="Postgres-和-Rails-集成"><a href="#Postgres-和-Rails-集成" class="headerlink" title="Postgres 和 Rails 集成"></a>Postgres 和 Rails 集成</h2><blockquote>
<p>首先需要安装<code>pg</code> gem :</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install pg -- --with-pg-config=/usr/local/bin/pg_config</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后创建一个默认数据库为Postgres的数据库:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rails new emptyapp --database=postgresql</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后我们scaffold 一个Post:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$  rails g scaffold Post title author body:text</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后修改<code>config/database.yml</code>, 添加数据库信息:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">default: &amp;default</span><br><span class="line">  adapter: postgresql</span><br><span class="line">  encoding: unicode</span><br><span class="line">  pool: 5</span><br><span class="line">  username: user1</span><br><span class="line">  password:</span><br><span class="line"></span><br><span class="line">development:</span><br><span class="line">  &lt;&lt;: *default</span><br><span class="line">  database: emptyapp_development1</span><br><span class="line"></span><br><span class="line">test:</span><br><span class="line">  &lt;&lt;: *default</span><br><span class="line">  database: emptyapp_test1</span><br><span class="line"></span><br><span class="line">production:</span><br><span class="line">  &lt;&lt;: *default</span><br><span class="line">  database: emptyapp_production</span><br><span class="line">  username: emptyapp</span><br><span class="line">  password: &lt;%= ENV[&apos;EMPTYAPP_DATABASE_PASSWORD&apos;] %&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后使用rake创建数据库, 并migrate</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rake db:create</span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后启动服务器, 插几条数据, 再查看一下数据库, 测试一下</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/18/ruby-concurrency-explained/" itemprop="url">
                  Ruby concurrency explained
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-01-18T08:37:39+08:00" content="2015-01-18">
              2015-01-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Ruby/" itemprop="url" rel="index">
                    <span itemprop="name">Ruby</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>这两天在看 ruby 并发的内容, 发现自身存在的很多问题, 比如概念混淆不清, 以前学习 java 语言的适合这些内容都被我忽略了, 现在看看还是很有意思的. 也许是 ruby 语言简练语法的功劳. 的确有些难度, 我不能再回避这些问题了. </p>
<p>我找了一个大牛的文章, 然后翻译过来, 看看自己对于这些内容的理解是否正确.</p>
<p>[原文地址:] (<a href="http://merbist.com/2011/02/22/concurrency-in-ruby-explained/" target="_blank" rel="external">http://merbist.com/2011/02/22/concurrency-in-ruby-explained/</a>) </p>
</blockquote>
<h2 id="译文"><a href="#译文" class="headerlink" title="译文"></a>译文</h2><blockquote>
<p>并发当然不是一个新的问题, 但是当机器处理器多于一个核心并且 web 流量急剧增加时,  就需要注意这个问题了. 一些新的技术站出来说它们更好因为可以将并发处理得更好.</p>
<p>为了帮助理解, 你可以把并发想象成多任务. 当人们说他们想要并发的时候, 他们的意思是想让代码同时做多件事情. 当你使用电脑时, 你不会希望在上网和听音乐直接来回切换(要买只能上网, 要么只能听音乐). 你更希望可以同时做两件事. 对于你的代码来说也是一样的. 当你运行一个 web 服务器时, 你并不希望它一次只能处理一个请求. 这篇文章的目的尽可能简单地来解释 ruby 中并发的概念, 为什么并发是个复杂的问题, 最后使用不同的办法来实现办法.</p>
<p>首先, 你还不熟悉并发, 花一分钟时间看看[维基百科的这篇文章] (<a href="http://en.wikipedia.org/wiki/Concurrency_%28computer_science%29" target="_blank" rel="external">http://en.wikipedia.org/wiki/Concurrency_%28computer_science%29</a>), 对其有一个整体理解. 但是现在, 你应该已经注意到了, 我上面的例子更多还是关于平行编程, 但是一会儿会回来的.</p>
<blockquote>
<p>对于并发来说的核心问题”如何来增加吞吐量”.</p>
</blockquote>
<p>我们想让代码运动得更好, 想让代码在更少的时间内做得更多. 我们看下两个简单具体的例子来描述并发. </p>
<p>第一个, 假设你正在写一个 Twitter 客户度,  在更新微博时, 你可能想让用户拉动滚动条查看微博. 换句话说, 当你的代码正在等待来自于 Twitter 的 API 响应时, 你不想阻断主循环打断用户的交互. 所以你就需要一种很普遍的解决方案就是多线程. 线程是同一内存环境的基本的程序. 我们需要用一个线程跑主循环, 另一个线程来处理远程 API 请求. 这两个线程共享一块内存所以当 Twitter API 线程完成取数据后就可以更新然后显示了. 幸运的是, 这已经被异步 API 透明化处理了(由操作系统或者编程语言的标准库提供), 避免了阻塞主线程.</p>
<p>第二个例子是 webserver. 假设你想跑一个 Rails 应用. 你希望看到很多流量. 很可能1 QPS(请求/秒). 你测试了你的应用发现平均响应时间大概是 100ms. 因此你的应用可以处理10 QPS, 使用单进程.</p>
<p>但是如果你的应用增长到每秒多于10次请求了, 会发生什么? 很简单, 请求会被备份, 花更长的时间, 直到它们中一些开始超时. 这就是你需要提高你应用并发能力的原因了. 有几种方法来做这件事. 很多人对一些不同的解决方案强烈反对但是他们经常忘了解释为什么不喜欢某些方案而更偏爱一些方案的原因. 你可能听过一些人的结论:Rails 无法伸缩, 你只能从 JRuby 中得到并行, 线程差劲, 只有线程才能实现并发, 我们应该切换到 Erlang/Node.js/Scala, 应该使用 fiber, 多加几台服务器, forking&gt;threading. 由于很多人在会经常在 Twitter 上, 一些论坛上, 个人博客上讨论, 你可能就相信了. 但是, 你真的明白为什么人们那样说, 你确定他们就是对的吗? </p>
<p>事实上, 原因很复杂, 但是也并没那么复杂.</p>
<p>需要牢记一点, 并发模型定义在了编程语言中. 拿 java 来说, 线程是普遍的解决方法, 如果你想要让你的 java 应用并发性更强, 只需要运行每个请求在它自己的线程上. 对于 PHP, 没有线程, 而是你在每个请求上开始了一个新的进程. 两者有利有弊, java 线程化的方法的好处是内存在两个线程间共享, 这样就节约了大量的内存空间, 通过共享内存两线程之间可以很容易地进行通讯. PHP 的好处是你不需要担心锁, 死锁, 线程安全代码和多线程背后的混乱.</p>
<p>说起来很简单, 但你可能想知道为什么 PHP 没有线程, 为什么 java 开发者不开启多进程. 答案可能关系到语言的设计初衷. PHP 被设计用于web, 和短期存活的进程. PHP 代码应该很快去加载不使用太多的内存. java 代码启动更慢, 再到趋于稳定运行, 它通常会消耗很多内存. 最后, java 不是为了 Internet 设计的. 其他编程语言如 Erlang 和 Scala 使用第3种方式: 参与者模式(the actor model). 参与者模式有点像2者的混合, 不同在于参与者像不共享相同内存环境的线程.参与者之间的通讯是通过交换信息来完成的, 确保每个参与者处理自己的状态, 这样避免了数据损坏(两个线程可能会修改同时修改相同的数据, 但是一个参与者在同一时间不会接收两条消息).</p>
<p>那么 ruby 是如何处理的呢? ruby 开发者应该使用线程, 多进程还是参与者模式或者其他的什么? 答案是” yes”.</p>
</blockquote>
<h3 id="Threads"><a href="#Threads" class="headerlink" title="Threads"></a>Threads</h3><blockquote>
<p>从 ruby1.9开始, ruby 已经有本地线程了(在这之前 ruby 使用的是<code>green threads</code>). 所以理论上来讲, 如果我们愿意, 可以想 java 开发者那样在任何地方使用线程. 但问题是ruby 像 Python 一样使用”全局编译器锁(Global Interpreter Lock (GIL))”, 这是一种锁机制可以保护你数据的完整. 它只允许数据同时被一个线程修改, 因此, 不会让别的线程过来损坏数据 但是这也不会让这些线程真正的并发运行. 这就是人们经常说 Ruby 和 Python 不能并发的原因了.</p>
<p>但是这些人并没有提及 GIL 使单线程程序运行更快, 多线程程序更加容易开发因为数据结构更加安全, 许多 C 的扩展不是线程安全的也没有 GIL, 这些 C 扩展就会出现问题. 这些争论不会说服每个人, 这就是你为什么听到一些人说你应该看看其他 没有 GIL 的 Ruby 实现, 比如 JRuby, Rubinius(hydra branch)或者 MacRuby(Rubinius 和 MacRuby 也提供其他并发方法). 如果你在用一个没有 GIL 的实现, 在 Ruby 中使用多线程就会和在 java 中一样有好处也有坏处. 也就是说, 你必须要处理好多线程带来的噩梦: 确定你数据是安全的, 不会被锁, 检查代码, 你的lib, plugin和 gem 是否线程安全. 并且, 跑太多的线程会影响性能, 因为你的操作系统没有足够的资源来分配, 可能会死掉, 由于把时间花费在环境的切换上. 这就要取决于你了, 是否值得为你的项目这么做.</p>
</blockquote>
<h3 id="Multiple-processes-amp-forking"><a href="#Multiple-processes-amp-forking" class="headerlink" title="Multiple processes &amp; forking"></a>Multiple processes &amp; forking</h3><blockquote>
<p>这是 Ruby 和 Python 中最常见实现并发的手段了. 因为默认的语言不能真正实现并发或者因为你想避免多线程编程带来的挑战, 你可能会开启更多的进程. 只要你不想在两个进程之间共享状态, 那么这就很简单了. 如果你想要共享状态, 你可能需要 DRb, 一种类似于RabbitMQ 的消息总线, 或者一种共享的数据存储像 memcached 或者一个数据库. 但是这将会占用你更多的内存. 如果你想跑5个 rails 进程, 你的应用需要100Mb, 你现在就得准备500Mb, 靠, 这是多大的内存开销! rails 的一些服务器比如 Mongrel 就是这么做的. 现在一些别的服务器像Passenger和 Unicorn 使用 unix forking 作为一种变通. forking 的优点是在 UNIX 系统中实现即写即拷语义, 具体说就是我们创建了主进程的一个新副本, 但是它们共享相同的物理内存. 但是, 每个进程可以修改其自己的内存而不影响到其他的进程. 所以现在, Passenger 能在一个进程中载入你100mb 的 rails app, 然后把这个进程做5个分支, 那么一共的台面空间只会比100mb 多一点而已, 你却能处理5倍的并发请求.注意, 如果你正在在你的请求处理代码(读 controller/view) 分配内存, 你总体的内存会增加但是你还是可以在用光内存之前运行许多的进程.  这个办法还是很吸引人的, 因为它既简单有安全. 如果分支进程运行有问题或者内存泄露, 只需要摧毁它然后从主进程上再创建一个分支即可. 注意这种做法也被用于Resque, Github 提供的异步处理解决方案.</p>
<p>如果你想要复制出像 webserver 注意完全的进程这种办法还是不错的, 然而, 当你只是想执行一些在后台运行的代码那么这就显得没意思了. Resque 这么做因为本质上, 异步任务可以产生奇怪的结果, 内存溢出和假死. 处理分支允许对进程有一个外部的控制, 分支的花费不是什么大事因为我们已经处于异步处理方法之中了. </p>
</blockquote>
<h3 id="Actors-Fibers"><a href="#Actors-Fibers" class="headerlink" title="Actors/Fibers"></a>Actors/Fibers</h3><blockquote>
<p>刚才我们提了一下”参与者模型( Actor Model )”. Ruby1.9之后, 开发者有了一种新的类型的轻量级线程叫做 “Fibers”. Fibers 不是 actor, Ruby 没有本地的 actor model 实现, 但是一些人还是写了一些在 fibers 上层actor的 lib. fiber 像是简化过的线程, 被程序员操作而不是被虚拟机. fiber像 block 可以被暂停并且还可以从外部恢复到自己内部. 相比于线程, 它运行更快使用更少内存, [这篇文章有对比] (<a href="http://oldmoe.blogspot.jp/2008/08/ruby-fibers-vs-ruby-threads.html" target="_blank" rel="external">http://oldmoe.blogspot.jp/2008/08/ruby-fibers-vs-ruby-threads.html</a>) . 可是由于 GIL 的原因, 你还是不能真正通过线程跑多个并发的 fiber, 如果你想使用多 CPU 核心, 你得在多线程上运行 fiber. 那么 fiber 如何并发呢? 答案是 fiber 是更大的解决方案的一部分. fiber 允许开发者手动来控制并发代码时序安排( scheduling ), 同时也要在 fiber 中有安排自身的代码. 说这个方案大是因为你现在可以包装进来的 web 请求 在其自己的 fiber 中, 当处理完成后告诉它发一个响应回去. 同时, 你可以继续下一次请求. 无论什么时候fiber 中的一个请求完成, 它会自动继续重复自身并返回.听起来不错, 但是唯一的问题是如果你在 fiber 中阻塞 IO, 那么整个的线程就会被阻塞, 其他的 fiber 也不会运行. 阻塞操作是指比如数据库或者缓存查询, http 请求… 基本上可能你从 controller 上上引起的. 好消息是这个问题已经可以通过避免阻塞 IO 来解决. 那么看看是如何做的吧.</p>
</blockquote>
<h3 id="Non-blocking-IOs-Reactors-pattern"><a href="#Non-blocking-IOs-Reactors-pattern" class="headerlink" title="Non blocking IOs/Reactors pattern"></a>Non blocking IOs/Reactors pattern</h3><blockquote>
<p>反应器模式( reactor pattern ) 非常容易理解. 阻塞 IO 调用这样重量级的工作被委托给了外部服务( reactor ), 可以接收并发请求. 根据接收到的响应的类型, 服务处理器( reactor ) 被给与了一个回调方法, 被异步触发.  我用类比的方式来看看是否可以将这个问题解释的更明了. 假如 你问别人一个很难的问题, 这个人要花一点时间来回复, 但是他的答案将决定你是否举起一面旗. 你有两个选择, 选择等待响应, 然后决定举起更具响应的旗, 或者你旗的逻辑已被定义, 然后你告诉这个人该做什么根据他的答案然后我可以继续而不需要担心等待答案. 第二种方法就是反应器模式. 很明显有一点更加复杂但是关键是允许你的代码定义了方法或者 block 基于将来过来的响应被调用.</p>
<p>在单线程 web 服务器中, 这是很重要的. 当一个请求进来, 你的代码做了一个 db 查询, 那么你就阻塞了任何其他被处理的请求. 为了避免这种情况, 我们可以将请求包装在 fiber 中, 触发异步数据库调用, 然后暂停 fiber, 这样另一个请求可以得到处理, 因为我们正在等待数据库.数据库查询回来, 它会唤醒 fiber, 然后再把响应发回客户端. 技术上来讲, 服务器还是一次发送一个响应, 但是现在 fibers 可以平行运行, 不会因为 IO 操作来阻塞主线程(因为IO 操作委托给了反应器)</p>
<p>这种方法被用于 Twisted, EventMachine 和 Node.js. Ruby 开发者可以使用 EventMachine 或者基于它的服务器向 Thin 和 EM clients/drivers 来实现 非阻塞式异步调用. 再加入 Fiber 就可以得到 Ruby 版的并发了. 需要小心, 使用 Thin, 非阻塞式驱动和  线程安全模式下的Rails并不意味着你就是在并发请求. Thin/EM 只会使用一个线程, 当我们正在等待的时候你就应该让它知道可以处理下一次请求了. 使用推迟响应, 让反应器知道可以实现.</p>
<p>正在办法明显的问题是改变了你写代码的方式. 你需要建立很多回调, 理解 fiber 语法, 并且使用可推迟响应, 我必须承认这很痛苦. 如果你看一些 node.js 的代码你就会发现这不是一种很优雅的办法. 好消息是这种处理可以被包装起来, 在包装下, 尽管在处理异步你的代码可以像是写同步时一样. 如果没有代码来解释会很复杂, 所以这个问题以后再说.</p>
</blockquote>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><blockquote>
<p>Ruby 中的高并发是可行的, 也被次使用. 可是, 还是可以更简单些, Ruby1.9为我们提供了 fiber, 可以更加细粒度控制并发, 结合非阻塞 IO, 高并发可以实现. 还有一种简单的方法就是分支出一个正在运行的进程来增加处理的能力. 但是在这个争论的背后是 Ruby 中的全局解释器锁将来会如何. 我们应该把它移除来提高并发能力而把精力花费在处理一些主要的线程问题上, 不安全的 C 扩张等等问题上吗? 两者选其一, Ruby 的开发者似乎也是这么认为的, 但是 Rails还在使用排它锁, 只允许一次被处理一个, 许多使用 Rails 不写线程安全的代码, 许多插件也不是线程安全的. 并发的将来会不会更像是 libdispatch/GCD , 线程只会被内核处理, 开发者只去处理更简单/安全的 API 呢?</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/10/ruby-2-0-works-hard-so-you-can-be-lazy-tranlation/" itemprop="url">
                  Ruby 2.0 Works Hard So You Can Be Lazy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-01-10T13:45:27+08:00" content="2015-01-10">
              2015-01-10
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p># </p>
<blockquote>
<p>原文地址: [click] (<a href="http://patshaughnessy.net/2013/4/3/ruby-2-0-works-hard-so-you-can-be-lazy" target="_blank" rel="external">http://patshaughnessy.net/2013/4/3/ruby-2-0-works-hard-so-you-can-be-lazy</a>)</p>
</blockquote>
<p><a href="https://github.com/DanielZhangQingLong/programming_ruby_review/blob/master/chapter4/ruby_2.0_works_hard_so_you_can_be_lazy_tranlation.md" target="_blank" rel="external"><strong><em>请点击这里查看</em></strong></a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/10/closure-explanations/" itemprop="url">
                  closure_explanations 闭包--- 简明解释(使用 Ruby)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-01-10T13:36:31+08:00" content="2015-01-10">
              2015-01-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Ruby/" itemprop="url" rel="index">
                    <span itemprop="name">Ruby</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="译文"><a href="#译文" class="headerlink" title="译文"></a>译文</h3><blockquote>
<p>引用自 <a href="http://www.skorks.com/2010/05/closures-a-simple-explanation-using-ruby/" target="_blank" rel="external">CLICK</a> May 18, 2010  By Alan Skorkin</p>
<p>有技术不错的程序员并不知道闭包的概念. 我没有在这个问题上进行统计, 只是根据经验凭直觉说的. 但是, 这种现象也是理所当然的, 因为目前最流行的语言比如 java, c++ 并不支持闭包. 一个程序员主要使用的语言不支持一个概念, 那么这个概念也不会被放大他日程优先级最高的位置, 甚至根本就不知道这个概念.<br>我个人比较赞成优秀的开发者应该尽量去多了解几门语言, 也有很多语言支持闭包, 你也很有可能陷入某个问题上. 这体现了大多数开发者学习一门新的语言时, 完全走错了方向. 有时候你听到有人说他会一大堆语言时, 他很可能是在夸大事实.下面就来讨论一下闭包(个人觉得这里有点攻击性, 不友好, 不符合社会主义核心价值观 ^_^)</p>
<p>你很可能上大学的时候就遇到过闭包, 但是你不记得了. 大概过去10年里, 软件相关的课程逐渐指出像闭包这样的概念不被强调, 它主要是一个函数的概念, 函数式编程语言已经过时, Java 成为主流. 他们试图让学位更加工业化结果导致了一代程序员成了”跛子”, 尽管这对他们来说没什么. 你自认为这种教育是正确的, 实际上你只有去信任, 因为你知道这种信任是错误的时候你也无能为力. 那我来说, 在我上学期间, 第一年学习 java, 第二年学习 C. 第一次接触函数式编程是学习人工智能的课程, 我学习了一下Lisp 语言以及一整套其他的概念. 不必说, 在这么课程中函数式编程不是被放在一个重要的位置上的. 许多人都很困惑. 我们当然或多或少地接触了一些闭包的知识, 但是谁有时间去仔细考虑呢? 好不容易花两年时间熟悉一门语言, 大多数人都不会去接收这种风格迥异语言. 参加工作以后, 闭包和其他一些函数式编程的概念早就忘在脑后了. 再次学习这些东西花了我很长的时间, 作为一个开发者,这些东西在我上大学受基础教育的适合就应该被掌握. 不过我那时没有学这些, 现在就要补回来了.</p>
<p>讽刺的是 java 又要恢复函数式编程的风格了. 完全函数式编程语言( Clojure ) 和 交替性函数式编程语言( Scala ) 所以概念有开始变得有意义了. 但是过去这些年对这些概念的损害已经造成了影响并且这种影响还会继续. 学术界也不急于调整. 你不可能再对函数式概念毫不知情了, 即使是 javascript, 这种 web 2.0让我们深恶痛绝的语言–是函数式的杂交产物. 开发者开始热衷于这些概念, 好像他们的这些观点就可以代表这些概念:</p>
<p>在计算机科学中, 闭包是first-class function ,并且 把自由的变量绑定到语法环境里. </p>
<p>这里 first-class 我在维基百科上找了下面的一句解释:<br>supports passing functions as arguments to other functions, returning them as the values from other functions, and assigning them to variables or storing them in data structures.</p>
<p>这到底是什么意思? 维基百科的解释还好些, 但是少了一些函数式的上下文, 还是很难说得通. 你也许听到这样的解释:</p>
<blockquote>
<p>闭包是一个函数, 据说是关闭的, 是自由变量. </p>
</blockquote>
<p>真的吗? closure 关闭, 为什么. 这么说直接跳过了问题. 一般下个问题一定是来争论使问题明朗. 但是想上面的解释还不如不解释, 它只会让别人觉得很时髦, 没有实际意义. 但是, 你想向某人解释什么事物时, 自己要明白, 而不是自欺欺人. 现在让我来解释一下吧. (这部分似乎用处不大, 而且很批判, 我不是很喜欢)</p>
</blockquote>
<h2 id="简单地解释概念"><a href="#简单地解释概念" class="headerlink" title="简单地解释概念"></a>简单地解释概念</h2><blockquote>
<p>闭包基本是一个 函数/方法, 具有下列属性:</p>
</blockquote>
<ul>
<li>你可以向传递对象那样传递它, 以后调用</li>
<li>当这个函数创建的时候, 它记住了该环境下所有的变量的值. 被调用时, 它可以一直访问这些变量, 甚至这些变量已处于环境的外部.</li>
</ul>
<blockquote>
<p>你可能猜到, 你不会免费得到闭包, 它需要被语言支持. 而且语言要支持 first-class functions. first-class function 指函数可以看成对象, 你可以把它存入集合, 也可以作为参数传递给其他函数. 正如我所说, 可以被传递是闭包的首要特性.</p>
<p>一个普通的函数被定义在一个指定的环境中(比如说 class) , 但是它只能在这个 class 中被调用. 这个方法可以访问到这个 class 范围内定义的全部变量, 比如说这个函数可以接受一些参数, 或者函数内部可以使用类变量. 而闭包可以在一个 scope(如 class) 被定义, 而在完全不同的 scope 中被调用(因为在调用之前可以将其作为传递), 因此, 当闭包创建时, 它保留了scope 内的所有变量的值.  闭包 被调用时,就算是变量已经不在那个 scope 了, 但是在闭包内部这些变量依然还在. 换言之, 被定义时, 闭包保留了其语法环境内所有的东西(knowledge 不知道咋翻译).</p>
</blockquote>
<h2 id="使用-Ruby-举例说明"><a href="#使用-Ruby-举例说明" class="headerlink" title="使用 Ruby 举例说明"></a>使用 Ruby 举例说明</h2><blockquote>
<p>没有例子就等于完全没有解释, 例子才能使这些逐渐被理解. 我要用 Ruby 语言, 因为它支持闭包.<br>在 Ruby 中, 闭包是通过 proc 和 lambda 支持的. 它们非常相似, 但是有一些微妙的区别. 我们来创建一个闭包来看看实现上面的两个属性的:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeClass</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(value1)</span></span></span><br><span class="line">    @value1 = value1</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">value_printer</span><span class="params">(value2)</span></span></span><br><span class="line">    lambda &#123; puts <span class="string">"Value1: <span class="subst">#&#123;@value1&#125;</span>, Value2: <span class="subst">#&#123;value2&#125;</span>"</span> &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">caller</span><span class="params">(some_closure)</span></span></span><br><span class="line">  some_closure.call</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">some_class = SomeClass.new(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">printer = some_class.value_printer(<span class="string">"some value"</span>)</span><br><span class="line"></span><br><span class="line">caller(printer)</span><br></pre></td></tr></table></figure>
<blockquote>
<p> 执行后输出了下面的内容:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">Value1:</span> <span class="number">5</span>, <span class="symbol">Value2:</span> some value</span><br></pre></td></tr></table></figure>
<blockquote>
<p>value_printer 创建了一个闭包, 通过使用 lambda 结构, 然后返回闭包. 然后把该闭包赋值给一个变量, 传给另外一个函数, 这个函数中调用了这个闭包. 这就满足了闭包的第一个属性–可传递.</p>
<p>同时也需要注意调用闭包的时候, 打印出来了 “5”和”some value” , 在程序剩下的部分调用闭包的时候,  @value1 和 value2 都已经在 scope(class) 之外了, 在闭包的内部这些变量还在 scope 内的, 因为闭包在被定义的时候就保留了 scope 内所有变量的状态. 因此, lambda 满足闭包的第二个属性.</p>
<p>当然, 我们可以再深入些, 当闭包被定义的时候, 它如何保留了 scope 内的变量? 这个必须要由语言支持, 有两只途径实现:</p>
<ol>
<li>闭包创建了它所需要的所有变量的一个备份, 因此是这些副本随着闭包传递.</li>
<li>闭包 延长了它所需要的所有变量的生命周期. 没有复制变量, 而是保留了它们的引用, 而且变量本身不可以被垃圾回收器回收掉.</li>
</ol>
<p>如果语言支持第一种方式, 那么如果我们创建两个或者更多闭包来访问相同的变量, 每个闭包被调用时都有自己单独对变量的拷贝. 如果语言支持第二中方式, 所有的闭包都引用同一个变量, 它们实际上处理的就是同一变量. Ruby 就是这么做的.看下面的例子:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeClass</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(value1)</span></span></span><br><span class="line">    @value1 = value1</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">value_incrementer</span></span></span><br><span class="line">    lambda &#123; @value1 += <span class="number">1</span> &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">value_printer</span></span></span><br><span class="line">    lambda &#123; puts <span class="string">"value: <span class="subst">#&#123; @value1 &#125;</span>"</span>&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">some_class = SomeClass.new(<span class="number">2</span>)</span><br><span class="line">incrementer_closure = some_class.value_incrementer</span><br><span class="line">printer_closure = some_class.value_printer</span><br><span class="line"><span class="number">3</span>.times <span class="keyword">do</span> </span><br><span class="line">  incrementer_closure.call</span><br><span class="line">  printer_closure.call</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">运行结果: </span><br><span class="line"> <span class="comment">#=&gt; </span></span><br><span class="line"><span class="symbol">value:</span> <span class="number">3</span></span><br><span class="line"><span class="symbol">value:</span> <span class="number">4</span></span><br><span class="line"><span class="symbol">value:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这一次我们创建了两个闭包, 一个做增加 value 的 一个做打印.  我们运行3次闭包, 发现: 每一次迭代2个闭包操作的都是同一个变量, 因为值在增长. 如果 Ruby 要是用复制变量的方法来实现闭包的话,我们将会看到打印的结果都是2, 打印的闭包操作的变量是它单独的拷贝.</p>
</blockquote>
<h3 id="为什么闭包有用"><a href="#为什么闭包有用" class="headerlink" title="为什么闭包有用?"></a>为什么闭包有用?</h3><blockquote>
<p>既然我们对于闭包的理解更好了一些, 那么闭包可以干什么呢? 嗯, 这要看你用的是什么语言了. 在函数式编程语言中它又很大的作用. 函数式编程语言内部是无状态的, 但是我们可以通过使用闭包来持久化一些状态,只要我们的闭包还在.(比如: 如果闭包改变了一个变量的值, 那么直到下次被调用时闭包会一直保持这个值). 我希望闭包的用途是不言而喻的. </p>
<p>像闭包以及其他几种结构的存在, 让函数式编程语言在表达逻辑方面更加简明, 你可以写更少的代码做更多的事情.</p>
<p>非函数式编程语言就显得没那么简明了. 表示状态是命令式编程语言的强项. 唯一让闭包引人注目的就是你可以用它们写出更加简明的代码而且还利用了命令式的风格. 闭包的存在就是可以使用像 Ruby 这样的语言用更少的代码做更多的事情, 而 java 就不能(不支持闭包).</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/04/23/git-contribution/" itemprop="url">
                  github的多人协作(转载)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-04-23T20:03:06+08:00" content="2014-04-23">
              2014-04-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>github上你可以用别人的现成的代码 直接 git clone 即可</li>
<li>然后你也想改代码或者贡献代码咋办？</li>
</ol>
<h2 id="Fork"><a href="#Fork" class="headerlink" title="Fork"></a>Fork</h2><blockquote>
<p>从别人的项目中fork一个到你自己的仓库 这个时候这个仓库就是你的了，要删除这个仓库到设置-admin 那里，像你删除你自己创建的repo一样删除，（因为这个库就是你的了，你现在可以任意修改这个库，除非你pull request被接受否则你 不会对原作者的库产生任何影响）</p>
<p>比如osteach账号下有个osteach.github.com的库 这个项目的地址是<a href="https://github.com/osteach/osteach.github.com" target="_blank" rel="external">https://github.com/osteach/osteach.github.com</a></p>
<p>这时候我（suziewong）想贡献代码了。fork之 fork之后，你的个人仓库就多了这个库 <a href="https://github.com/suziewong/osteach.github.com" target="_blank" rel="external">https://github.com/suziewong/osteach.github.com</a></p>
</blockquote>
<h2 id="开发并且提交代码"><a href="#开发并且提交代码" class="headerlink" title="开发并且提交代码"></a>开发并且提交代码</h2><h3 id="clone"><a href="#clone" class="headerlink" title="clone"></a>clone</h3><blockquote>
<p>首先要从github上下载代码到本地，你需要执行如下命令：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/suziewong/osteach.github.com.git </span><br><span class="line">cd osteach.github.com</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后代码到本地里了，你就可以各种修改 add commit 了</p>
</blockquote>
<h3 id="commit"><a href="#commit" class="headerlink" title="commit"></a>commit</h3><blockquote>
<p>当你修改代码之后，需要commit到本地仓库，执行的命令如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git add xx</span><br><span class="line">git commit  -m &apos;修改原因，相关说明信息&apos;</span><br></pre></td></tr></table></figure>
<h3 id="push"><a href="#push" class="headerlink" title="push"></a>push</h3><blockquote>
<p>执行git commit之后，只是提交到了本机的仓库，而不是github上你账号的仓库。你需要执行push命令，把commit提交到服务器。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这里你可以直接git push 木有问题直接到远程默认仓库，当然remote add 也木有问题，因为和操纵自己的库没有任何区别</span><br><span class="line">git push</span><br><span class="line">这里的git push  指的是push 到suziewong/osteach.github.com 的默认仓库（master）</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里有重点</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这里你如果 remote add osteach osteach/osteach.github.com.git</span><br><span class="line">好吧，你 </span><br><span class="line">git push osteach master 之类的都是没用的</span><br><span class="line">因为你没有权限！没有权限修改别人(osteach)的库!</span><br></pre></td></tr></table></figure>
<h2 id="上游仓库"><a href="#上游仓库" class="headerlink" title="上游仓库"></a>上游仓库</h2><h3 id="添加远程仓库"><a href="#添加远程仓库" class="headerlink" title="添加远程仓库"></a>添加远程仓库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin https://github.com/suziewong/osteach.github.com.git</span><br></pre></td></tr></table></figure>
<h3 id="更新远程代码"><a href="#更新远程代码" class="headerlink" title="更新远程代码"></a>更新远程代码</h3><blockquote>
<p>好吧，这里得分2种情况</p>
</blockquote>
<ol>
<li>拉取自己的库的最新的代码到本地（这个其实和操纵自己的库没区别）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull</span><br></pre></td></tr></table></figure>
<ol>
<li>你正在开发，主作者【项目负责人】osteach也在开发，你当时fork的代码已经不是osteach的最新的代码了。 这时候的你对你的代码肯定没问题，但是pull request 就有可以会出错，因为你fork的repo和现在的osteach的repo已经不一样了。 这时候理论上osteach会close你的request，让你先pull osteach的最新代码。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote add osteach osteach/osteach.github.com.git</span><br><span class="line">git fetch osteach master:develop</span><br></pre></td></tr></table></figure>
<blockquote>
<p>自己merge代码 不和谐的地方，这里肯定不能git pull,会提示conflict 即代码是需要自己merge的</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">你修改代码后</span><br><span class="line"></span><br><span class="line">git add </span><br><span class="line">git commit</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后测试一下是不是已经拉取完成最新的了。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull osteach master</span><br></pre></td></tr></table></figure>
<blockquote>
<p>你就会发现原先的出错不见了，变成了<strong>everything update </strong><br>你就可以提交到自己的远程版本库了。 git push origin master<br>之后你再pull request，osteach那边就木有出现 不能 auto merge的情况了，然后osteach看你的代码给不给力， 给力就merge你的代码到他的主分支去了。</p>
</blockquote>
<h2 id="pull-request"><a href="#pull-request" class="headerlink" title="pull request"></a>pull request</h2><blockquote>
<p>登陆github，在你自己的账号中的仓库中点击pull request，就会要求你输入pull request的原因和详细信息，你确认之后。osteach的owner就会收到并且审查，审查通过就会合并到主干上。</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/default_avatar.jpg"
               alt="John Doe" />
          <p class="site-author-name" itemprop="name">John Doe</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">106</span>
              <span class="site-state-item-name">Artikel</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">Kategorien</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">104</span>
                <span class="site-state-item-name">Tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>

<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  

</body>
</html>
