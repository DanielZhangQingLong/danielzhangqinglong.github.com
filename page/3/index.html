<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'uSvyVbAJs-5jfXFawgQ3','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/19/rails-cache/" itemprop="url">
                  Fragment Caching
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-19T14:51:24+08:00" content="2015-03-19">
              2015-03-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails4中废除了Action Caching和Page Caching. 重点是Fragment Caching.</p>
<p>需要缓存最新创建的3个posts</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def show</span><br><span class="line">  # 首先查看缓存片段是否存在, 如果不存在, 再去执行数据库查询</span><br><span class="line">  unless fragment_exist? &apos;recent_post&apos;</span><br><span class="line">    Post.order(created_at: :desc).limit(3)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="使用cache-block包裹需要缓存的部分"><a href="#使用cache-block包裹需要缓存的部分" class="headerlink" title="使用cache block包裹需要缓存的部分:"></a>使用<code>cache</code> block包裹需要缓存的部分:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- cache(&apos;recent_post&apos;, skip_digest: true)</span><br><span class="line">  .recentPost</span><br><span class="line">    ul</span><br><span class="line">    - @recent_posts.each do |post|</span><br><span class="line">      li = link_to post.title, post</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong><em> 这里要尤其注意: <code>skip_digest: true</code> 指定了不使用rails为我们提供的digest作为key, 而是使用自定义的</em></strong></p>
</blockquote>
<h2 id="使缓存过期expire-fragment"><a href="#使缓存过期expire-fragment" class="headerlink" title="使缓存过期expire_fragment"></a>使缓存过期expire_fragment</h2><blockquote>
<p>使用方法 <code>expire_fragment(key)</code>, 比如我想在某个action中让recent_post过期, 那么我可以这样写:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Post#update</span><br><span class="line"></span><br><span class="line">def update</span><br><span class="line">  [...]</span><br><span class="line">  expire_fragment(&apos;recent_post&apos;)</span><br><span class="line">  [...]</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="使用对象作为cache-key"><a href="#使用对象作为cache-key" class="headerlink" title="使用对象作为cache key"></a>使用对象作为cache key</h2><blockquote>
<p>下面的代码会自动调用对象cache_key方法, 返回的值为<code>&quot;posts/1-20150319072533719235000&quot;</code>, 包含updated_at这个时间戳, 也就是说, 一旦对象发生变化, 这个缓存片段会自动过期, 非常酷<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- cache @post</span><br><span class="line">  # blah ...</span><br></pre></td></tr></table></figure></p>
<p>需要注意, 使用对象作为cache key, 其内部有动态的部分发生了变化, 不会自动变化, 比如说@post内部又迭代了评论(comment)</p>
<p>解决方法是在ActiveRecord(comment.rb) 的belongs_to: :post, 添加 <code>touch: true</code>, 其原理是,如果我修改了与post相关联的comment或者添加一个comment, 同时也会更新这个post的updated_at属性, 也就触发了cache_key.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Comment &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :post, touch: true</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="俄罗斯套娃缓存机制"><a href="#俄罗斯套娃缓存机制" class="headerlink" title="俄罗斯套娃缓存机制"></a>俄罗斯套娃缓存机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- cache(cache_key_for_products)</span><br><span class="line">  - Product.all.each  do |p|</span><br><span class="line">    - cache(p)</span><br><span class="line">      = link_to p.name, product_url(p)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>一个对象发生了变化, 不会影响其它对象的缓存, 其他对象还好从缓存中读取, 而变化的对象是从数据库中返回.</p>
</blockquote>
<h2 id="缓存是如何存储的"><a href="#缓存是如何存储的" class="headerlink" title="缓存是如何存储的"></a>缓存是如何存储的</h2><blockquote>
<p>进入Rails Console <code>rails c</code>. 缓存是以键值对的形式存取的:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># rails console</span><br><span class="line"></span><br><span class="line">Rails.cache.read(&apos;views/recent_post&apos;)</span><br><span class="line">=&gt; &quot;&lt;div class=\&quot;recentPost\&quot;&gt;\n  &lt;strong&gt; Recent Posts&lt;/strong&gt;\n  &lt;ul&gt;&lt;/ul&gt;\n  &lt;li&gt;\n    &lt;a href=\&quot;/posts/23\&quot;&gt;额  &lt;/a&gt;\n  &lt;/li&gt;\n  &lt;li&gt;\n    &lt;a href=\&quot;/posts/22\&quot;&gt;888一 4&lt;/a&gt;\n  &lt;/li&gt;\n  &lt;li&gt;\n    &lt;a href=\&quot;/posts/21\&quot;&gt;瞎忙活&lt;/a&gt;\n  &lt;/li&gt;\n  &lt;li&gt;\n    &lt;a href=\&quot;/posts/20\&quot;&gt;法拉利&lt;/a&gt;\n  &lt;/li&gt;\n  &lt;li&gt;\n    &lt;a href=\&quot;/posts/19\&quot;&gt;太阳额&lt;/a&gt;\n  &lt;/li&gt;\n&lt;/div&gt;&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>目前是存储于文件系统的</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Rails.cache.class</span><br><span class="line"># =&gt; ActiveSupport::Cache::FileStore</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果要使用memcached来存储, 需要修改配置文件 <code>config/environments/*.rb</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.cache_store = :mem_cache_store</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/19/rails-caching/" itemprop="url">
                  Rails中使用memcached内存缓存技术
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-19T08:47:56+08:00" content="2015-03-19">
              2015-03-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>介绍一下Rails如何使用memcached.<br>简单来说, 就是把<code>{}</code> 存入内存, 来获得更快的存取速度</p>
</blockquote>
<h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><blockquote>
<p>在development.rb文件中添加如下配置信息:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># config/environments/development.rb</span><br><span class="line"></span><br><span class="line"># 打开缓存</span><br><span class="line">config.action_controller.perform_caching = true</span><br><span class="line"></span><br><span class="line"># 使用memcached 作为存储</span><br><span class="line">config.cache_store = :dalli_store</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Rails4中需要安装dalli gem, 作为<code>mem_cache_store</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line">gem &apos;dalli&apos;</span><br><span class="line"></span><br><span class="line">$ bundle install</span><br></pre></td></tr></table></figure>
<blockquote>
<p>安装完毕</p>
</blockquote>
<h2 id="memcached的一些方法"><a href="#memcached的一些方法" class="headerlink" title="memcached的一些方法"></a>memcached的一些方法</h2><blockquote>
<p>接下来介绍memcached一些存取方法, 在console中操作</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ rails c</span><br><span class="line"></span><br><span class="line"># 存入</span><br><span class="line">Rails.cache.write(&apos;first&apos;, Post.first)</span><br><span class="line"></span><br><span class="line"># 取出</span><br><span class="line">Rails.cache.read(&apos;first&apos;)</span><br><span class="line"></span><br><span class="line"># 删除</span><br><span class="line">Rails.cache.delete(&apos;first&apos;)</span><br><span class="line"></span><br><span class="line"># 查看</span><br><span class="line">Rails.cache.exist?(&apos;first&apos;)</span><br><span class="line"></span><br><span class="line"># fetch: 检查key是否存在, 不存在, 把block里的结果作为value, 并返回结果. 如果存在, 就不去执行block的内容</span><br><span class="line"></span><br><span class="line">Rails.cache.fetch(&apos;last_post&apos;) &#123; Post.last &#125;</span><br><span class="line"># =&gt; blah</span><br><span class="line"></span><br><span class="line"># 还可以设定过期时间</span><br><span class="line">Rails.cache.fetch(&apos;time&apos;, expires_in: 4.seconds) &#123; Time.now &#125;</span><br></pre></td></tr></table></figure>
<h2 id="memcached的使用举例"><a href="#memcached的使用举例" class="headerlink" title="memcached的使用举例"></a>memcached的使用举例</h2><blockquote>
<p>没经过30分钟查询一次数据库获取最新的10个posts, 然后放入memcached中</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def self.recent</span><br><span class="line">  Rails.cache.fetch(&apos;recent_posts&apos;, expires_in: 30.minutes) do</span><br><span class="line">    self.order(created_at: :desc).limit(10)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>页面的fragment每隔30分钟 被render一次</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- cache(:recent_posts, expires_in: 30.minutes)</span><br></pre></td></tr></table></figure>
<h2 id="智能keys"><a href="#智能keys" class="headerlink" title="智能keys"></a>智能keys</h2><blockquote>
<p><code>memcached</code>内部会计算出一些不常用的key, 然后删除, 类似于垃圾回收, 所以程序员不需要手动去清理:</p>
<p>那么我可以使用对象来命名key, 比如:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- cache(post)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>rails约定其内部会调用对象的<code>cache_key</code>方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">post.cache_key</span><br><span class="line"></span><br><span class="line"># =&gt; posts/1-20150319075048049376000&quot;&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>对于这些方法, rails也有同样的约定: <code>write_fragment(post)</code>, <code>read_fragment(post)</code>, <code>fragment_exist?(post)</code>, <code>expire_fragment(post)</code></p>
<p>如果需要缓存符合对象比如: <code>cache([post, user])</code>, rails会将其分别调用cache_key方法, 然后拼凑起来:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">views/posts/1-20150319075048049376000/users/1-20150312111908608706000</span><br></pre></td></tr></table></figure>
<h2 id="什么时候使用memcached"><a href="#什么时候使用memcached" class="headerlink" title="什么时候使用memcached"></a>什么时候使用memcached</h2><blockquote>
<p>试想一个flickr图片网站, 用户可以在一个图片下添加评论, 如果评论增加或者删除, 就会触发key的变化:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- cache([photo, photo.version])</span><br><span class="line"></span><br><span class="line"># comment.rb</span><br><span class="line">class Comment &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :photo</span><br><span class="line"></span><br><span class="line">  after_save :increment_photo_version</span><br><span class="line">  after_destroy :increment_photo_version</span><br><span class="line"></span><br><span class="line">  def increment_photo_version</span><br><span class="line">    self.photo.increment(:version)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><strong><em> 如上面的例子, 一些内容不经常改变, 为了避免访问数据库, 我一次查询出来, 放到memcached中.</em></strong></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/18/activejob-delayjob/" itemprop="url">
                  Rails 中使用ActiveJob和DelayedJob进行后台处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-18T08:48:12+08:00" content="2015-03-18">
              2015-03-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在开发中, 往往需要涉及到发送邮件, 大量数据的导入导出, 这种耗时长的任务就需要进行后台处理. Rails中可以使用Sidekiq, Resque, Delayed Job 这些流行的gem来实现后台处理. Rails 4.2开始, 又加入了Active Job, 但需要和其他gem配合使用才可以进行后台任务处理.</p>
<p>本文是我从项目中抽取出来, 做了简化处理, 说明如何在Rails中使用这些gem, 让它们配合来处理后台任务</p>
</blockquote>
<h2 id="Delayed-Job的安装和使用"><a href="#Delayed-Job的安装和使用" class="headerlink" title="Delayed Job的安装和使用"></a>Delayed Job的安装和使用</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><blockquote>
<p>向Gemfile中加入如下的gem:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;delayed_job_active_record&apos;</span><br><span class="line"></span><br><span class="line">$ bundle install</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后我使用scaffold来创建一个letter model, 我要以邮件发送为例, 来说明问题(我并不会真的发送邮件):</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rails g scaffold Letter title description delivered_at:time</span><br><span class="line">$ rake db:migrate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>新建job管理表</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rails g delayed_job:active_record</span><br><span class="line">$ rake db:migrate</span><br></pre></td></tr></table></figure>
<h3 id="创建job"><a href="#创建job" class="headerlink" title="创建job"></a>创建job</h3><blockquote>
<p>通过使用<code>delay</code>方法, 可以实现后台处理:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 前台发送邮件</span><br><span class="line"></span><br><span class="line">@letter.deliver</span><br><span class="line"></span><br><span class="line"># 后台发送邮件</span><br><span class="line">@letter.delay.deliver</span><br></pre></td></tr></table></figure>
<blockquote>
<p>比如说, 我如果想下面这写代码, 那么就需要耗费用户不必要的等待时间:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/letters_controller.rb</span><br><span class="line">  def deliver</span><br><span class="line">    @letter = Letter.find(params[:id])</span><br><span class="line">    # 发送邮件</span><br><span class="line">    @letter.deliver</span><br><span class="line">    redirect_to letters_url, notice: &apos;Letter sent successfully!&apos;</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line"># app/models/letter.rb</span><br><span class="line"></span><br><span class="line">class Letter &lt; ActiveRecord::Base</span><br><span class="line">  def deliver</span><br><span class="line">    # 让现场sleep 10秒钟, 模拟延迟</span><br><span class="line">    sleep(10)</span><br><span class="line">    update(deliver_at: Time.zone.now)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在页面上等待了10秒钟, 然后才执行完毕, 这对于用户来说体验是很不好的.<br><img src="http://i3.tietuku.com/9e424f6b8f41a9b8.png"><br><img src="http://i3.tietuku.com/5d9272720896edc6.png"></p>
<p>但是如何使用<code>delay</code>方法, 页面马上就会跳转, 不会让用户等待, 发送的动作会交给另一个线程来做:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/letters_controller.rb</span><br><span class="line">@letter.delay.deliver</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启动worker线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rake jobs:work</span><br></pre></td></tr></table></figure></p>
<p>然后点击<code>Deliver</code>, 马上重定向页面, 由于我设定的让线程sleep 10秒, 所以Delivered_at 的值还是空的, 过一会我再刷新页面, 发现其被设定了, 表示我的邮件被发出了:</p>
<p><img src="http://i2.tietuku.com/852355042d0afb1b.png"><br><img src="http://i2.tietuku.com/e6a24317283d1c6a.png"></p>
</blockquote>
<h3 id="运行job-worker的启动-停止和重启"><a href="#运行job-worker的启动-停止和重启" class="headerlink" title="运行job(worker的启动, 停止和重启)"></a>运行job(worker的启动, 停止和重启)</h3><h4 id="开发模式"><a href="#开发模式" class="headerlink" title="开发模式"></a>开发模式</h4><blockquote>
<p><code>rake jobs:work</code> , 退出 ctrl C</p>
</blockquote>
<h4 id="开发模式-1"><a href="#开发模式-1" class="headerlink" title="开发模式"></a>开发模式</h4><blockquote>
<p>在开发模式下, 需要安装一个<code>daemons</code>的gem, 使用下面的命令:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 启动2个worker</span><br><span class="line">RAILS_ENV=production bin/delayed_job -n 2 start</span><br><span class="line"></span><br><span class="line"># 停止</span><br><span class="line">RAILS_ENV=production bin/delayed_job stop</span><br><span class="line"></span><br><span class="line"># 重启worker</span><br><span class="line">RAILS_ENV=production bin/delayed_job -n 2 restart</span><br></pre></td></tr></table></figure>
<h2 id="和ActiveJob一起使用"><a href="#和ActiveJob一起使用" class="headerlink" title="和ActiveJob一起使用"></a>和ActiveJob一起使用</h2><blockquote>
<p>ActiveJob的目的作于减少使用Sidekiq, Resque, Delayed Job这些gem的差异, 充当中间件的作用.</p>
</blockquote>
<h3 id="设定后台job适配器"><a href="#设定后台job适配器" class="headerlink" title="设定后台job适配器"></a>设定后台job适配器</h3><blockquote>
<p>在<code>application.rb</code>中设定Sidekiq, Resque, Delayed Job各自的内容, 这里以delayed_job为例, 需要指定<code>:delayed_job</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># config/application.rb</span><br><span class="line"></span><br><span class="line">module DelayedJobTest</span><br><span class="line">  class Application &lt; Rails::Application</span><br><span class="line">    [...]</span><br><span class="line"></span><br><span class="line">    config.active_job.queue_adapter = :delayed_job</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="创建job-1"><a href="#创建job-1" class="headerlink" title="创建job"></a>创建job</h3><blockquote>
<p>使用下面的命令来创建job</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rails g job news_deliver</span><br><span class="line">  invoke  test_unit</span><br><span class="line">  create    test/jobs/news_deliver_job_test.rb</span><br><span class="line">  create  app/jobs/news_deliver_job.rb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>按照规定, job的配置文件需要在job目录下, 继承<code>ActiveJob::Base</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># app/jobs/news_deliver_job.rb</span><br><span class="line">class NewsDeliverJob &lt; ActiveJob::Base</span><br><span class="line">  queue_as :default</span><br><span class="line"></span><br><span class="line">  def perform(*args)</span><br><span class="line">    # Do something later</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>queue_as</code>指定运行哪个队列, <code>perform</code>方法来指定需要执行的job: 上一节的例子可以改写成这样:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class NewsDeliverJob &lt; ActiveJob::Base</span><br><span class="line">  queue_as :default</span><br><span class="line">  </span><br><span class="line">  def perform(letter_id)</span><br><span class="line">    Letter.find(letter_id).deliver</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># Controller的方法中</span><br><span class="line"></span><br><span class="line">class LettersController &lt; ApplicationController</span><br><span class="line">  [...]</span><br><span class="line">  </span><br><span class="line">  def deliver</span><br><span class="line">    NewsDeliverJob.perform_later(params[:id])</span><br><span class="line">    redirect_to letters_url, notice: &quot;Sent!&quot;</span><br><span class="line">  end</span><br><span class="line">  [...]</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 设定具体的执行时间</span><br><span class="line">NewsDeliverJob.set(wait_until: Date.tomorrow.noon).perform_later(params[:id])</span><br><span class="line">NewsDeliverJob.set(wait: 1.week).perform_later(params[:id])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启动: <code>rake jobs:work</code></p>
</blockquote>
<h3 id="ActiveJob异常的处理"><a href="#ActiveJob异常的处理" class="headerlink" title="ActiveJob异常的处理"></a>ActiveJob异常的处理</h3><blockquote>
<p>job中发生了异常的话, 使用<code>rescue_from</code>处理:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class NewsDeliverJob &lt; ActiveJob::Base</span><br><span class="line">  queue_as :default</span><br><span class="line"></span><br><span class="line">  rescue_from(ActiveRecord::RecordNotFound) do |exception|</span><br><span class="line">    Rails.logger.error &quot;Letter Not FOUND&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/17/angular-examples/" itemprop="url">
                  看例子学习angular
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-17T18:43:32+08:00" content="2015-03-17">
              2015-03-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Angular/" itemprop="url" rel="index">
                    <span itemprop="name">Angular</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用Angular-当input-text-改变时-模板也作出相应的改变"><a href="#使用Angular-当input-text-改变时-模板也作出相应的改变" class="headerlink" title="使用Angular, 当input text 改变时, 模板也作出相应的改变:"></a>使用Angular, 当input text 改变时, 模板也作出相应的改变:</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">ng-app</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Angular.js Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"//cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Name:<span class="tag">&lt;<span class="name">input</span> <span class="attr">ng-model</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"text"</span>/&gt;</span></span><br><span class="line">Hello &#123;&#123;name&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="多个text-input的数据绑定"><a href="#多个text-input的数据绑定" class="headerlink" title="多个text input的数据绑定"></a>多个text input的数据绑定</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html ng-app&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line"></span><br><span class="line">    &lt;title&gt;AngularJS&lt;/title&gt;</span><br><span class="line">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.14/angular.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">      Name: &lt;input type=&quot;text&quot; ng-model=&quot;name&quot; /&gt;</span><br><span class="line">      &lt;br /&gt;</span><br><span class="line">      Name: &lt;input type=&quot;text&quot; ng-model=&quot;name&quot; /&gt;</span><br><span class="line">      &lt;br /&gt;</span><br><span class="line">      &#123;&#123;name&#125;&#125;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/17/coffeescript/" itemprop="url">
                  coffeescript入门教程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-17T08:19:30+08:00" content="2015-03-17">
              2015-03-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/CoffeeScript/" itemprop="url" rel="index">
                    <span itemprop="name">CoffeeScript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是coffescript"><a href="#什么是coffescript" class="headerlink" title="什么是coffescript"></a>什么是coffescript</h2><blockquote>
<p>coffeescript 是一种ruby/python风格的语言可以被编译成js, 相比于js来讲, 它使用更少的代码.而且可读性更好. <a href="http://coffeescript.org/" target="_blank" rel="external">http://coffeescript.org/</a> OVERVIEW 部分可以看出只相当于js的三分之二的代码.</p>
</blockquote>
<h2 id="安装coffeescript"><a href="#安装coffeescript" class="headerlink" title="安装coffeescript"></a>安装coffeescript</h2><blockquote>
<p>前提需要安装nodejs环境, 然后执行下面的命令:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo npm install -g coffee-script</span><br></pre></td></tr></table></figure>
<h2 id="编译coffeescript"><a href="#编译coffeescript" class="headerlink" title="编译coffeescript"></a>编译coffeescript</h2><blockquote>
<p>新建一个script.coffee的文件, 使用 <code>--wantch --compile</code> 监视并编译该文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ coffeescript --watch --compile script.coffee</span><br></pre></td></tr></table></figure>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><h3 id="变量声明与赋值"><a href="#变量声明与赋值" class="headerlink" title="变量声明与赋值"></a>变量声明与赋值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># script.coffee</span><br><span class="line"></span><br><span class="line">name = &quot;Daniel&quot;</span><br><span class="line"></span><br><span class="line">person = true</span><br></pre></td></tr></table></figure>
<blockquote>
<p>编译成的js 代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(function() &#123;</span><br><span class="line">  var name, person;</span><br><span class="line">  name = &quot;Daniel&quot;;</span><br><span class="line">  person = true;</span><br><span class="line">&#125;).all(this)</span><br></pre></td></tr></table></figure>
<h3 id="函数的定义"><a href="#函数的定义" class="headerlink" title="函数的定义"></a>函数的定义</h3><blockquote>
<p>使用 <code>-&gt;</code> 来定义函数, 而且需要注意使用缩进:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># script.coffee</span><br><span class="line">yell = -&gt;</span><br><span class="line">  alert name</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yell = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> alert(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="函数的调用"><a href="#函数的调用" class="headerlink" title="函数的调用"></a>函数的调用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yell()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意括号不可以省略.</p>
</blockquote>
<h3 id="向函数传递参数"><a href="#向函数传递参数" class="headerlink" title="向函数传递参数"></a>向函数传递参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yell = (a) -&gt;</span><br><span class="line">  age = a</span><br><span class="line">  alert name</span><br><span class="line">  alert a</span><br></pre></td></tr></table></figure>
<h2 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">is            ===</span><br><span class="line">isnt          !==</span><br><span class="line">not           !</span><br><span class="line">and           &amp;&amp;</span><br><span class="line">or            ||</span><br><span class="line">true, yes, on true</span><br><span class="line">false, no, off                  false</span><br><span class="line">@, this                         this</span><br><span class="line">of                              in</span><br></pre></td></tr></table></figure>
<h2 id="条件控制语句"><a href="#条件控制语句" class="headerlink" title="条件控制语句"></a>条件控制语句</h2><blockquote>
<p>非常接近于ruby的语法:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yell(22) if person is true</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(person === <span class="literal">true</span>) &#123;</span><br><span class="line">  yell(<span class="number">22</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">age = <span class="number">22</span></span><br><span class="line">yell(<span class="number">33</span>) unless age &lt; <span class="number">33</span></span><br></pre></td></tr></table></figure>
<figure class="highlight coffee"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> person <span class="keyword">isnt</span> <span class="literal">false</span> <span class="keyword">then</span> yell(<span class="string">"Daniel"</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (person === <span class="literal">true</span> &amp;&amp; name !== <span class="string">"Daniel"</span>) &#123;</span><br><span class="line">  yell(<span class="string">"Daniel"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight coffee"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> name?</span><br><span class="line">  yell()</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (name != <span class="literal">null</span>)&#123;</span><br><span class="line">  yell(<span class="string">"Daniel"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># coffee</span><br><span class="line">if gender?</span><br><span class="line">  yell()</span><br><span class="line"></span><br><span class="line"># js</span><br><span class="line">if (typeof gender !== &quot;undefined&quot; &amp;&amp; gender !== null) &#123;</span><br><span class="line">  yell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>检查是否为null, 如果是 就 : <code>?=</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># coffee</span><br><span class="line">gender = &quot;&quot;</span><br><span class="line">gender ?= &quot;Male&quot;</span><br><span class="line"></span><br><span class="line"># js</span><br><span class="line">if (gender == null)</span><br><span class="line">  gender = &quot;Male&quot;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="Array-和-Object"><a href="#Array-和-Object" class="headerlink" title="Array 和 Object"></a>Array 和 Object</h2><blockquote>
<p>对于数组来讲, coffee 的形式和js形式是相同的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># coffeescript</span><br><span class="line">type = [&quot;Rice&quot;, &quot;Crab&quot;, &quot;Cumcumber&quot;]</span><br><span class="line"></span><br><span class="line"># js</span><br><span class="line">type = [&quot;Rice&quot;, &quot;Crab&quot;, &quot;Cumcumber&quot;]</span><br></pre></td></tr></table></figure></p>
<p>Obejct的声明:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># coffee</span><br><span class="line">sushi =</span><br><span class="line">  kind: &quot;Roll&quot;</span><br><span class="line">  roll: -&gt;</span><br><span class="line">    &quot;Rolled&quot;</span><br><span class="line">  fish: &quot;Salmon&quot;</span><br><span class="line">  ing:</span><br><span class="line">    rice: &quot;White&quot;</span><br><span class="line">    veg: &quot;Green&quot;</span><br><span class="line"># js</span><br><span class="line">sushi = &#123;</span><br><span class="line">  kind: &quot;Roll&quot;,</span><br><span class="line">  roll: function() &#123;</span><br><span class="line">    return &quot;Rolled&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  fish: &quot;Salmon&quot;,</span><br><span class="line">  ing:</span><br><span class="line">    rice: &quot;White&quot;,</span><br><span class="line">    veg: &quot;Green&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果带有关键字, coffee会自动加上 “”</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># coffee</span><br><span class="line">sushi =</span><br><span class="line">  class: &quot;Yellow&quot;</span><br><span class="line"></span><br><span class="line"># js</span><br><span class="line">sushi = &#123;</span><br><span class="line">  &quot;class&quot;: &quot;Yellow&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="类似于ruby的字符串插入变量"><a href="#类似于ruby的字符串插入变量" class="headerlink" title="类似于ruby的字符串插入变量"></a>类似于ruby的字符串插入变量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># coffee</span><br><span class="line"></span><br><span class="line">alert(&quot;hello #&#123;name&#125;&quot;)</span><br><span class="line"></span><br><span class="line">#js</span><br><span class="line"></span><br><span class="line">alert(&quot;hello &quot; + name)</span><br></pre></td></tr></table></figure>
<h2 id="Block-comments"><a href="#Block-comments" class="headerlink" title="Block comments"></a>Block comments</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">###</span><br><span class="line">可以在coffee中写多行注释</span><br><span class="line">###</span><br><span class="line"></span><br><span class="line">js中会变成:</span><br><span class="line">/*</span><br><span class="line">可以在coffee中写多行注释</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<h2 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># coffee</span><br><span class="line">for item in type</span><br><span class="line">  alert(item)</span><br><span class="line"># 还可以写成一行</span><br><span class="line">alert(item) for item in type</span><br><span class="line"></span><br><span class="line"># js</span><br><span class="line">for (i=0, len=type.length; i&lt;len; i++)</span><br><span class="line">  item = type[i]</span><br><span class="line">  alert(item)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意if和when的区别</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">alert(item) for item in type if item isnt &quot;Crab&quot;</span><br><span class="line"></span><br><span class="line">if (item !== &quot;Crab&quot;) &#123;</span><br><span class="line">  for(i = 0, len = type.length; i &lt; len; i++) &#123;</span><br><span class="line">    item = type[i]</span><br><span class="line">    alert(item)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># when 用在循环里面做判断:</span><br><span class="line"></span><br><span class="line">alert(item) for item in type when item isnt &quot;Crab&quot;</span><br><span class="line"></span><br><span class="line"># js</span><br><span class="line">for (i=0, len = type.length; i &lt; len; i++)</span><br><span class="line">  item = type[i] </span><br><span class="line">  if (item !== &quot;Crab&quot;) &#123;</span><br><span class="line">    alert(item)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Splats"><a href="#Splats" class="headerlink" title="Splats"></a>Splats</h2><blockquote>
<p>基本和ruby的splats相同, splats参数最后赋值, 先去赋值明确的参数</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">letters = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]</span><br><span class="line"></span><br><span class="line">iLike = (first, second, rest...) -&gt;</span><br><span class="line">  alert(first)</span><br><span class="line">  alert(second)</span><br><span class="line">  alert(rest)</span><br><span class="line"></span><br><span class="line"># js</span><br><span class="line"></span><br><span class="line">  letters = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;];</span><br><span class="line"></span><br><span class="line">  iLike = function() &#123;</span><br><span class="line">      var most, rest, second;</span><br><span class="line">      most = arguments[0], second = arguments[1], rest = 3 &lt;= arguments.length ? slice.call(arguments, 2) : [];</span><br><span class="line">      alert(most);</span><br><span class="line">      alert(second);</span><br><span class="line">      return alert(rest);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="分割数组"><a href="#分割数组" class="headerlink" title="分割数组"></a>分割数组</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">first = letters[0..3]</span><br><span class="line">rest = letters[4..]</span><br><span class="line">copy = letters[..]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">first = letters.slice(0, 4);</span><br><span class="line">rest = letters.slice(4);</span><br><span class="line">copy = letters.slice(0);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>替换元素</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">letters[2..4] = [&quot;M&quot;, &quot;N&quot;, &quot;Q&quot;]</span><br><span class="line"></span><br><span class="line">[].splice.apply(letters, [2, 3].concat(ref = [&quot;M&quot;, &quot;N&quot;, &quot;Q&quot;])), ref;</span><br></pre></td></tr></table></figure>
<h2 id="Switch-语句"><a href="#Switch-语句" class="headerlink" title="Switch 语句"></a>Switch 语句</h2><blockquote>
<p>switch when then</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">switch colors</span><br><span class="line">  when &quot;Blue&quot; then &quot;Blue&quot;</span><br><span class="line">  when &quot;Green&quot; then name = &quot;Green&quot;</span><br><span class="line">  when &quot;Black&quot;, &quot;Brown&quot;</span><br><span class="line">    if colors == &quot;Black&quot;</span><br><span class="line">      alert &quot;Black&quot;</span><br><span class="line">    name = &quot;Brown/Black&quot;</span><br><span class="line">  else alert &quot;No Colors&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># js</span><br><span class="line">switch (colors) &#123;</span><br><span class="line">  case &quot;Blue&quot;:</span><br><span class="line">    &quot;Blue&quot;;</span><br><span class="line">    break;</span><br><span class="line">  case &quot;Green&quot;:</span><br><span class="line">    name = &quot;Green&quot;;</span><br><span class="line">    break;</span><br><span class="line">  case &quot;Black&quot;:</span><br><span class="line">  case &quot;Brown&quot;:</span><br><span class="line">    if (colors === &quot;Black&quot;) &#123;</span><br><span class="line">      alert(&quot;Black&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    name = &quot;Brown/Black&quot;;</span><br><span class="line">    break;</span><br><span class="line">  default:</span><br><span class="line">  alert(&quot;No Colors&quot;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/16/angularjs00/" itemprop="url">
                  angularjs00
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-16T20:25:38+08:00" content="2015-03-16">
              2015-03-16
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/16/resume/" itemprop="url">
                  My Resume of English Version
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-16T14:43:38+08:00" content="2015-03-16">
              2015-03-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Resume/" itemprop="url" rel="index">
                    <span itemprop="name">Resume</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Daniel-Zhang"><a href="#Daniel-Zhang" class="headerlink" title="Daniel Zhang"></a>Daniel Zhang</h2><h3 id="Personal-Info"><a href="#Personal-Info" class="headerlink" title="Personal Info"></a>Personal Info</h3><ul>
<li>Email: shangrenzhidao@126.com</li>
<li>Tel: +8618654650142</li>
</ul>
<h3 id="Personal-Summary"><a href="#Personal-Summary" class="headerlink" title="Personal Summary"></a>Personal Summary</h3><blockquote>
<p>Experienced Ruby on Rails Developer with extensive technical background, positive attitude and strong motivation, detail oriented, and results focused. Strong interest in learning new knowledge and skills. Seeking a challenging position in IT.</p>
</blockquote>
<h3 id="Work-Experience"><a href="#Work-Experience" class="headerlink" title="Work Experience"></a>Work Experience</h3><h4 id="Ruby-on-Rails-Developer"><a href="#Ruby-on-Rails-Developer" class="headerlink" title="Ruby on Rails Developer"></a>Ruby on Rails Developer</h4><blockquote>
<p>Institute of Zoology of Chinese Academy of Science - China Beijing</p>
<p>August 2013 to December 2014</p>
<p>Responsibilities</p>
<ul>
<li><p>Participating in discussions with taxonomists about what they need in eolchina system version2.</p>
</li>
<li><p>Had working experiences with American team.</p>
</li>
<li><p>Used Ruby on Rails framework to display all the species.</p>
</li>
<li><p>Implemented pronunciation functionality which is that one can hear the Chinese name’s pronunciation when clicking the icon.</p>
</li>
<li><p>Used Redis to count the times of species that are visited.</p>
</li>
<li><p>Deployed application on Ubuntu Linux platform.</p>
</li>
<li><p>Developped a gem named <a href="https://github.com/DanielZhangQingLong/asian_character_image" target="_blank" rel="external">asian_character_image</a>, which can provide images for Chinese characters.</p>
</li>
</ul>
<p>Accomplishments</p>
<ul>
<li><p>Was able to quickly iterate solutions to common web development problems. </p>
</li>
<li><p>Learned new skills quickly and was able to apply new knowledge effectively. </p>
</li>
<li><p>Learned programming best practices and agile software development methods. </p>
</li>
</ul>
<p>Skills Used </p>
<blockquote>
<p>Ruby on Rails, Redis, HTML5, Git, RSpec, Unicorn, Nginx and etc.</p>
</blockquote>
</blockquote>
<h3 id="Education"><a href="#Education" class="headerlink" title="Education"></a>Education</h3><h4 id="Harbin-University-of-Science-and-Technology"><a href="#Harbin-University-of-Science-and-Technology" class="headerlink" title="Harbin University of Science and Technology"></a>Harbin University of Science and Technology</h4><blockquote>
<p>2009 – 2013</p>
</blockquote>
<h3 id="Additional-Information"><a href="#Additional-Information" class="headerlink" title="Additional Information"></a>Additional Information</h3><blockquote>
<p>Skills</p>
<blockquote>
<p>Technologies: Ruby, Rails, HTML5, Linux, Java, Vim, MySQL and etc.</p>
<p>Personal Project: <a href="https://infinite-island-7861.herokuapp.com/" target="_blank" rel="external">https://infinite-island-7861.herokuapp.com/</a> (Not done yet though…)</p>
<p>Blog: <a href="http://danielzhangqinglong.github.io/" target="_blank" rel="external">http://danielzhangqinglong.github.io/</a></p>
<p>Github: <a href="https://github.com/DanielZhangQingLong" target="_blank" rel="external">https://github.com/DanielZhangQingLong</a></p>
</blockquote>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/15/rails-pdf1/" itemprop="url">
                  Rails使用PDFKit和wkhtmltopdf将HTML转换成PDF
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-15T16:25:20+08:00" content="2015-03-15">
              2015-03-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="准备项目"><a href="#准备项目" class="headerlink" title="准备项目"></a>准备项目</h2><blockquote>
<p>新建一个rails项目, 并导入一些数据, 不详细阐述, 我将index的截图贴出了:</p>
<p><img src="http://i3.tietuku.com/1b3fe58e7b61ac08.png"></p>
</blockquote>
<h2 id="安装PDFKit和wkhtmtopdf"><a href="#安装PDFKit和wkhtmtopdf" class="headerlink" title="安装PDFKit和wkhtmtopdf"></a>安装PDFKit和wkhtmtopdf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line">gem &apos;pdfkit&apos;</span><br><span class="line">gem &apos;wkhtmltopdf&apos;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>$ bundle install</p>
<p>wkhtmltopdf 是非常不错的工具, 我可以直接在终端中使用它把html转化为 pdf</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wkhtmltopdf http://www.baidu.com b.pdf</span><br></pre></td></tr></table></figure>
<blockquote>
<p>看看当前路径下是不是多了b.pdf 呢?</p>
</blockquote>
<h2 id="生成PDF格式"><a href="#生成PDF格式" class="headerlink" title="生成PDF格式"></a>生成PDF格式</h2><blockquote>
<p>当浏览器的请求是以<code>.pdf</code>结尾时候, Rails端要做出相应的处理.<br>首先在在show页面添加一个pdf格式的超链接:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># views/products/show.html.erb</span><br><span class="line">[...]</span><br><span class="line">&lt;%= &quot;View in PDF&quot;, product_path(@product, format: &quot;pdf&quot;) %&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接着, 在Controller的show方法中, 使用<code>respond_to</code>方法对pdf和html格式的请求做出处理:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">def show</span><br><span class="line">  respond_to do |format|</span><br><span class="line">    format.html</span><br><span class="line">    format.pdf do</span><br><span class="line">      html = render_to_string template: &quot;products/show&quot;</span><br><span class="line">      pdf = PDFKit.new(html, encoding: &quot;UTF-8&quot;)</span><br><span class="line">      # 加入样式</span><br><span class="line">      pdf.stylesheets &lt;&lt; &quot;#&#123;Rails.root&#125;/app/assets/stylesheets/scaffolds.scss&quot;</span><br><span class="line">      pdf.stylesheets &lt;&lt; &quot;#&#123;Rails.root&#125;/app/assets/stylesheets/bootstrap.min.css&quot;</span><br><span class="line">      send_data pdf.to_pdf,</span><br><span class="line">        filename: &quot;#&#123;@product.id&#125;.pdf&quot;,</span><br><span class="line">        type: &quot;application/pdf&quot;,</span><br><span class="line">        # 在浏览器内显示, 而非下载</span><br><span class="line">        disposition: &quot;inline&quot;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="PDFKit-配置信息"><a href="#PDFKit-配置信息" class="headerlink" title="PDFKit 配置信息"></a>PDFKit 配置信息</h2><blockquote>
<p>新建 <code>config/initializers/pdfkit.rb</code> :</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># config/initializers/pdfkit.rb</span><br><span class="line"></span><br><span class="line">PDFKit.configure do |config|</span><br><span class="line">  config.wkhtmltopdf = `which wkhtmltopdf`.to_s.strip</span><br><span class="line">  config.default_options = &#123;</span><br><span class="line">    encoding:                &quot;UTF-8&quot;,</span><br><span class="line">    page_size:               &quot;A4&quot;,</span><br><span class="line">    margin_top:              &quot;0.25in&quot;, </span><br><span class="line">    margin_right:            &quot;1in&quot;,</span><br><span class="line">    margin_bottom:           &quot;0.25in&quot;,</span><br><span class="line">    margin_left:             &quot;1in&quot;,</span><br><span class="line">    disable_smart_shrinking: false</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后, 需要添加pdf格式的模板文件, 实际上和html格式大致一样</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># app/views/products/show.pdf.erb</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;page-header&quot;&gt;</span><br><span class="line">&lt;h1&gt;Product&lt;/h1&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;a href=&quot;#&quot;, class=&quot;btn btn-primary&quot;&gt;HELLO&lt;/a&gt;</span><br><span class="line">&lt;img src=&quot;http://proof.nationalgeographic.com/files/2014/12/MM8228_130309_01458_1-990x450.jpg&quot; alt=&quot;&quot; /&gt;</span><br><span class="line">&lt;p id=&quot;notice&quot;&gt;&lt;%= notice %&gt;&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;</span><br><span class="line">&lt;strong&gt;Name:&lt;/strong&gt;</span><br><span class="line">&lt;%= @product.name %&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;</span><br><span class="line">&lt;strong&gt;Price:&lt;/strong&gt;</span><br><span class="line">&lt;%= @product.price %&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;</span><br><span class="line">&lt;strong&gt;Number:&lt;/strong&gt;</span><br><span class="line">&lt;%= @product.number %&gt;</span><br><span class="line">&lt;/p&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后重启服务器, 访问 <a href="http://localhost:3000/products/1.pdf" target="_blank" rel="external">http://localhost:3000/products/1.pdf</a> , 效果如下:</p>
<p><img src="http://i2.tietuku.com/434257cfaeca315b.png"></p>
</blockquote>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="Heroku下无法转换"><a href="#Heroku下无法转换" class="headerlink" title="Heroku下无法转换"></a>Heroku下无法转换</h3><blockquote>
<p>使用 <code>wkhtmltopdf-binary</code> gem 代替原来的 <code>wkhtmltopdf</code></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/12/ransack-full-text-search/" itemprop="url">
                  Rails 使用ransack全文搜索
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-12T07:52:40+08:00" content="2015-03-12">
              2015-03-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>ransack gem可以帮助我们简单地进行全文检索, 本文就简单介绍一下具体的使用方法.</p>
</blockquote>
<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><blockquote>
<p>创建项目, 倒入数据等准备工作:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ rails new ransack_test</span><br><span class="line">$ cd ransack_test</span><br><span class="line"></span><br><span class="line"># 使用Scaffolding 生成Product</span><br><span class="line"></span><br><span class="line">$ rails g scaffold Product name:string description:string price:integer discontinued:boolean carrier_id:integer</span><br><span class="line"></span><br><span class="line"># 创建Product的货架(持有者)Model Carrier</span><br><span class="line">$ rails g model Carrier name:string</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Carrier和Product是一对多的关系:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># app/models/carrier.rb</span><br><span class="line"></span><br><span class="line">class Carrier &lt; ActiveRecord::Base</span><br><span class="line">  has_many :products</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/models/carrier.rb</span><br><span class="line"></span><br><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :carrier</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>创建表:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>初始化一些数据(seeds.rb)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">carrier1 = Carrier.create!(name: &quot;JD&quot;)</span><br><span class="line">carrier2 = Carrier.create!(name: &quot;SN&quot;)</span><br><span class="line"></span><br><span class="line">carrier1.products.create!(</span><br><span class="line">  name: &quot;MacbookAir 2015&quot;,</span><br><span class="line">  description: &quot;2015年3月10号 苹果推出了新一代MacBookAir, 这对PC厂商来说是很大的打击, 精湛的工艺和超前的设计, 简直让人陶醉了.&quot;,</span><br><span class="line">  price: 8000,</span><br><span class="line">  discontinued: true</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">carrier1.products.create!(</span><br><span class="line">  name: &quot;Xbox One&quot;,</span><br><span class="line">  description: &quot;Xbox One 是由MicroSoft公司于2013年推出的一款电视游戏机, 它集成了电视盒功能...&quot;,</span><br><span class="line">  price: 3300,</span><br><span class="line">  discontinued: false</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">carrier2.products.create!(</span><br><span class="line">  name: &quot;PS4&quot;,</span><br><span class="line">  description: &quot;PlayStation 4（官方缩写：PS4）是一部索尼电脑娱乐推出的电子游戏机，2013年11月15日正式于北美发售，PlayStation 4属于第八世代的游戏机，作为PlayStation 3的后续机种，并将与任天堂的Wii U和微软的Xbox One共同在市场上竞争&quot;,</span><br><span class="line">  price: 2800,</span><br><span class="line">  discontinued: false</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>导入数据:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rake db:seed</span><br></pre></td></tr></table></figure>
<blockquote>
<p>现在, 把Carrier的name显示在product的index页面上, 替换掉id</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># app/views/products/index.html.erb</span><br><span class="line"></span><br><span class="line"># &lt;td&gt;&lt;%= product.carrier_id %&gt;&lt;/td&gt; 替换为</span><br><span class="line"></span><br><span class="line">&lt;td&gt;&lt;%= product.carrier.name %&gt;&lt;/td&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>到现在为止, 准备工作已经做完, 看下面的截图:</p>
<p><img src="http://i3.tietuku.com/b50913417ef7affa.png"></p>
</blockquote>
<h2 id="安装-ransack"><a href="#安装-ransack" class="headerlink" title="安装 ransack"></a>安装 ransack</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line">gem &apos;ransack&apos;</span><br><span class="line"></span><br><span class="line">$ bundle install</span><br></pre></td></tr></table></figure>
<h2 id="添加搜索功能和搜索表单"><a href="#添加搜索功能和搜索表单" class="headerlink" title="添加搜索功能和搜索表单"></a>添加搜索功能和搜索表单</h2><blockquote>
<p>在Controller的index 方法中</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def index</span><br><span class="line">  @q = Product.search(params[:q])</span><br><span class="line">  @products = @q.result(distinct: true)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后再index 页面中添加一个搜索的表单:<br><strong><em> 需要注意: <code>search_form_for</code> 是一个helper, 会生成一个搜索的表单</em></strong><br><strong><em> 页面搜索字段为<code>[column_name]_start</code>, <code>[column_name]_cont</code> </em></strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">... </span><br><span class="line">&lt;h1&gt;Listing Products&lt;/h1&gt;</span><br><span class="line">    &lt;%# 使用search_form_for 生成搜索表单  %&gt;</span><br><span class="line">    &lt;%= search_form_for @q do |f| %&gt;</span><br><span class="line">      &lt;%# name_start搜索数据库中name字段的值需要以该field填入值开头 %&gt;</span><br><span class="line">      &lt;%= f.label :name_start, &quot;Name starts with:&quot; %&gt;</span><br><span class="line">      &lt;%= f.search_field :name_start %&gt;</span><br><span class="line">      &lt;br /&gt;</span><br><span class="line">      &lt;%# cont指的是搜索含有该field的值的字段 %&gt;</span><br><span class="line">      &lt;%= f.label :description_cont, &quot;Description contains:&quot; %&gt;</span><br><span class="line">      &lt;%= f.search_field :description_cont %&gt;</span><br><span class="line">      &lt;br /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;%# 关联搜索: Product.carrier.name %&gt;</span><br><span class="line">      &lt;%= f.label :carrier_name_cont, &quot;Carrier:&quot; %&gt;</span><br><span class="line">      &lt;%= f.search_field :carrier_name_cont %&gt;</span><br><span class="line">      &lt;br /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;%# lt 指的是查找小于该field的记录 %&gt;</span><br><span class="line">      &lt;%= f.label :price_lt, &quot;Price &lt; :&quot; %&gt;</span><br><span class="line">      &lt;%= f.search_field :price_lt %&gt;</span><br><span class="line"></span><br><span class="line">      &lt;%# or 指定是使用or连接的多条字段查询, 也就是name或description包含指定的值  %&gt;</span><br><span class="line">      &lt;%= f.label :name_or_description_cont, &quot;Name OR Description contains:&quot; %&gt;</span><br><span class="line">      &lt;%= f.search_field :name_or_description_cont %&gt;</span><br><span class="line"></span><br><span class="line">      &lt;%# 搜索按钮  %&gt;</span><br><span class="line">      &lt;%= f.submit %&gt;</span><br><span class="line">    &lt;% end %&gt;</span><br><span class="line">&lt;hr /&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启动服务器, 效果如下:</p>
<p><img src="http://i3.tietuku.com/5bcfb19d3a748955.png"></p>
</blockquote>
<h2 id="排序链接"><a href="#排序链接" class="headerlink" title="排序链接"></a>排序链接</h2><blockquote>
<p>ransack还提供了<code>sort_link</code>方法生成链接来按照某个字段的升序或者降序来进行排序, default_order 选项可以指定查询结果是按照升序还是降序:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># app/views/products/index.html.erb</span><br><span class="line"></span><br><span class="line"># 默认按照价格的降序来排序结果</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">&lt;th&gt; &lt;%= sort_link(@q, :price, default_order: :desc) %&gt; &lt;/th&gt;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<blockquote>
<p>点击 Price表头, 倒序结果:</p>
<p><img src="http://i3.tietuku.com/9e9be59b1a6360e4.png"></p>
</blockquote>
<h2 id="搜索字段的黑白名单"><a href="#搜索字段的黑白名单" class="headerlink" title="搜索字段的黑白名单"></a>搜索字段的黑白名单</h2><blockquote>
<p>由于安全性的考量, 需要限制一些字段搜索, 加入我不想让别人使用name进行搜索, 我需要在 product.rb中重写<code>self.ransackable_attributes</code>方法来限制name字段, 有些类似于Strong Parameters</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :carrier</span><br><span class="line"></span><br><span class="line">  def self.ransackable_attributes auth_object = nil</span><br><span class="line">    %w( description price) # name不在其中</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果需要限制关联的字段, 比如<code>carrier</code>, 就需要重写<code>self.ransackable_associations</code>方法. 还可以限制scope等等. 具体请参考 <a href="https://github.com/activerecord-hackery/ransack#authorization-whitelistingblacklisting" target="_blank" rel="external">https://github.com/activerecord-hackery/ransack#authorization-whitelistingblacklisting</a></p>
</blockquote>
<h2 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h2><h3 id="访问页面前-需先设置好-q"><a href="#访问页面前-需先设置好-q" class="headerlink" title="访问页面前, 需先设置好@q"></a>访问页面前, 需先设置好@q</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">No Ransack::Search object was provided to search_form_for! #3</span><br></pre></td></tr></table></figure>
<blockquote>
<p>解决方案</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">I did this <span class="keyword">in</span> my application controller</span><br><span class="line"></span><br><span class="line">before_filter <span class="symbol">:set_search</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_search</span></span></span><br><span class="line">  @search=Product.search(params[<span class="symbol">:q</span>])</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><blockquote>
<p><a href="https://github.com/activerecord-hackery/ransack" target="_blank" rel="external">https://github.com/activerecord-hackery/ransack</a></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/11/google-map-in-rails/" itemprop="url">
                  Rails4中使用Google Map 服务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-11T17:25:34+08:00" content="2015-03-11">
              2015-03-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>从项目中抽取模型, 来简单介绍一下Rails中使用Google Map服务的方法.</p>
</blockquote>
<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><blockquote>
<p>创建并添加所需的gem</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ rails new google_map &amp;&amp; cd google_map</span><br><span class="line"></span><br><span class="line"># Gemfile</span><br><span class="line"></span><br><span class="line">gem &apos;gmaps4rails&apos;</span><br><span class="line">gem &apos;geocoder&apos;</span><br><span class="line"></span><br><span class="line">&amp; bundle install</span><br></pre></td></tr></table></figure>
<h2 id="准备Model"><a href="#准备Model" class="headerlink" title="准备Model"></a>准备Model</h2><blockquote>
<p>Scaffold一个User, latitude和longitude分别表示纬度和经度, 有了这两个属性, 就可以定位了.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rails g scaffold user title:string description:string address:string latitude:float longitude:float</span><br><span class="line"></span><br><span class="line">$ rake db:migrate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后, 修改<code>user.rb</code>:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># app/models/user.rb</span><br><span class="line"></span><br><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  geocoded_by :address</span><br><span class="line">  after_validation :geocode</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="添加javascript代码"><a href="#添加javascript代码" class="headerlink" title="添加javascript代码"></a>添加javascript代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># app/views/layouts/application.html.erb</span><br><span class="line">...</span><br><span class="line">&lt;script src=&quot;//maps.google.com/maps/api/js?v=3.13&amp;amp;sensor=false&amp;amp;libraries=geometry&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&apos;//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js&apos; type=&apos;text/javascript&apos;&gt;&lt;/script&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>把这段<a href="http://underscorejs.org/underscore-min.js" target="_blank" rel="external">代码拷贝</a> <code>vendor/assts/javascripts/underscore.js</code>中.<br>然后, 引入在<code>assets/javascripts/application.js</code>中引入js库:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># assets/javascripts/application.js</span><br><span class="line">...</span><br><span class="line">//= require underscore</span><br><span class="line">//= require gmaps/google</span><br></pre></td></tr></table></figure>
<h2 id="准备地图的视图页面"><a href="#准备地图的视图页面" class="headerlink" title="准备地图的视图页面"></a>准备地图的视图页面</h2><blockquote>
<p>创建Controller和对应的页面, 来显示Google地图</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rails g controller map index</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接着在视图中调用Google Map:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># views/map/index.html.erb</span><br><span class="line"></span><br><span class="line">  &lt;div style=&apos;width: 800px;&apos;&gt;</span><br><span class="line">    &lt;div id=&quot;map&quot; style=&apos;width: 800px; height: 400px;&apos;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    handler = Gmaps.build(&apos;Google&apos;);</span><br><span class="line">    handler.buildMap(&#123; provider: &#123;&#125;, internal: &#123;id: &apos;map&apos;&#125; &#125;, function()&#123;</span><br><span class="line">    markers = handler.addMarkers(&lt;%=raw @hash.to_json %&gt;);</span><br><span class="line">    handler.bounds.extendWith(markers);</span><br><span class="line">    handler.fitMapToBounds();</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">  &lt;/script&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>编辑Controller index action, 从User中获取经度和纬度信息, 设置Google Map参数:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class MapController &lt; ApplicationController</span><br><span class="line">  def index</span><br><span class="line">    @users = User.all</span><br><span class="line">    @hash = Gmaps4rails.build_markers(@users) do |user, marker|</span><br><span class="line">      marker.lat user.latitude</span><br><span class="line">      marker.lng user.longitude</span><br><span class="line">      marker.infowindow user.description</span><br><span class="line">      marker.json(&#123;title: user.title&#125;)</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="设置经纬度-观察是否正确显示位置"><a href="#设置经纬度-观察是否正确显示位置" class="headerlink" title="设置经纬度, 观察是否正确显示位置"></a>设置经纬度, 观察是否正确显示位置</h2><blockquote>
<p>创建一个用户, 设置其经纬度, 该定位点是北京, 然后访问localhost:3000/map/index, 观察到显示正确位置, 呵呵, 八九不离十吧.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.create(latitude: 39.8960407788, longitude: 116.4042663574)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><img src="http://i2.tietuku.com/192c665e48da578e.png"></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Daniel Zhang" />
          <p class="site-author-name" itemprop="name">Daniel Zhang</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">105</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">104</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Daniel Zhang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  

</body>
</html>
