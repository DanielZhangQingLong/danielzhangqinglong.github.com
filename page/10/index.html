<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/10/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'uSvyVbAJs-5jfXFawgQ3','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/04/using-devise-in-rails/" itemprop="url">
                  使用devise gem为Rails提供验证
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-04T12:57:45+08:00" content="2015-02-04">
              2015-02-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Ruby-Gems/" itemprop="url" rel="index">
                    <span itemprop="name">Ruby Gems</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/04/using-devise-in-rails/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/04/using-devise-in-rails/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>上一个项目中, 我发现老外的登录验证等都是自己写, 我不解就问, 老外告诉我, 其实他们的登录验证非常复杂, 如果使用 devise 很多东西都会被限制住. 而且他还告诉我, 对于新手来说, 最好是先写一些实现, 等到理解背后的原理以后再去走捷径.</p>
<p>不过现在我觉得我已经不用再继续制造车轮了, 该用一下别人的车轮了, 谨以此文总结记录一下如何在 Rails 中使用 devise 进行验证.</p>
</blockquote>
<h2 id="安装与设定"><a href="#安装与设定" class="headerlink" title="安装与设定"></a>安装与设定</h2><blockquote>
<p>在项目的Gemfile 中加入 <code>gem &#39;devise&#39;</code>, 然后执行 <code>bundle install</code></p>
<p>然后我们为 Rails 设定 devise 相关联的配置文件, 运行:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ rails g devise:install</span><br><span class="line">  create config/initializers/devise.rb</span><br><span class="line">  create config/locales/devise.en.yml</span><br><span class="line"></span><br><span class="line">  Some setup you must do manually if you haven&apos;t yet:</span><br><span class="line"></span><br><span class="line">  1. Ensure you have defined default url options in your environments files. Here</span><br><span class="line">  is an example of default_url_options appropriate for a development environment</span><br><span class="line">  in config/environments/development.rb:</span><br><span class="line"></span><br><span class="line">  config.action_mailer.default_url_options = &#123; host: &apos;localhost&apos;, port: 3000  &#125;</span><br><span class="line"></span><br><span class="line">  In production, :host should be set to the actual host of your application.</span><br><span class="line"></span><br><span class="line">  2. Ensure you have defined root_url to *something* in your config/routes.rb.</span><br><span class="line">  For example:</span><br><span class="line"></span><br><span class="line">  root to: &quot;home#index&quot;</span><br><span class="line"></span><br><span class="line">  3. Ensure you have flash messages in app/views/layouts/application.html.erb.</span><br><span class="line">  For example:</span><br><span class="line"></span><br><span class="line">  &lt;p class=&quot;notice&quot;&gt;&lt;%= notice %&gt;&lt;/p&gt;</span><br><span class="line">  &lt;p class=&quot;alert&quot;&gt;&lt;%= alert %&gt;&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">  4. If you are deploying on Heroku with Rails 3.2 only, you may want to set:</span><br><span class="line"></span><br><span class="line">  config.assets.initialize_on_precompile = false</span><br><span class="line"></span><br><span class="line">  On config/application.rb forcing your application to not access the DB</span><br><span class="line">  or load models when precompiling your assets.</span><br><span class="line"></span><br><span class="line">  5. You can copy Devise views (for customization) to your app by running:</span><br><span class="line"></span><br><span class="line">  rails g devise:views</span><br><span class="line"></span><br><span class="line">  ===============================================================================</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这时 devise 会让我设定5项内容. 我们依次来做.</p>
</blockquote>
<ul>
<li><p>指定邮件发送的机器的 ip.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># config/environments/development.rb</span><br><span class="line">config.action_mailer.default_url_options = &#123; host: &apos;localhost:3000&apos; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>确保routes.rb中定义了 root_url<br>  由于退出一个重定向到 root, 所以 root 需要一并设定.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># config/routes.rb</span><br><span class="line"></span><br><span class="line">root to: &quot;home#index&quot;</span><br></pre></td></tr></table></figure>
<p>  root_url 已经设定, 但是对应的Controller 和 View 还没有创建, 所以需要创建.<br>  “home#index” 创建后, root_url 就可以访问了.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rails g controller Home index show</span><br></pre></td></tr></table></figure>
<p>  home#show 创建后, 接下来文章着重介绍 Devise定制访问限制的使用.</p>
</li>
<li><p>确保在 application.html.erb 中定义了 flash 消息.<br>  用户登录成功后或者密码错误, 我们需要使用 Flash 给用户返回友好信息, 我们在 application 模板中加入该信息.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;p class=&quot;notice&quot;&gt;&lt;%= notice %&gt;&lt;/p&gt;</span><br><span class="line">&lt;p class=&quot;alert&quot;&gt;&lt;%= alert %&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果你只使用 rails 3.2 部署, 还需要设置一下内容:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.assets.initialize_on_precompile = false</span><br></pre></td></tr></table></figure>
</li>
<li><p>你可以使用 devise 提供的视图</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g devise:views</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>到此为止, 我们已经设定完了.</p>
</blockquote>
<h2 id="使用devise生成Model"><a href="#使用devise生成Model" class="headerlink" title="使用devise生成Model"></a>使用devise生成Model</h2><blockquote>
<p>我们开始使用 devise 写一个小例子吧. 我们来生成一个叫做 <code>User</code> 的Model.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rails g devise User</span><br><span class="line"></span><br><span class="line">invoke  active_record</span><br><span class="line">create    db/migrate/20150204073457_devise_create_users.rb</span><br><span class="line">create    app/models/user.rb</span><br><span class="line">invoke    test_unit</span><br><span class="line">create      test/models/user_test.rb</span><br><span class="line">create      test/fixtures/users.yml</span><br><span class="line">insert    app/models/user.rb</span><br><span class="line">route   devise_for :users</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们来看看user.rb 和 其对应的 migration 文件中看看.</p>
<p>首先在 user.rb 中, 一些module 是被注释掉的.如果你想开启一些功能就需要去掉其注释.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  # Include default devise modules. Others available are:</span><br><span class="line">  # :confirmable, :lockable, :timeoutable and :omniauthable</span><br><span class="line">  devise :database_authenticatable, :registerable,</span><br><span class="line">  ¦ ¦ ¦ ¦:recoverable, :rememberable, :trackable, :validatable</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后再看看这个migration文件, xxx_devise_create_users.rb. 注意看注释部分, 并且结合 user.rb, 比如: <code>Database authenticatable</code> <code>Rememberable</code> 是不是和 user.rb 对应的呢!<br>再比如: 我们在 user.rb 中注释掉了<code>confirmable</code>, 那么在该 migration 中也相应地去掉了这些字段. 也就是程序员没有设定Model 的这些性质, 那么移植文件就不会增加相应字段. 并且, <code>confirmation_token</code> 的add_index 方法也被去掉了.</p>
</blockquote>
<p><strong><em> 如果有空闲时间, 一定要读读这些优秀 gem 的源码, 肯定会对自己很有帮助</em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">class DeviseCreateUsers &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    create_table(:users) do |t|</span><br><span class="line">      ## Database authenticatable</span><br><span class="line">      t.string :email,              null: false, default: &quot;&quot;</span><br><span class="line">      t.string :encrypted_password, null: false, default: &quot;&quot;</span><br><span class="line"></span><br><span class="line">      ## Recoverable</span><br><span class="line">      t.string   :reset_password_token</span><br><span class="line">      t.datetime :reset_password_sent_at</span><br><span class="line"></span><br><span class="line">      ## Rememberable</span><br><span class="line">      t.datetime :remember_created_at</span><br><span class="line"></span><br><span class="line">      ## Trackable</span><br><span class="line">      t.integer  :sign_in_count, default: 0, null: false</span><br><span class="line">      t.datetime :current_sign_in_at</span><br><span class="line">      t.datetime :last_sign_in_at</span><br><span class="line">      t.string   :current_sign_in_ip</span><br><span class="line">      t.string   :last_sign_in_ip</span><br><span class="line"></span><br><span class="line">      ## Confirmable</span><br><span class="line">      # t.string   :confirmation_token</span><br><span class="line">      # t.datetime :confirmed_at</span><br><span class="line">      # t.datetime :confirmation_sent_at</span><br><span class="line">      # t.string   :unconfirmed_email # Only if using reconfirmable</span><br><span class="line"></span><br><span class="line">      ## Lockable</span><br><span class="line">      # t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts</span><br><span class="line">      # t.string   :unlock_token # Only if unlock strategy is :email or :both</span><br><span class="line">      # t.datetime :locked_at</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    add_index :users, :email,                unique: true</span><br><span class="line">    add_index :users, :reset_password_token, unique: true</span><br><span class="line">    # add_index :users, :confirmation_token,   unique: true</span><br><span class="line">    # add_index :users, :unlock_token,         unique: true</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>我们先 migrate.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rake db:migrate</span><br></pre></td></tr></table></figure></p>
<p>然后我们写页面的代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;header&gt;</span><br><span class="line">    &lt;nav&gt;</span><br><span class="line">      &lt;!-- user_signed_in? 判断用户是否已经登录 --&gt;</span><br><span class="line">      &lt;!-- current_user 返回当前已登录的用户--&gt;</span><br><span class="line">      &lt;!-- *_path 使用 User 对象组合而成的, 都是 devise 提供的helper --&gt;</span><br><span class="line">      &lt;% if user_signed_in? %&gt;</span><br><span class="line">        Logged in as &lt;strong&gt;&lt;%= current_user.email %&gt;&lt;/strong&gt;</span><br><span class="line">        &lt;%= link_to &apos;Edit Profile&apos;, edit_user_registration_path %&gt; |</span><br><span class="line">        &lt;%= link_to &apos;Sign Out&apos;, destroy_user_session_path, method: :delete %&gt;</span><br><span class="line">      &lt;% else  %&gt;</span><br><span class="line">        &lt;%= link_to &apos;Sign up&apos;, new_user_registration_path %&gt; |</span><br><span class="line">        &lt;%= link_to &apos;Sign in&apos;, new_user_session_path %&gt;</span><br><span class="line">      &lt;% end %&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line">  &lt;/header&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;notice&quot;&gt;&lt;%= notice %&gt;&lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;alert&quot;&gt;&lt;%= alert %&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;%= yield %&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我偷个懒, 就不传图片了.</p>
</blockquote>
<h2 id="devise-的10个-module"><a href="#devise-的10个-module" class="headerlink" title="devise 的10个 module"></a>devise 的10个 module</h2><blockquote>
<p>下面解释一下user.rb 中这10个 module 到底都有什么作用</p>
</blockquote>
<ul>
<li>Database Authenticatable<br>  为了登录过程中用户认证, 密码经过加密后保存到数据库, 最基本的.</li>
<li>Omniauthable<br>  开放性验证, 比如想用 Facebook Twitter 等账号登录时需要打开.</li>
<li>Confirmable<br>  新用户注册后会通过邮件发送确认链接, 如果不设置该项, 用户注册马上就会登录.</li>
<li>Recoverabl<br>  提供用户忘记密码重置功能.</li>
<li>Registerable<br>  处理用户注册, 同时也允许编辑删除账户.</li>
<li>Rememberable<br>  管理生成和清除记住用户的 token, 从 cookie 中.</li>
<li>Trackable<br>  将用户的登录次数和时间保存到数据库中</li>
<li>Timeoutable<br>  让一段时间内没有活动的 session 失效</li>
<li>Lockable<br>  错误登录一定次数后锁住账号, 可以通过email 或者一段时间后解锁.</li>
</ul>
<h2 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h2><ul>
<li><p><code>before_action :authenticate_user!</code> 不登录无法访问</p>
</li>
<li><p><code>user_signed_in?</code></p>
</li>
<li><p><code>current_user</code></p>
</li>
</ul>
<h2 id="特别鸣谢"><a href="#特别鸣谢" class="headerlink" title="特别鸣谢"></a>特别鸣谢</h2><p><a href="https://github.com/plataformatec/devise" target="_blank" rel="external">plataformatec/devise · GitHub</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/03/install-postgresSQL-osx/" itemprop="url">
                  OSX 下安装PostgresSQL
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-03T15:58:45+08:00" content="2015-02-03">
              2015-02-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/03/install-postgresSQL-osx/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/03/install-postgresSQL-osx/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>一直使用 MySQL 数据库, 感觉很合适, 之前就听说过 PostgresSQL, 就是一直停留在自己的舒适区, 一直都没用鼓起勇气来试试, 今天就要尝试一下, 先写一篇在 OSX 下安装的教程.</p>
</blockquote>
<ul>
<li><p>需要准备 Homebrew, 在命令行中运行:</p>
<blockquote>
<p><code>brew install postgres</code></p>
</blockquote>
</li>
<li>安装完成之后, 我们需要创建一个新的数据库:<blockquote>
<p><code>initdb</code> /usr/local/var/postgres</p>
</blockquote>
</li>
<li>设置系统登录时, 自动后台启动 PostgresSQL  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/Library/LaunchAngents</span><br><span class="line">ln -sfv /usr/local/opt/postgressql/*.plist ~/Library/LaunchAgents</span><br><span class="line">launchctl load ~/Library/LaunchAgents/homebrew.mxcl.postgressql.plist</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="在Rails-中集成-PostgresSQL"><a href="#在Rails-中集成-PostgresSQL" class="headerlink" title="在Rails 中集成 PostgresSQL"></a>在Rails 中集成 PostgresSQL</h2><ul>
<li><p>安装pg gem (并指定其配置文件)</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install pg -- --with-pg-config=/usr/local/bin/pg_config</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 pg 加入到 rails 项目的 Gemfile 中. 然后运行<code>bundle install</code></p>
</li>
<li><p>数据库配置, <code>config/database.yml</code> 指向 Postgres 数据库</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">development:</span><br><span class="line">  adapter: postgresql</span><br><span class="line">  encoding: unicode</span><br><span class="line">  database: myapp_dev</span><br><span class="line">  pool: 5</span><br><span class="line">  username: your_username_on_mac</span><br><span class="line">  password:</span><br><span class="line"></span><br><span class="line">test:</span><br><span class="line">  adapter: postgresql</span><br><span class="line">  encoding: unicode</span><br><span class="line">  database: myapp_test</span><br><span class="line">  pool: 5</span><br><span class="line">  username: your_username_on_mac</span><br><span class="line">  password:</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建数据库<br>  <code>rake db:create:all</code></p>
</li>
<li>移植表<br>  <code>rake db:migrate</code></li>
</ul>
<blockquote>
<p>和MySQL 大体相似, 这只是皮毛的安装过程, 以后会继续深入研究</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/02/import-redis-gracefully/" itemprop="url">
                  优雅地将 Redis 引入你的 Rails 项目(代码重构)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-02T10:45:27+08:00" content="2015-02-02">
              2015-02-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/02/import-redis-gracefully/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/02/import-redis-gracefully/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>上一节我们使用了一个小例子来说明 Redis 在项目中是如何使用的,  我们回顾一下所使用记录文章被浏览次数和访问过该文章的 ip 的集合的这段代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def show</span><br><span class="line">  $redis.incr &quot;#&#123;Date.year&#125;:#&#123;Date.month&#125;:#&#123;Date.day&#125;:posts:@post.id:views&quot;</span><br><span class="line">  $redis.sadd &quot;#&#123;Date.year&#125;:#&#123;Date.month&#125;:#&#123;Date.day&#125;:posts:@post.id:uniques&quot;, request.remote_ip </span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>怎么样? 这代码看起来简单粗暴, 通俗易懂吧, 首先 <code>$redis</code> 全局变量直接写到对外暴露的 action 方法中, 还有那么长的字符串, 乱七八糟, 这两行代码是不是有很多相似之处呢? 我们是不是可以用方法包装一下呢? 这些问题就是这一节需要解决的!</p>
</blockquote>
<h2 id="整理思路"><a href="#整理思路" class="headerlink" title="整理思路"></a>整理思路</h2><blockquote>
<p>我们要写的这个方法是作用是什么? 方法归给谁? 方法的结构应该是什么样的呢?</p>
<p>既然要追踪某文章被访问的情况, 该方法应该属于文章(@post), 假设方法名为<code>track</code>, 该方法的参数应该接收几个参数? 这就要看 <code>incr</code> 和 <code>sadd</code> 这两个方法的具体作用了, <code>incr</code> 接收 的参数作为 redis 内部的 key, 其值为该页面被访问的次数, <code>sadd</code> 接收2个参数, 第一个参数类似于<code>incr</code> 的参数, redis 作为该页面的标志, 同样作为 key, 而第二个参数就有所不同了, 我们传入了访问者的 ip 地址, redis 会将其作为 value. </p>
<p>通过上面的分析, 我们可以确定: 方法形式应该是这样的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def track (:views, [:uniques, request.remote_ip])</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>这样, 我只需要在 show 方法中这样来调用, <code>@post.track(:views, [:uniques, request.remote_ip])</code></p>
</blockquote>
<h2 id="生成-KEY"><a href="#生成-KEY" class="headerlink" title="生成 KEY"></a>生成 KEY</h2><blockquote>
<p>需要说明一点, 我并没有加入前面一长串 key, 因为 key 是一样的, 我想用一个方法来生成 key.</p>
<p>所以我们先生成 key, 在 lib 目录下创建一个文件 <code>analytix.rb</code>, 我为什么选择该目录? 因为在该目录下的文件是被自动加载到 rails 环境中的, 详情请参见<code>config/application.rb</code>. </p>
<p>由于生成 key 这样的方法属于一种功能性方法(我也不会表达了), 所以将其写入 module 比较合适, 然后在 class 中mixin, 就可以给当前对象使用该方法了, 这里确实需要理解 module Mixin 等知识. 我先把方法的大致轮廓写一下, 然后再分析: </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module Analytix</span><br><span class="line"></span><br><span class="line">  module Key</span><br><span class="line">  ¦</span><br><span class="line">  ¦ def self.build_for stat, object</span><br><span class="line">  ¦ ¦</span><br><span class="line">  ¦ end</span><br><span class="line"></span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用这个方法, 我们需要得到 key, 对吧, 像这样:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$redis.incr &quot;#&#123;Date.today.year&#125;:#&#123;Date.today.month&#125;:#&#123;Date.today.day&#125;:posts:#&#123;@post.id&#125;:views&quot;</span><br><span class="line"></span><br><span class="line">$redis.sadd &quot;#&#123;Date.today.year&#125;:#&#123;Date.today.month&#125;:#&#123;Date.today.day&#125;:posts:#&#123;@post.id&#125;:uniques&quot;, request.remote_ip</span><br></pre></td></tr></table></figure></p>
<p>看这两个参数, stat 容易理解, 指的是要追踪的对象, 比如 <code>views</code>, <code>uniques</code> 等等. 那么 <code>object</code> 这个参数指的是什么呢? 指的是资源, 也就是 post, 这点很重要, 我们不能用 hard-coding 把让这个方法只能为 post 生成 key, 假如应用中还有 video 资源, 我们要去追踪某个视频被点播的次数, 难道再写一个为 video 生成 key 的方法吗? 那样的话, 代码就显得太冗余了. (题外话, java 出身的我忽然意识到这很像java 中的反射技术), 我们可以通过 object 动态获得类的相关信息.<br>那么现在既然已经知道了我们需要的结果, 我所期待的, 所以我觉得使用 TDD 比较合适. 所以, 我们在 创建一个 <code>spec/lib/analytix_spec.rb</code> 文件来写测试驱动方法的实现.</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spec/lib/analytix_spec.rb</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'rails_helper'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'spec_helper'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'analytix'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Analytix</span></span></span><br><span class="line">  describe Key <span class="keyword">do</span></span><br><span class="line">  ¦ let(<span class="symbol">:klass_name</span>) &#123; double(<span class="string">"Object"</span>, &#123; <span class="symbol">name:</span> <span class="string">"Post"</span>  &#125;)  &#125;</span><br><span class="line">  ¦ let(<span class="symbol">:post</span>) &#123; double(<span class="string">'Post'</span>, &#123;<span class="symbol">id:</span> <span class="number">1</span>, <span class="class"><span class="keyword">class</span>: <span class="title">klass_name</span>&#125;)  &#125;</span></span><br><span class="line">  ¦ let(<span class="symbol">:date</span>) &#123; Date.today  &#125;</span><br><span class="line"></span><br><span class="line">  ¦ let(<span class="symbol">:views_key</span>) &#123; <span class="string">"<span class="subst">#&#123;date.year&#125;</span>:<span class="subst">#&#123;date.month&#125;</span>:<span class="subst">#&#123;date.day&#125;</span>:posts:1:views"</span>  &#125;</span><br><span class="line"></span><br><span class="line">  ¦ describe <span class="string">"#build_for"</span> <span class="keyword">do</span></span><br><span class="line">  ¦ ¦ it <span class="string">'should create key for :views'</span> <span class="keyword">do</span></span><br><span class="line">  ¦ ¦ ¦ expect(Key.build_for(<span class="symbol">:views</span>, post)).to eq views_key</span><br><span class="line">  ¦ ¦ <span class="keyword">end</span></span><br><span class="line">  ¦ <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后我们写方法实现, 让其测试通过</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'active_support/inflector'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Analytix</span></span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Key</span></span></span><br><span class="line">  ¦</span><br><span class="line">  ¦ <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">build_for</span> <span class="title">stat</span>, <span class="title">object</span></span></span><br><span class="line">  ¦ ¦ date = Date.today</span><br><span class="line">  ¦ ¦ key = [ date.year, date.month, date.day, object.<span class="keyword">class</span>.name.underscore.pluralize, object.id, stat  ].join(<span class="string">':'</span>)</span><br><span class="line">  ¦ <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="实现真正的-track-方法"><a href="#实现真正的-track-方法" class="headerlink" title="实现真正的 track 方法."></a>实现真正的 track 方法.</h2><blockquote>
<p>到此为止, 我们仅仅构造好了 key, build_for 只是个辅助的方法, 那么我们看看最重要的 track 方法的实现.</p>
<p>参数需要被定义成方法, 方法中使用 redis 来存储数据:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">views</span></span></span><br><span class="line">  $redis.incr(Key.build_for(<span class="symbol">:views</span>, <span class="keyword">self</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uniques</span><span class="params">(data)</span></span></span><br><span class="line">  $redis.sadd(Key.build_for(<span class="symbol">:uniques</span>, <span class="keyword">self</span>), data)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>文章开始已经分析过了, 方法应该是这样的<code>track(:views, [:uniques, &#39;127.0.0.1&#39;])</code>, 那么既然是两种类型的参数, 可以使用 ruby 的 splat 进行处理, 这样无论传的是 symbol 还是数组或者两者都有, 都可以接收:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">track</span><span class="params">(*stats)</span></span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>好, <code>track</code> 方法一个如何实现? 首先, 参数是不固定的, 我使用了splat 将参数强行压入数组, 然后在方法内遍历<code>stats</code>, 对每个参数使用 send 来进行动态方法调用, 也就是定义的<code>views</code>, <code>uniques</code>. 思路就是这样, 我们来使用 TDD.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">describe Model do</span><br><span class="line">  let(:klass_name) &#123; double(&quot;Object&quot;, &#123;name: &quot;Post&quot;&#125;) &#125;</span><br><span class="line">  let(:post) &#123; double(&apos;Post&apos;, &#123;id: 1, class: klass_name&#125;).extend(Model) &#125;</span><br><span class="line"></span><br><span class="line">  before do</span><br><span class="line">    keys = $analytix.keys(&apos;*&apos;)</span><br><span class="line">    $analytix.del(keys) if keys.present?</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  describe &quot;#track&quot; do</span><br><span class="line">    it &apos;should return call the correct method when just symbol&apos; do</span><br><span class="line">      post.track(:views).should eq [1]</span><br><span class="line">      post.track(:views).should eq [2]</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    it &apos;should return call the correct method when just array&apos; do</span><br><span class="line">      post.track([:uniques, &apos;127.0.0.1&apos;]).should eq [true]</span><br><span class="line">      post.track([:uniques, &apos;127.0.0.1&apos;]).should eq [false]</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    it &apos;should return mutiple results with multiple stats&apos; do</span><br><span class="line">      post.track(:views, [:uniques, &apos;127.0.0.1&apos;]).should eq [1, true]</span><br><span class="line">      post.track(:views, [:uniques, &apos;127.0.0.1&apos;]).should eq [2, false]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里需要补充关于 <code>$analytix</code> 的知识点, Rails中有3种环境, dev, pro 和 test, 我们需要对不同的环境创建不同的全局变量, 这样才不至于互相干扰. 这时我们需要一个 gem <code>redis-namespace</code>, 通过它, 我可以为 redis 的 key 指定命名空间, 也就是添加前缀, 区别于其他的变量.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r = Redis.new</span><br><span class="line">$analytix = Redis::Namespace.new([Rails.env, &apos;analytics&apos;].join(&apos;:&apos;), redis: r)</span><br></pre></td></tr></table></figure></p>
<p>当然, 这只是个小插曲, 我们来实现 track 方法代码, 让测试通过. 如下:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def track(*stats)</span><br><span class="line"></span><br><span class="line">  stats.each do |stat|</span><br><span class="line">    send(*stat)</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>是不是很巧妙呢! 它可以处理任意个数参数, 不但可以兼容 symbol 类型还可以兼容数组.</p>
<ul>
<li>如果 参数:views, send 直接调用views方法</li>
<li>如果参数是[:uniques, request.remote_ip], 就会组合成这种形式:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send(*[:uniques, request.remote_ip])</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>request.remote_ip 会作为 uniques 方法的参数.</p>
</blockquote>
<h2 id="应用到-controller-中"><a href="#应用到-controller-中" class="headerlink" title="应用到 controller 中"></a>应用到 controller 中</h2><blockquote>
<p>还记得开头我们说<code>PostController#show</code> 中的方法写得太邋遢吗? 看看经过重构之后的 show 方法成什么样了吧!</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># After</span><br><span class="line">def show</span><br><span class="line">  track(:views, [:uniques, request.remote_ip])</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># Before</span><br><span class="line">def show</span><br><span class="line">  $analytix.incr(&quot;#&#123;Date.year&#125;:#&#123;Date.month&#125;:#&#123;Date.day&#125;:posts:@post.id:views&quot;)</span><br><span class="line"></span><br><span class="line">  $analytix.sadd(&quot;#&#123;Date.year&#125;:#&#123;Date.month&#125;:#&#123;Date.day&#125;:posts:@post.id:uniques&quot;, request.remote_ip)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="不足之处"><a href="#不足之处" class="headerlink" title="不足之处"></a>不足之处</h2><blockquote>
<p>我需要表达一下歉意, 实际上在测试部分我介绍的很敷衍, 主要是因为我认为如果写得太过于细致文章主题就不够突出, 会显得很乱. 另外, 我的TDD 水平也不敢恭维, 不过我个人也希望和大家一起切磋, 从中受益. 如果有不理解的地方或是不当之处, 欢迎指正!</p>
<p>我会在近期从项目的源码中抽取一些Redis 的具体应用场合. 精彩还在后面…</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/01/using-redis-in-rails/" itemprop="url">
                  在 Rails 中使用 Redis
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-01T20:51:24+08:00" content="2015-02-01">
              2015-02-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/01/using-redis-in-rails/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/01/using-redis-in-rails/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>我们看看如何将 redis 应用于 Rails 中,  为了说明问题, 我会尽量简化这个 rails 应用.</p>
<p>我们先创建一个 Rails 应用, 然后在 Gemfile 中加入 <code>redis-rails</code>, 然后 bundle 安装.</p>
<p> 既然我们需要向 Redis 中存储数据, 那么就需要有一个 redis 对象, 而且该对象的 作用范围是整个应用, 所以我需要将该 redis 对象 声明为可怕的全局变量! 而且, 在 rails 应用启动时, 就应该存在该 redis 对象, 所以我们这样做:</p>
<blockquote>
<ul>
<li>在 <code>config/initializers/</code> 目录下新建 <code>redis.rb</code> 文件</li>
<li>初始化 redis <code>$redis = Redis.new</code> , 注意我们使用了全局变量.</li>
</ul>
</blockquote>
<p>以上只是前期的准备工作, 那么我们拿 redis 存什么呢? 假设我们现在有 Post (发表的文章) 资源, 我需要记录每篇文章被访问的次数. </p>
<p>为了方便起见, 我使用 scaffold 创建 Post 资源<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g scaffold Post title:string body:text</span><br></pre></td></tr></table></figure></p>
<p>然后我创建一些文章, 既然我们需要记录文章被访问的次数, 很显然, 我需要使用<code>INCR</code> 方法, 我希望在 key 上体现出文章的时间等信息, 所以我注意做:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$redis.incr &quot;#&#123;Date.today.year&#125;:#&#123;Date.today.month&#125;:#&#123;Date.today.day&#125;:posts:#&#123;@post.id&#125;:views&quot;</span><br></pre></td></tr></table></figure></p>
<p>那么这段代码放到什么方法中? 很显然, 既然是记录某篇文章的访问量, 我们应该把它放到 show 方法中. 因为每次文章被访问就是调用 show 方法. 现在去刷新文章, 就会发现该 key 是递增的.</p>
<p>记录某文章有哪些 ip 访问, 这时需要 <code>sadd</code> 方法, 可以理解成一个 key 对应一个集合, 而集合的元素就是 ip, 并且集合元素不可以重复添加.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$redis.sadd &quot;#&#123;Date.today.year&#125;:#&#123;Date.today.month&#125;:#&#123;Date.today.day&#125;:posts:#&#123;@post.id&#125;:uniques&quot;, request.remote_ip</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后你去访问该文章, 再观察文章的 key对应的 value, 就是你机器对应的 ip, 如果你再次刷新, 其也不会重复添加. </p>
<p>但是, 现在还存在一个问题, 这代码太脏, 也就是 DHH 说的 Dirty Code. 我们能不能重构一下这段代码呢? 下一节精彩继续…</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/01/redis-incr-sets/" itemprop="url">
                  Redis 自增
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-01T19:19:54+08:00" content="2015-02-01">
              2015-02-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/01/redis-incr-sets/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/01/redis-incr-sets/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>我们上网常常会看到页面上有一个计数器, ‘该帖子已被浏览 xx 次’, 比如 <a href="http://www.ruby-china.org" target="_blank" rel="external">ruby-china</a>. 如果我们每次都要从数据库里面取这个字段, 那岂不是很耗资源, 因为页面访问量是很大的, 所以放到 redis 中是最好不过了. 那么这一节我们就研究一下 redis 自增的问题.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis.incr &apos;pageviews&apos;</span><br><span class="line">=&gt; 1</span><br><span class="line"></span><br><span class="line">redis.incr &apos;pageviews&apos;</span><br><span class="line">=&gt; 2</span><br></pre></td></tr></table></figure>
<blockquote>
<p>只要调用一次incr 计数器就会增加一次. 还有一个与之相反的方法: decr, 每当调用一次, 就会减少一次.</p>
<p>现实中情况会复杂得很多, 比如某个用户于2015年2月1日发了一个帖子, 那么我们就不能使用 pageviews 这种偷懒的办法来追踪该贴的浏览次数了, 我们需要加入一个时间戳.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.incr &apos;2015:02:01:post:2&apos;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要注意的是, redis 会自动使用<code>:</code> 断开, 一个冒号及其前面的部分看做一个目录, 也就是一层层的目录结构.</p>
<p>有这么一种情况, 某人一直重复刷新一个页面, 再用incr 这个方法的话就不好了, 因为它会一直累加, 论坛管理员肯定不希望这样, 我们需要做的是, 如果来自于某个用户看过了该贴, 他再次刷新时, value 就不可以再增加了. </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis.sadd &apos;2015:01:01:post:3&apos;, &apos;10.0.0.1&apos;</span><br><span class="line">=&gt; true</span><br><span class="line">redis.sadd &apos;2015:01:01:post:3&apos;, &apos;10.0.0.1&apos;</span><br><span class="line">=&gt; false</span><br><span class="line">redis.sadd &apos;2015:01:01:post:3&apos;, &apos;10.0.0.2&apos;</span><br><span class="line">=&gt; true</span><br><span class="line"></span><br><span class="line">redis.smembers &apos;2015:01:01:post:3&apos;</span><br><span class="line">=&gt; [&quot;10.0.0.2&quot;, &quot;10.0.0.1&quot;]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>redis 发现已经被添加后, 就不会再次添加了.</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/01/using-redis-in-ruby/" itemprop="url">
                  OSX 下 ruby/rails 中使用 Redis
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-01T09:03:16+08:00" content="2015-02-01">
              2015-02-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/01/using-redis-in-ruby/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/01/using-redis-in-ruby/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><blockquote>
<p>我打算做一个系列的教程, 关于如何在ruby 中使用 redis 这种 nosql 存储技术. 闲言少叙, 现在开始.</p>
<p>首先, 你需要安装 redis, ruby. 这些不详细介绍了, 另外我还建议安装一个叫做redis-commander  , 启动,  它会监听 8081这个端口, 你可以通过浏览器来查看 redis 中存储的对象了.<br>你还需要安装 redis gem, <code>gem install redis</code>.</p>
</blockquote>
<h2 id="简单入门"><a href="#简单入门" class="headerlink" title="简单入门"></a>简单入门</h2><blockquote>
<p>好, 那么我们就开始 hello world 吧! </p>
</blockquote>
<ul>
<li>运行 irb.  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">require &apos;redis&apos;</span><br><span class="line">=&gt; true</span><br><span class="line"></span><br><span class="line">redis = Redis.new</span><br><span class="line"></span><br><span class="line">=&gt; #&lt;Redis client v3.2.0 for redis://127.0.0.1:6379/0&gt;</span><br><span class="line"></span><br><span class="line">redis.get &apos;hello&apos;</span><br><span class="line">=&gt; &quot;world&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>是不是很简单呢?  我们存入了 K-V 对.<br>在 redis 中, 就相当于这样: </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set hello world</span><br><span class="line">get hello</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然 redis 可以做的不只是这些, 我们试试往redis 的 list 中存入元素吧!</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">fruits = [ <span class="string">'apple'</span>, <span class="string">'orange'</span>, <span class="string">'banana'</span> ]</span><br><span class="line"></span><br><span class="line">fruits.each <span class="keyword">do</span> <span class="params">|fruit|</span></span><br><span class="line">  redis.lpush <span class="string">'fruits'</span>, fruit</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>我先定义了一个数组 fruits, 然后遍历数组, 将每个元素存入 redis, 这里注意我使用的方法 <code>lpush</code> , 指left push, 就是每个元素从左边依次插入, 所以在 redis 的fruits 这个 list 中, 最后加入的banana 的索引为0, 而最先进入的 apple 索引为3. </p>
<p>那么你可能会说如果我想要颠倒这个顺序插入该怎么办, 很简单, 只需使用 redis 提供的 rpush 这个方法. 它会将元素加入 redis list 的右边.</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[ <span class="string">'watermenlon'</span>, <span class="string">'mongo'</span> ].each <span class="keyword">do</span> <span class="params">|fruit|</span></span><br><span class="line">  redis.rpush <span class="string">'fruits'</span>, fruit</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>如何遍历redis 中的 list ? </p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">redis.lrange <span class="string">'fruits'</span>, <span class="number">0</span>, -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">=&gt; [<span class="string">"banana"</span>, <span class="string">"orange"</span>, <span class="string">"apple"</span>, <span class="string">"watermelon"</span>, <span class="string">"mongo"</span>]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从返回这个数组的元素的排列顺序不难看出 <code>lpush</code>, <code>rpush</code> 的插入顺序.</p>
</blockquote>
<h2 id="how-fast"><a href="#how-fast" class="headerlink" title="how fast"></a>how fast</h2><blockquote>
<p>让我们来看看, redis 存取数据到底有多快</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">st = Time.now; 1000.times &#123;|i| redis.rpush(&quot;tweets&quot;, &quot;tweet #&#123;i&#125;&quot;) &#125;; et = Time.now;</span><br><span class="line"></span><br><span class="line">et - st</span><br><span class="line">=&gt; 0.096875</span><br><span class="line"></span><br><span class="line">st = Time.now; 10000.times &#123;|i| redis.rpush(&quot;tweets&quot;, &quot;tweet #&#123;i&#125;&quot;) &#125;; et = Time.now;</span><br><span class="line"></span><br><span class="line">et - st</span><br><span class="line">=&gt; 0.929873</span><br><span class="line"></span><br><span class="line"># 遍历数据</span><br><span class="line">st = Time.now; redis.lrange &quot;tweets&quot;, 0, 10000 ; et = Time.now;</span><br><span class="line">et -st </span><br><span class="line">=&gt; 0.063555</span><br><span class="line"></span><br><span class="line"># remove tweets</span><br><span class="line">redis.del &apos;tweets&apos;</span><br><span class="line"></span><br><span class="line"># 确认一下是否移除</span><br><span class="line"></span><br><span class="line">redis.llen &apos;tweets&apos;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们向 redis 的 list 中存入1000条数据, 一个用时不到0.1 秒. 存10000条数据不过在1秒左右, 由于 Redis 是一种基于内存的存储, 相比较写入硬盘的数据库, 就非常非常快了.</p>
</blockquote>
<h2 id="存储结构化数据"><a href="#存储结构化数据" class="headerlink" title="存储结构化数据"></a>存储结构化数据</h2><blockquote>
<p>在实际的项目中, 我们往往需要保存各种各样的结构化数据, 比如保存一个类的对象, hash .这样的数据如何保存到 redis 中? </p>
<p>你很可能会这样做:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">some_hash = &#123;id: 1, user: &quot;daniel&quot;, time: Time.now&#125;</span><br><span class="line"></span><br><span class="line">=&gt; &#123;:id=&gt;1, :user=&gt;&quot;daniel&quot;, :time=&gt;2015-02-01 12:49:38 +0800&#125;</span><br><span class="line"></span><br><span class="line">redis.set &apos;msg&apos;, some_hash</span><br><span class="line"></span><br><span class="line">redis.get &apos;msg&apos;</span><br><span class="line"></span><br><span class="line">=&gt; &quot;&#123;:id=&gt;1, :user=&gt;\&quot;daniel\&quot;, :time=&gt;2015-02-01 12:49:38 +0800&#125;&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>看出什么问题了吗? 我们放进去的是 hash, 但是取出来的却是字符串!</p>
<p>想同样返回 hash 对象, 我们可以”曲线救国” 将 hash先转成 JSON 对象, 然后在存入 redis 中.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">redis.set &apos;msg_1&apos;, some_hash.to_json</span><br><span class="line"></span><br><span class="line">JSON.parse(redis.get(&apos;msg_1&apos;))</span><br><span class="line"></span><br><span class="line">=&gt; &#123;&quot;id&quot;=&gt;1, &quot;user&quot;=&gt;&quot;daniel&quot;, &quot;time&quot;=&gt;&quot;2015-02-01 12:49:38 +0800&quot;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>还有一种办法, 就是我们可以使用 redis 专门为这类hash 结构的数据提供的方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis.hmset &apos;test3&apos;, :id, 1, :user, &apos;daniel&apos;</span><br><span class="line">redis.hmget &apos;test3&apos;, :id</span><br><span class="line">=&gt; [&quot;1&quot;]</span><br><span class="line"></span><br><span class="line">redis.hmget &apos;test3&apos;, :id, :user</span><br><span class="line">=&gt; [&quot;1&quot;, &quot;daniel&quot;]</span><br><span class="line"></span><br><span class="line">redis.hgetall &apos;test3&apos;</span><br><span class="line">=&gt; &#123;&quot;id&quot;=&gt;&quot;1&quot;, &quot;user&quot;=&gt;&quot;daniel&quot;&#125; # 注意我们 symbol 被转换成了 string</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们还可以使用映射式的存取方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis.mapped_hmset &apos;test4&apos;, some_hash</span><br><span class="line"></span><br><span class="line">redis.mapped_hmget &apos;test4&apos;, :user</span><br><span class="line">=&gt; &#123;:user=&gt;&quot;daniel&quot;&#125;</span><br><span class="line"></span><br><span class="line">redis.hgetall &apos;test4&apos;</span><br><span class="line">=&gt; &#123;&quot;id&quot;=&gt;&quot;1&quot;, &quot;user&quot;=&gt;&quot;daniel&quot;, &quot;time&quot;=&gt;&quot;2015-02-01 12:49:38 +0800&quot;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用-redis-存储推文"><a href="#使用-redis-存储推文" class="headerlink" title="使用 redis 存储推文"></a>使用 redis 存储推文</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tweet = &#123;id: 1, user: &apos;daniel&apos;, time: Time.now, body: &apos;Good morning!&apos;&#125;</span><br><span class="line">redis.set &apos;msg_1&apos;, tweet.to_json</span><br><span class="line">redis.rpush &apos;home_1&apos;, &apos;msg_1&apos;</span><br><span class="line"></span><br><span class="line">tweet = &#123;id: 2, user: &apos;daniel&apos;, time: Time.now, body: &apos;I had a good lunch&apos;&#125;</span><br><span class="line">redis.set &apos;msg_2&apos;, tweet.to_json</span><br><span class="line">redis.rpush &apos;home_1&apos;, &apos;msg_2&apos;</span><br><span class="line"></span><br><span class="line">tweet = &#123;id: 3, user: &apos;daniel&apos;, time: Time.now, body: &apos;Its too late, I gotta go to bed!!!&apos;&#125;</span><br><span class="line">redis.set &apos;msg_3&apos;, tweet.to_json</span><br><span class="line">redis.rpush &apos;home_1&apos;, &apos;msg_3&apos;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Daniel 一天发了三条推文, 然后我们使用将其转化为 json 对象, 使用 msg作为 key 存入 redis, 最后把这些 key 放入一个 list 中.<br>那么我们要想显示这些推文该怎么办呢? </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">home_timeline = redis.lrange(&apos;home_1&apos;, -100, -1).map do |key|</span><br><span class="line">  JSON.parse(redis.get key)</span><br><span class="line">end.reverse</span><br><span class="line"></span><br><span class="line">home_timeline.each do |tweet|</span><br><span class="line">  puts &quot;#&#123;tweet[&apos;user&apos;]&#125; | #&#123;tweet[&apos;body&apos;]&#125; (#&#123;tweet[&apos;time&apos;]&#125;)&quot;</span><br><span class="line">end</span><br><span class="line"> # 打印的结果 </span><br><span class="line">daniel | Its too late, I gotta go to bed!!! (2015-02-01 16:26:51 +0800)</span><br><span class="line">daniel | I had a good lunch (2015-02-01 16:24:22 +0800)</span><br><span class="line">daniel | Good morning! (2015-02-01 16:21:44 +0800)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个例子模拟了显示推文. 最晚的应该在前面, 所以我使用了 reverse.</p>
</blockquote>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><blockquote>
<p>上面的例子还有可以改进之处</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 之前的代码 </span><br><span class="line">redis.lrange(&quot;home_1&quot;, -100, -1).map&#123;|key| JSON.parse(redis.get key)&#125; </span><br><span class="line"></span><br><span class="line"># 改进的方法</span><br><span class="line">keys = redis.lrange(&apos;home_1&apos;, -100, -1)</span><br><span class="line">redis.mget(*keys).map&#123; |value| JSON.parse(value) &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>看出为什么后面的方法要更好一些了吗?  前半部分都一样, 从 list 中拿出 key, 而后半部分就不同了, 前者去拿到了 key 的列表, 分别拿列表的元素到 redis 中拿对于的值(推文信息) , 而后者来得更直接, 通过 <code>mget</code> 方法, 通过 key 直接取出了对于的 value, 所以效率更好些.</p>
</blockquote>
<p>=========== 这一节先到这里 =================</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/30/solr-config/" itemprop="url">
                  Config Solr in Linux
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-01-30T14:15:48+08:00" content="2015-01-30">
              2015-01-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Solr/" itemprop="url" rel="index">
                    <span itemprop="name">Solr</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/01/30/solr-config/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/01/30/solr-config/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>这个简短的教程描述了如何在 Ubuntu Server 上安装 Solr 4，我使用的版本是：Ubuntu Server 12.04 和 Apache Solr 4.0-BETA. 我同时将展示如何测试安装以及执行一个简单的索引和查询任务。</p>
<p>在 Ubuntu 12.04 LTS 上安装 Tomcat</p>
</blockquote>
<ol>
<li>安装包</li>
</ol>
<p>1    apt-get install tomcat6 curl</p>
<ol>
<li><p>从 <a href="http://lucene.apache.org/solr" target="_blank" rel="external">http://lucene.apache.org/solr</a> 上下载 Solr 4 (写文章是的最新版本是 apache-solr-4.0.0-BETA.tgz)</p>
</li>
<li><p>为 solr 选择一个目录，并使用 SOLR_HOME 环境变量指向这个目录，我这里选择的是 /opt/solr ，因此我的 SOLR_HOME=/opt/solr. 如果你想选择不同的目录请替换 /opt/solr</p>
</li>
<li><p>解压缩文件并复制到 $SOLR_HOME:</p>
</li>
</ol>
<p>复制 example/solr/* 到 /opt/solr<br>复制 example/webapps/solr.war 到 /opt/solr</p>
<ol>
<li>编辑 /opt/solr/collection1/conf/solrconfig.xml 中的 dataDir 配置项</li>
</ol>
<p>1    <datadir>${solr.data.dir:/opt/solr/data}</datadir></p>
<ol>
<li>为 Solr 创建数据目录，并给 tomcat 设置可读写权限</li>
</ol>
<p>1    % mkdir /opt/solr/data<br>2    % sudo chown tomcat6 /opt/solr/data<br>下面是我的 /opt/solr 目录的结构：</p>
<p>$ tree -d ├── bin<br>├── collection1<br>│   └── conf<br>│       ├── lang<br>│       ├── velocity<br>│       └── xslt<br>└── data</p>
<ol>
<li>在 Tomcat 中设置新的 context （web应用程序）并指向我们的 solr 文件，只需要在创建文件/etc/tomcat6/Catalina/localhost/solr.xml ，内容如下:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;Context docBase=&quot;/opt/solr/solr.war&quot; debug=&quot;0&quot; crossContext=&quot;true&quot;&gt;</span><br><span class="line">&lt;Environment name=&quot;solr/home&quot; type=&quot;java.lang.String&quot; value=&quot;/opt/solr&quot;override=&quot;true&quot;/&gt;</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure>
<ol>
<li>重启 tomcat</li>
</ol>
<p><code>/etc/init.d/tomcat6 restart</code></p>
<p>这是引用网上的教程，基本就是这样子，还需要补充的就是多和配置，需要配置的solr HOME 的solr.xml文件 ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;solr persistent=&quot;true&quot;&gt;</span><br><span class="line">        &lt;!-- by default, this is 50 @ WARN</span><br><span class="line">  &lt;logging enabled=&quot;true&quot;&gt;</span><br><span class="line">        &lt;watcher size=&quot;100&quot; threshold=&quot;INFO&quot; /&gt;</span><br><span class="line">  &lt;/logging&gt;</span><br><span class="line">   --&gt;</span><br><span class="line">  &lt;!--</span><br><span class="line">  adminPath: RequestHandler path to manage cores.</span><br><span class="line">    If &apos;null&apos; (or absent), cores will not be manageable via request handler</span><br><span class="line">  defaultCoreName: (optional) core to use when no core name is specified in an access url</span><br><span class="line">  All of the attributes in cores after defaultCoreName only apply when running in SolrCloud mode.</span><br><span class="line">  You can read more about SolrCloud mode at http://wiki.apache.org/solr/SolrCloud</span><br><span class="line">  --&gt;</span><br><span class="line">  &lt;cores adminPath=&quot;/admin/cores&quot; defaultCoreName=&quot;collection1&quot; host=&quot;$&#123;host:&#125;&quot; hostPort=&quot;$&#123;jetty.port:&#125;&quot; hostContext=&quot;$&#123;hostContext:&#125;&quot; zkClientTimeout=&quot;$&#123;zkClientTimeout:15000&#125;&quot;&gt;</span><br><span class="line">    &lt;core name=&quot;collection1&quot; instanceDir=&quot;collection1&quot; /&gt;</span><br><span class="line">     &lt;core name=&quot;activity_logs&quot; instanceDir=&quot;/opt/cores/solr/cores/activity_logs&quot; dataDir=&quot;/opt/cores/solr/data/activity_logs&quot;/&gt;</span><br><span class="line">      &lt;core name=&quot;bhl&quot; instanceDir=&quot;/opt/cores/solr/cores/bhl&quot; dataDir=&quot;/opt/cores/solr/data/bhl&quot;/&gt;</span><br><span class="line">      &lt;core name=&quot;collection_items&quot; instanceDir=&quot;/opt/cores/solr/cores/collection_items&quot; dataDir=&quot;/opt/cores/solr/data/collection_items&quot;/&gt;</span><br><span class="line">      &lt;core name=&quot;data_objects&quot; instanceDir=&quot;/opt/cores/solr/cores/data_objects&quot; dataDir=&quot;/opt/cores/solr/data/data_objects&quot;/&gt;</span><br><span class="line">      &lt;core name=&quot;hierarchy_entries&quot; instanceDir=&quot;/opt/cores/solr/cores/hierarchy_entries&quot; dataDir=&quot;/opt/cores/solr/data/hierarchy_entries&quot;/&gt;</span><br><span class="line">      &lt;core name=&quot;hierarchy_entry_relationship&quot; instanceDir=&quot;/opt/cores/solr/cores/hierarchy_entry_relationship&quot; dataDir=&quot;/opt/cores/solr/data/hierarchy_entry_relationship&quot;/&gt;</span><br><span class="line">      &lt;core name=&quot;site_search&quot; instanceDir=&quot;/opt/cores/solr/cores/site_search&quot; dataDir=&quot;/opt/cores/solr/data/site_search&quot;/&gt;</span><br><span class="line">      &lt;core name=&quot;taxon_concepts&quot; instanceDir=&quot;/opt/cores/solr/cores/taxon_concepts&quot; dataDir=&quot;/opt/cores/solr/data/taxon_concepts&quot;/&gt;</span><br><span class="line">  &lt;/cores&gt;</span><br><span class="line">&lt;/solr&gt;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/30/mysql-multiple-instances/" itemprop="url">
                  MySQL 多实例 配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-01-30T13:50:48+08:00" content="2015-01-30">
              2015-01-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/01/30/mysql-multiple-instances/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/01/30/mysql-multiple-instances/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>创建 mysql的数据目录 mkdir -p /data/mysqldata3304</li>
<li>编辑apparmor (一种安全软件)： 添加 <figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/data/mysqldata3304/ r,</span><br><span class="line"><span class="regexp">/data/mysqldata</span>3304/** rwk,</span><br><span class="line"><span class="regexp">/data/mysqldata</span>3304/mysql3304.sock w,</span><br><span class="line"><span class="regexp">/data/mysqldata</span>3304/mysql3304.pid rw,</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>保存 退出 重启 apparmor</p>
<ol>
<li><p>创建my_multi.cnf ,配置 新的实例.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysqld4]</span><br><span class="line">socket = <span class="regexp">/data/mysqldata</span>3304/mysql3304.sock</span><br><span class="line">port = <span class="number">3304</span></span><br><span class="line">pid-file = <span class="regexp">/data/mysqldata</span>3304/mysql3304.pid</span><br><span class="line">datadir = <span class="regexp">/data/mysqldata</span>3304/</span><br><span class="line">user = root</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化该实例</p>
</li>
</ol>
<p><code>mysql_install_db --datadir=/data/mysqldata3304/ —basedir=/...</code></p>
<ol>
<li>启动这个实例</li>
</ol>
<p><code>mysqld_multi --defaults-file=/etc/mysql/my_multi.cnf start 4</code></p>
<ol>
<li>查看实例的运行</li>
</ol>
<p><code>mysqld_multi --defaults-file=/etc/mysql/my_multi.cnf report</code></p>
<ol>
<li>使用 socke登录</li>
</ol>
<p><code>mysql -S /data/mysqldata3304/mysql3304.sock</code></p>
<ol>
<li>查看mysql的运行状态 netstat -ln | grep mysql</li>
</ol>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/30/mysql-master-slave/" itemprop="url">
                  mysql 做master 和 slave 总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-01-30T13:11:30+08:00" content="2015-01-30">
              2015-01-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/01/30/mysql-master-slave/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/01/30/mysql-master-slave/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p> 环境: 我使用的环境是Ubuntu Linux, 一台服务器用87指代，作为master，另外一台用89指代，作为slave</p>
</blockquote>
<ol>
<li>安装MySQL，这里就不细说。不过需要强调的是87我使用的是多实例的MySQL，本例中使用的实例是3308端口</li>
<li>配置master<br>① 编辑 my.cnf(my_multi.cnf) ,首先取消ip绑定 注释掉 bind-address = 127.0.0.1<br>② server-id = 1<br>③ log_bin = /var/log/mysql-bin.log # 该文件保存了master的变化，slave会拷贝所有这些变化<br>④ binlog_do_db = newdb # 指定需要同步的数据库</li>
</ol>
<ol>
<li>重启MySQL sudo service mysql restart</li>
<li><p>登录MySQL  mysql -uroot -p</p>
</li>
<li><p>为slave数据库服务器的用户（slave_user）赋予同步权限,并刷新权限<br><code>grant replication slave on *.* to ‘slave_user’@‘%’ identified by ‘root’;
flush privileges;</code></p>
</li>
<li><p>切换到需要同步的数据库</p>
</li>
</ol>
<p><code>use newdb;</code></p>
<ol>
<li><p>为表加上只读锁，这样做的目的是防止导出数据库的过程中表被更改.<br><code>flush tables with read lock;</code></p>
</li>
<li><p>查看master的状态<br><code>show master status;</code></p>
</li>
</ol>
<p><code>mysql&gt; SHOW MASTER STATUS;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">| mysql-bin.000001 |      107 | newdatabase  |                  |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br></pre></td></tr></table></figure>
<blockquote>
<p>记住这个表中的数据，因为接下来配置slave的时候会用得到</p>
</blockquote>
<ol>
<li><p>退回shell，导出数据库<br><code>mysql -u root -p --opt newdb &gt; newdatabase.sql</code></p>
</li>
<li><p>回到mysql，解锁表</p>
</li>
</ol>
<p><code>unlock tables;</code><br><code>quit;</code></p>
<h3 id="设置slave-（89）服务器"><a href="#设置slave-（89）服务器" class="headerlink" title="设置slave （89）服务器"></a>设置slave （89）服务器</h3><ol>
<li>登录到mysql，创建这个数据库。退回到shell</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create database newdb; </span><br><span class="line">exit;</span><br></pre></td></tr></table></figure>
<ol>
<li>导出数据库</li>
</ol>
<p><code>mysql -uroot -p newdb &lt; /path/to/newdatabase.sql</code></p>
<p>这里需要说明，newdatabse.sql 是由87传过来的，是由scp这个工具，用法自己去google</p>
<ol>
<li>编辑my.cnf</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server-id = 2</span><br><span class="line">relay-log = /var/log/mysql/mysql-relay-bin.log</span><br><span class="line">log_bin = /var/log/mysql/mysql-bin.log</span><br><span class="line">binlog_do_db = newdb</span><br></pre></td></tr></table></figure>
<ol>
<li><p>重启 mysql.</p>
</li>
<li><p>登录到mysql. 执行:</p>
</li>
</ol>
<p><code>change master to master_host=&#39;159.226.67.87&#39;, master_user=&#39;daniel&#39;,master_password=&#39;123456&#39;,master_port=3308,master_log_file=&#39;mysql-bin.000006&#39;,master_log_pos=633;</code></p>
<p>这里需要注意一点，master_port需要根据自己的具体实例的端口来填写 然后可以start salve</p>
<ol>
<li>master 配置如下:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mysqld2]</span><br><span class="line">socket     = /Data/mysqlcnd/mysqlcn/mysqldcn3308.sock</span><br><span class="line">port       = 3308</span><br><span class="line">pid-file   = /Data/mysqlcnd/mysqlcn/mysqldcn3308.pid</span><br><span class="line">datadir    = /Data/mysqlcnd/mysqlcn/</span><br><span class="line">#datadir    = /Data/newdb/data/mysql/</span><br><span class="line">log-bin    = /Data/mysqlcnd/mysqlcn/mysql-bin.log</span><br><span class="line">server-id  = 1</span><br><span class="line">binlog_do_db  = testmirror</span><br><span class="line">binlog_format=mixed</span><br><span class="line">log        = /Data/mysqlcnd/mysqlcn/mysql-bin.000001</span><br><span class="line">log-error  = /Data/mysqlcnd/mysqlcn/mysqlcn3308.err</span><br><span class="line">user       = daniel</span><br></pre></td></tr></table></figure>
<p>slave 配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server-id               = 2</span><br><span class="line">relay-log               = /var/log/mysql/mysql-reply-bin.log</span><br><span class="line">log_bin                 = /var/log/mysql/mysql-bin.log</span><br><span class="line">binlog_do_db            = testmirror</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/30/rails-data-read-write-seperate/" itemprop="url">
                  Rails 实现数据库读写分离
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-01-30T12:44:17+08:00" content="2015-01-30">
              2015-01-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/01/30/rails-data-read-write-seperate/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/01/30/rails-data-read-write-seperate/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>我厂领导突然产生了一个奇妙的想法, 他想让我把美国master 的数据库在中国的 slave 做成读写分离的模式, 但是网站跑起来就会产生日志, 一样会修改本地的 slave. 从而阻止 master 同步, 数据库一旦停止同步, 美国那边就得重新来弄. sigh … </p>
<p>废话少说, 这就是命令, 顺便也能学到一些知识:</p>
<h3 id="所使用环境："><a href="#所使用环境：" class="headerlink" title="所使用环境："></a>所使用环境：</h3><ul>
<li>Ubuntu Linux，Mac，Rails 3.2.18 ，MySQL数据库。还有这个 gem, octopus gem <a href="https://github.com/tchandy/octopus" target="_blank" rel="external">https://github.com/tchandy/octopus</a> 。</li>
</ul>
</blockquote>
<ol>
<li><p>MySQL分别安装在了Mac和Linux上，Mac的MySQL作为写入数据库，而Linux的作为读取数据库，这两个数据库并未同步。</p>
</li>
<li><p>在Rails 项目的config目录下新建文件 shards.xml,该文件用于保存Linux下MySQL read数据库, 该文件长成这个样子：</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">octopus:</span></span><br><span class="line"><span class="attr">  replicated:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  fully_replicated:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  environments:</span></span><br><span class="line"><span class="bullet">   -</span> development</span><br><span class="line"><span class="bullet">   -</span> production</span><br><span class="line"></span><br><span class="line"><span class="attr">  development:</span></span><br><span class="line"><span class="attr">    slave1:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="number">159.226</span><span class="number">.67</span><span class="number">.89</span></span><br><span class="line"><span class="attr">      adapter:</span> mysql2</span><br><span class="line"><span class="attr">      database:</span> testmirror</span><br><span class="line"><span class="attr">      username:</span> root</span><br><span class="line"><span class="attr">      password:</span> root</span><br><span class="line"><span class="attr">  production:</span></span><br><span class="line"><span class="attr">    slave1:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="number">159.226</span><span class="number">.67</span><span class="number">.89</span></span><br><span class="line"><span class="attr">      adapter:</span> mysql2</span><br><span class="line"><span class="attr">      database:</span> testmirror</span><br><span class="line"><span class="attr">      username:</span> root</span><br><span class="line"><span class="attr">      password:</span> root</span><br></pre></td></tr></table></figure>
<ol>
<li><p>rails c （指定开发环境）</p>
<blockquote>
<p>Post.using(:slave1).count 指定读取的数据库查询</p>
</blockquote>
</li>
<li><p>需说明一点：rails 会将database.yml中配置的数据库作为写数据库 查询使用 Post.using(:master).count</p>
</li>
</ol>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Daniel Zhang" />
          <p class="site-author-name" itemprop="name">Daniel Zhang</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">105</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">104</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Daniel Zhang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"danielhexo"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
