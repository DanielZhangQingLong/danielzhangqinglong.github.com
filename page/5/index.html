<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'uSvyVbAJs-5jfXFawgQ3','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/06/rails-create-and-test-API/" itemprop="url">
                  Rails 创建API和测试API
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-06T08:53:31+08:00" content="2015-03-06">
              2015-03-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/06/rails-create-and-test-API/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/06/rails-create-and-test-API/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本文主要讲解Rails中创建JSON格式的API及API的测试方法, Rails是通过使用一个叫做<code>jbuilder</code>的gem提供的<code>to_json</code>方法来返回JSON格式的API的.<br>同样也使用RSpec3来测试API</p>
</blockquote>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><blockquote>
<p>scaffolding Product并且创建Category Model, 并使其具备多对一的关系.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rails g scaffold Product name:string price:integer category_id:integer</span><br><span class="line">rails g model Category name</span><br><span class="line"></span><br><span class="line"># app/models/category.rb</span><br><span class="line">class Category &lt; ActiveRecord::Base</span><br><span class="line">  has_many :products</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">  # app/models/product.rb</span><br><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :category</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="生成API"><a href="#生成API" class="headerlink" title="生成API"></a>生成API</h2><h3 id="Controller中返回HTML-JSON等API"><a href="#Controller中返回HTML-JSON等API" class="headerlink" title="Controller中返回HTML JSON等API"></a>Controller中返回HTML JSON等API</h3><blockquote>
<p>既然是返回给客户端(浏览器), 那么就需要使用Controller的<code>respond_to</code>方法.<br>首先根据管理设置routing:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># config/routes.rb</span><br><span class="line">Rails.application.routes.draw do</span><br><span class="line">  resources :products</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>确认路由:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ bin/rake routes</span><br><span class="line">  Prefix Verb   URI Pattern                  Controller#Action</span><br><span class="line">  products GET    /products(.:format)          products#index</span><br><span class="line">  POST   /products(.:format)          products#create</span><br><span class="line">  new_product GET    /products/new(.:format)      products#new</span><br><span class="line">  edit_product GET    /products/:id/edit(.:format) products#edit</span><br><span class="line">  product GET    /products/:id(.:format)      products#show</span><br><span class="line">  PATCH  /products/:id(.:format)      products#update</span><br><span class="line">  PUT    /products/:id(.:format)      products#update</span><br><span class="line">  DELETE /products/:id(.:format)      products#destroy</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后在使用<code>respond_to</code>方法, 返回相应的格式.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class ProductsController &lt; ApplicationController</span><br><span class="line">  def index</span><br><span class="line">    @products = Product.all</span><br><span class="line"></span><br><span class="line">    respond_to do |format|</span><br><span class="line">      format.html # 请求为一般url时, 返回index.html.erb</span><br><span class="line">      format.json &#123;render json: @products&#125; # 请求url为json时, 返回@products.to_json</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>默认返回HTML给浏览器, 如果请求/products.json, 就会返回<code>@products</code>的json格式给浏览器</p>
<p><code>to_json</code>方法可以简单地将model转成json格式, 请注意: 这里我是通过在Controller中将json数据放入response中通过URL返回的, 这里只返回了一种model对象, 如果需要返回几种有关联的model, 这样的处理方法就不可取了.<br>这时我们可以使用<code>jbuilder</code>处理器来返回json格式的内容, 我们需要创建以单独的jbuilder视图文件:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># app/views/products/index.json.jbuilder</span><br><span class="line">json.array!(@products) do |product|</span><br><span class="line">  json.extract! product, :id, :name, :price, :publised_at, :category_id</span><br><span class="line">  json.url product_url(product, format: :json)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在Controller中返回相应的格式:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">respond_to do |format|</span><br><span class="line">  format.html # app/views/products/index.html.erb</span><br><span class="line">  format.json # app/views/products/index.json.jbuilder</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后我们在浏览器中请求<code>/products.json</code>, 会返回jbuilder定义的json数据:</p>
</blockquote>
<p><img src="http://i3.tietuku.com/3536abf6dc3355e3.png" alt=""></p>
<blockquote>
<p>参考自<a href="https://github.com/rails/jbuilder" target="_blank" rel="external">https://github.com/rails/jbuilder</a></p>
</blockquote>
<h3 id="只返回json格式"><a href="#只返回json格式" class="headerlink" title="只返回json格式"></a>只返回json格式</h3><blockquote>
<p>首先在routing中添加<code>namespace :api { format: &#39;json&#39; }</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># config/routes.rb</span><br><span class="line">Rails.application.routes.draw do</span><br><span class="line">  namespace :api, &#123; format: &apos;json&apos; &#125; do</span><br><span class="line">    resources :products</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>rake routes</code> :</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ rake routes</span><br><span class="line">  Prefix Verb   URI Pattern                      Controller#Action</span><br><span class="line">  api_products GET    /api/products(.:format)          api/products#index &#123;:format=&gt;&quot;json&quot;&#125;</span><br><span class="line">  POST   /api/products(.:format)          api/products#create &#123;:format=&gt;&quot;json&quot;&#125;</span><br><span class="line">  new_api_product GET    /api/products/new(.:format)      api/products#new &#123;:format=&gt;&quot;json&quot;&#125;</span><br><span class="line">  edit_api_product GET    /api/products/:id/edit(.:format) api/products#edit &#123;:format=&gt;&quot;json&quot;&#125;</span><br><span class="line">  api_product GET    /api/products/:id(.:format)      api/products#show &#123;:format=&gt;&quot;json&quot;&#125;</span><br><span class="line">  PATCH  /api/products/:id(.:format)      api/products#update &#123;:format=&gt;&quot;json&quot;&#125;</span><br><span class="line">  PUT    /api/products/:id(.:format)      api/products#update &#123;:format=&gt;&quot;json&quot;&#125;</span><br><span class="line">  DELETE /api/products/:id(.:format)      api/products#destroy &#123;:format=&gt;&quot;json&quot;&#125;</span><br><span class="line">  .....</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样就通过命名空间的方法将通常Controller和API Controller区别开来, 而且, 由于设置了<code>{ format: &#39;json&#39;  }</code>即便是我们在url(/products)不添加<code>.json</code>后缀, 也会默认返回json格式的数据.</p>
<p>然后创建命名空间的Controller, 需要<code>app/controllers/api/products_controller.rb</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/api/products_controller.rb</span><br><span class="line">module Api</span><br><span class="line">  class ProductsController &lt; ApplicationController</span><br><span class="line"></span><br><span class="line">    def index</span><br><span class="line">      @products = Product.all</span><br><span class="line">      render json: @products</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="API-版本"><a href="#API-版本" class="headerlink" title="API 版本"></a>API 版本</h3><blockquote>
<p>实际上就是再套一层namespace, Controller多加一层module和目录.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Rails.application.routes.draw do</span><br><span class="line"></span><br><span class="line">  namespace :api, &#123; format: &apos;json&apos;  &#125; do</span><br><span class="line">    namespace :v2 do</span><br><span class="line">      resources :products</span><br><span class="line">    end</span><br><span class="line">    namespace :v1 do</span><br><span class="line">      resources :products</span><br><span class="line">    end</span><br><span class="line">    end</span><br><span class="line">  resources :products</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Controller:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/api/v1/products_controller.rb</span><br><span class="line">module Api</span><br><span class="line">  module V1</span><br><span class="line">    class ProductsController &lt; ApplicationController</span><br><span class="line">      def index</span><br><span class="line">        @products = Product.all</span><br><span class="line">        render json: @products</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/controllers/api/v2/products_controller.rb</span><br><span class="line">module Api</span><br><span class="line">  module V2</span><br><span class="line">    class ProductsController &lt; ApplicationController</span><br><span class="line">      def index</span><br><span class="line">        @products = Product.all</span><br><span class="line">        render json: @products</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="API-测试"><a href="#API-测试" class="headerlink" title="API 测试"></a>API 测试</h2><h3 id="生成测试文件"><a href="#生成测试文件" class="headerlink" title="生成测试文件"></a>生成测试文件</h3><blockquote>
<p>关于API 的测试我们使用<code>spec/requests</code>, 因为如果使用<code>spec/controllers</code>测试验证返回值是很困难的, 使用<code>spec/features</code>又需要启动Capybara, 会占用很长的时间, 具体请参见<a href="http://www.relishapp.com/rspec/rspec-rails/docs/request-specs/request-spec" target="_blank" rel="external">http://www.relishapp.com/rspec/rspec-rails/docs/request-specs/request-spec</a></p>
<p>生成RSpec的请求测试文件:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rails g rspec:integration Product</span><br><span class="line"></span><br><span class="line">  identical  spec/requests/products_spec.rb</span><br></pre></td></tr></table></figure>
<h2 id="index-API的测试"><a href="#index-API的测试" class="headerlink" title="index API的测试"></a>index API的测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">require &apos;rails_helper&apos;</span><br><span class="line"></span><br><span class="line">RSpec.describe &quot;Products&quot;, type: :request do</span><br><span class="line"></span><br><span class="line">  describe &quot;GET /products.json&quot; do</span><br><span class="line">    before do</span><br><span class="line">      @products = FactoryGirl.create_list(:product, 3)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    it &quot;get the list in json&quot; do</span><br><span class="line">      get products_path format: :json</span><br><span class="line"></span><br><span class="line">      expect(response.status).to eq 200</span><br><span class="line"></span><br><span class="line">      # JSON</span><br><span class="line">      json = JSON.parse(response.body)</span><br><span class="line">      expect(json.size).to eq @products.count</span><br><span class="line">      expect(json[0][&quot;id&quot;]).to eq @products[0].id # 注意json[0][:id]的写法是错误的</span><br><span class="line">      expect(json[0][&quot;name&quot;]).to eq @products[0].name</span><br><span class="line">      expect(json[1][&quot;id&quot;]).to eq @products[1].id </span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Controller:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/products_controller.rb</span><br><span class="line">class ProductsController &lt; ApplicationController</span><br><span class="line">  # GET /products</span><br><span class="line">  # GET /products.json</span><br><span class="line">  def index</span><br><span class="line">    @products = Product.all</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># index.json.jbuilder</span><br><span class="line">json.array!(@products) do |product|</span><br><span class="line">  json.extract! product, :id, :name, :price</span><br><span class="line">  json.url product_url(product, format: :json)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="show-API的测试"><a href="#show-API的测试" class="headerlink" title="show API的测试"></a>show API的测试</h3><blockquote>
<p>测试:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># spec/requests/products_spec.rb</span><br><span class="line">  describe  &quot;GET /products/:id.json&quot; do</span><br><span class="line">    before do</span><br><span class="line">      @product = FactoryGirl.create(:product)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    it &quot;gets specified product&quot; do</span><br><span class="line">      get product_path(@product, format: :json)</span><br><span class="line"></span><br><span class="line">      expect(response.status).to eq 200</span><br><span class="line"></span><br><span class="line">      json = JSON.parse(response.body)</span><br><span class="line"></span><br><span class="line">      expect(json[&quot;id&quot;]).to eq @product.id</span><br><span class="line">      expect(json[&quot;name&quot;]).to eq @product.name</span><br><span class="line">    end</span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Controller:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># show</span><br><span class="line">def show</span><br><span class="line">  @product = Product.find(params[:id])</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># show.json.jbuilder</span><br><span class="line">json.extract! @product, :id, :name, :price, :publised_at, :category_id, :created_at, :updated_at</span><br></pre></td></tr></table></figure>
<h3 id="create-update-的测试"><a href="#create-update-的测试" class="headerlink" title="create/update 的测试"></a>create/update 的测试</h3><blockquote>
<p>这两个基本相同, 以create为例</p>
<p>测试:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># spec/requests/products_spec.rb</span><br><span class="line"># test create/update product</span><br><span class="line"># POST请求也会给浏览器一个响应, 重点就是要测试post请求后, 是否得到了成功的响应</span><br><span class="line">describe &quot;POST /products.json&quot; do</span><br><span class="line">  it &quot;creates new product&quot; do</span><br><span class="line"></span><br><span class="line">    params = &#123; product: FactoryGirl.attributes_for(:product) &#125; </span><br><span class="line">    # 测试product的数量是否增加了1</span><br><span class="line">    expect &#123;</span><br><span class="line">      post products_path(format: :json), params</span><br><span class="line">    &#125;.to change &#123; Product.count &#125;.from(0).to(1)</span><br><span class="line"></span><br><span class="line">    # status code is 201 (post)</span><br><span class="line">    expect(response.status).to eq 201</span><br><span class="line"></span><br><span class="line">    # JSON ( the same as show )</span><br><span class="line">    json = JSON.parse(response.body)</span><br><span class="line">    expect(json[&quot;name&quot;]).to eq params[:product][:name]</span><br><span class="line">    expect(json[&quot;price&quot;]).to eq params[:product][:price]</span><br><span class="line"></span><br><span class="line">    # current url location test</span><br><span class="line">    expect(response.location).to eq product_url(Product.last)</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>Controller:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># POST /products</span></span><br><span class="line"><span class="comment"># POST /products.json</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span></span></span><br><span class="line">  @product = Product.new(product_params)</span><br><span class="line"></span><br><span class="line">  respond_to <span class="keyword">do</span> <span class="params">|format|</span></span><br><span class="line">    <span class="keyword">if</span> @product.save</span><br><span class="line">      format.html &#123; redirect_to @product, <span class="symbol">notice:</span> <span class="string">'Product was successfully created.'</span> &#125;</span><br><span class="line">      format.json &#123; render <span class="symbol">:show</span>, <span class="symbol">status:</span> <span class="symbol">:created</span>, <span class="symbol">location:</span> @product &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      format.html &#123; render <span class="symbol">:new</span> &#125;</span><br><span class="line">      format.json &#123; render <span class="symbol">json:</span> @product.errors, <span class="symbol">status:</span> <span class="symbol">:unprocessable_entity</span> &#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># show.json.jbuilder</span></span><br><span class="line">json.extract! @product, <span class="symbol">:id</span>, <span class="symbol">:name</span>, <span class="symbol">:price</span>, <span class="symbol">:publised_at</span>, <span class="symbol">:category_id</span>, <span class="symbol">:created_at</span>, <span class="symbol">:updated_at</span></span><br></pre></td></tr></table></figure>
<h2 id="destroy的测试"><a href="#destroy的测试" class="headerlink" title="destroy的测试"></a>destroy的测试</h2><blockquote>
<p>测试:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># test destroy</span><br><span class="line">describe &quot;DELETE /products/:id.json&quot; do</span><br><span class="line">    before do</span><br><span class="line">      @product = FactoryGirl.create(:product)</span><br><span class="line">    end</span><br><span class="line">  it &quot;deletes a product&quot; do</span><br><span class="line"></span><br><span class="line">    # Product count should decrease by 1</span><br><span class="line">    expect &#123;</span><br><span class="line">      delete product_path(@product, format: :json)</span><br><span class="line">    &#125;.to change &#123; Product.count &#125;.by(-1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # state code should be 204</span><br><span class="line">    expect(response.status).to eq 204</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>Controller:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DELETE /products/1</span></span><br><span class="line"><span class="comment"># DELETE /products/1.json</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destroy</span></span></span><br><span class="line">  @product.destroy</span><br><span class="line">  respond_to <span class="keyword">do</span> <span class="params">|format|</span></span><br><span class="line">    format.html &#123; redirect_to products_url, <span class="symbol">notice:</span> <span class="string">'Product was successfully destroyed.'</span> &#125;</span><br><span class="line">    format.json &#123; head <span class="symbol">:no_content</span> &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/05/debug/" itemprop="url">
                  Rails Debug
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-05T20:50:33+08:00" content="2015-03-05">
              2015-03-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/05/debug/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/05/debug/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="视图debug"><a href="#视图debug" class="headerlink" title="视图debug"></a>视图debug</h2><blockquote>
<p>视图内可以使用<code>debug</code>方法来表示参数的值:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 页面打印出@products的值</span><br><span class="line">&lt;%= debug @products %&gt;</span><br><span class="line"></span><br><span class="line"># 打印params对象的值</span><br><span class="line">&lt;%= debug params %&gt;</span><br><span class="line"></span><br><span class="line"># 其他还有 session、headers、params、flash、request、response</span><br></pre></td></tr></table></figure>
<blockquote>
<p>只在development环境下表示这些对象的值:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= debug params if Rails.env.development? %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Model和Controller-debug"><a href="#Model和Controller-debug" class="headerlink" title="Model和Controller debug"></a>Model和Controller debug</h2><blockquote>
<p>Model和Controller与视图不同, 不能在页面上显示, 但是可以使用<code>logger.debug</code>方法, 在log文件中查看:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger.debug &quot;New article #&#123;@article.attributes.inspect&#125;&quot;</span><br></pre></td></tr></table></figure>
<h2 id="断点调试"><a href="#断点调试" class="headerlink" title="断点调试"></a>断点调试</h2><blockquote>
<p>使用pry-debug这个gem, 可以进行断点调试, 需要安装下面的gem</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line">group :development, :test do</span><br><span class="line">  gem &apos;pry-rails&apos; # 使用pry代替irb作为rails的console</span><br><span class="line">  gem &apos;pry-doc&apos; # 方法表示</span><br><span class="line">  gem &apos;pry-byebug&apos;</span><br><span class="line">  gem &apos;pry-stack_explorer&apos;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">$ bundle install</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后我可以在View, Controller, Model等代码中使用<code>&lt;% binding.pry %&gt;</code>设置断点:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># app/views/users/show.html.erb</span><br><span class="line">2:</span><br><span class="line">3: &lt;p&gt;</span><br><span class="line">4:   &lt;strong&gt;Name:&lt;/strong&gt;</span><br><span class="line">5:   &lt;%= @user.name %&gt;</span><br><span class="line">6:   &lt;% binding.pry %&gt;</span><br><span class="line">=&gt;  7: &lt;/p&gt;</span><br><span class="line">8:</span><br><span class="line">9: &lt;p&gt;</span><br><span class="line">10:   &lt;strong&gt;Age:&lt;/strong&gt;</span><br><span class="line">11:   &lt;%= @user.age %&gt;</span><br><span class="line">12: &lt;/p&gt;</span><br><span class="line"></span><br><span class="line">[1] pry(#&lt;#&lt;Class:0x007f9b68cf9918&gt;&gt;)&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我可以交互命令行中查看变量的内容:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">=&gt; #&lt;User:0x007f9b6b92b9f0</span><br><span class="line">id: 1,</span><br><span class="line">name: &quot;daniel&quot;,</span><br><span class="line">age: 23,</span><br><span class="line">created_at: Thu, 05 Mar 2015 23:49:49 UTC +00:00,</span><br><span class="line">updated_at: Thu, 05 Mar 2015 23:49:49 UTC +00:00&gt;</span><br><span class="line">[2] pry(#&lt;#&lt;Class:0x007f9b68cf9918&gt;&gt;)&gt; @user.name</span><br><span class="line">=&gt; &quot;daniel&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我还可以通过下面4个命令来移动程序的执行</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">exit # 跳转到下一个断点</span><br><span class="line">step: Step execution into the next line or method. Takes an optional numeric argument to step multiple times.</span><br><span class="line"></span><br><span class="line">next: Step over to the next line within the same frame. Also takes an optional numeric argument to step multiple lines.</span><br><span class="line"></span><br><span class="line">finish: Execute until current stack frame returns.</span><br><span class="line"></span><br><span class="line">continue: Continue program execution and end the Pry session.</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/05/spring-load-test-file/" itemprop="url">
                  使用Spring缩短测试文件的载入时间
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-05T15:27:12+08:00" content="2015-03-05">
              2015-03-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/05/spring-load-test-file/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/05/spring-load-test-file/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Spring从Rails4.1开始已经成了”标配”, 我们在命令行敲入命令时, 由于Rails中有各种各样的library需要进行加载, 会增加命令执行的时间, 尤其是在测试的时候, 会严重影响开发效率. Spring扮演的角色是preloader-预加载器, 它事先在后台加载这些library, 以缩短敲入命令后的等待时间.</p>
</blockquote>
<h2 id="创建Rails项目"><a href="#创建Rails项目" class="headerlink" title="创建Rails项目"></a>创建Rails项目</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rails new spring_test</span><br><span class="line">cd spring_test</span><br><span class="line"></span><br><span class="line">rails g scaffold User firstname:string lastname:string email:string</span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
<h2 id="安装Spring"><a href="#安装Spring" class="headerlink" title="安装Spring"></a>安装Spring</h2><blockquote>
<p>由于我使用的Rails版本是4.1本身就已经安装了Spring.<br>如果使用的Rails版本没有安装Spring, 可以进行如下操作:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line"></span><br><span class="line"># Spring speeds up development by keeping your application running in the background. Read more: https://github.com/rails/spring</span><br><span class="line">gem &apos;spring&apos;,        group: :development</span><br><span class="line"></span><br><span class="line">$ bundle install</span><br><span class="line"></span><br><span class="line"># 生成bin/spring 可执行文件</span><br><span class="line">bundle exec spring binstub --all</span><br><span class="line"></span><br><span class="line"># 向 `bin/rails`和`bin/rake`添加加载spring的代码</span><br><span class="line">begin</span><br><span class="line">load File.expand_path(&quot;../spring&quot;, __FILE__)</span><br><span class="line">  rescue LoadError</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="Spring使用说明"><a href="#Spring使用说明" class="headerlink" title="Spring使用说明"></a>Spring使用说明</h2><blockquote>
<p>查看Spring运行状态</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bin/spring status</span><br><span class="line">Spring is running.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>停止/启动 spring:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ spring stop / spring start</span><br></pre></td></tr></table></figure>
<h2 id="spring使用前后用时对比"><a href="#spring使用前后用时对比" class="headerlink" title="spring使用前后用时对比"></a>spring使用前后用时对比</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 使用spring</span><br><span class="line">bin/rake test  0.09s user 0.01s system 18% cpu 0.548 total</span><br><span class="line"># 未使用spring</span><br><span class="line">bin/rake test  0.09s user 0.01s system 4% cpu 2.077 total</span><br></pre></td></tr></table></figure>
<h2 id="将spring功能加入rspec-cucumber等命令"><a href="#将spring功能加入rspec-cucumber等命令" class="headerlink" title="将spring功能加入rspec, cucumber等命令"></a>将spring功能加入rspec, cucumber等命令</h2><blockquote>
<p>RSpec和Cucumber的方法都是一样的, 这里以RSpec为例</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line"></span><br><span class="line">gem &quot;spring-commands-rspec&quot;, group: :development</span><br><span class="line"></span><br><span class="line">$ bundle install</span><br></pre></td></tr></table></figure>
<blockquote>
<p>停止Spring:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/spring stop</span><br></pre></td></tr></table></figure>
<blockquote>
<p>向rspec命令中添加载入spring的代码:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ spring binstub --all</span><br><span class="line">* bin/rake: spring already present</span><br><span class="line">* * bin/rspec: generated with spring</span><br><span class="line">* * bin/rails: spring already present</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这时候查看bin/rspec会发现多了这样一段代码:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin</span><br><span class="line">  load File.expand_path(&quot;../spring&quot;, __FILE__)</span><br><span class="line">rescue LoadError</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="删除spring"><a href="#删除spring" class="headerlink" title="删除spring"></a>删除spring</h2><blockquote>
<p>从项目中删除spring:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/spring binstub --remove --all</span><br></pre></td></tr></table></figure>
<blockquote>
<p>删除gem:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## Gemfile</span><br><span class="line"></span><br><span class="line"># 注释掉</span><br><span class="line"># gem &apos;spring&apos;,        group: :development</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>bundle install</code></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/05/guard-livereload/" itemprop="url">
                  guard-livereload 自动重新加载页面
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-05T14:02:13+08:00" content="2015-03-05">
              2015-03-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/05/guard-livereload/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/05/guard-livereload/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>guard-livereload 追踪View文件, 当其发生变化的时候, 会重新加载浏览器.</p>
</blockquote>
<h2 id="创建Rails项目"><a href="#创建Rails项目" class="headerlink" title="创建Rails项目"></a>创建Rails项目</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rails new guard_test</span><br><span class="line">cd guard_test</span><br><span class="line">rails g scaffold Product name:string price:integer discontinued:boolean</span><br><span class="line"></span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
<h2 id="安装guard-livereload"><a href="#安装guard-livereload" class="headerlink" title="安装guard-livereload"></a>安装guard-livereload</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line">group :development do</span><br><span class="line">  gem &apos;guard-livereload&apos;, require: false</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">$ bundle install</span><br></pre></td></tr></table></figure>
<h2 id="初始化Guardfile"><a href="#初始化Guardfile" class="headerlink" title="初始化Guardfile"></a>初始化Guardfile</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bundle exec guard init livereload</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们可以通过Guardfile来查看哪些文件被Guard追踪.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># A sample Guardfile</span><br><span class="line"># More info at https://github.com/guard/guard#readme</span><br><span class="line"></span><br><span class="line">guard &apos;livereload&apos; do</span><br><span class="line">  watch(%r&#123;app/views/.+\.(erb|haml|slim)$&#125;)</span><br><span class="line">  watch(%r&#123;app/helpers/.+\.rb&#125;)</span><br><span class="line">  watch(%r&#123;public/.+\.(css|js|html)&#125;)</span><br><span class="line">  watch(%r&#123;config/locales/.+\.yml&#125;)</span><br><span class="line">  # Rails Assets Pipeline</span><br><span class="line">  watch(%r&#123;(app|vendor)(/assets/\w+/(.+\.(css|js|html|png|jpg))).*&#125;) &#123; |m| &quot;/assets/#&#123;m[3]&#125;&quot;  &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>要想实现变更视图文件后浏览器自动刷新, 还需要向浏览器中安装扩展插件, 访问<a href="http://feedback.livereload.com/knowledgebase/articles/86242-how-do-i-install-and-use-the-browser-extensions-" target="_blank" rel="external">改地址</a>你可以下载到Safari, Chrome, Firefox这3种浏览器扩展插件</p>
<p>安装完成后, 执行<code>bundle exec guard</code>, 再启动服务器<code>rails s</code>.<br>访问<code>http://localhost:3000/products</code>, 会看到:</p>
</blockquote>
<p><img src="http://i3.tietuku.com/b54469a60c35a1e6.png" alt=""></p>
<blockquote>
<p>然后, 修改该页面的视图文件<code>app/views/products/index.html.erb</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;!-- 添加 --&gt;</span><br><span class="line">&lt;h2 style=&quot;color:red;&quot;&gt;I added some text&lt;/h2&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>保存, 切换到浏览器, 不要刷新, 观察到页面已经发生变化:</p>
</blockquote>
<p><img src="http://i3.tietuku.com/3b90ce8d59c51fb1.png" alt=""></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a href="https://github.com/guard/guard" target="_blank" rel="external">https://github.com/guard/guard</a></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/05/rspec-guard/" itemprop="url">
                  Rails使用guard和rspec自动测试
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-05T12:21:03+08:00" content="2015-03-05">
              2015-03-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/05/rspec-guard/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/05/rspec-guard/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>guard可以检测出spec文件是否发生改变, 自动进行相应RSpec用例测试.</p>
</blockquote>
<h2 id="创建rails项目-添加RSpec"><a href="#创建rails项目-添加RSpec" class="headerlink" title="创建rails项目, 添加RSpec"></a>创建rails项目, 添加RSpec</h2><blockquote>
<p>这一部分我略写, 只提供代码和必要的注释</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ rails new test_guard skip-unit-test</span><br><span class="line">cd test_guard</span><br><span class="line"></span><br><span class="line"># Gemfile</span><br><span class="line"></span><br><span class="line">group :development, :test do</span><br><span class="line">  gem &apos;rspec-rails&apos;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">$ bundle</span><br><span class="line"></span><br><span class="line">rails g rspec:install</span><br><span class="line">create  .rspec</span><br><span class="line">create  spec</span><br><span class="line">create  spec/spec_helper.rb</span><br><span class="line">create  spec/rails_helper.rb</span><br><span class="line"></span><br><span class="line"># .rspec</span><br><span class="line"></span><br><span class="line">--color</span><br><span class="line">--require spec_helper</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接下来创建Product Scaffolding.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rails g scaffold Product name:string price:integer discontinued:boolean</span><br><span class="line"></span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>运行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rspec</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Finished in 0.27292 seconds (files took 2.15 seconds to load)</span><br><span class="line">30 examples, 0 failures, 17 pending</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="导入guard-rspec"><a href="#导入guard-rspec" class="headerlink" title="导入guard-rspec"></a>导入guard-rspec</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line"></span><br><span class="line">group :development do</span><br><span class="line">  gem &apos;guard-rspec&apos;, require: false # 使用guard启动rspec</span><br><span class="line">  gem &apos;terminal-notifier-guard&apos; # 测试完成后 osx右上角会显示一个通知, 前提: brew install terminal-notifier</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">$ bundle install</span><br></pre></td></tr></table></figure>
<blockquote>
<p>生成Guardfile</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ guard init rspec</span><br></pre></td></tr></table></figure>
<blockquote>
<p>该文件会追踪所有的测试文件及被测试的文件, 一旦发生改变, 会自动运行相应的测试用例</p>
<p>最后启动guard: <code>bundle exec guard</code>, 修改文件测试会自动执行, 无需手动执行测试.</p>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<p><a href="https://github.com/guard/guard-rspec" target="_blank" rel="external">guard/guard-rspec · GitHub</a></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/05/rspec-speedup/" itemprop="url">
                  RSpec测试提速方法总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-05T09:16:01+08:00" content="2015-03-05">
              2015-03-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/05/rspec-speedup/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/05/rspec-speedup/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在TDD/BDD开发中, 测试是一个比较耗时的过程, 本文将对提高测试速度的方法进行总结:</p>
</blockquote>
<h2 id="RSpec的性能测试"><a href="#RSpec的性能测试" class="headerlink" title="RSpec的性能测试"></a>RSpec的性能测试</h2><blockquote>
<p>首先必须了解执行完一组测试后, 测试用时多少, 哪些测试最慢.<br>执行<code>rspec -p</code>命令, 我可以了解到最慢的十个测试用例<code>Top 10 slowest examples</code>, 最慢的10个测试用例组<code>Top 10 slowest example groups</code>, 知道这些信息以后, 我可以有针对性的对这些测试用例进行加速.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ rspce -p</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Finished in 0.67808 seconds (files took 2.55 seconds to load)</span><br><span class="line"></span><br><span class="line">Top 10 slowest examples (0.27127 seconds, 40.0% of total time):</span><br><span class="line">UsersController routing routes to #show</span><br><span class="line">0.05689 seconds ./spec/routing/users_routing_spec.rb:14</span><br><span class="line">orders/edit renders the edit order form</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Top 10 slowest example groups:</span><br><span class="line">orders/edit</span><br><span class="line">0.05224 seconds average (0.05224 seconds / 1 example) ./spec/views/orders/edit.html.erb_spec.rb:3</span><br><span class="line">products/edit</span><br><span class="line">0.02615 seconds average (0.02615 seconds / 1 example) ./spec/views/products/edit.html.erb_spec.rb:3</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="使用test-queue并行测试"><a href="#使用test-queue并行测试" class="headerlink" title="使用test-queue并行测试"></a>使用test-queue并行测试</h2><blockquote>
<p><a href="https://github.com/tmm1/test-queue" target="_blank" rel="external">test-queue</a>这个gem.</p>
</blockquote>
<h2 id="使用rspec-guard自动测试"><a href="#使用rspec-guard自动测试" class="headerlink" title="使用rspec-guard自动测试"></a>使用rspec-guard自动测试</h2><blockquote>
<p>rspec-guard可以自动测试修改过的测试, 具体请参见我的<a href="/2015/03/05/rspec-guard/">Rails使用guard和rspec自动测试</a>一文</p>
</blockquote>
<h2 id="使用Spring缩短测试文件的载入时间"><a href="#使用Spring缩短测试文件的载入时间" class="headerlink" title="使用Spring缩短测试文件的载入时间"></a>使用Spring缩短测试文件的载入时间</h2><blockquote>
<p>详细内容请参见<a href="/2015/03/05/spring-load-test-file/">使用Spring缩短测试文件的载入时间</a></p>
</blockquote>
<h2 id="修改log级别"><a href="#修改log级别" class="headerlink" title="修改log级别"></a>修改log级别</h2><blockquote>
<p>development和test环境下默认log级别为<code>:debug</code>, 由于我们一般不会去关注test环境下的log, 所以可以调整为<code>:error</code>级别, 这样会产生更少的log,减少IO输出, 提高测试速度</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># config/environments/test.rb</span><br><span class="line"></span><br><span class="line"># Setting of a Log Level</span><br><span class="line">config.log_level = :error</span><br></pre></td></tr></table></figure>
<h2 id="推迟GC的执行"><a href="#推迟GC的执行" class="headerlink" title="推迟GC的执行"></a>推迟GC的执行</h2><blockquote>
<p> 让ruby没隔15秒执行一次GC:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class DeferredGarbageCollection</span><br><span class="line"></span><br><span class="line">DEFERRED_GC_THRESHOLD = (ENV[&apos;DEFER_GC&apos;] || 15.0).to_f</span><br><span class="line"></span><br><span class="line">@@last_gc_run = Time.now</span><br><span class="line"></span><br><span class="line">def self.start</span><br><span class="line">GC.disable if DEFERRED_GC_THRESHOLD &gt; 0</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">def self.reconsider</span><br><span class="line">if DEFERRED_GC_THRESHOLD &gt; 0 &amp;&amp; Time.now - @@last_gc_run &gt;= DEFERRED_GC_THRESHOLD</span><br><span class="line">GC.enable</span><br><span class="line">GC.start</span><br><span class="line">GC.disable</span><br><span class="line">@@last_gc_run = Time.now</span><br><span class="line">end</span><br><span class="line">end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>让rspec使用自定义的GC</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config.before(:all) do</span><br><span class="line">DeferredGarbageCollection.start</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">config.after(:all) do</span><br><span class="line">DeferredGarbageCollection.reconsider</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这时候运行测试会使用自定义的GC, 我们也可以更改这个临界值:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEFER_GC=20 rake spec</span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考自<a href="https://ariejan.net/2011/09/24/rspec-speed-up-by-tweaking-ruby-garbage-collection/" target="_blank" rel="external">https://ariejan.net/2011/09/24/rspec-speed-up-by-tweaking-ruby-garbage-collection/</a></p>
</blockquote>
<h2 id="通过重构RSpec测试文件来加速测试"><a href="#通过重构RSpec测试文件来加速测试" class="headerlink" title="通过重构RSpec测试文件来加速测试"></a>通过重构RSpec测试文件来加速测试</h2><h3 id="减少it的使用"><a href="#减少it的使用" class="headerlink" title="减少it的使用"></a>减少<code>it</code>的使用</h3><blockquote>
<p>测试使用it最重要的目的就是找出哪里出了问题, 这样具有更好的可读性, 可是一个测试中包含许多<code>it</code>的话, 就会需要占用很多时间, 因为每次执行it都先要去执行前面的before block.<br>那么如何在”可读性”和”测试执行时间”这两者之间权衡呢?我觉得应该这样考虑:</p>
</blockquote>
<ul>
<li>单元测试(Model, Controller)这种不需要太多的before准备, 或者即使需要before也很轻量级, 这种情况应该考虑可读性, 也就是尽量多使用it, 尽可能避免合并</li>
<li>如Features这种end2end(集成)测试, 由于需要模拟浏览器, 比如访问地址, 点击链接等等, 这些比较重量级的before准备会消耗很多时间, 所以尽量合并it</li>
</ul>
<blockquote>
<p>如下面的代码:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">before do</span><br><span class="line">  fill_in ...</span><br><span class="line">  fill_in ...</span><br><span class="line">  click_button ...</span><br><span class="line"></span><br><span class="line">  it &quot;...&quot; do</span><br><span class="line">    expect(page).to have_content &quot;...&quot;</span><br><span class="line">  end</span><br><span class="line">  it &quot;...&quot; do</span><br><span class="line">    expect(page).to have_content &quot;...&quot;</span><br><span class="line">  end</span><br><span class="line">  it &quot;...&quot; do</span><br><span class="line">    expect(page).to have_content &quot;...&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>改成下面这样会更好:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">before do</span><br><span class="line">  fill_in ...</span><br><span class="line">  fill_in ...</span><br><span class="line">  click_button ...</span><br><span class="line"></span><br><span class="line">  it &quot;...&quot; do</span><br><span class="line">    expect(page).to have_content &quot;...&quot;</span><br><span class="line">    expect(page).to have_content &quot;...&quot;</span><br><span class="line">    expect(page).to have_content &quot;...&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="用build-stubbed代替create"><a href="#用build-stubbed代替create" class="headerlink" title="用build_stubbed代替create"></a>用<code>build_stubbed</code>代替<code>create</code></h2><blockquote>
<p>另一个占用测试时间的因素是访问数据库, 因为发生了磁盘的读写操作, 我们知道磁盘的读写速度远远低于内存, 所以在测试Model时, 使用FactoryGirl的<code>build_stubbed</code>方法代替<code>create</code>方法就可以避免对数据库操作, 可以提高速度</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">RSpec.describe LineItem, :type =&gt; :model do</span><br><span class="line">  describe &quot;#total_price&quot; do</span><br><span class="line">    let(:product)   &#123; create(:product, price: 100) &#125;</span><br><span class="line">    let(:line_item) &#123; create(:line_item, product: product, quantity: quantity)  &#125;</span><br><span class="line"></span><br><span class="line">    subject &#123; line_item.total_price  &#125;</span><br><span class="line"></span><br><span class="line">    context &quot;quantity = 0&quot; do</span><br><span class="line">      let(:quantity) &#123; 0  &#125;</span><br><span class="line">      it &#123; is_expected.to eq 0  &#125;</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    context &quot;quantity = 1&quot; do</span><br><span class="line">      let(:quantity) &#123; 1  &#125;</span><br><span class="line">      it &#123; is_expected.to eq 100  &#125;</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    context &quot;quantity = 2&quot; do</span><br><span class="line">      let(:quantity) &#123; 2  &#125;</span><br><span class="line">      it &#123; is_expected.to eq 200  &#125;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>下面的方法会更好</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RSpec.describe LineItem, :type =&gt; :model do</span><br><span class="line">  describe &quot;#total_price&quot; do</span><br><span class="line">    let(:product)   &#123; build_stubbed(:product, price: 100) &#125;</span><br><span class="line">    let(:line_item) &#123; build_stubbed(:line_item, product: product, quantity: quantity)  &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/04/test-js-with-jasmine/" itemprop="url">
                  Rails中使用Jasmine测试javascript
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-04T21:09:31+08:00" content="2015-03-04">
              2015-03-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/04/test-js-with-jasmine/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/04/test-js-with-jasmine/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本篇文章讲解如何使用jasmine对javascript进行单元测试, 我们知道controller, Model都有相应的单元测试, jasmine就是针对javascript及其衍生的语言如coffeescript进行单元测试的. 在rails中, 添加<code>jasmine-rails</code>这个gem来使用jasmine.<br>前一篇文章中不难发现, Rails中也提供了js测试的方案, 比如capybara-webkit, 但是capybara-webkit会启动虚拟的浏览器而占用时间, 所以使用这种针对js 单元测试的方法还是很有必要的</p>
</blockquote>
<h2 id="安装jasmine-rails"><a href="#安装jasmine-rails" class="headerlink" title="安装jasmine-rails"></a>安装jasmine-rails</h2><blockquote>
<p>添加到Gemfile中:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line"></span><br><span class="line">group :development, :test do</span><br><span class="line">  gem &apos;jasmine-rails&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>bundle install</p>
<p>安装gem以后, 生成相关的文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rails g jasmine_rails:install</span><br><span class="line">  identical  spec/javascripts/support/jasmine.yml</span><br><span class="line">         route  mount JasmineRails::Engine =&gt; &apos;/specs&apos; if defined?(JasmineRails)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面的命令创建了 jasmine的设置文件spec/javascripts/support/jasmine.yml. 该文件描述了javascript(coffeescript)文件的路径, jasmine测试文件的路径等.</p>
</blockquote>
<h2 id="简单介绍jasmine的使用方法"><a href="#简单介绍jasmine的使用方法" class="headerlink" title="简单介绍jasmine的使用方法"></a>简单介绍jasmine的使用方法</h2><blockquote>
<p>首先创建测试文件spec/javascripts/foo_spec.js.coffee. jasmine的语法和RSpec的语法类似:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Foo&quot; -&gt;</span><br><span class="line">  beforeEach -&gt;</span><br><span class="line">    @foo = new Foo(&quot;Daniel&quot;)</span><br><span class="line"></span><br><span class="line">  it &quot;is first test&quot;, -&gt;</span><br><span class="line">    expect(@foo.greet()).toBe &quot;hello, Daniel&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>实现js代码:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class @Foo -&gt;</span><br><span class="line">  constructor: (name) -&gt;</span><br><span class="line">    @name = name</span><br><span class="line"></span><br><span class="line">  greet: -&gt;</span><br><span class="line">    &quot;hello, #&#123;@name&#125;&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>运行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RAILS_ENV=test bundle exec rake spec:javascript</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Finished</span><br><span class="line">-----------------</span><br><span class="line">1 spec, 0 failures in 0.003s.</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="jasmine可以使用的matcher"><a href="#jasmine可以使用的matcher" class="headerlink" title="jasmine可以使用的matcher"></a>jasmine可以使用的matcher</h2><blockquote>
<p>类似于RSpec, jasmine也提供了matcher, 具体内容请参见<a href="http://jasmine.github.io/2.0/introduction.html" target="_blank" rel="external">http://jasmine.github.io/2.0/introduction.html</a></p>
</blockquote>
<h2 id="jquery支持-TODO"><a href="#jquery支持-TODO" class="headerlink" title="jquery支持 #TODO"></a>jquery支持 #TODO</h2><blockquote>
<p>jasmine-jquery为jasmine JavaScript测试框架扩展了下面的功能:</p>
</blockquote>
<ul>
<li>为jquery提供了一些定制化的matcher</li>
<li>提供了处理HTML, CSS和JSON的API</li>
</ul>
<blockquote>
<p>具体方法请参见<a href="https://github.com/velesin/jasmine-jquery" target="_blank" rel="external">https://github.com/velesin/jasmine-jquery</a></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/03/rspec-capybara-cheatsheet/" itemprop="url">
                  RSpec Capybara 方法总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-03T19:21:03+08:00" content="2015-03-03">
              2015-03-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/03/rspec-capybara-cheatsheet/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/03/rspec-capybara-cheatsheet/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Rspec-Matcher"><a href="#Rspec-Matcher" class="headerlink" title="Rspec Matcher"></a>Rspec Matcher</h2><h3 id="判断值是否相等"><a href="#判断值是否相等" class="headerlink" title="判断值是否相等"></a>判断值是否相等</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(actual).to eq expected</span><br><span class="line">expect(actual).not_to eq expected</span><br></pre></td></tr></table></figure>
<h3 id="判断是否为同一对象"><a href="#判断是否为同一对象" class="headerlink" title="判断是否为同一对象"></a>判断是否为同一对象</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">expect(actual).to be expected</span><br><span class="line"></span><br><span class="line"># 注意String类型并非同一对象</span><br><span class="line">expect(&quot;test&quot;).to be &quot;test&quot; # =&gt; Failure/Error</span><br></pre></td></tr></table></figure>
<h3 id="比较-gt-gt-lt-lt-be-within"><a href="#比较-gt-gt-lt-lt-be-within" class="headerlink" title="比较(&gt;, &gt;=, &lt;=, &lt;, be_within)"></a>比较(&gt;, &gt;=, &lt;=, &lt;, be_within)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">expect(actual).to be &gt; expected</span><br><span class="line">expect(actual).to be &gt;= expected</span><br><span class="line">expect(actual).to be &lt; expected</span><br><span class="line">expect(actual).to be &lt;= expected</span><br><span class="line">expected(actual).to be_within(delta).of(expected)</span><br><span class="line"># i.e. 2.99在2.9-0.2到2.9+0.2的范围内</span><br><span class="line">expect(2.99).to be_within(0.2).of(2.9)</span><br></pre></td></tr></table></figure>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">expect(actual).to match(/expression/)</span><br><span class="line"># i.e.</span><br><span class="line">expect(&quot;hello daniel&quot;).to match(/^hel/)</span><br></pre></td></tr></table></figure>
<h3 id="实例所属类型"><a href="#实例所属类型" class="headerlink" title="实例所属类型"></a>实例所属类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 判断是否为某个类的实例</span><br><span class="line">expect(actual).to be_an_instance_of(expected)</span><br><span class="line"># i.e.</span><br><span class="line">expect(&quot;hell&quot;).to be_instance_of(String) # 不包括继承关系</span><br><span class="line"></span><br><span class="line"># 含继承关系的所属关系</span><br><span class="line">expect(actual).to be_a(expected)</span><br><span class="line">expect(actual).to be_an(expected)</span><br><span class="line">expect(actual).to be_a_kind_of(expected)</span><br><span class="line"></span><br><span class="line"># i.e.</span><br><span class="line">expect(&quot;1.11&quot;).to be_an Object</span><br></pre></td></tr></table></figure>
<h3 id="true-false-和-nil"><a href="#true-false-和-nil" class="headerlink" title="true, false 和 nil"></a>true, false 和 nil</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">expect(actual).to be(true)</span><br><span class="line">expect(actual).not_to be(false)</span><br><span class="line">expect(actual).to be_nil</span><br><span class="line">expect(actual).not_to be_nil</span><br></pre></td></tr></table></figure>
<h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">expect &#123; code where exception happens &#125;.to raise_error</span><br><span class="line">expect &#123; code where exception happens &#125;.to raise_error ErrorClass</span><br><span class="line">expect &#123; code where exception happens &#125;.to raise_error &quot;message&quot;</span><br><span class="line">expect &#123; code where exception happens &#125;.to raise_error(ErrorClass, &quot;message&quot;)</span><br><span class="line"></span><br><span class="line"># i.e.</span><br><span class="line">expect &#123; Post.find(-1)  &#125;.to raise_error ActiveRecord::RecordNotFound</span><br></pre></td></tr></table></figure>
<h3 id="Predicate-machers"><a href="#Predicate-machers" class="headerlink" title="Predicate machers"></a>Predicate machers</h3><blockquote>
<p>Rails中 <code>xxx?</code>的方法在RSpec中对于的匹配器为<code>be_xxx</code>, Rails中<code>has_xxx?</code>这种形式的方法在RSpec中对应的匹配器为<code>have_xxx</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">expect(actual).to be_xxx(expected)</span><br><span class="line">expect(actual).to have_xxx(expected)</span><br><span class="line"></span><br><span class="line">expect([1, 3]).to be_include(1)</span><br><span class="line">expect([]).to be_empty</span><br><span class="line"></span><br><span class="line">expect(a: 1).to have_key(:a)</span><br></pre></td></tr></table></figure>
<h3 id="范围-Range"><a href="#范围-Range" class="headerlink" title="范围(Range)"></a>范围(Range)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(1..10).to cover(3)</span><br><span class="line">expect(1..10).not_to cover(30)</span><br></pre></td></tr></table></figure>
<h3 id="数值变化-change-by-from-to"><a href="#数值变化-change-by-from-to" class="headerlink" title="数值变化(change, by, from, to)"></a>数值变化(change, by, from, to)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 增加2个Post</span><br><span class="line"></span><br><span class="line">it do</span><br><span class="line">  Post.create title: &quot;first&quot;, content: &quot;first&quot;</span><br><span class="line">    expect &#123;</span><br><span class="line">      2.times do |i|</span><br><span class="line">        Post.create title: &quot;MyPost#&#123;i&#125;&quot;, content: &quot;MyContent#&#123;i&#125;&quot;</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">    &#125;.to change &#123; Post.count  &#125;.by(2)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 删除一个Post</span><br><span class="line">it do</span><br><span class="line">  Post.create title: &quot;first&quot;, content: &quot;first&quot;</span><br><span class="line">    expect &#123;</span><br><span class="line">      Post.first.destroy</span><br><span class="line">    &#125;.to change &#123; Post.count  &#125;.by(-1)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 数值从...变化到...</span><br><span class="line">it do</span><br><span class="line">  Post.create title: &quot;first&quot;, content: &quot;first&quot;</span><br><span class="line">    expect &#123;</span><br><span class="line">      2.times do |i|</span><br><span class="line">        Post.create title: &quot;MyPost#&#123;i&#125;&quot;, content: &quot;MyContent#&#123;i&#125;&quot;</span><br><span class="line">      end</span><br><span class="line">    &#125;.to change &#123; Post.count  &#125;.from(1).to(3)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="数组和字符串以及Hash包含的元素相关测试"><a href="#数组和字符串以及Hash包含的元素相关测试" class="headerlink" title="数组和字符串以及Hash包含的元素相关测试"></a>数组和字符串以及Hash包含的元素相关测试</h3><blockquote>
<p>其实字符串可以理解为一种数组.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 包含</span><br><span class="line">expect(actual).to include(expected)</span><br><span class="line"></span><br><span class="line"># 开始元素结束元素</span><br><span class="line">expect(actual).to start_with(expected)</span><br><span class="line">expect(actual).to end_with(expected)</span><br><span class="line"></span><br><span class="line"># 判断两个数组元素(不含顺序)是否相同</span><br><span class="line">expect(actual).to match_array(expected)</span><br><span class="line"></span><br><span class="line"># i.e.</span><br><span class="line">expect([1, 2, 3]).to include(1)</span><br><span class="line">expect([1, 2, 3]).to include(1, 2)</span><br><span class="line">expect([1, 2, 3]).to start_with(1)</span><br><span class="line">expect([1, 2, 3]).to start_with(1, 2)</span><br><span class="line">expect([1, 2, 3]).to end_with(3)</span><br><span class="line">expect([1, 2, 3]).to end_with(2, 3)</span><br><span class="line">expect(&#123;:a =&gt; &apos;b&apos;&#125;).to include(:a =&gt; &apos;b&apos;)</span><br><span class="line">expect(&quot;this string&quot;).to include(&quot;is str&quot;)</span><br><span class="line">expect(&quot;this string&quot;).to start_with(&quot;this&quot;)</span><br><span class="line">expect(&quot;this string&quot;).to end_with(&quot;ring&quot;)</span><br><span class="line">expect([1, 2, 3]).to contain_exactly(2, 3, 1)</span><br><span class="line">expect([1, 2, 3]).to match_array([3, 2, 1])</span><br></pre></td></tr></table></figure>
<h2 id="自定义-Matcher-匹配器"><a href="#自定义-Matcher-匹配器" class="headerlink" title="自定义 Matcher(匹配器)"></a>自定义 Matcher(匹配器)</h2><blockquote>
<p>可以在spec/support 目录下新建一个文件用于定义匹配器, 使用<code>RSpec::Matchers.define</code>来定义Matcher.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RSpec::Matchers.define :be_a_multiple_of do |expected|</span><br><span class="line">  match do |actual|</span><br><span class="line">    actual % expected == 0</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 使用</span><br><span class="line">expect(9).to be_a_multiple_of(3)</span><br></pre></td></tr></table></figure>
<h2 id="RSpec-Mock"><a href="#RSpec-Mock" class="headerlink" title="RSpec Mock"></a>RSpec Mock</h2><h3 id="Mock基础"><a href="#Mock基础" class="headerlink" title="Mock基础"></a>Mock基础</h3><blockquote>
<p>在RSpec中, 使用<code>allow</code>, <code>receive</code>, <code>and_return</code>方法, 可以调用mock的类方法或者实例方法.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 设置对象的实例方法及其返回值</span><br><span class="line">post = double(:post)</span><br><span class="line">allow(post).to receive(:title).and_return(&quot;Mock Name&quot;) # 可以理解为在post对象上快捷的定义了方法title和返回值</span><br><span class="line">puts post.title # =&gt; &quot;Mock Name&quot;</span><br><span class="line"></span><br><span class="line"># 上面的写法等价于</span><br><span class="line">allow(post).to receive(:title) &#123; &quot;Mock Name&quot; &#125;</span><br><span class="line"></span><br><span class="line"># 设定类方法及其返回值</span><br><span class="line">allow(Post).to receive(:count).and_return(4)</span><br></pre></td></tr></table></figure>
<h3 id="连续返回值"><a href="#连续返回值" class="headerlink" title="连续返回值"></a>连续返回值</h3><blockquote>
<p><code>and_return</code>方法传入多个参数, 连续调用方法会依次返回这些值</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">allow(Product).to receive(:increment).and_return(1, 2, 3)</span><br><span class="line">puts Product.increment # =&gt; 1</span><br><span class="line">puts Product.increment # =&gt; 2</span><br><span class="line">puts Product.increment # =&gt; 3</span><br><span class="line">puts Product.increment # =&gt; 3</span><br><span class="line">puts Product.increment # =&gt; 3</span><br></pre></td></tr></table></figure>
<h3 id="返回异常"><a href="#返回异常" class="headerlink" title="返回异常"></a>返回异常</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow(double).to receive(:msg).and_raise(error)</span><br></pre></td></tr></table></figure>
<h2 id="Capybara"><a href="#Capybara" class="headerlink" title="Capybara"></a>Capybara</h2><blockquote>
<p>Capybara可以模拟用户的行为, 比如点击按钮, 链接, 填写表单等</p>
</blockquote>
<h3 id="访问路径"><a href="#访问路径" class="headerlink" title="访问路径"></a>访问路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">visit &quot;/posts&quot;</span><br><span class="line">visit posts_path(post)</span><br></pre></td></tr></table></figure>
<h3 id="鼠标点击按钮或者超链接"><a href="#鼠标点击按钮或者超链接" class="headerlink" title="鼠标点击按钮或者超链接"></a>鼠标点击按钮或者超链接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">click_link &quot;new&quot;</span><br><span class="line"></span><br><span class="line">click_button &quot;Ceate User&quot;</span><br><span class="line"></span><br><span class="line">click_on &quot;Create User&quot; # 该方法表示点击链接或者按钮</span><br></pre></td></tr></table></figure>
<h3 id="填写表单"><a href="#填写表单" class="headerlink" title="填写表单"></a>填写表单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 输入textfield或者textarea</span><br><span class="line">fill_in &quot;可以是id属性, name属性或者label名称&quot;, with: &quot;值&quot;</span><br><span class="line"></span><br><span class="line"># radio 选择</span><br><span class="line">choose &quot;id属性, name属性或者label名称&quot;</span><br><span class="line"></span><br><span class="line"># checkbox 的选择</span><br><span class="line">check &quot;id属性, name属性或者label名称&quot;</span><br><span class="line">uncheck &quot;id属性, name属性或者label名称&quot;</span><br><span class="line"></span><br><span class="line"># 上传</span><br><span class="line">attach_file &quot;id属性, name属性或者label名称&quot;, &quot;/path/to/image.jpg&quot;  </span><br><span class="line"></span><br><span class="line"># selectbox</span><br><span class="line"></span><br><span class="line">select &quot;选择option的属性值&quot;, &quot;id属性, name属性或者label名称&quot;</span><br></pre></td></tr></table></figure>
<h3 id="验证当前路径current-path"><a href="#验证当前路径current-path" class="headerlink" title="验证当前路径current_path"></a>验证当前路径current_path</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(current_path).to eq new_post_path</span><br><span class="line">expect(page.current_path).to eq new_post_path</span><br></pre></td></tr></table></figure>
<h3 id="验证页面的文字内容"><a href="#验证页面的文字内容" class="headerlink" title="验证页面的文字内容"></a>验证页面的文字内容</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(page).to have_content &quot;foo&quot;</span><br><span class="line">expect(page).to have_no_content &quot;bar&quot;</span><br></pre></td></tr></table></figure>
<h3 id="验证css和xpath"><a href="#验证css和xpath" class="headerlink" title="验证css和xpath"></a>验证css和xpath</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(page).to have_css &quot;table tr.foo&quot;</span><br><span class="line">expect(page).to have_path &quot;//table/tr&quot;</span><br></pre></td></tr></table></figure>
<h3 id="验证一些HTML元素是否存在"><a href="#验证一些HTML元素是否存在" class="headerlink" title="验证一些HTML元素是否存在"></a>验证一些HTML元素是否存在</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find_link(&quot;Hello&quot;).visible?</span><br><span class="line">expect(find(&apos;#navigation&apos;)).to have_button(&apos;Sign out&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="特定范围内验证"><a href="#特定范围内验证" class="headerlink" title="特定范围内验证"></a>特定范围内验证</h3><blockquote>
<p>在页面中圈出一个范围来进行测试, 使用的方法是<code>within</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 可以使用CSS和XPath来圈定范围</span><br><span class="line">within &quot;li#employee&quot; do</span><br><span class="line">  fill_in &apos;Name&apos;, :with =&gt; &apos;Jimmy&apos;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">within :xpath, &apos;//div[contains(., &quot;bar&quot;)]&apos; do</span><br><span class="line">...</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">within &quot;li&quot;, text: &quot;hello&quot; do</span><br><span class="line">...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="操作其他窗口"><a href="#操作其他窗口" class="headerlink" title="操作其他窗口"></a>操作其他窗口</h3><blockquote>
<p>Capybara还可以操作弹出的窗口, 比如使用facebook第三方登录:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">facebook_window = window_opened_by do</span><br><span class="line">  click_button &apos;Login with FB&apos;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 操作弹出的窗口</span><br><span class="line">within_window facebook_window do</span><br><span class="line">  find(&apos;#login_email&apos;).set(&apos;d@f.com&apos;)</span><br><span class="line">  find(&apos;#login_password&apos;).set(&apos;pwd&apos;)</span><br><span class="line">  click_button &apos;Login&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><blockquote>
<p>笨方法是打印出页面的html代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puts page.body</span><br></pre></td></tr></table></figure></p>
<p>另外, 使用<code>launchy</code>这个gem, 在测试中调用<code>save_and_open_page</code>, 具体请参阅<a href="https://github.com/copiousfreetime/launchy" target="_blank" rel="external">https://github.com/copiousfreetime/launchy</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">it &apos;find_link&apos; do</span><br><span class="line">  find_link(&quot;hello&quot;).visible?</span><br><span class="line">  save_and_open_page</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="Javascript的测试"><a href="#Javascript的测试" class="headerlink" title="Javascript的测试"></a>Javascript的测试</h2><blockquote>
<p>上篇文章已经说过, 测试js时需要指定选项<code>js: true</code>; 还要在<code>rails_helper.rb</code>中配置Database Cleaner清除数据的策略</p>
</blockquote>
<h3 id="点击js的alert-confirm对话框的确定按钮"><a href="#点击js的alert-confirm对话框的确定按钮" class="headerlink" title="点击js的alert, confirm对话框的确定按钮"></a>点击js的alert, confirm对话框的确定按钮</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 点击OK按钮</span><br><span class="line">page.driver.browser.accept_js_confirms</span><br><span class="line"></span><br><span class="line"># 点击NO按钮</span><br><span class="line">page.driver.browser.dismiss_js_confirms</span><br><span class="line"></span><br><span class="line"># 获取对话框的消息</span><br><span class="line">page.driver.browser.alert_messages</span><br><span class="line">page.driver.browser.confirm_messages</span><br><span class="line">page.driver.browser.console_messages</span><br></pre></td></tr></table></figure>
<h2 id="测试错误页面"><a href="#测试错误页面" class="headerlink" title="测试错误页面"></a>测试错误页面</h2><blockquote>
<p>测试404, 500等错误页面首先需要修改<code>test.rb</code>的配置信息, 这样发生找不到资源时会跳转的错误页面.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Show full error reports.</span><br><span class="line">config.consider_all_requests_local       = false</span><br><span class="line"># Raise exceptions instead of rendering exception templates.</span><br><span class="line">config.action_dispatch.show_exceptions = true</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试代码:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"># spec/features/applications_spec.rb</span><br><span class="line">require &apos;rails_helper&apos;</span><br><span class="line"></span><br><span class="line">RSpec.feature &quot;Applications&quot;, type: :feature do</span><br><span class="line">  describe &quot;404 error&quot; do</span><br><span class="line"></span><br><span class="line">    context &quot;Routing Error&quot; do</span><br><span class="line">      before do</span><br><span class="line">        visit &quot;/undefined_routing_path&quot;</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;moves to 404 page&quot; do</span><br><span class="line">        expect(page).to have_content(&quot;The page you were looking for doesn&apos;t exist.&quot;)</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;status code is 404&quot; do</span><br><span class="line">        expect(page.status_code).to eq 404</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    context &quot;RecordNotFound&quot; do</span><br><span class="line">      before do</span><br><span class="line">        visit edit_post_path(100000)</span><br><span class="line">        save_and_open_page</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;move to 404 page&quot; do</span><br><span class="line">        expect(page).to have_content(&quot;The page you were looking for doesn&apos;t exist.&quot;)</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;has status code 404&quot; do</span><br><span class="line">        expect(page.status_code).to eq 404</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  describe &quot;500 error&quot; do</span><br><span class="line">    context &quot;RecordNotFound&quot; do</span><br><span class="line">      before do</span><br><span class="line">        expect_any_instance_of(PostsController).to receive(:index).and_throw(Exception)</span><br><span class="line">        visit posts_path</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;move to 500 page&quot; do</span><br><span class="line">        expect(page).to have_content(&quot;We&apos;re sorry, but something went wrong.&quot;)</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;has status code 500&quot; do</span><br><span class="line">        expect(page.status_code).to eq 500</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/03/rspec-capybara/" itemprop="url">
                  RSpec, Capybara, FactoryGirl的使用方法介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-03T08:05:33+08:00" content="2015-03-03">
              2015-03-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/03/rspec-capybara/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/03/rspec-capybara/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在阅读本文前你需要对RSpec有一个基本的了解, 本文会对 Model, Controller, Feature 等测试写法进行总结.</p>
</blockquote>
<h2 id="环境及gem版本"><a href="#环境及gem版本" class="headerlink" title="环境及gem版本"></a>环境及gem版本</h2><ul>
<li>Mac OS X 10</li>
<li>Ruby 2.1</li>
<li>Rails 4.1</li>
<li>rspec-rails 3.1.0</li>
<li>shoulda-matchers 2.6.2</li>
<li>factory_girl_rails 4.4.1</li>
<li>capybara 2.4.1</li>
<li>capybara-webkit 1.3.0</li>
<li>database_cleaner 1.3.0</li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><blockquote>
<p>新建一个rails项目, 在Gemfile中添加以下gem:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">group :development, :test do</span><br><span class="line"></span><br><span class="line">  # Debug相关gem</span><br><span class="line">  gem &apos;pry-rails&apos;</span><br><span class="line">  gem &apos;pry-doc&apos;</span><br><span class="line">  gem &apos;pry-byebug&apos;</span><br><span class="line">  gem &apos;pry-stack_explorer&apos;</span><br><span class="line"></span><br><span class="line">  # RSpec所需Gem</span><br><span class="line">  gem &apos;rspec-rails&apos;</span><br><span class="line">  gem &apos;shoulda-matchers&apos;</span><br><span class="line">  gem &apos;factory_girl_rails&apos;</span><br><span class="line"></span><br><span class="line">  # 模拟用户行为</span><br><span class="line">  gem &apos;capybara&apos;</span><br><span class="line">end</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>安装gem, 然后生成rspec的配置文件:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bundle install</span><br><span class="line"></span><br><span class="line">rails g rspec:install</span><br><span class="line"># 生成</span><br><span class="line">create  .rspec</span><br><span class="line">create  spec</span><br><span class="line">create  spec/spec_helper.rb</span><br><span class="line">create  spec/rails_helper.rb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>添加设定:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># spec/rails_helper.rb</span><br><span class="line">...</span><br><span class="line"># Add additional requires below this line. Rails is not loaded until this point!</span><br><span class="line">require &apos;capybara/rails&apos;</span><br><span class="line">require &apos;capybara/rspec&apos;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">RSpec.configure do |config|</span><br><span class="line">  # 添加FactoryGirl语法</span><br><span class="line">  # 比如: FactoryGirl.create(:post) =&gt; create(:post)</span><br><span class="line">  config.include FactoryGirl::Syntax::Methods</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="Model的测试"><a href="#Model的测试" class="headerlink" title="Model的测试"></a>Model的测试</h2><h3 id="生成针对post-Model的测试"><a href="#生成针对post-Model的测试" class="headerlink" title="生成针对post Model的测试"></a>生成针对post Model的测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rails g rspec:model post</span><br><span class="line"></span><br><span class="line">  create  spec/models/post_spec.rb</span><br><span class="line">  invoke  factory_girl</span><br><span class="line">  create    spec/factories/posts.rb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然, 由于我已经做了配置, 直接生成post Model也会生成相应的测试文件.</p>
</blockquote>
<h3 id="写测试"><a href="#写测试" class="headerlink" title="写测试"></a>写测试</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spec/models/post_spec.rb</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'rails_helper'</span></span><br><span class="line"></span><br><span class="line">RSpec.describe Post, <span class="symbol">type:</span> <span class="symbol">:model</span> <span class="keyword">do</span></span><br><span class="line">  describe <span class="string">"#title"</span> <span class="keyword">do</span></span><br><span class="line">    it &#123; is_expected.to validate_presence_of(<span class="symbol">:title</span>)  &#125;</span><br><span class="line">    it &#123; is_expected.to validate_uniqueness_of(<span class="symbol">:title</span>)  &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">"#content"</span> <span class="keyword">do</span></span><br><span class="line">    it &#123; is_expected.to validate_presence_of(<span class="symbol">:content</span>)  &#125;</span><br><span class="line">    it &#123; is_expected.to validate_length_of(<span class="symbol">:content</span>)  &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="测试失败-生成post-Model并添加相应的验证"><a href="#测试失败-生成post-Model并添加相应的验证" class="headerlink" title="测试失败, 生成post Model并添加相应的验证"></a>测试失败, 生成post Model并添加相应的验证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ rails g model post title content:text</span><br><span class="line">$ rake db:migrate</span><br><span class="line"></span><br><span class="line"># app/models/post.rb</span><br><span class="line">class Post &lt; ActiveRecord::Base</span><br><span class="line">  validates :title, presence: true, uniqueness: true</span><br><span class="line">  validates :content, presence: true, length: &#123; maximum: 500  &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="Controller的测试"><a href="#Controller的测试" class="headerlink" title="Controller的测试"></a>Controller的测试</h2><h3 id="相关知识点"><a href="#相关知识点" class="headerlink" title="相关知识点"></a>相关知识点</h3><h4 id="响应状态"><a href="#响应状态" class="headerlink" title="响应状态"></a>响应状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(response).to be_success</span><br><span class="line">expect(response[&apos;Content-Type&apos;]).to =~ %r^text/html!</span><br></pre></td></tr></table></figure>
<h4 id="assigns-方法"><a href="#assigns-方法" class="headerlink" title="assigns()方法"></a><code>assigns()</code>方法</h4><blockquote>
<p><code>assigns</code>声明实例变量(@), 共享给视图</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expect(assigns(:entries)).to == Entry.all</span><br></pre></td></tr></table></figure>
<h4 id="模拟渲染视图和重定向"><a href="#模拟渲染视图和重定向" class="headerlink" title="模拟渲染视图和重定向"></a>模拟渲染视图和重定向</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(response).to render_template(&apos;index&apos;)</span><br><span class="line">expect(response).to redirect_to(entries_url)</span><br></pre></td></tr></table></figure>
<h3 id="生成Controller测试文件"><a href="#生成Controller测试文件" class="headerlink" title="生成Controller测试文件"></a>生成Controller测试文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rails g rspec:controller posts</span><br><span class="line">  create  spec/controllers/posts_controller_spec.rb</span><br></pre></td></tr></table></figure>
<h3 id="写测试代码"><a href="#写测试代码" class="headerlink" title="写测试代码"></a>写测试代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># spec/controllers/posts_controller_spec.rb</span><br><span class="line">require &apos;rails_helper&apos;</span><br><span class="line"></span><br><span class="line">RSpec.describe PostsController, :type =&gt; :controller do</span><br><span class="line"></span><br><span class="line">  def valid_attributes</span><br><span class="line">    &#123; title: &quot;title&quot;, content: &quot;content&quot;  &#125;</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def invalid_attributes</span><br><span class="line">    &#123; title: &quot;&quot;, content: &quot;&quot;  &#125;</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  describe &quot;POST create&quot; do</span><br><span class="line">    describe &quot;with valid params&quot; do</span><br><span class="line">      it &quot;creates a new Post&quot; do</span><br><span class="line">        expect &#123;</span><br><span class="line">          post :create, &#123;:post =&gt; valid_attributes&#125;</span><br><span class="line"></span><br><span class="line">        &#125;.to change(Post, :count).by(1)</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;assigns a newly created post as @post&quot; do</span><br><span class="line">        post :create, &#123;:post =&gt; valid_attributes&#125;</span><br><span class="line">        expect(assigns(:post)).to be_a(Post)</span><br><span class="line">        expect(assigns(:post)).to be_persisted</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;redirects to the created post&quot; do</span><br><span class="line">        post :create, &#123;:post =&gt; valid_attributes&#125;</span><br><span class="line">        expect(response).to redirect_to(Post.last)</span><br><span class="line">      end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">    describe &quot;with invalid params&quot; do</span><br><span class="line">      it &quot;assigns a newly created but unsaved post as @post&quot; do</span><br><span class="line">        post :create, &#123;:post =&gt; invalid_attributes&#125;</span><br><span class="line">        expect(assigns(:post)).to be_a_new(Post)</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      it &quot;re-renders the &apos;new&apos; template&quot; do</span><br><span class="line">        post :create, &#123;:post =&gt; invalid_attributes&#125;</span><br><span class="line">        expect(response).to render_template(&quot;new&quot;)</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="完成Controller代码"><a href="#完成Controller代码" class="headerlink" title="完成Controller代码"></a>完成Controller代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/posts_controller.rb</span><br><span class="line"></span><br><span class="line"># POST /posts</span><br><span class="line"># POST /posts.json</span><br><span class="line">def create</span><br><span class="line">@post = Post.new(post_params)</span><br><span class="line"></span><br><span class="line">respond_to do |format|</span><br><span class="line">    if @post.save</span><br><span class="line">      format.html &#123; redirect_to @post, notice: &apos;Post was successfully created.&apos;  &#125;</span><br><span class="line">      format.json &#123; render :show, status: :created, location: @post  &#125;</span><br><span class="line">    else</span><br><span class="line">      format.html &#123; render :new  &#125;</span><br><span class="line">      format.json &#123; render json: @post.errors, status: :unprocessable_entity  &#125;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="Helper的测试"><a href="#Helper的测试" class="headerlink" title="Helper的测试"></a>Helper的测试</h2><h3 id="生成helper-spec"><a href="#生成helper-spec" class="headerlink" title="生成helper_spec"></a>生成helper_spec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g rspec:helper application</span><br><span class="line">  create  spec/helpers/application_helper_spec.rb</span><br></pre></td></tr></table></figure>
<h3 id="编写测试-实现helper代码"><a href="#编写测试-实现helper代码" class="headerlink" title="编写测试, 实现helper代码"></a>编写测试, 实现helper代码</h3><blockquote>
<p><strong><em> 注意<code>helper</code>对象包含了ApplicationHelper </em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># spec/helpers/application_helper_spec.rb</span><br><span class="line">RSpec.describe ApplicationHelper, type: :helper do</span><br><span class="line">  describe &quot;active_if_current&quot; do</span><br><span class="line">    subject &#123; helper.active_if_current(&quot;/any_path&quot;)  &#125;</span><br><span class="line"></span><br><span class="line">    context &quot;current page path equals to &apos;/any_path&apos;&quot; do</span><br><span class="line">      it do</span><br><span class="line">        allow(helper).to receive(:current_page?).and_return(true)</span><br><span class="line">        expect(subject).to eq &apos;active&apos;</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    context &quot;current page path does not equal to &apos;/any_path&apos;&quot; do</span><br><span class="line">      it do</span><br><span class="line">        allow(helper).to receive(:current_page?).and_return(false)</span><br><span class="line">        expect(subject).to be_nil</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/helpers/application_helper.rb</span><br><span class="line">module ApplicationHelper</span><br><span class="line">  def active_if_current(path)</span><br><span class="line">    &apos;active&apos; if current_page?(path)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="Features的测试"><a href="#Features的测试" class="headerlink" title="Features的测试"></a>Features的测试</h2><blockquote>
<p>Features测试将route, Controller, View, Model结合在一起进行测试, 比如: 用户创建了一个新的post.</p>
</blockquote>
<h3 id="生成Feature-Spec"><a href="#生成Feature-Spec" class="headerlink" title="生成Feature Spec"></a>生成Feature Spec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g rspec:feature posts</span><br><span class="line">   create  spec/features/posts_spec.rb</span><br></pre></td></tr></table></figure>
<h3 id="写feature-spec"><a href="#写feature-spec" class="headerlink" title="写feature spec"></a>写feature spec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">require &apos;rails_helper&apos;</span><br><span class="line"></span><br><span class="line">RSpec.feature &quot;Posts&quot;, type: :feature do</span><br><span class="line">  describe &quot;Create a Post&quot; do</span><br><span class="line">    before do</span><br><span class="line">    visit posts_path</span><br><span class="line">    click_link &quot;New Post&quot;</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  it &quot;gets to new post page&quot; do</span><br><span class="line">    expect(page.current_path).to eq new_post_path</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  it &quot;creates new post&quot; do</span><br><span class="line">    # Fill in the form</span><br><span class="line">    fill_in &quot;Title&quot;, with: &quot;Title1&quot;</span><br><span class="line">    fill_in &quot;Content&quot;, with: &quot;Content1&quot;</span><br><span class="line">    click_button &quot;Create Post&quot;</span><br><span class="line"></span><br><span class="line">    expect(page).to have_content &quot;Post was successfully created.&quot;</span><br><span class="line">    expect(page).to have_content &quot;Title1&quot;</span><br><span class="line">    expect(page).to have_content &quot;Content1&quot;</span><br><span class="line"></span><br><span class="line">    # Make sure data is stored into db.</span><br><span class="line">    post = Post.last</span><br><span class="line">    expect(post.title).to eq &quot;Title1&quot;</span><br><span class="line">    expect(post.content).to eq &quot;Content1&quot;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="JavaScript测试"><a href="#JavaScript测试" class="headerlink" title="JavaScript测试"></a>JavaScript测试</h2><blockquote>
<p>简单介绍一下javascript的测试.<br>需要添加测试js测试驱动 Capybara-Webkit 到Gemfile中. 还需要添加用于清理数据库的gem Database Cleaner</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Gemfile</span><br><span class="line">group :test do</span><br><span class="line">  gem &apos;capybara-webkit&apos;</span><br><span class="line">  gem &apos;database_cleaner&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后<code>$ bundle install</code>, 如果出现错误:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    /Users/daniel/.rvm/rubies/ruby-2.2.0/bin/ruby -r ./siteconf20150303-33956-1xk6nvy.rb extconf.rb</span><br><span class="line">    sh: qmake: command not found</span><br><span class="line">    *** extconf.rb failed ***</span><br><span class="line">    Could not create Makefile due to some reason, probably lack of necessary</span><br><span class="line">    libraries and/or headers.  Check the mkmf.log file for more details.  You may</span><br><span class="line">    need configuration options.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>那么很有可能是没有安装qt</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">如果你使用Mac, 那么:</span><br><span class="line">brew install qt</span><br><span class="line">如果使用Ubuntu Linux, 那么</span><br><span class="line">sudo apt-get install qt4-dev-tools libqt4-dev libqt4-core libqt4-gui</span><br><span class="line"></span><br><span class="line">其他情况请Google</span><br></pre></td></tr></table></figure>
<blockquote>
<p>也可参加这篇文章 <a href="https://github.com/thoughtbot/capybara-webkit/wiki/Installing-Qt-and-compiling-capybara-webkit" target="_blank" rel="external">https://github.com/thoughtbot/capybara-webkit/wiki/Installing-Qt-and-compiling-capybara-webkit</a></p>
<p>接下来修改设置文件, 添加DatabaseCleaner的相关设定</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">RSpec.configure do |config|</span><br><span class="line">  ...</span><br><span class="line">    </span><br><span class="line">  # DatabaseCleaner设定</span><br><span class="line">  # suite: 以RSpec的一个命令作为单位</span><br><span class="line">  # all: 一个RSpec测试文件作为单位</span><br><span class="line">  # each: 一个测试用例(it)作为一个单位</span><br><span class="line">  config.before(:suite) do</span><br><span class="line">    DatabaseCleaner.clean_with :truncation # 测试开始时(执行一个测试命令时)清空数据库</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # js除外的其他测试使用transaction策略清除数据</span><br><span class="line">  config.before(:each) do</span><br><span class="line">    DatabaseCleaner.strategy = :transaction</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # js测试时使用truncation策略清空数据</span><br><span class="line">  config.before(:each, js: true) do</span><br><span class="line">    DatabaseCleaner.strategy = truncation</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # 开启transaction策略</span><br><span class="line">  config.before(:each) do</span><br><span class="line">    DatabaseCleaner.start</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # 测试完了使用transaction策略清理数据库(我根据的是before/after的参数判断何种策略的)</span><br><span class="line">  config.after(:each) do</span><br><span class="line">    DatabaseCleaner.clean</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # 每个测试文件执行完后使用truncation策略清理数据</span><br><span class="line">  config.after(:all) do</span><br><span class="line">    DatabaseCleaner.clean_with :truncation </span><br><span class="line">  end</span><br><span class="line">  ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在测试文件中添加<code>js: true</code>就会使用javascript 驱动来测试</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;JS TEST&quot;, js: true do</span><br><span class="line">  # js test</span><br><span class="line">  ...</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">it &quot;JS TEST&quot;, js: true do</span><br><span class="line">  # js test case</span><br><span class="line">  ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/02/rails-test-samples/" itemprop="url">
                  在实际开发中使用RSpec和Cucumber进行TDD/BDD测试
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-02T12:25:54+08:00" content="2015-03-02">
              2015-03-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/02/rails-test-samples/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/02/rails-test-samples/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h2><blockquote>
<p>请参见我的上一篇文章: <a href="/2015/03/02/rails-test-install/">在Rails中使用Cucumber和RSpec搭建BDD/TDD测试环境</a>.</p>
</blockquote>
<h2 id="Cucumber-和-RSpec的区别"><a href="#Cucumber-和-RSpec的区别" class="headerlink" title="Cucumber 和 RSpec的区别"></a>Cucumber 和 RSpec的区别</h2><h3 id="Cucumber的特点"><a href="#Cucumber的特点" class="headerlink" title="Cucumber的特点"></a>Cucumber的特点</h3><blockquote>
<p>由于使用了更自然的语言来描述, 所以阅读代码时更容易理解. 更加适合整体测试.</p>
</blockquote>
<h3 id="RSpec的特点"><a href="#RSpec的特点" class="headerlink" title="RSpec的特点"></a>RSpec的特点</h3><blockquote>
<p>读起来像英语一样, 适合测试View, Controller, Model这些单独的组件.</p>
</blockquote>
<h2 id="结合RSpec和Cucumber"><a href="#结合RSpec和Cucumber" class="headerlink" title="结合RSpec和Cucumber"></a>结合RSpec和Cucumber</h2><blockquote>
<p>不能看出, Cucumber读起来简单但是写起来麻烦, 而RSpec恰恰相反, 所以可以将二者结合进行测试. 具体来讲:</p>
</blockquote>
<ul>
<li>单元测试(View, Controller, Model各个各个组件的测试)使用RSpec</li>
<li>结合测试(将View, Controller, Model结合, 页面之间跳转这样的测试)使用Cucumber</li>
<li>整体测试(页面跳转后是否会达到预期效果这样的测试)使用Cucumber</li>
</ul>
<h2 id="测试流程"><a href="#测试流程" class="headerlink" title="测试流程"></a>测试流程</h2><h3 id="生成User-story"><a href="#生成User-story" class="headerlink" title="生成User story"></a>生成User story</h3><blockquote>
<p>为了便于说明问题, 我目的的创建一个对于User进行增删改查的Rails应用, 我先来描述一下我想要的效果:</p>
</blockquote>
<ul>
<li>在User 列表页面, 有以下可以跳转到的页面:<ul>
<li>新建和编辑User的页面</li>
<li>列出用户详细信息的页面</li>
</ul>
</li>
<li>有如下功能:<ul>
<li>管理员可以查看展示所有用户的信息</li>
<li>管理员可以新建, 编辑和删除用户</li>
<li>管理员可以查看某一用户的详细信息</li>
</ul>
</li>
</ul>
<h3 id="使用cucumber生成scenario-场景"><a href="#使用cucumber生成scenario-场景" class="headerlink" title="使用cucumber生成scenario(场景)"></a>使用cucumber生成scenario(场景)</h3><blockquote>
<p>接下来描述”管理员可以查看展示所有用户的信息”这个场景.<br>Cucumber规定, 在features/目录下创建<code>.feature</code>文件(feature file), 在文件中使用自然语言来定义scenario ; 然后, 在<code>features/step_definitions</code>目录下定义<code>.rb</code>文件用于将自然语言和实际的代码匹配.</p>
</blockquote>
<h3 id="feature-file的语法"><a href="#feature-file的语法" class="headerlink" title="feature file的语法"></a>feature file的语法</h3><blockquote>
<p>首先看看feature file如果定义, 可以选择除了英语之外的其他语言, 不过我还是会使用英语, 如果使用其他语言需要在文件开头写上 <code># language cn</code>.<br>一个feature 文件中可以定义多个scenario, scenario中必须有”Given”, “When”和”Then”, 分别表示前提, 如果 和 那么. 看下面的例子:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Feature: [描述功能]</span><br><span class="line">  [可以随便写, 也可以不写]</span><br><span class="line"></span><br><span class="line">  # 注释</span><br><span class="line">  Scenario: [一个前提的情况下]</span><br><span class="line">    Given [描述前提]</span><br><span class="line">    When [描述一个动作(action)]</span><br><span class="line">    Then [描述结果]</span><br><span class="line"></span><br><span class="line">  Scenario: [两个前提条件情况]</span><br><span class="line">    Given [前提描述]</span><br><span class="line">    And [另一个前提]</span><br><span class="line">    When [一个action]</span><br><span class="line">    And [另一个action]</span><br><span class="line">    Then [结果]</span><br><span class="line"></span><br><span class="line">  Scenario Outline: [需要输入的情况]</span><br><span class="line">    Given [前提]</span><br><span class="line">    When 输入&lt;input&gt;</span><br><span class="line">    Then 显示&lt;result&gt;</span><br><span class="line">  Example:</span><br><span class="line">    | input | result |</span><br><span class="line">    |     0 |     0  |</span><br><span class="line">    |     1 |     1  |</span><br><span class="line">    |     2 |     10 |</span><br><span class="line">    |     3 |    100 |</span><br></pre></td></tr></table></figure>
<h3 id="生成feature-file"><a href="#生成feature-file" class="headerlink" title="生成feature file"></a>生成feature file</h3><blockquote>
<p>创建User story的feature file</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ vim feature/user_index.feature</span><br><span class="line"></span><br><span class="line">Feature: Listing all users&apos; info for admin</span><br><span class="line"></span><br><span class="line">  Scenario Outline: List all users</span><br><span class="line">    Given There are &lt;user_number&gt; users in the db</span><br><span class="line">    When the index page is displayed</span><br><span class="line">    Then I should see &lt;user_number&gt; users</span><br><span class="line">    Examples:</span><br><span class="line">      | user_number |</span><br><span class="line">      | 0 |</span><br><span class="line">      | 1 |</span><br><span class="line"></span><br><span class="line"># 执行测试返回结果:</span><br><span class="line">➜  test_rspec_cucumber_rails  cucumber features/user_index.feature</span><br><span class="line">Using the default profile...</span><br><span class="line">Feature: Listing all users&apos; info for admin</span><br><span class="line"></span><br><span class="line">Scenario Outline: List all users                # features/user_index.feature:3</span><br><span class="line">Given There are &lt;user_number&gt; users in the db # features/user_index.feature:4</span><br><span class="line">When the index page is displayed              # features/user_index.feature:5</span><br><span class="line">Then I should see &lt;user_number&gt; users         # features/user_index.feature:6</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">| user_number |</span><br><span class="line">| 0           |</span><br><span class="line">Undefined step: &quot;There are 0 users in the db&quot; (Cucumber::Undefined)</span><br><span class="line">features/user_index.feature:4:in `Given There are &lt;user_number&gt; users in the db&apos;</span><br><span class="line">| 1           |</span><br><span class="line">Undefined step: &quot;There are 1 users in the db&quot; (Cucumber::Undefined)</span><br><span class="line">features/user_index.feature:4:in `Given There are &lt;user_number&gt; users in the db&apos;</span><br><span class="line"></span><br><span class="line">2 scenarios (2 undefined)</span><br><span class="line">6 steps (6 undefined)</span><br><span class="line">0m0.055s</span><br><span class="line"></span><br><span class="line">You can implement step definitions for undefined steps with these snippets:</span><br><span class="line"></span><br><span class="line">Given(/^There are (\d+) users in the db$/) do |arg1|</span><br><span class="line">pending # express the regexp above with the code you wish you had</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">When(/^the index page is displayed$/) do</span><br><span class="line">pending # express the regexp above with the code you wish you had</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">Then(/^I should see (\d+) users$/) do |arg1|</span><br><span class="line">pending # express the regexp above with the code you wish you had</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="实现step定义"><a href="#实现step定义" class="headerlink" title="实现step定义"></a>实现step定义</h3><blockquote>
<p>其实上面的错误信息已经提示如何实现step文件.我们需要让自然语言和代码进行匹配时, 相比于方法的设计我们考虑更多的是实际问题, 这样更加利于理解.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># user_steps.rb</span><br><span class="line"></span><br><span class="line">Given(/^There are (\d+) users in the db$/) do |num|</span><br><span class="line">  num.to_i.times do |i|</span><br><span class="line">    User.create(name: &quot;User#&#123;i&#125;&quot;, email: &quot;user#&#123;i&#125;@example.com&quot;)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">When(/^the index page is displayed$/) do</span><br><span class="line">  visit users_path # 跳转到index页面, visit方法来自于Capybara</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">Then(/^I should see (\d+) users$/) do |num|</span><br><span class="line">  # 判断所期待的内容是否存在</span><br><span class="line">  num.to_i.times do |i|</span><br><span class="line">    expect(page).to have_content(&quot;user#&#123;i&#125;@example.com&quot;)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="再次测试"><a href="#再次测试" class="headerlink" title="再次测试"></a>再次测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">test_rspec_cucumber_rails  cucumber features/user_index.feature</span><br><span class="line">Using the default profile...</span><br><span class="line">Feature: Listing all users&apos; info for admin</span><br><span class="line"></span><br><span class="line">Scenario Outline: List all users                # features/user_index.feature:3</span><br><span class="line">Given There are &lt;user_number&gt; users in the db # features/step_definitions/users_steps.rb:1</span><br><span class="line">When the index page is displayed              # features/step_definitions/users_steps.rb:7</span><br><span class="line">Then I should see &lt;user_number&gt; users         # features/step_definitions/users_steps.rb:11</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">| user_number |</span><br><span class="line">| 0           |</span><br><span class="line">undefined local variable or method `users_path&apos; for #&lt;Cucumber::Rails::World:0x007fc3100576b8&gt; (NameError)</span><br><span class="line">./features/step_definitions/users_steps.rb:8:in `/^the index page is displayed$/&apos;</span><br><span class="line">features/user_index.feature:5:in `When the index page is displayed&apos;</span><br><span class="line">| 1           |</span><br><span class="line">uninitialized constant User (NameError)</span><br><span class="line">./features/step_definitions/users_steps.rb:3:in `block (2 levels) in &lt;top (required)&gt;&apos;</span><br><span class="line">./features/step_definitions/users_steps.rb:2:in `times&apos;</span><br><span class="line">./features/step_definitions/users_steps.rb:2:in `/^There are (\d+) users in the db$/&apos;</span><br><span class="line">features/user_index.feature:4:in `Given There are &lt;user_number&gt; users in the db&apos;</span><br><span class="line"></span><br><span class="line">Failing Scenarios:</span><br><span class="line">cucumber features/user_index.feature:3 # Scenario: List all users</span><br><span class="line">cucumber features/user_index.feature:3 # Scenario: List all users</span><br><span class="line"></span><br><span class="line">2 scenarios (2 failed)</span><br><span class="line">6 steps (2 failed, 3 skipped, 1 passed)</span><br><span class="line">0m0.025s`</span><br></pre></td></tr></table></figure>
<blockquote>
<p>users_path 没有定义, 接下来使用RSpec来实现MVC各个单元测试和开发</p>
</blockquote>
<h2 id="使用RSpec实现单元测试"><a href="#使用RSpec实现单元测试" class="headerlink" title="使用RSpec实现单元测试"></a>使用RSpec实现单元测试</h2><h3 id="Rspec的基本语法"><a href="#Rspec的基本语法" class="headerlink" title="Rspec的基本语法"></a>Rspec的基本语法</h3><blockquote>
<p>首先介绍一下RSpec的相关知识:</p>
</blockquote>
<ul>
<li>文件名: xxx_spec.rb 表示是rspec的测试文件</li>
<li>describe: 对于测试用例的描述.</li>
<li>context: describe分情况讨论的描述.</li>
<li>subject: 设置it所指代的对象</li>
<li>it / specify : 测试的对象</li>
<li>expect : 需要在it block中使用</li>
<li>异常: raise_error(RuntimeError, ‘msg…’)</li>
</ul>
<blockquote>
<p>基本形式:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">describe &quot;Array&quot; do</span><br><span class="line">  before &#123; @arr = Array.new &#125;</span><br><span class="line"></span><br><span class="line">  it &quot;should be empty&quot; do</span><br><span class="line">    expect(:arr).to be_empty</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="Controller的测试"><a href="#Controller的测试" class="headerlink" title="Controller的测试"></a>Controller的测试</h3><blockquote>
<p>由于我已经安装了RSpec, 所以我在创建Controller的时候会自动创建相应的rspec测试文件:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g controller Users </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试文件:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">require &apos;rails_helper&apos;</span><br><span class="line"></span><br><span class="line">RSpec.describe UsersController, type: :controller do</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  describe &quot;GET #index&quot; do</span><br><span class="line"></span><br><span class="line">    # Test responsing HTTP 200 status code</span><br><span class="line">    it &quot;should respond successfully with an HTTP 200 status code&quot; do</span><br><span class="line">      get :index</span><br><span class="line">      expect(response).to be_success</span><br><span class="line">      expect(response).to have_http_status(200)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    # Test Rendering index template</span><br><span class="line">    it &quot;should render index template&quot; do</span><br><span class="line">      get :index</span><br><span class="line">      expect(response).to render_template(&quot;index&quot;)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    # Test loading all users into @users</span><br><span class="line">    it &quot;should load all users into @users&quot; do</span><br><span class="line">      user1 = User.create!(name: &quot;test user1&quot;, email: &quot;user1@example.com&quot;)</span><br><span class="line">      user2 = User.create!(name: &quot;test user2&quot;, email: &quot;user2@example.com&quot;)</span><br><span class="line">      get :index</span><br><span class="line"></span><br><span class="line">      expect(assigns(:users)).to match_array([user1, user2])</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>运行测试</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ rspec --color --format doc spec/</span><br><span class="line"></span><br><span class="line">UsersController</span><br><span class="line">GET #index</span><br><span class="line">responds successfully with an HTTP 200 status code (FAILED - 1)</span><br><span class="line">renders the index template (FAILED - 2)</span><br><span class="line">loads all of the users into @users (FAILED - 3)</span><br><span class="line"></span><br><span class="line">Failures:</span><br><span class="line"></span><br><span class="line">1) UsersController GET #index responds successfully with an HTTP 200 status code</span><br><span class="line">Failure/Error: get :index</span><br><span class="line">ActionController::UrlGenerationError:</span><br><span class="line">No route matches &#123;:action=&gt;&quot;index&quot;, :controller=&gt;&quot;users&quot;&#125;</span><br><span class="line"># ./spec/controllers/users_controller_spec.rb:11:in `block (3 levels) in &lt;top (required)&gt;&apos;</span><br><span class="line"></span><br><span class="line">2) UsersController GET #index renders the index template</span><br><span class="line">Failure/Error: get :index</span><br><span class="line">ActionController::UrlGenerationError:</span><br><span class="line">No route matches &#123;:action=&gt;&quot;index&quot;, :controller=&gt;&quot;users&quot;&#125;</span><br><span class="line"># ./spec/controllers/users_controller_spec.rb:18:in `block (3 levels) in &lt;top (required)&gt;&apos;</span><br><span class="line"></span><br><span class="line">3) UsersController GET #index loads all of the users into @users</span><br><span class="line">Failure/Error: user1 = User.create!(name: &quot;test user1&quot;, email: &quot;user1@example.com&quot;)</span><br><span class="line">NameError:</span><br><span class="line">uninitialized constant User</span><br><span class="line"># ./spec/controllers/users_controller_spec.rb:24:in `block (3 levels) in &lt;top (required)&gt;&apos;</span><br><span class="line"></span><br><span class="line">Finished in 0.00799 seconds (files took 1.93 seconds to load)</span><br><span class="line">3 examples, 3 failures</span><br><span class="line"></span><br><span class="line">Failed examples:</span><br><span class="line"></span><br><span class="line">rspec ./spec/controllers/users_controller_spec.rb:10 # UsersController GET #index responds successfully with an HTTP 200 status code</span><br><span class="line">rspec ./spec/controllers/users_controller_spec.rb:17 # UsersController GET #index renders the index template</span><br><span class="line">rspec ./spec/controllers/users_controller_spec.rb:23 # UsersController GET #index loads all of the users into @usersZ</span><br></pre></td></tr></table></figure>
<h3 id="RSpec设置options"><a href="#RSpec设置options" class="headerlink" title="RSpec设置options"></a>RSpec设置options</h3><blockquote>
<p>顺便说一句, 如果觉得每次都指定<code>--color</code>和<code>--format doc</code>麻烦, 那么可以修改<code>.rspec</code>文件, 添加默认option</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim .rspec</span><br><span class="line">--color</span><br><span class="line">--format doc</span><br></pre></td></tr></table></figure>
<h3 id="添加Routing"><a href="#添加Routing" class="headerlink" title="添加Routing"></a>添加Routing</h3><blockquote>
<p>从刚刚的结果看以判断, 首先需要添加routing:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># config/route.rb</span><br><span class="line"></span><br><span class="line">Rails.application.routes.draw do</span><br><span class="line">  get &apos;users&apos; =&gt; &apos;users#index&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="实现UsersController"><a href="#实现UsersController" class="headerlink" title="实现UsersController"></a>实现UsersController</h3><blockquote>
<p>执行<code>rspec</code>, 这回返回的错误信息是<code>The action &#39;index&#39; could not be found for UsersController</code>, 所以我需要在<code>UsersController</code>中实现index方法, 在index方法中, 我需要从数据库中取出所有的user赋给实例变量@users, 进而可以在index.html.erb中显示这些用户.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class UsersController &lt; ApplicationController</span><br><span class="line"></span><br><span class="line">  def index</span><br><span class="line">    @users = User.all</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="创建User-model"><a href="#创建User-model" class="headerlink" title="创建User model"></a>创建User model</h3><blockquote>
<p>继续执行测试, 这时发生的错误是 <code>uninitialized constant UsersController::User</code>, 所以我应该创建User Model了.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ rails g model User name:string email:string</span><br><span class="line">  invoke  active_record</span><br><span class="line">  create    db/migrate/20150302123110_create_users.rb</span><br><span class="line">  create    app/models/user.rb</span><br><span class="line">  invoke    rspec</span><br><span class="line">  create      spec/models/user_spec.rb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后, 我来实现User的测试代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># spec/models/user_spec.rb</span><br><span class="line"></span><br><span class="line">require &apos;rails_helper&apos;</span><br><span class="line"></span><br><span class="line">RSpec.describe User, type: :model do</span><br><span class="line">  # before()在测试执行前执行</span><br><span class="line">  before &#123; @user = User.new(name: &quot;test user&quot;, email: &quot;user@example.com&quot;)  &#125;</span><br><span class="line"></span><br><span class="line">  # it = @user</span><br><span class="line">  subject &#123; @user  &#125;</span><br><span class="line"></span><br><span class="line">  # respond_to 测试的是对象能否调用某个方法</span><br><span class="line">  # 在本例中, 测试的是@user.email 和 @user.name是否可以成功调用</span><br><span class="line">  it &#123; should respond_to :name  &#125;</span><br><span class="line">  it &#123; should respond_to :email  &#125;</span><br><span class="line"></span><br><span class="line">  # be_valid测试数据是否可以正确调用</span><br><span class="line">  it &#123; should be_valid  &#125;</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>执行 migrate, <code>$ rake db:migrate</code></p>
<p>然后, 单独测试model</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ rspec spec/models/user_spec.rb</span><br><span class="line">  User</span><br><span class="line">  should respond to #name</span><br><span class="line">  should respond to #email</span><br><span class="line">  should be valid</span><br><span class="line"></span><br><span class="line">  Finished in 0.00976 seconds (files took 1.97 seconds to load)</span><br><span class="line">  3 examples, 0 failures</span><br></pre></td></tr></table></figure>
<h3 id="实现视图"><a href="#实现视图" class="headerlink" title="实现视图"></a>实现视图</h3><blockquote>
<p>这时候再执行 Controller的测试:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ rspec spec/controllers/users_controller_spec.rb</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">Failures:</span><br><span class="line"></span><br><span class="line">1) UsersController GET #index responds successfully with an HTTP 200 status code</span><br><span class="line">Failure/Error: get :index</span><br><span class="line">ActionView::MissingTemplate:</span><br><span class="line">Missing template users/index, application/index with ...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我来创建<code>index.html.erb</code>并实现其代码.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;List Users&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;% @users.each do |user| %&gt;</span><br><span class="line">    &lt;li&gt;</span><br><span class="line">      &lt;%= user.name %&gt;</span><br><span class="line">      &lt;%= user.email %&gt;</span><br><span class="line">    &lt;/li&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<h3 id="启动server-观察页面"><a href="#启动server-观察页面" class="headerlink" title="启动server, 观察页面"></a>启动server, 观察页面</h3><blockquote>
<p>执行所有测试<code>rspec spec/</code>, 全都通过:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ rspec spec/</span><br><span class="line"></span><br><span class="line">  UsersController</span><br><span class="line">  GET #index</span><br><span class="line">  should respond successfully with an HTTP 200 status code</span><br><span class="line">  should render index template</span><br><span class="line">  should load all users into @users</span><br><span class="line"></span><br><span class="line">  User</span><br><span class="line">  should respond to #name</span><br><span class="line">  should respond to #email</span><br><span class="line">  should be valid</span><br><span class="line"></span><br><span class="line">  Finished in 0.03626 seconds (files took 1.41 seconds to load)</span><br><span class="line">  6 examples, 0 failures</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后我通过rails console新建一条数据</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rails console</span><br><span class="line"></span><br><span class="line">001:0&gt; User.create(name: &quot;test user&quot;, email: &quot;user@example.com&quot;)</span><br><span class="line">002:0&gt; User.all.count #=&gt; 1</span><br><span class="line">003:0&gt; exit</span><br></pre></td></tr></table></figure>
<blockquote>
<p>效果图:</p>
</blockquote>
<p><img src="http://i3.tietuku.com/024da538e47035a4.png" alt=""></p>
<h2 id="通过Cucumber测试"><a href="#通过Cucumber测试" class="headerlink" title="通过Cucumber测试"></a>通过Cucumber测试</h2><blockquote>
<p>这时cucumber的测试也可以通过了</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$  cucumber features/user_index.feature</span><br><span class="line">Using the default profile...</span><br><span class="line"><span class="symbol">Feature:</span> Listing all users<span class="string">' info for admin</span><br><span class="line"></span><br><span class="line">Scenario Outline: List all users                # features/user_index.feature:3</span><br><span class="line">Given There are &lt;user_number&gt; users in the db # features/step_definitions/users_steps.rb:1</span><br><span class="line">When the index page is displayed              # features/step_definitions/users_steps.rb:7</span><br><span class="line">Then I should see &lt;user_number&gt; users         # features/step_definitions/users_steps.rb:11</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">| user_number |</span><br><span class="line">| 0           |</span><br><span class="line">| 1           |</span><br><span class="line"></span><br><span class="line">2 scenarios (2 passed)</span><br><span class="line">6 steps (6 passed)</span><br><span class="line">0m0.982s</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>重构代码, 可以将公共的视图代码抽取到局部视图(app/views/users/_user.html.erb)中:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># app/views/users/index.html.erb</span><br><span class="line">&lt;h1&gt;List Users&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;% @users.each do |user| %&gt;</span><br><span class="line">    &lt;%= render @users %&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># app/views/users/_user.html.erb</span><br><span class="line"></span><br><span class="line">&lt;li&gt;</span><br><span class="line">  &lt;%= user.name&gt; %&gt;</span><br><span class="line">  &lt;%= user.email %&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>重构之后再分别进行cucumber和rspec的测试, 保证通过.</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>通过以上的例子不难发现, cucumber着重于整体的页面测试, 而RSpec着重于MVC这三个组件这样的细节测试.<br>具体的步骤, 先使用cucumber生成一个失败的测试, 因为没有MVC这三个组件, 我必须要通过RSpec来实现各个细节, 最后在RSpec开始测试到View时, 需要考虑让Cucumber测试也可以通过.</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Daniel Zhang" />
          <p class="site-author-name" itemprop="name">Daniel Zhang</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">104</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">104</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Daniel Zhang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"danielhexo"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
