<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'uSvyVbAJs-5jfXFawgQ3','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/16/form-for/" itemprop="url">
                  关于form_for
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-16T21:29:09+08:00" content="2015-02-16">
              2015-02-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/16/form-for/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/16/form-for/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><code>form_for</code>是一个非常重要的方法, 用户填写的表单中的信息就是通过该方法处理的, 对于form_for的处理涉及到Controller, View, Model.</p>
</blockquote>
<h2 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h2><ul>
<li>在Controller的new方法或者edit方法生成实例变量, 比如: <code>@user = User.new</code></li>
<li>在View中使用<code>form_for</code>方法使用model对象(@user)的各个字段生成一个form</li>
<li>用户点击submit按钮提交, 刚刚页面输入的各字段就会被以hash的形式封装进<code>params</code>中, 然后传给Controller.</li>
<li>Controller的create方法或者update方法就会就会使用params变量创建或者更新model</li>
</ul>
<h2 id="以新建用户为例"><a href="#以新建用户为例" class="headerlink" title="以新建用户为例"></a>以新建用户为例</h2><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><blockquote>
<p>现有一个实体叫做User, 还有2个属性<code>name</code>和<code>email</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># app/models/user.rb</span><br><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="在Controller的new方法中生成user的实例变量"><a href="#在Controller的new方法中生成user的实例变量" class="headerlink" title="在Controller的new方法中生成user的实例变量"></a>在Controller的new方法中生成user的实例变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/users_controller.rb</span><br><span class="line"></span><br><span class="line">def new</span><br><span class="line">  # 新建一个空的Model对象@user, 主要是在View中使用.</span><br><span class="line">  # 如果Controller中没有明确的指出`render xxx.html.erb`或`redirect_to xxx.html.erb`, 那么默认就是当前方法名, 这里是new, 需要渲染的视图是`new.html.erb`</span><br><span class="line">  @user = User.new</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="在View中使用form-for方法创建表单"><a href="#在View中使用form-for方法创建表单" class="headerlink" title="在View中使用form_for方法创建表单"></a>在View中使用<code>form_for</code>方法创建表单</h3><blockquote>
<p><code>form_for</code>方法接收@user为参数, 生成users表的name和email字段的label和text_field这些页面元素 </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_for @user do |f| %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">  &lt;%= f.label :name, &quot;Name&quot; %&gt;</span><br><span class="line">  &lt;%= f.text_field :name %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">  &lt;%= f.label :email, &quot;Email&quot; %&gt;</span><br><span class="line">  &lt;%= f.text_field :email %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">  &lt;%= f.submit &quot;Submit&quot; %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>像这样:<br><img src="http://i2.tietuku.com/fa25e83f8c10aae2.png" alt=""></p>
<p>这是部分html代码, 注意input表情的name属性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;label for=&quot;user_name&quot;&gt;Name&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;user[name]&quot; id=&quot;user_name&quot;&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h3><blockquote>
<p>我们输入这些文本框, 然后点击submit, 查看log信息,看看这些值是如何被封装以及如何在Controller中获取的.</p>
</blockquote>
<p><img src="http://i2.tietuku.com/09b177fc2e10b2dd.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">params = </span><br><span class="line">&#123;</span><br><span class="line">user: &#123;   # params[:user] #=&gt; &#123; name: &quot;daniel&quot;, email: &quot;shangrenzhidao@126.com&quot; &#125;</span><br><span class="line">    name: &quot;daniel&quot;, # params[:user][:name] # =&gt; &quot;daniel&quot;</span><br><span class="line">    email: &quot;shangrenzhidao@126.com&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="接收参数-保存到数据库"><a href="#接收参数-保存到数据库" class="headerlink" title="接收参数, 保存到数据库"></a>接收参数, 保存到数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class UsersController &lt; ApplicationController</span><br><span class="line">  def new</span><br><span class="line">    @user = User.new</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def create</span><br><span class="line">    @user = User.new(user_params)</span><br><span class="line">    if @user.save</span><br><span class="line">      # 相当于 user_path(@user)</span><br><span class="line">      redirect_to @user, notice: &quot;创建成功&quot;</span><br><span class="line">    else</span><br><span class="line">      render :new</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def show</span><br><span class="line">    @user = User.find(params[:id])</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">    def user_params</span><br><span class="line">      params.require(:user).permit(:name, :email)</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/15/migration/" itemprop="url">
                  Rails migration
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-15T16:14:52+08:00" content="2015-02-15">
              2015-02-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/15/migration/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/15/migration/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails的migration可以对数据库表进行修改, 比如添加或者删除列, 添加索引, 加NULL限制, 更改列名等等. 以下就对migration进行总结.</p>
</blockquote>
<h2 id="Migration的基础"><a href="#Migration的基础" class="headerlink" title="Migration的基础"></a>Migration的基础</h2><h3 id="创建migration文件"><a href="#创建migration文件" class="headerlink" title="创建migration文件"></a>创建migration文件</h3><blockquote>
<p>migration可以说是管理数据库schema的基础.<br>有两种方法来创建migration文件, 一个是”手动直接创建”, 另一个是<code>rails g model</code>间接创建.<br>实际上我们在创建一个model <code>rails g model</code>也会生成对应的migration, 然后我们使用<code>rake db:migrate</code>创建数据库, 之后如果需要修改表, 比如添加自动, 加约束, 那么就需要使用<code>rails g migration</code>了.</p>
</blockquote>
<h4 id="通过生成model创建migration"><a href="#通过生成model创建migration" class="headerlink" title="通过生成model创建migration"></a>通过生成model创建migration</h4><blockquote>
<p>生成Article model, 同时生成对应的migration, Article中有String类型的title 和 Text类型的content.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ rails g model Article title content:text</span><br><span class="line">invoke  active_record</span><br><span class="line">create    db/migrate/20150215104136_create_articles.rb</span><br><span class="line">create    app/models/article.rb</span><br><span class="line">invoke    test_unit</span><br><span class="line">create      test/models/article_test.rb</span><br><span class="line">create      test/fixtures/articles.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>migration 文件在<code>db/migrate</code>目录下, 而且为了防止生成的migration名字冲突, 将生成migration的时刻加入到了migration的文件名中, 降低了同名文件的概率.<br>那么我们来看看刚刚生成的migration文件, 需要继承<code>ActiveRecord::Migration</code>, 而且需要有<code>change</code>方法, 或者有<code>up</code>和<code>down</code>方法.<br>方法中, 可以创建一个表或者添加/删除列. 本例中使用<code>create_table</code>方法创建了一个叫做<code>articles</code>的方法, 在block中添加列.<br>timestamps实际上是生成了两个列: 记录创建时刻<code>created_at</code>记录被更新的时刻<code>updated_at</code>, 这两个列我们在创建或者更新属性的时候不需要添加, rails会自动更新这两个列的值.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># db/migrate/20150215104136_create_articles.rb</span><br><span class="line"></span><br><span class="line">class CreateArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    create_table :articles do |t|</span><br><span class="line">      t.string :title</span><br><span class="line">      t.text :content</span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>up</code>和<code>down</code>方法同时定义可以取代<code>change</code>方法, <code>up</code>方法在<code>rake db:migrate</code>执行时被执行, <code>down</code>方法在<code>rake db:rollback</code>执行时被执行.<br>使用<code>change</code>方法时, 我们应该可以推断出实现逻辑是可逆的, 如果我不确定实现的逻辑是否可逆, 那么就使用<code>up/down</code>方法, 下面的代码使用<code>up/down</code>替代了<code>change</code>方法:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class CreateArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def up</span><br><span class="line">    create_table :articles do |t|</span><br><span class="line">      t.string :title</span><br><span class="line">      t.text :content</span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def down</span><br><span class="line">    drop_table :articles</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h4 id="直接生成migration文件"><a href="#直接生成migration文件" class="headerlink" title="直接生成migration文件"></a>直接生成migration文件</h4><blockquote>
<p>有时候需要为已生成的表修改结构, 这时候就需要使用migration文件了.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rails g migration create_articles title:string content:text</span><br><span class="line"></span><br><span class="line">  invoke  active_record</span><br><span class="line">  create    db/migrate/&#123;current_time&#125;_create_articles.rb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>生成了与<code>rails g model</code>相同的migration文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># db/migrate/20150215104136_create_articles.rb</span><br><span class="line"></span><br><span class="line">class CreateArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    create_table :articles do |t|</span><br><span class="line">      t.string :title</span><br><span class="line">      t.text :content</span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="移植命令rake-db-migrate"><a href="#移植命令rake-db-migrate" class="headerlink" title="移植命令rake db:migrate"></a>移植命令<code>rake db:migrate</code></h3><blockquote>
<p><code>rake db:migrate</code>命令执行后, <strong><em>没有被移植的所有migration文件, 会被执行</em></strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rake db:migrate</span><br><span class="line"></span><br><span class="line"># 可以指定环境(生产, 开发或者测试等等)</span><br><span class="line">$ rake db:migrate RAILS_ENV=test</span><br><span class="line">$ rake db:migrate RAILS_ENV=production</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果了刚刚实行的migration, 可以使用<code>rake db:rollback</code>命令回退一步, 注意必须要有<code>down</code>方法.(使用change的请忽略)</p>
<p>如果要将数据库回到最初状态可以使用:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rake db:migrate VERSION=0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果想要删除数据库所有的表和数据, 就需要使用到<code>schema.rb</code>了, 有时候migration把数据库弄得很乱, 又不知道该如何修复, 那么干脆就重置数据库:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 数据库将被重置</span><br><span class="line">$ rake db:reset</span><br></pre></td></tr></table></figure>
<h3 id="查看migrate的使用记录"><a href="#查看migrate的使用记录" class="headerlink" title="查看migrate的使用记录"></a>查看migrate的使用记录</h3><blockquote>
<p>有时候我们需要查看使用了那些migrate, up状态还是down状态, 需要使用<code>rake db:migrate:status</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ rake db:migrate:status</span><br><span class="line"></span><br><span class="line"># up代表执行的是up方法(rake db:migrate),down方法, 表示运行的命令时rake db:rollback</span><br><span class="line">database: /Users/daniel/workspace/web_dev/backend/my_own_project/rails_basic/migration_test/db/development.sqlite3</span><br><span class="line"></span><br><span class="line"> Status   Migration ID    Migration Name</span><br><span class="line"> --------------------------------------------------</span><br><span class="line">    up     20150215104136  Create articles</span><br></pre></td></tr></table></figure>
<h3 id="批量导入数据"><a href="#批量导入数据" class="headerlink" title="批量导入数据"></a>批量导入数据</h3><blockquote>
<p>在开发时, 我们往往需要一些初始化数据, 一个个从页面提交固然可以, 但是, 这样做太麻烦, rails提供了更为简洁的方法:<br>可以在db/seeds.rb中创建对象, 然后运行<code>rake db:seed</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.times do |i|</span><br><span class="line">  Article.create!( title: &quot;T#&#123;i&#125;&quot; , content: &quot;C#&#123;i&#125;&quot; )</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后运行:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rake db:seed</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样数据就被保存的db中作为初始数据了.</p>
</blockquote>
<h3 id="migration中可以使用的数据类型"><a href="#migration中可以使用的数据类型" class="headerlink" title="migration中可以使用的数据类型"></a>migration中可以使用的数据类型</h3><blockquote>
<p><code>rails g model</code>和<code>rails g migration</code>可以使用的数据类型如下:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">integer 整数</span><br><span class="line">float 浮点小数</span><br><span class="line">decimal 高精度小数</span><br><span class="line"></span><br><span class="line">string </span><br><span class="line">text</span><br><span class="line">binary</span><br><span class="line"></span><br><span class="line">datetime</span><br><span class="line">timestamp</span><br><span class="line">date</span><br><span class="line">time</span><br><span class="line"></span><br><span class="line">boolean</span><br><span class="line"></span><br><span class="line">primary_key</span><br><span class="line">references</span><br></pre></td></tr></table></figure>
<h2 id="Migration的方法总结"><a href="#Migration的方法总结" class="headerlink" title="Migration的方法总结"></a>Migration的方法总结</h2><h3 id="添加列-add-column"><a href="#添加列-add-column" class="headerlink" title="添加列(add_column)"></a>添加列(add_column)</h3><blockquote>
<p>向<code>articles</code>表中添加<code>user_id</code>列.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rails g migration add_user_id_to_articles user_id:integer</span><br><span class="line"></span><br><span class="line">invoke  active_record</span><br><span class="line">create    db/migrate/20150216050907_add_user_id_to_articles.rb</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class AddUserIdToArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    add_column :articles, :user_id, :integer</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>add_column</code>还可以指定下面的选项:</p>
</blockquote>
<ul>
<li>null(null_allowed): true 指的是该列允许是空值</li>
<li>limit: size 指的是对字段限定长度, 如果是string类型或者text类型的size代表字符个数, 如果是binary类型或者integer类型那么size就代表字节数</li>
<li>default: 设定默认值</li>
</ul>
<blockquote>
<p>如果类型是<code>decimal</code>, 还可以追加精确度选项, <code>precision: [num], scale: [num]</code>, precision表示一共保留几位有效数字, scale表示其中保留几位小数.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">precision: 5, scale: 2 # =&gt; 一共保留5位有效数字, 保留2位小数. 所以范围是 -999.99~999.99</span><br></pre></td></tr></table></figure>
<h3 id="删除列"><a href="#删除列" class="headerlink" title="删除列"></a>删除列</h3><blockquote>
<p>删除使用的方法是<code>remove_column</code>, 比如: 删除user_id这一列</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ rails g migration remove_user_id_from_articles user_id</span><br><span class="line"></span><br><span class="line">invoke  active_record</span><br><span class="line">create    db/migrate/20150216055403_remove_user_id_from_articles.rb</span><br><span class="line"></span><br><span class="line"># 生成的文件</span><br><span class="line">class RemoveUserIdFromArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    remove_column :articles, :user_id, :string</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="改变数据类型"><a href="#改变数据类型" class="headerlink" title="改变数据类型"></a>改变数据类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rails g migration change_datatype_title_of_articles</span><br><span class="line"></span><br><span class="line">invoke  active_record</span><br><span class="line">create    db/migrate/20150216061727_change_datatype_title_of_articles.rb</span><br><span class="line"></span><br><span class="line">class ChangeDatatypeTitleOfArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    change_column :articles, :title, :text</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>change_column</code>方法也可以指定各种选项, 这里不多说了.</p>
</blockquote>
<h3 id="索引及唯一性限制条件的添加与删除"><a href="#索引及唯一性限制条件的添加与删除" class="headerlink" title="索引及唯一性限制条件的添加与删除"></a>索引及唯一性限制条件的添加与删除</h3><blockquote>
<p>可以使用<code>add_index</code>方法向表的某一列添加索引. 下面的例子是为title字段添加索引</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class AddTitleIndexToArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    # 唯一性约束</span><br><span class="line">    add_index :articles, :title, unique: true</span><br><span class="line">    add_index :articles, :title</span><br><span class="line">    # 设定复合索引</span><br><span class="line">    add_index :articles, [:title, :created_at]</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="是否允许为NULL"><a href="#是否允许为NULL" class="headerlink" title="是否允许为NULL"></a>是否允许为NULL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">change_column_null(:users, :nickname, false) # =&gt; 不允许 :nickname NULL</span><br><span class="line">change_column_null(:users, :nickname, true) # =&gt; 允许 :nickname NULL</span><br></pre></td></tr></table></figure>
<h3 id="设定默认值"><a href="#设定默认值" class="headerlink" title="设定默认值"></a>设定默认值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change_column_default :suppliers, :qualification, &apos;new&apos;</span><br></pre></td></tr></table></figure>
<h3 id="修改列名"><a href="#修改列名" class="headerlink" title="修改列名"></a>修改列名</h3><blockquote>
<p>列名也是可以修改的, 使用<code>rename_column</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class RenameTitleToTimuInArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    # rename_column(:table_name, :old_column_name, :new_column_name)</span><br><span class="line">    rename_column :articles, :title, :timu</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="创建表-create-table"><a href="#创建表-create-table" class="headerlink" title="创建表(create_table)"></a>创建表(create_table)</h3><blockquote>
<p>创建<code>users</code>表</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">rails g migration create_users name:string email:string</span><br><span class="line">  invoke  active_record</span><br><span class="line">  create    db/migrate/20150216073226_create_users.rb</span><br><span class="line"></span><br><span class="line">class CreateUsers &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    create_table :users do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.string :email</span><br><span class="line"></span><br><span class="line">      # 如果没有生成时间戳, 自行加上</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h3><blockquote>
<p>使用<code>drop_table</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class DropUsers &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    drop_table :users</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要注意: 删除表和删除列都是不可逆的, 也就是说不可以使用<code>rake db:rollback</code>撤销刚刚的变更.如果想使用<code>rollback</code>就需要使用<code>up/down</code>取代change方法了:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class DropUsers &lt; ActiveRecord::Migration</span><br><span class="line">  def up</span><br><span class="line">    drop_table :users</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def down</span><br><span class="line">    create_table :users do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.string :email</span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="改变表名-rename-table"><a href="#改变表名-rename-table" class="headerlink" title="改变表名(rename_table)"></a>改变表名(rename_table)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rails g migration rename_artiles_to_posts</span><br><span class="line">  invoke  active_record</span><br><span class="line">  create    db/migrate/20150216075545_rename_artiles_to_posts.rb</span><br><span class="line"></span><br><span class="line">class RenameArtilesToPosts &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    rename_table :articles, :posts</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="生成环境下初始化数据库"><a href="#生成环境下初始化数据库" class="headerlink" title="生成环境下初始化数据库"></a>生成环境下初始化数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rails g migration insert_initial_categories_into_categories</span><br><span class="line">class InsertInitialCategoriesIntoCategories &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    contents = %w(交通费 电话费 水费 燃气费)</span><br><span class="line">    contents.each do |content|</span><br><span class="line">      Article.create content: content</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/15/model-callback/" itemprop="url">
                  Model中的回调方法(CallBack)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-15T14:27:57+08:00" content="2015-02-15">
              2015-02-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/15/model-callback/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/15/model-callback/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>ActiveRecord中, 在model的校验, 创建, 更新和删除前后可以插入一些预处理或后处理的回调方法(Callbacks)</p>
</blockquote>
<h2 id="简单介绍callback"><a href="#简单介绍callback" class="headerlink" title="简单介绍callback"></a>简单介绍callback</h2><blockquote>
<p>简单来说, 就是在执行某个方法之前(或之后)先去执行另外一个方法. <code>before_save</code> <code>after_save</code>这种在<code>save</code>之前, 之后执行的方法.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  before_create :create_remember_token</span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">    def create_remember_token</span><br><span class="line">      User.remember_token = User.encrypt(User.new_remember_token)</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="ActiveRecord的Callback方法一览"><a href="#ActiveRecord的Callback方法一览" class="headerlink" title="ActiveRecord的Callback方法一览"></a>ActiveRecord的Callback方法一览</h2><blockquote>
<p>按照被调用的先后顺序排列:</p>
</blockquote>
<h3 id="创建对象"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象</h3><ul>
<li>before_validation</li>
<li>after_validation</li>
<li>before_save</li>
<li>around_save</li>
<li>before_create</li>
<li>around_create</li>
<li>after_create</li>
<li>after_save</li>
</ul>
<h3 id="更新对象"><a href="#更新对象" class="headerlink" title="更新对象"></a>更新对象</h3><ul>
<li>before_validation</li>
<li>after_validation</li>
<li>before_save</li>
<li>around_save</li>
<li>before_update</li>
<li>around_update</li>
<li>after_update</li>
<li>after_save</li>
</ul>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><ul>
<li>before_destroy</li>
<li>around_destroy</li>
<li>after_destroy</li>
<li>after_save</li>
</ul>
<h3 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a>实例化</h3><ul>
<li>after_initialize </li>
</ul>
<h3 id="从数据库加载记录后"><a href="#从数据库加载记录后" class="headerlink" title="从数据库加载记录后"></a>从数据库加载记录后</h3><ul>
<li>after_find </li>
</ul>
<h3 id="设定了touch"><a href="#设定了touch" class="headerlink" title="设定了touch"></a>设定了touch</h3><ul>
<li>after_touch</li>
</ul>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/15/scope-model/" itemprop="url">
                  Rails Model的Scope的使用方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-15T09:59:29+08:00" content="2015-02-15">
              2015-02-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/15/scope-model/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/15/scope-model/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Model 的Scope可以把一些共同的查询定义成model的类方法, 这样一来, 就不需要写复杂查询了, 而且程序的可读性也大大提高了.</p>
</blockquote>
<ul>
<li><code>scope</code>可以定义范围.</li>
<li><code>default_scope</code>可以定义默认的范围</li>
</ul>
<h2 id="scope声明"><a href="#scope声明" class="headerlink" title="scope声明"></a>scope声明</h2><blockquote>
<p>下面的两种定义查询的方法是等价的:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 使用scope方法定义</span><br><span class="line"></span><br><span class="line">class Post &lt; ActiveRecord::Base</span><br><span class="line">  scope :published, -&gt; &#123; where(published: true) &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 或者使用类方法定义</span><br><span class="line"></span><br><span class="line">class Post &lt; ActiveRecord::Base</span><br><span class="line">  def self.published</span><br><span class="line">    where(published: true)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以直接以类方法的形式调用:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Post.published</span><br><span class="line">category = Category.first</span><br><span class="line">category.posts.published</span><br></pre></td></tr></table></figure>
<h2 id="scope-方法的参数"><a href="#scope-方法的参数" class="headerlink" title="scope 方法的参数"></a>scope 方法的参数</h2><blockquote>
<p>scope方法也可以接收参数, 更准确来讲是scope方法的proc的参数</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># app/modes/post.rb</span><br><span class="line">class Post &lt; ActiveRecord::Base</span><br><span class="line">  scope :created_before, -&gt;(time) &#123; where(&quot;created_at &lt; ?&quot;, time)  &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">Post.created_before(Time.local(2011)) #=&gt; 2011年之前所有的数据</span><br></pre></td></tr></table></figure>
<h2 id="scope-的合并查询"><a href="#scope-的合并查询" class="headerlink" title="scope 的合并查询"></a>scope 的合并查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># app/models/user.rb</span><br><span class="line"></span><br><span class="line"># app/models/user.rb</span><br><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  scope :inactive, -&gt; &#123; where state: &apos;inactive&apos;  &#125;</span><br><span class="line">  scope :finished, -&gt; &#123; where state: &apos;finished&apos;  &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 使用方法</span><br><span class="line">User.inactive.finished</span><br><span class="line"># =&gt; SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &apos;inactive&apos; AND &quot;users&quot;.&quot;state&quot; = &apos;finished&apos;</span><br></pre></td></tr></table></figure>
<h2 id="default-scope设定"><a href="#default-scope设定" class="headerlink" title="default_scope设定"></a><code>default_scope</code>设定</h2><blockquote>
<p><code>default_scope</code>相当于是对整个查询的限定. 比如下面的例子, 我需要查询所有没有退会的会员, 乃至后面的查询都是建立在此查询的基础之上的:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Customer &lt; ActiveRecord::Base</span><br><span class="line">  default_scope &#123; where(&quot;removed_at is NULL&quot;) &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">Customer.all</span><br><span class="line"># =&gt; SELECT &quot;customers&quot;.* FROM &quot;customers&quot; WHERE (removed_at IS NULL)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/15/mac-mysql-install/" itemprop="url">
                  OSX下使用Homebrew安装MySQL数据库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-15T07:29:30+08:00" content="2015-02-15">
              2015-02-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/15/mac-mysql-install/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/15/mac-mysql-install/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用Homebrew安装MySQL"><a href="#使用Homebrew安装MySQL" class="headerlink" title="使用Homebrew安装MySQL"></a>使用Homebrew安装MySQL</h2><blockquote>
<p>首先安装MySQL</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install mysql</span><br></pre></td></tr></table></figure>
<blockquote>
<p>确认安装成功:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew info mysql</span><br></pre></td></tr></table></figure>
<blockquote>
<p>初始化数据库:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ unset TMPDIR</span><br><span class="line">$ mysql_install_db --verbose --user=`whoami` --basedir=&quot;$(brew --prefix mysql)&quot;\</span><br><span class="line">                                             --datadir=/usr/local/var/mysql\</span><br><span class="line">                                             --tmpdir=/tmp</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果出现了下面的错误:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mysql.server start&lt;br /&gt;Starting MySQL</span><br><span class="line">.. ERROR! The server quit without updating PID file (/usr/local/var/mysql/daniel.my-home.pid).</span><br></pre></td></tr></table></figure>
<blockquote>
<p>很明显, 没有 /usr/local/var/mysql的权限, 所以使用chown将该目录的权限更改为<code>_mysql:_mysql</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -R _mysql:_mysql /usr/local/var/mysql</span><br></pre></td></tr></table></figure>
<blockquote>
<p>修改MySQL密码和系统管理员密码(可选)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysqladmin -u root password &apos;password&apos;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样就可以使用MySQL了.<br>登录MySQL, 删除没有必要的数据和不安全的用户:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; drop database test;</span><br><span class="line">mysql &gt; use mysql;</span><br><span class="line">mysql &gt; delete from user where password=&quot;&quot;;</span><br><span class="line">mysql &gt; flush privileges;</span><br><span class="line">mysql &gt; exit;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>设置登录OSX时自动启动MySQL(可选)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -sfv /usr/local/opt/mysql/*.plist ~/Library/LaunchAgents</span><br><span class="line">launchctl load ~/Library/LaunchAgents/homebrew.mxcl.mysql.plist</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/14/validate-error/" itemprop="url">
                  Rails 中model的校验错误消息相关
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-14T22:11:54+08:00" content="2015-02-14">
              2015-02-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/14/validate-error/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/14/validate-error/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Model的校验错误消息对象errors的使用方法"><a href="#Model的校验错误消息对象errors的使用方法" class="headerlink" title="Model的校验错误消息对象errors的使用方法"></a>Model的校验错误消息对象<code>errors</code>的使用方法</h2><blockquote>
<p>Model中发生了验证错误时, 具体的错误信息会被保存在<code>errors</code>对象中, 而且, 可以通过<code>full_messages</code>取出所以错误消息的数组, 看下面的例子:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/models/product.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  validate <span class="symbol">:name</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发生验证错误</span></span><br><span class="line">&gt; product = Product.new</span><br><span class="line">&gt; =&gt; #&lt;Product id: nil, name: nil, price: nil, discontinued: nil, created_at: nil, updated_at: nil&gt;</span><br><span class="line">&gt; &gt; product.valid?</span><br><span class="line">&gt; =&gt; <span class="literal">false</span></span><br><span class="line">&gt; &gt; product.errors.messages</span><br><span class="line">&gt; =&gt; &#123;<span class="symbol">:name=&gt;</span>[<span class="string">"can't be blank"</span>]&#125;</span><br><span class="line">&gt; &gt; product.errors.full_messages</span><br><span class="line">&gt; =&gt; [<span class="string">"Name can't be blank"</span>]</span><br><span class="line">&gt; &gt; product.save</span><br><span class="line">&gt; =&gt; <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 未发生验证错误</span></span><br><span class="line">product = Product.new( <span class="symbol">name:</span> <span class="string">"Pname"</span>  )</span><br><span class="line">=&gt; #&lt;Product id: nil, name: "Pname", price: nil, discontinued: nil, created_at: nil, updated_at: nil&gt;</span><br><span class="line"><span class="meta">irb(main):017:0&gt;</span> product.valid?</span><br><span class="line">=&gt; true</span><br><span class="line">&gt; product.errors.messages</span><br><span class="line">&gt; =&gt; &#123;&#125;</span><br><span class="line">&gt; &gt; product.errors.full_messages</span><br><span class="line">&gt; =&gt; []</span><br><span class="line">&gt; &gt; product.save</span><br><span class="line">&gt; =&gt; <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="添加错误消息到model"><a href="#添加错误消息到model" class="headerlink" title="添加错误消息到model"></a>添加错误消息到model</h2><blockquote>
<p>使用 <code>errors.add</code>和<code>errors[:base]</code> 可以自己添加错误消息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line"></span><br><span class="line">validate :add_error_sample</span><br><span class="line"></span><br><span class="line">  def add_error_sample</span><br><span class="line">    if name.blank?</span><br><span class="line">      errors.add(:name, &quot;is empty!&quot;)</span><br><span class="line">      errors[:base] &lt;&lt; &quot;for all columns errors&quot;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如下图, errors[:base]是公共错误信息, 只要有验证错误, 它就会被显示<br><img src="http://i2.tietuku.com/9bba27b8227d8572.png" alt=""></p>
<p>我们也可以清除这些错误信息:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">product = Product.new</span><br><span class="line">product.valid? # =&gt; false</span><br><span class="line">product.errors.full_messages # =&gt; [&quot;Name can&apos;t be blank&quot;]</span><br><span class="line">product.errors.clear</span><br><span class="line">product.erros.empty? # =&gt; true</span><br></pre></td></tr></table></figure>
<h2 id="在视图中显示错误消息"><a href="#在视图中显示错误消息" class="headerlink" title="在视图中显示错误消息"></a>在视图中显示错误消息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if @product.errors.any? %&gt;</span><br><span class="line">  &lt;div id=&quot;error_explanation&quot;&gt;</span><br><span class="line">    &lt;h2&gt;&lt;%= pluralize(@product.errors.count, &quot;error&quot;) %&gt; prohibited this product from being saved:&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">    &lt;% @product.errors.full_messages.each do |message| %&gt;</span><br><span class="line">    &lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;</span><br><span class="line">    &lt;% end %&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h2><ol>
<li>在config/locales/ 下添加 <code>zh-CN.yml</code></li>
<li>在 config/application.rb 添加 <code>config.i18n.default_locale = :&quot;zh-CN&quot;</code></li>
<li>重启服务器<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># config/locales/zh-CN.yml</span><br><span class="line">zh-CN:</span><br><span class="line">  attributes:</span><br><span class="line">      name: &quot;名字&quot;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>效果如下:<br><img src="http://i2.tietuku.com/104e8ee52c2ae9ac.png" alt=""></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/13/validation/" itemprop="url">
                  对Model校验
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-13T08:13:21+08:00" content="2015-02-13">
              2015-02-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/13/validation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/13/validation/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails中, 我们可以将用户输入数据在被保存到数据库前进行校验, 成为Validation.</p>
</blockquote>
<h2 id="Rails校验流程"><a href="#Rails校验流程" class="headerlink" title="Rails校验流程"></a>Rails校验流程</h2><blockquote>
<p>我要一步步说明Rails的校验流程</p>
</blockquote>
<h3 id="使用validates方法-对Model进行校验的条件的设定"><a href="#使用validates方法-对Model进行校验的条件的设定" class="headerlink" title="使用validates方法, 对Model进行校验的条件的设定"></a>使用validates方法, 对Model进行校验的条件的设定</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># app/models/product.rb</span><br><span class="line"></span><br><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line">  # title必须存在</span><br><span class="line">  validates :title, presence: true</span><br><span class="line">  # price的值为integer类型, 取值范围大于0</span><br><span class="line">  validates :price, numericality: &#123; only_integer: true, greater_than_or_equal_to: 0 &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="在controller中保存或更新model"><a href="#在controller中保存或更新model" class="headerlink" title="在controller中保存或更新model"></a>在controller中保存或更新model</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def create</span><br><span class="line">  # product_params 以hash形式封装了用户在表单中输入的值</span><br><span class="line">¦ @product = Product.new(product_params)</span><br><span class="line"></span><br><span class="line">¦ respond_to do |format|</span><br><span class="line">    # 在保存前Product 类会参照验证定义.</span><br><span class="line">    # 未发生验证错误, 则将记录保存到数据库, 否则再次渲染new action</span><br><span class="line">¦ ¦ if @product.save</span><br><span class="line">¦ ¦ ¦ format.html &#123; redirect_to @product, notice: &apos;Product was successfully created.&apos;  &#125;</span><br><span class="line">¦ ¦ ¦ format.json &#123; render :show, status: :created, location: @product  &#125;</span><br><span class="line">¦ ¦ else</span><br><span class="line">¦ ¦ ¦ format.html &#123; render :new  &#125;</span><br><span class="line">¦ ¦ ¦ format.json &#123; render json: @product.errors, status: :unprocessable_entity  &#125;</span><br><span class="line">¦ ¦ end</span><br><span class="line">¦ end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="验证错误会被保存在errors中"><a href="#验证错误会被保存在errors中" class="headerlink" title="验证错误会被保存在errors中"></a>验证错误会被保存在<code>errors</code>中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_for(@product) do |f| %&gt;</span><br><span class="line">  &lt;% if @product.errors.any? %&gt;</span><br><span class="line">  &lt;div id=&quot;error_explanation&quot;&gt;</span><br><span class="line">  &lt;!-- 取出错误消息， 显示在页面上 --&gt;</span><br><span class="line">  &lt;h2&gt;&lt;%= pluralize(@product.errors.count, &quot;error&quot;) %&gt; prohibited this product from being saved:&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">  &lt;ul&gt;</span><br><span class="line">  &lt;% @product.errors.full_messages.each do |message| %&gt;</span><br><span class="line">  &lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">  &lt;%= f.label :title %&gt;&lt;br&gt;</span><br><span class="line">  &lt;%= f.text_field :title %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">  &lt;%= f.label :price %&gt;&lt;br&gt;</span><br><span class="line">  &lt;%= f.number_field :price %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">  &lt;%= f.submit %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="定义验证"><a href="#定义验证" class="headerlink" title="定义验证"></a>定义验证</h2><h3 id="存在性检查"><a href="#存在性检查" class="headerlink" title="存在性检查"></a>存在性检查</h3><blockquote>
<p>使用<code>prensence</code> 对字段进行非空检查.<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">validates <span class="symbol">:name</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RSpec检查的方法</span></span><br><span class="line"></span><br><span class="line">it &#123; is_expected.to validate_presence_of(<span class="symbol">:name</span>) &#125;</span><br></pre></td></tr></table></figure></p>
<p>boolean类型的验证, 使用inclusion 选项</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 其实即使保持字符串也是可以的, ruby会作为true来处理</span></span><br><span class="line">validates <span class="symbol">:flag</span>, <span class="symbol">inclusion:</span> &#123; <span class="symbol">in:</span> [<span class="literal">true</span>, flase] &#125;</span><br></pre></td></tr></table></figure>
<h2 id="唯一性验证"><a href="#唯一性验证" class="headerlink" title="唯一性验证"></a>唯一性验证</h2><blockquote>
<p>使用<code>uniqueness</code>选项检查属性值是否唯一</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validates <span class="symbol">:email</span>, <span class="symbol">uniqueness:</span> <span class="literal">true</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">it &#123; is_expected.to validate_uniqueness_of(<span class="symbol">:email</span>) &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要注意的是: 如果服务器的并发很高时, 比如在注册新用户时, 连续两次点击创建按钮, 还是有可能跳过rails的验证在数据库中创建两条相同的记录.<br>这时候有必要再加一道防线: 数据库中添加唯一性索引:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rails g migration add_index_to_users_email</span><br><span class="line"># db/migrate/YYYYMNDDHHMMSS_add_index_to_users_email.rb</span><br><span class="line"></span><br><span class="line">class AddIndexToUsersEmail &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    add_index :users, :email, unique: true</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure></p>
<p>当然也可以对多个属性的唯一性, 比如用户发表不可以发表相同题目的文章:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  belongs_to <span class="symbol">:user</span></span><br><span class="line">  validates <span class="symbol">:title</span>, <span class="symbol">uniqueness:</span> &#123; <span class="symbol">scope:</span> [<span class="symbol">:user_id</span>] &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rspec</span></span><br><span class="line">it &#123; is_expected.to validate_uniqueness_of(<span class="symbol">:title</span>).scoped_to(<span class="symbol">:user_id</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># db migration</span></span><br><span class="line">add_index <span class="symbol">:articles</span>, [<span class="symbol">:title</span>, <span class="symbol">:user_id</span>], <span class="symbol">uniqueness:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>一般在验证Email时, 都是统一转化为小写, 再进行唯一性检查:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  before_save &#123; <span class="keyword">self</span>.downcase! &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="长度检查-length"><a href="#长度检查-length" class="headerlink" title="长度检查(length)"></a>长度检查(length)</h3><blockquote>
<p>使用<code>length</code>进行长度验证</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">validates <span class="symbol">:name</span>, <span class="symbol">length:</span> &#123; <span class="symbol">minumum:</span> <span class="number">2</span> &#125;</span><br><span class="line">validates <span class="symbol">:bio</span>, <span class="symbol">length:</span> &#123; <span class="symbol">maximum:</span> <span class="number">500</span> &#125;</span><br><span class="line">validates <span class="symbol">:password</span>, <span class="symbol">length:</span> &#123; <span class="symbol">in:</span> <span class="number">6</span>..<span class="number">20</span> &#125;</span><br><span class="line">validates <span class="symbol">:registration_number</span>, <span class="symbol">length:</span> &#123; <span class="symbol">is:</span> <span class="number">5</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># rspec</span></span><br><span class="line">it &#123; is_expected_to ensure_length_of(<span class="symbol">:name</span>).is_at_least(<span class="number">2</span>) &#125;</span><br><span class="line">it &#123; is_expected_to ensure_length_of(<span class="symbol">:bio</span>).is_at_most(<span class="number">500</span>) &#125;</span><br><span class="line">it &#123; is_expected_to ensure_length_of(<span class="symbol">:password</span>).is_at_least(<span class="number">6</span>).is_at_most(<span class="number">20</span>) &#125;</span><br><span class="line">it &#123; is_expected_to ensure_length_of(<span class="symbol">:registration_number</span>).is_equal_to(<span class="number">6</span>) &#125;</span><br></pre></td></tr></table></figure>
<h3 id="格式检查-format"><a href="#格式检查-format" class="headerlink" title="格式检查(format)"></a>格式检查(format)</h3><blockquote>
<p>使用<code>format</code> option可以对格式进行检查, 一般使用正则表达式比较多一些:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">VALID_EMAIL_REGEX =  <span class="regexp">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span></span><br><span class="line">validates <span class="symbol">:email</span>, <span class="symbol">format:</span> &#123; <span class="symbol">with:</span> VALID_EMAIL_REGEX &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># rspec</span></span><br><span class="line"></span><br><span class="line">it <span class="string">"valid emails"</span> <span class="keyword">do</span></span><br><span class="line">  valid_emails = <span class="string">%w(</span><br><span class="line">    user@foo.COM</span><br><span class="line">    A_US-ER@f.b.org</span><br><span class="line">    frst.lst@foo.jp</span><br><span class="line">    a+b@baz.cn</span><br><span class="line">  )</span></span><br><span class="line">  is_expected_to allow_value(*valid_emails).<span class="keyword">for</span>(<span class="symbol">:email</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">it <span class="string">"invalid emails"</span> <span class="keyword">do</span></span><br><span class="line">  invalid_emails = <span class="string">%w(</span><br><span class="line">    user@foo,com</span><br><span class="line">    user_at_foo.org</span><br><span class="line">    example.user@foo.</span><br><span class="line">    foo@bar_baz.com</span><br><span class="line">    foo@bar+baz.com</span><br><span class="line">    foo@bar..com</span><br><span class="line">  )</span></span><br><span class="line">  is_expected_not_to allow_value(*invalid_emails).<span class="keyword">for</span>(<span class="symbol">:email</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="数值检查"><a href="#数值检查" class="headerlink" title="数值检查"></a>数值检查</h3><blockquote>
<p><code>numericality</code>选项可以对数值类型进行验证</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  validates <span class="symbol">:points</span>, <span class="symbol">numericality:</span> <span class="literal">true</span> <span class="comment"># 整数或者小数有效</span></span><br><span class="line">  validates <span class="symbol">:counts</span>, <span class="symbol">numericality:</span> &#123; <span class="symbol">only_integer:</span> <span class="literal">true</span> &#125; <span class="comment"># 只有整数有效</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rspec</span></span><br><span class="line"></span><br><span class="line">it &#123; is_expected.to validate_numericality_of(<span class="symbol">:points</span>) &#125;</span><br><span class="line">it &#123; is_expected.to validate_numericality_of(<span class="symbol">:counts</span>).only_integer &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>only_integer: true</code>指定后, 可以追加下面选项来对数值本身进行限制</p>
</blockquote>
<ul>
<li>greater_than</li>
<li>greater_than_or_equal_to</li>
<li>equal_to</li>
<li>less_than</li>
<li>less_than_or_equal_to</li>
<li>odd</li>
<li><p>even</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">validates :counts, numericality: &#123;</span><br><span class="line"> only_integer: true, greater_than_or_equal_to: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># rspec</span><br><span class="line">it &#123; is_expected.to validate_numericality_of(:counts).only_integer.is_greater_or_equal_to(0) &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="包含在集合内的验证"><a href="#包含在集合内的验证" class="headerlink" title="包含在集合内的验证"></a>包含在集合内的验证</h3><blockquote>
<p><code>inclusion</code> option中使用<code>in</code>来定义一个集合, 指定的值需要包含在集合内(属于集合的元素之一)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validates :size, inclusion: &#123; in: %w(small medium large) &#125;</span><br><span class="line"></span><br><span class="line"># rspec</span><br><span class="line">it &#123; is_expected.to ensure_inclusion_of(:size).in_array(%w(small medium large)) &#125;</span><br></pre></td></tr></table></figure>
<h3 id="不包含在集合内的验证"><a href="#不包含在集合内的验证" class="headerlink" title="不包含在集合内的验证"></a>不包含在集合内的验证</h3><blockquote>
<p><code>exclusion</code>option指定属性不应该是集合中的元素, 同样, 集合使用<code>in</code>定义</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validates :subdomain, exclusion: &#123; in: %(www us cn jp) &#125;</span><br><span class="line"></span><br><span class="line"># rspec</span><br><span class="line">it &#123; is_expected.to ensure_exclusion_of(:subdomain).in_array(%(www us cn jp)) &#125;</span><br></pre></td></tr></table></figure>
<h2 id="跳过验证"><a href="#跳过验证" class="headerlink" title="跳过验证"></a>跳过验证</h2><blockquote>
<p>以下方法需要先通过验证才可以成功保存到数据库中</p>
</blockquote>
<ul>
<li>create</li>
<li>create!</li>
<li>save</li>
<li>save!</li>
<li>update</li>
<li>update!</li>
</ul>
<blockquote>
<p>如果不要经过验证, 可以使用<code>validate</code> option<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save(<span class="symbol">valiate:</span> <span class="literal">false</span>)</span><br></pre></td></tr></table></figure></p>
<p>或者使用以下方法也同样可以绕过验证:</p>
</blockquote>
<ul>
<li>decrement!</li>
<li>decrement_counter</li>
<li>increment!</li>
<li>increment_counter</li>
<li>toggle!</li>
<li>update_all</li>
<li>update_attribute</li>
<li>update_column</li>
<li>update_columns</li>
<li>update_counters</li>
</ul>
<blockquote>
<p>这些方法都是直接使用SQL更新数据库, 未经过ActiveRecord</p>
</blockquote>
<h2 id="定义校验条件"><a href="#定义校验条件" class="headerlink" title="定义校验条件"></a>定义校验条件</h2><blockquote>
<p>有些验证需要在某种特定的情况下才会发生, 这时候就需要使用带有条件的验证了, 可以指定<code>if</code>或<code>unless</code>选项.比如下面的例子, 当使用银行卡支付时才会验证卡号存在:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Order &lt; ActiveRecord::Base</span><br><span class="line">  validates :card_number, presence: true, if: :paid_with_card?</span><br><span class="line"></span><br><span class="line">  def paid_with_card?</span><br><span class="line">    payment_type == &quot;card&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="保存前确定数值是否有效"><a href="#保存前确定数值是否有效" class="headerlink" title="保存前确定数值是否有效"></a>保存前确定数值是否有效</h2><blockquote>
<p>我们可以使用<code>valid?</code> <code>invalid?</code> 检查要保存的属性值是否有效(能否通过验证), 如果调用完该方法返回的结果是false, rails就会把错误消息设定到当前对象的errors中:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># app/models/article.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  validates <span class="symbol">:title</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">article = Article.new(<span class="symbol">title:</span> <span class="literal">nil</span>)</span><br><span class="line">article.valid?</span><br><span class="line"></span><br><span class="line"><span class="comment"># =&gt; false # 这时候向errors中添加错误消息</span></span><br><span class="line"></span><br><span class="line">article.errors.full_messages</span><br><span class="line"><span class="comment"># =&gt; ["Title can't be blank"]</span></span><br><span class="line"></span><br><span class="line">article = Article.new(<span class="symbol">title:</span> <span class="literal">nil</span>)</span><br><span class="line">article.invalid?</span><br><span class="line"></span><br><span class="line"><span class="comment"># =&gt; true # 这时候向errors中添加错误信息</span></span><br><span class="line"></span><br><span class="line">article.errors.full_messages</span><br><span class="line"><span class="comment"># =&gt; ["Title can't be blank"]</span></span><br></pre></td></tr></table></figure>
<h2 id="定义自己的验证类和方法"><a href="#定义自己的验证类和方法" class="headerlink" title="定义自己的验证类和方法"></a>定义自己的验证类和方法</h2><blockquote>
<p>当rails提供的验证方法无法满足需求时, 可以自己定义一些验证</p>
</blockquote>
<h3 id="定制化校验方法-ValidatE"><a href="#定制化校验方法-ValidatE" class="headerlink" title="定制化校验方法(ValidatE)"></a>定制化校验方法(ValidatE)</h3><blockquote>
<p><code>validate</code>(注意是原形) 可以创建自己的校验方法. 我们可以定义自己的方法进行校验逻辑的实现, 然后将方法名symbol化, 作为参数传递给<code>validate</code><br>需要注意的是: 验证错误消息需要自己添加上.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># app/models/invoice.rb</span><br><span class="line">class Invoice &lt; ActiveRecord::Base</span><br><span class="line">  validate :expiration_date_cannot_be_in_the_past,</span><br><span class="line">  :discount_cannot_be_greater_than_total_value</span><br><span class="line"></span><br><span class="line">  def expiration_date_cannot_be_in_the_past</span><br><span class="line">  if expiration_date.present? &amp;&amp; expiration_date &lt; Date.today</span><br><span class="line">  errors.add(:expiration_date, &quot;can&apos;t be in the past&quot;)</span><br><span class="line">  end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def discount_cannot_be_greater_than_total_value</span><br><span class="line">  if discount &gt; total_value</span><br><span class="line">  errors.add(:discount, &quot;can&apos;t be greater than total value&quot;)</span><br><span class="line">  end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="定制化校验类-Validator"><a href="#定制化校验类-Validator" class="headerlink" title="定制化校验类(Validator)"></a>定制化校验类(Validator)</h3><blockquote>
<p>通过继承<code>ActiveModel::Validator</code> 创建自己的验证类, 并且, 我们必须实现<code>validate</code>方法, 然后把自己的验证类Mixin进Model类中</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class MyValidator &lt; ActiveModel::Validator</span><br><span class="line">  def validate(record)</span><br><span class="line">    unless record.name.starts_with? &apos;X&apos;</span><br><span class="line">      record.errors[:name] &lt;&lt; &apos;Need a name starting with X please!&apos;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # app/models/person.rb</span><br><span class="line">  class Person</span><br><span class="line"></span><br><span class="line">    include ActiveModel::Validations</span><br><span class="line">    validates_with MyValidator</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/12/accept-nested-attributes-for/" itemprop="url">
                  在表单中提交相关实体
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-12T08:18:53+08:00" content="2015-02-12">
              2015-02-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/12/accept-nested-attributes-for/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/12/accept-nested-attributes-for/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在Rails中, 我们可以通过使用<code>accepts_nested_attributes_for</code>简单地将一对多的model通过表单一起提交. 比如说: 某人有多个地址(家庭地址, 公司地址等等) 这种一对多的关系. 我想通过一个表达提交用户的同时提交若干个地址.</p>
</blockquote>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><blockquote>
<p>生成项目:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails new accepts_nested_attributes_for_test</span><br><span class="line">cd accepts_nested_attributes_for_test</span><br></pre></td></tr></table></figure></p>
<p>使用scaffold生成user:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g scaffold User username age:integer</span><br></pre></td></tr></table></figure>
<blockquote>
<p>生成Address model<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g model Address zipcode city street tel user_id:integer</span><br></pre></td></tr></table></figure></p>
<p>移植</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>添加关联关系, user 对 address 是一对多的关系:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># app/models/user.rb</span><br><span class="line"></span><br><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  has_many :addresses</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/models/address.rb</span><br><span class="line"></span><br><span class="line">class Address &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :user</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="实现嵌套表单"><a href="#实现嵌套表单" class="headerlink" title="实现嵌套表单"></a>实现嵌套表单</h2><blockquote>
<p>ActiveRecord提供了accepts_nested_attributes_for 方法来处理嵌套表单, 我们把这个方法加入到user model以后, 在user中就会自动添加一个方法<code>addresses_attributes=</code>, 由此, 我们可以对Address进行添加,修改和删除了.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># app/models/user.rb</span><br><span class="line"></span><br><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  has_many :addresses</span><br><span class="line">  accepts_nested_attributes_for :addresses</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/models/address.rb</span><br><span class="line"></span><br><span class="line">class Address &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :user</span><br><span class="line">  # 不可以对user_id进行验证, 否则会无法存入数据库, 因为params中并没有user_id</span><br><span class="line">  validates :user_id, presence: true</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接下来处理表单, 使用<code>fields_for</code> 把输入的参数嵌入到请求参数中.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">¦ &lt;%= f.label :username %&gt;&lt;br&gt;</span><br><span class="line">¦ &lt;%= f.text_field :username %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">¦ &lt;%= f.label :age %&gt;&lt;br&gt;</span><br><span class="line">¦ &lt;%= f.number_field :age %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">¦ &lt;%= f.label :addresses, &quot;Address&quot; %&gt;</span><br><span class="line">¦ &lt;%= f.fields_for :addresses do |addresses_form| %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :zipcode, &quot;zipcode&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :zipcode %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :city, &quot;city&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :city %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :street, &quot;street&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :street %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :tel, &quot;Telephone Number&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :tel %&gt; &lt;br/&gt;</span><br><span class="line">¦ &lt;% end %&gt;</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">¦ &lt;%= f.submit %&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接下来, 在User的Controller中的new action中中准备好供表单使用的数据. 新建一个与用户相关联的Address对象, 作为<code>fields_for</code>的参数.<br>还需要将address属性加入到StrongParameters的允许列表中. 写法是view中的<code>fields_for</code>方法的参数(addresses) 与<code>_attributes</code>拼接而成. 也就是<code>addresses_attributes</code>, 其内部属性使用数组表示.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/users_controller.rb</span><br><span class="line"></span><br><span class="line">def new</span><br><span class="line">  @user = User.new</span><br><span class="line">  @user.addresses.build</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Strong Parameters</span><br><span class="line"></span><br><span class="line">def user_params</span><br><span class="line">  params.require(:user).permit(</span><br><span class="line">    :username,</span><br><span class="line">    :age,</span><br><span class="line">    addresses_attributes: [:id, :zipcode, :city, :street, :tel]</span><br><span class="line">  )</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如下图新建用户:<br><img src="http://i2.tietuku.com/63b34f8f063814c8.png" alt=""></p>
<p>点击提交后, 产生的参数和执行的sql语句:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Processing by UsersController#create as HTML</span><br><span class="line">  Parameters: &#123;&quot;utf8&quot;=&gt;&quot;✓&quot;, &quot;authenticity_token&quot;=&gt;&quot;gAoS9H1E0orttTcXOte5voqnEhwY/QROIA3noJLp84o=&quot;, &quot;user&quot;=&gt;&#123;&quot;username&quot;=&gt;&quot;daniel&quot;, &quot;age&quot;=&gt;&quot;22&quot;, &quot;addresses_attributes&quot;=&gt;&#123;&quot;0&quot;=&gt;&#123;&quot;zipcode&quot;=&gt;&quot;100101&quot;, &quot;city&quot;=&gt;&quot;北京&quot;, &quot;street&quot;=&gt;&quot;北辰西路1号院5号&quot;, &quot;tel&quot;=&gt;&quot;1223423&quot;&#125;&#125;&#125;, &quot;commit&quot;=&gt;&quot;Create User&quot;&#125;</span><br><span class="line">     (0.1ms)  begin transaction</span><br><span class="line">       SQL (13.0ms)  INSERT INTO &quot;users&quot; (&quot;age&quot;, &quot;created_at&quot;, &quot;updated_at&quot;, &quot;username&quot;) VALUES (?, ?, ?, ?)  [[&quot;age&quot;, 22], [&quot;created_at&quot;, &quot;2015-02-12 05:51:59.128755&quot;], [&quot;updated_at&quot;, &quot;2015-02-12 05:51:59.128755&quot;], [&quot;username&quot;, &quot;daniel&quot;]]</span><br><span class="line">         SQL (0.1ms)  INSERT INTO &quot;addresses&quot; (&quot;city&quot;, &quot;created_at&quot;, &quot;street&quot;, &quot;tel&quot;, &quot;updated_at&quot;, &quot;user_id&quot;, &quot;zipcode&quot;) VALUES (?, ?, ?, ?, ?, ?, ?)  [[&quot;city&quot;, &quot;北京&quot;], [&quot;created_at&quot;, &quot;2015-02-12 05:51:59.184579&quot;], [&quot;street&quot;, &quot;北辰西路1号院5号&quot;], [&quot;tel&quot;, &quot;1223423&quot;], [&quot;updated_at&quot;, &quot;2015-02-12 05:51:59.184579&quot;], [&quot;user_id&quot;, 1], [&quot;zipcode&quot;, &quot;100101&quot;]]</span><br></pre></td></tr></table></figure></p>
<p><code>accepts_nested_attributes_for</code>和<code>fields_for</code>可以逆向生成user和address, 访问编辑页面,可以发现表单中的数据可以自动填充回来:</p>
</blockquote>
<p><img src="http://i2.tietuku.com/d13fc866f9f8b7dc.png" alt=""></p>
<h2 id="删除nested-model"><a href="#删除nested-model" class="headerlink" title="删除nested model"></a>删除nested model</h2><blockquote>
<p><code>accepts_nested_attributes_for</code>方法还可以简单地删除User相关的address model. 下面就在编辑用户的页面添加一个CheckBox来加入删除地址的功能</p>
<p>首先, 在user model中加入<code>allow_destroy: true</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  has_many :addresses</span><br><span class="line">  accepts_nested_attributes_for :addresses, allow_destroy: true</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>接下来在表单view中加入删除checkbox. 表单中check_box方法的参数 <code>:_destroy</code> 当单选框被点击时, 其值会被设置为1, 然后”_destroy” =&gt; “1”会被封装到params中, <code>accepts_nested_attributes_for</code>会根据_destroy的值决定是否删除address对象. 大概就是这个意思, 不对之处请多指正.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># app/views/users/_form.html.erb</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">¦ &lt;%= f.label :addresses, &quot;Address&quot; %&gt; &lt;br/&gt;</span><br><span class="line">¦ &lt;%= f.fields_for :addresses do |addresses_form| %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :zipcode, &quot;zipcode&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :zipcode %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :city, &quot;city&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :city %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :street, &quot;street&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :street %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :tel, &quot;Telephone Number&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :tel %&gt; &lt;br/&gt;</span><br><span class="line">¦ ¦ &lt;% if @user.persisted? %&gt;</span><br><span class="line">¦ ¦ ¦ &lt;%= addresses_form.check_box :_destroy %&gt;</span><br><span class="line">¦ ¦ ¦ &lt;%= addresses_form.label :_destroy, &quot;DELETE&quot; %&gt; &lt;br/&gt;</span><br><span class="line">¦ ¦ &lt;% end %&gt;</span><br><span class="line">¦ &lt;% end %&gt;</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<p>最后, 还要在StrongParameters中设置_destroy</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/users_controller.rb</span><br><span class="line"></span><br><span class="line">private</span><br><span class="line"></span><br><span class="line">def user_params</span><br><span class="line">  params.require(:user).permit(</span><br><span class="line">  :username,</span><br><span class="line">  :age,</span><br><span class="line">  addresses_attributes: [:id, :zipcode, :city, :street, :tel, :_destroy]</span><br><span class="line"></span><br><span class="line">  )</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>删除:<br><img src="http://i2.tietuku.com/63f5e698387ae183.png" alt=""><br>删除后:<br><img src="http://i2.tietuku.com/651115caa7f68117.png" alt=""></p>
</blockquote>
<h2 id="相关Model的验证"><a href="#相关Model的验证" class="headerlink" title="相关Model的验证"></a>相关Model的验证</h2><blockquote>
<p>下面就添加验证:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validates :zipcode, presence: true</span><br><span class="line">validates :city, presence: true</span><br><span class="line">validates :street, presence: true</span><br><span class="line">validates :tel, presence: true</span><br></pre></td></tr></table></figure></p>
<p>如果我们不填写这几项, 页面会是这样的.<br><img src="http://i2.tietuku.com/79bc3f2175ed7052.png" alt=""></p>
<p>那么如果某人不想提交地址, 他连用户都无法创建, 这不符合逻辑, 这时候就需要<code>reject_if</code>了选项了, 它会更具条件决定是否执行验证方法. 比如下面的例子:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果不输入邮编, 就不会执行Address Model中的验证</span></span><br><span class="line">accepts_nested_attributes_for <span class="symbol">:address</span>, <span class="symbol">allow_destroy:</span> <span class="literal">true</span>, <span class="symbol">reject_if:</span> proc &#123; <span class="params">|attributes|</span> attributes[<span class="string">'zipcode'</span>].blank? &#125;</span><br></pre></td></tr></table></figure></p>
<p>那么我们可以这样修改user model</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/models/user.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  has_many <span class="symbol">:addresses</span></span><br><span class="line">  <span class="comment"># 如果地址全都不填写, 就不会执行验证.</span></span><br><span class="line">  accepts_nested_attributes_for <span class="symbol">:addresses</span>, <span class="symbol">allow_destroy:</span> <span class="literal">true</span>, <span class="symbol">reject_if:</span> <span class="symbol">:all_blank</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># user 还会继续验证</span></span><br><span class="line">  validates <span class="symbol">:username</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line">  validates <span class="symbol">:age</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>下面是address 栏位中什么都不写的视图:<br><img src="http://i2.tietuku.com/f5618fac5bba5664.png" alt=""></p>
</blockquote>
<h2 id="添加或者删除项目"><a href="#添加或者删除项目" class="headerlink" title="添加或者删除项目"></a>添加或者删除项目</h2><blockquote>
<p>用户可能会需要多个地址, 有时候也需要删除地址, 这时候就需要使用Ajax了.</p>
<p>首先需要让jQuery和turbolink共存, 使用<code>jquery-turbolinks</code> gem.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;gem &apos;jquery-turbolinks&apos;&quot; &gt;&gt; Gemfile</span><br><span class="line">bundle install</span><br><span class="line"></span><br><span class="line"># app/assets/javascripts/application.js</span><br><span class="line">...</span><br><span class="line">//= require jquery</span><br><span class="line">//= require jquery.turbolinks</span><br><span class="line">//= require jquery_ujs</span><br></pre></td></tr></table></figure></p>
<p>将address 相关的自动抽取成单独的局部视图</p>
</blockquote>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;fieldset&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.label <span class="symbol">:zipcode</span>, <span class="string">"zipcode"</span> </span>%&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.text_field <span class="symbol">:zipcode</span> </span>%&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">&lt;%=<span class="ruby"> f.label <span class="symbol">:city</span>, <span class="string">"city"</span> </span>%&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.text_field <span class="symbol">:city</span> </span>%&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">&lt;%=<span class="ruby"> f.label <span class="symbol">:street</span>, <span class="string">"street"</span> </span>%&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.text_field <span class="symbol">:street</span> </span>%&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">&lt;%=<span class="ruby"> f.label <span class="symbol">:tel</span>, <span class="string">"Telephone Number"</span> </span>%&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.text_field <span class="symbol">:tel</span> </span>%&gt; &lt;br/&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.hidden_field <span class="symbol">:_destroy</span> </span>%&gt;</span><br><span class="line">&lt;%=<span class="ruby"> link_to <span class="string">"DELETE"</span>, <span class="string">"#"</span>, <span class="class"><span class="keyword">class</span>: "<span class="title">remove_field</span>" </span></span>%&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>调用上面的局部视图, 然后创建一个添加的超链接, 注意这里使用了自定义的helper<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># app/views/users/_form.html.erb</span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;%= f.label :addresses, &quot;住所&quot; %&gt;&lt;br /&gt;</span><br><span class="line">&lt;%= f.fields_for :addresses do |builder| %&gt;</span><br><span class="line">&lt;%= render &quot;address_fields&quot;, f: builder %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br><span class="line">&lt;%= link_to_add_fields &quot;住所追加&quot;, f, :addresses %&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<p>实现helper <code>link_to_add_fields</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># app/helpers/application_helper.rb</span><br><span class="line">module ApplicationHelper</span><br><span class="line">  def link_to_add_fields(name, f, association)</span><br><span class="line">    new_object = f.object.send(association).klass.new</span><br><span class="line">    id = new_object.object_id</span><br><span class="line">    # 拼接</span><br><span class="line">    fields = f.fields_for(association, new_object, child_index: id) do |builder|</span><br><span class="line">      render(association.to_s.singularize + &quot;_fields&quot;, f: builder)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    link_to(name, &apos;#&apos;, class: &quot;add_fields&quot;, data: &#123;id: id, fields: fields.gsub(&quot;\n&quot;, &quot;&quot;)&#125;)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最后使用CoffeeScript来完成Ajax部分, 添加和删除功能:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># app/assets/javascripts/user.js.coffee</span><br><span class="line">$ -&gt;</span><br><span class="line">  $(&apos;form&apos;).on &apos;click&apos;, &apos;.remove_fields&apos;, (event) -&gt;</span><br><span class="line">  $(this).prev(&apos;input[type=hidden]&apos;).val(&apos;1&apos;)</span><br><span class="line">  $(this).closest(&apos;fieldset&apos;).hide()</span><br><span class="line">  event.preventDefault()</span><br><span class="line"></span><br><span class="line">  $(&apos;form&apos;).on &apos;click&apos;, &apos;.add_fields&apos;, (event) -&gt;</span><br><span class="line">  time = new Date().getTime()</span><br><span class="line">  regexp = new RegExp($(this).data(&apos;id&apos;), &apos;g&apos;)</span><br><span class="line">  $(this).before($(this).data(&apos;fields&apos;).replace(regexp, time))</span><br><span class="line">  event.preventDefault()</span><br></pre></td></tr></table></figure></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/11/polymorphic/" itemprop="url">
                  Rails 实现多态(polymorphic) 关系
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-11T17:29:53+08:00" content="2015-02-11">
              2015-02-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/11/polymorphic/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/11/polymorphic/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>如果在 model 中使用has_many的 <code>as</code> 选项和belongs_to 的<code>polymorphic</code> 选项, 可以很简单地实现数据库的多态关系.</p>
</blockquote>
<h2 id="何谓多态"><a href="#何谓多态" class="headerlink" title="何谓多态"></a>何谓多态</h2><p><img src="http://i2.tietuku.com/ba11da08a8701338.png" alt=""></p>
<blockquote>
<p>看这个 ER 图, Article和Event都可以有多个Comment. 也就是说, Comment 即属于Article, 又属于Event, comments 表即被article引用又被event 引用. 这种关系就是多态.</p>
</blockquote>
<h2 id="生成Polymorphic-类型的表"><a href="#生成Polymorphic-类型的表" class="headerlink" title="生成Polymorphic 类型的表"></a>生成Polymorphic 类型的表</h2><blockquote>
<p>首先, 生成Event model 和表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g model event name:string content:text</span><br></pre></td></tr></table></figure></p>
<p>然后, 生成Article model 和表</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g model article title:string body:text</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最后, 生成 Comment model 和表.<br><strong><em> 非常重要: 需要加入两个列, 一个是引用外键id, 一个是引用的外部 model 的类型</em></strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g model comment content:text commentable_id:integer commentable_type:string</span><br></pre></td></tr></table></figure>
<blockquote>
<p>并且需要添加索引:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># db/migrate/yyyymmddhhMMss_create_comments.rb</span><br><span class="line"></span><br><span class="line">class CreateComments &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    create_table :comments do |t|</span><br><span class="line">    t.text :content</span><br><span class="line">    t.integer :commentable_id</span><br><span class="line">    t.string :commentable_type</span><br><span class="line"></span><br><span class="line">    t.timestamps</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  add_index :comments, [:commentable_id, :commentable_type]</span><br><span class="line"></span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>最后移植:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="向-model-中加入has-many-和-belongs-to-实现关联关系"><a href="#向-model-中加入has-many-和-belongs-to-实现关联关系" class="headerlink" title="向 model 中加入has_many 和 belongs_to 实现关联关系"></a>向 model 中加入has_many 和 belongs_to 实现关联关系</h2><blockquote>
<p>在Comment 加上 belongs_to 方法, 并且需要注意参数应该是其对应的表的外键xxx_id 的 xxx, polymorphic 选项为 true<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># app/models/comment.rb</span><br><span class="line">class Comment &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :commentable, polymorphic: true</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>在Event 和 Article这一边加入 has_many 和 as option</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># app/models/event.rb</span><br><span class="line">class Event &lt; ActiveRecord::Base</span><br><span class="line">  has_many :comments, as: :commentable</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/models/article.rb</span><br><span class="line">class Article &lt; ActiveRecord::Base</span><br><span class="line">  has_many :comments, as: :commentable</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>设定完毕.</p>
</blockquote>
<h2 id="可以使用的方法"><a href="#可以使用的方法" class="headerlink" title="可以使用的方法"></a>可以使用的方法</h2><blockquote>
<p>通过多态设定的comment 在被创建之后会自动设定<code>commentable_id</code> 和 <code>commentable_type</code>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">event = Event.create name: &quot;event1&quot;</span><br><span class="line">event_comment = event.comments.create content: &quot;This event is awesome!&quot;</span><br><span class="line">event_comment</span><br><span class="line"># =&gt; &lt;Comment id: 1, content: &quot;This event is awesome!&quot;, commentable_id: 1, commentable_type: &quot;Event&quot;, created_at: ...&gt;</span><br><span class="line"></span><br><span class="line">article = Article.create title: &quot;article1&quot;</span><br><span class="line">article_comment = article.comments.create content: &quot;This article is great!&quot;</span><br><span class="line">article_comment</span><br><span class="line"># =&gt; &lt;Comment id: 2, content: &quot;This article is great!&quot;, commentable_id: 1, commentable_type: &quot;Article&quot;, created_at: ...&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="CommentController-的实现"><a href="#CommentController-的实现" class="headerlink" title="CommentController 的实现"></a>CommentController 的实现</h2><blockquote>
<p>接下来就看看我们在提交一条评论时, 这条评论是如何关联到相关对象上, 你在查看某个对象时, 相关的评论又是如何被查询出来的:</p>
<p>首先在路由中配置好访问的 url.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># config/routes.rb</span><br><span class="line"></span><br><span class="line">resources :articles do</span><br><span class="line">  resources :comments</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">resources :events do</span><br><span class="line">  resources :comments</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p><code>load_commentable</code> 方法中, 从 URL 中判断请求的是Article的评论还是Event的评论.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">class CommentController &lt; ApplicationController</span><br><span class="line">  before_action :load_comments</span><br><span class="line"></span><br><span class="line">  def index</span><br><span class="line">    @comments = @commentable.comments</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def new</span><br><span class="line">    @comment = @commentable.comments.new</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def create</span><br><span class="line">    @commnet = @commentable.comments.new(comment_params)</span><br><span class="line">    if @comment.save</span><br><span class="line">      redirect_to @commentable, notice: &quot;评论成功&quot;</span><br><span class="line">    elsif</span><br><span class="line">      render :new</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">  private</span><br><span class="line"></span><br><span class="line">    def load_comments</span><br><span class="line">      # ex: /events/:id/comments</span><br><span class="line">      # ex: /articles/:id/comments</span><br><span class="line">      resource, id = request.fullpath.split(&apos;/&apos;)[1, 2]</span><br><span class="line">      @commentable = resource.singularize.classify.constantize.find(id)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    def comment_params</span><br><span class="line">      params.require(:comment).permit(:content)</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>实际上Polimorphic很好理解, 就是一个表(A)与多个表(Bs)发生映射多对一的映射关系(Bs对A), 这时候就不能只拿id作为外键了, 既然要处理与多个表的映射关系, 还需要使用其他这些表的类型,也就是commentable_type, 结合刚才的例子, 我们可以拿到是某个对象的所有comment就是因为这个type.</p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/10/sti/" itemprop="url">
                  Rails实现单一表继承STI(Single Table Inheritance)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-10T18:50:44+08:00" content="2015-02-10">
              2015-02-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/10/sti/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/10/sti/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>现在有一个需求, Book 和Computer 是Product 的子类, Book 和 Computer有一部分列相同, 一部分不同, 如下面2个示意图, 我们让3个 model 共用一个表 products. Rails 这边来看, 好像我们已经创建了 books 表和computers 表, 从而处理好Book对象和Computer 对象.<br><img src="http://i2.tietuku.com/1fe41c4fd78847e2.png" alt=""><br><img src="http://i2.tietuku.com/61db191e5f8490ba.png" alt=""></p>
<p>type 字段代表的是”Book” 还是”Computer”, 所以:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Product.all # =&gt; 从 products 中获取含有 Book和 Computer model的全部记录</span><br><span class="line">Computer.all # =&gt; 从 products 中只获取type 是&quot;Computer&quot;的记录</span><br><span class="line">Book.all # =&gt; 从 products 中只获取 type 是&quot;Book&quot; 的记录</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样的好处是:</p>
<ul>
<li>透明化处理了Computer 和 Book, 无需分别建立表</li>
<li>可以单独处理Book 或 Computer</li>
</ul>
</blockquote>
<h2 id="创建新的项目"><a href="#创建新的项目" class="headerlink" title="创建新的项目"></a>创建新的项目</h2><blockquote>
<p>首先我们先新建一个Rails项目</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails new sti_test</span><br><span class="line">cd sti_test</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用generator 生成Product, Maker, Cpu, Author, 然后migrate.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rails g scaffold Product name price:integer maker_id:integer cpu_id:integer author_id:integer</span><br><span class="line"></span><br><span class="line">rails g model maker name</span><br><span class="line">rails g model cpu name</span><br><span class="line">rails g model author name</span><br><span class="line"></span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>初始化数据</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># db/seeds.rb</span><br><span class="line"></span><br><span class="line">Init Data</span><br><span class="line"></span><br><span class="line">%w(Pentium Core Xeno).each &#123; |name| Cpu.create! name: name  &#125;</span><br><span class="line">%w(Lenovo HP Apple).each &#123; |name| Maker.create! name: name  &#125;</span><br><span class="line">%w(Daniel Lucy Nigo).each &#123; |name| Author.create! name: name  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>向各个 model 中加入关联关系和验证.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># app/models/cpu.rb</span><br><span class="line">class Cpu &lt; ActiveRecord::Base</span><br><span class="line">  has_many :products</span><br><span class="line">  validates :name, presence: true</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># app/models/maker.rb</span><br><span class="line">class Maker &lt; ActiveRecord::Base</span><br><span class="line">  has_many :products</span><br><span class="line">  validates :name, presence: true</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># app/models/author.rb</span><br><span class="line">class Author &lt; ActiveRecord::Base</span><br><span class="line">  has_many :products</span><br><span class="line">  validates :name, presence: true</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># app/models/product.rb</span><br><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :cpu</span><br><span class="line">  belongs_to :maker</span><br><span class="line">  belongs_to :author</span><br><span class="line"></span><br><span class="line">  validates :name,  presence: true</span><br><span class="line">  validates :price, presence: true</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="实现-STI"><a href="#实现-STI" class="headerlink" title="实现 STI"></a>实现 STI</h2><blockquote>
<p>首先, 在products中加入<code>type</code> 字段, 很重要, 这是 rails 的约定.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g migration add_type_to_products type:string</span><br></pre></td></tr></table></figure>
<blockquote>
<p>获取Book 和Computer 对象时, rails 会搜索<code>type</code> 字段, 所以我们使用<code>type</code> 作为索引(提高效率)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class AddTypeToProducts &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    add_column :products, :type, :string</span><br><span class="line">    add_index :products, :type</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 移植(应用到数据库. p.s. 到底该如何翻译才贴切?)</span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure></p>
<p>为 type 添加存在性验证<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :maker</span><br><span class="line">  belongs_to :cpu</span><br><span class="line">  belongs_to :author</span><br><span class="line"></span><br><span class="line">  validates :name, presence: true</span><br><span class="line">  validates :price, presence: true</span><br><span class="line">  validates :type, presence: true</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>接着, 新建<code>Product</code> 的两个子类 model <code>Computer</code> 和 <code>Book</code>, 并加入验证:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># app/models/computer.rb</span><br><span class="line"></span><br><span class="line">class Computer &lt; Product</span><br><span class="line">  validates :maker_id, presence: true</span><br><span class="line">  validates :cpu_id, presence: true</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/models/book.rb</span><br><span class="line"></span><br><span class="line">class Book &lt; Product</span><br><span class="line">  validates :author_id, presence: true</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>我们在 console 中做实验看看是否实现了 STI :</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 设定`type` 为&quot;Computer&quot;, Product 会自动创建 Computer 的对象</span><br><span class="line"></span><br><span class="line">Product.new(type: &quot;Computer&quot;)</span><br><span class="line"># =&gt; &lt;Computer id: nil, name: nil, price: nil, type: &quot;Computer&quot;, maker_id: nil, cpu_id: nil, author_id: nil, created_at: nil, updated_at: nil&gt;</span><br><span class="line"></span><br><span class="line"># 设定`type` 为&quot;Book&quot;, Product 会自动创建Book 对象</span><br><span class="line">Product.new(type: &quot;Book&quot;)</span><br><span class="line"># =&gt; &lt;Book id: nil, name: nil, price: nil, type: &quot;Book&quot;, maker_id: nil, cpu_id: nil, author_id: nil, created_at: nil, updated_at: nil&gt;</span><br><span class="line"></span><br><span class="line"># 设定`type` 为&quot;&quot;, 会生成Product对象(本身) (p.s. nil, false, [], &#123;&#125;等都可以创建 Product对象)</span><br><span class="line"># =&gt; &lt;Product id: nil, name: nil, price: nil, type: &quot;&quot;, maker_id: nil, cpu_id: nil, author_id: nil, created_at: nil, updated_at: nil&gt;</span><br><span class="line"></span><br><span class="line"># 如果设定`type` 为一个非 Product( 或子类 )的类型, 就会发生异常</span><br><span class="line">Product.new type: &quot;hello&quot;</span><br><span class="line"># =&gt; ActiveRecord::SubclassNotFound: Invalid single-table inheritance type: hello is not a subclass of Product</span><br></pre></td></tr></table></figure>
<h2 id="相应的控制器-视图和路由"><a href="#相应的控制器-视图和路由" class="headerlink" title="相应的控制器, 视图和路由"></a>相应的控制器, 视图和路由</h2><blockquote>
<p>首先, 调整一下视图. 我们先从index视图着手, 由于一开始我们使用 scaffold 生成了Product, 生成了一些没有用的属性.比如 外键 id.我们需要删除这些属性, 将<code>name</code>, <code>type</code>添加进去.</p>
<p><code>try</code> 方法是个好东西, 如果接收者(maker, cpu, author) 为 nil, 它会返回nil, 而不是抛异常.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># app/views/products/index.html.erb</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Listing products&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;table&gt;</span><br><span class="line">&lt;thead&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">&lt;th&gt;Name&lt;/th&gt;</span><br><span class="line">&lt;th&gt;Price&lt;/th&gt;</span><br><span class="line">&lt;!-- 已修改 --&gt;</span><br><span class="line">&lt;th&gt;Type&lt;/th&gt;</span><br><span class="line">&lt;!-- 修改结束 --&gt;</span><br><span class="line">&lt;th&gt;Maker&lt;/th&gt;</span><br><span class="line">&lt;th&gt;Cpu&lt;/th&gt;</span><br><span class="line">&lt;th&gt;Author&lt;/th&gt;</span><br><span class="line">&lt;th colspan=&quot;3&quot;&gt;&lt;/th&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;/thead&gt;</span><br><span class="line"></span><br><span class="line">&lt;tbody&gt;</span><br><span class="line">&lt;% @products.each do |product| %&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">&lt;td&gt;&lt;%= product.name %&gt;&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= product.price %&gt;&lt;/td&gt;</span><br><span class="line">&lt;!--  已修改 --&gt;</span><br><span class="line">&lt;td&gt;&lt;%= product.type %&gt;&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= product.maker.try(:name) %&gt;&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= product.cpu.try(:name) %&gt;&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= product.author.try(:name) %&gt;&lt;/td&gt;</span><br><span class="line">&lt;!-- 修改结束 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;td&gt;&lt;%= link_to &apos;Show&apos;, product %&gt;&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= link_to &apos;Edit&apos;, edit_product_path(product) %&gt;&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= link_to &apos;Destroy&apos;, product, method: :delete, data: &#123; confirm: &apos;Are you sure?&apos;  &#125; %&gt;&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;% end %&gt;</span><br><span class="line">&lt;/tbody&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line"></span><br><span class="line">&lt;%= link_to &apos;New Product&apos;, new_product_path %&gt;</span><br></pre></td></tr></table></figure></p>
<p>show 页面去掉id, 添加 name</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># app/views/products/show.html.erb</span><br><span class="line"></span><br><span class="line">&lt;p id=&quot;notice&quot;&gt;&lt;%= notice %&gt;&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;</span><br><span class="line">&lt;strong&gt;Name:&lt;/strong&gt;</span><br><span class="line">&lt;%= @product.name %&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;</span><br><span class="line">&lt;strong&gt;Price:&lt;/strong&gt;</span><br><span class="line">&lt;%= @product.price %&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 已修改 --&gt;</span><br><span class="line">&lt;p&gt;</span><br><span class="line">&lt;strong&gt;Type:&lt;/strong&gt;</span><br><span class="line">&lt;%= @product.type %&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;</span><br><span class="line">&lt;strong&gt;Maker:&lt;/strong&gt;</span><br><span class="line">&lt;%= @product.maker.try(:name) %&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;</span><br><span class="line">&lt;strong&gt;Cpu:&lt;/strong&gt;</span><br><span class="line">&lt;%= @product.cpu.try(:name) %&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;</span><br><span class="line">&lt;strong&gt;Author:&lt;/strong&gt;</span><br><span class="line">&lt;%= @product.author.try(:name) %&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line">&lt;!--  修改结束 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;%= link_to &apos;Edit&apos;, edit_product_path(@product) %&gt; |</span><br><span class="line">&lt;%= link_to &apos;Back&apos;, products_path %&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后, 修改新建和编辑页面的表单,  把Maker, CPU, Author的text field 变成 select box.<br>而且, 需要把 form_for方法中加入 <code>as: :product</code>. 这是因为: <code>@product</code> 可能是 Book 对象也可能是Computer, 那么name属性的值就可能是book[nane], 或者computer[name], 控制器的StrongParameters的方法就不会认识这样的名字, 因为它指认识product[name], <code>as: :product</code> 设置之后起到了统一名称的作用.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># app/views/products/_form.html.erb</span><br><span class="line"></span><br><span class="line">&lt;!--  已修改 --&gt;</span><br><span class="line">&lt;%= form_for(@product, as: :product) do |f| %&gt;</span><br><span class="line">&lt;% if @product.errors.any? %&gt;</span><br><span class="line">&lt;div id=&quot;error_explanation&quot;&gt;</span><br><span class="line">&lt;h2&gt;&lt;%= pluralize(@product.errors.count, &quot;error&quot;) %&gt; prohibited this product from being saved:&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">&lt;% @product.errors.full_messages.each do |message| %&gt;</span><br><span class="line">&lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;</span><br><span class="line">&lt;% end %&gt;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;%= f.label :name %&gt;&lt;br&gt;</span><br><span class="line">&lt;%= f.text_field :name %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;%= f.label :price %&gt;&lt;br&gt;</span><br><span class="line">&lt;%= f.number_field :price %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;!--  已修改 --&gt;</span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;%= f.label :type %&gt;&lt;br&gt;</span><br><span class="line">&lt;%= f.select :type, [&quot;Computer&quot;, &quot;Book&quot;].map &#123; |t| [t, t]  &#125;, include_blank: true %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;%= f.label :maker_id, &quot;Maker(only for computer)&quot; %&gt;&lt;br&gt;</span><br><span class="line">&lt;%= f.select :maker_id, Maker.all.map &#123; |m| [m.name, m.id]  &#125;, include_blank: true %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;%= f.label :cpu_id, &quot;CPU(only for Computer)&quot; %&gt;&lt;br&gt;</span><br><span class="line">&lt;%= f.select :cpu_id, Cpu.all.map &#123; |c| [c.name, c.id]  &#125;, include_blank: true %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;%= f.label :author_id, &quot;Author only for author&quot; %&gt;&lt;br&gt;</span><br><span class="line">&lt;%= f.select :author_id, Author.all.map &#123; |a| [a.name, a.id]  &#125;, include_blank: true %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;!--  修改完毕 --&gt;</span><br><span class="line">&lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">&lt;%= f.submit %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>由于添加了<code>type</code> 所以需要把该字段加入到controller 中的StrongParameters 方法中.</p>
<p>最后设定路由, 当用户访问books_path 和computer_path时, 将其交由products controller 处理.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Rails.application.routes.draw do</span><br><span class="line">resources :products</span><br><span class="line"></span><br><span class="line">resources :books,     controller: :products</span><br><span class="line">resources :computers, controller: :products</span><br><span class="line"></span><br><span class="line">root &quot;products#index&quot;</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>我们看一下效果:<br><img src="http://i2.tietuku.com/f4623f154e98115f.png" alt=""><br><img src="http://i2.tietuku.com/65de7595adc2b341.png" alt=""></p>
<p>如果还有一些属性相似的物品, 我们也可以通过这种办法来添加, 只需要继承 <code>Product</code>即可, 比如衣服, 文具, 体育器材等等. 但是, 如果差异比较大的对象我们是否继续用这种办法还是新建表和 model(不继承Product) 就需要慎重考虑了.</p>
</blockquote>
<h2 id="对-model-单独处理-同名虚属性"><a href="#对-model-单独处理-同名虚属性" class="headerlink" title="对 model 单独处理(同名虚属性)"></a>对 model 单独处理(同名虚属性)</h2><blockquote>
<p>到现在已经很好了, 不过我想让 name 这一列显示的更具各自的特点, 对书来说我想让其显示出来的是”书名 written by author#name”, 对于computer 来说我想让其显示”name /cpu.name/maker.name”.</p>
<p>想要达到这个目的我需要在两个子类(Book &amp; Computer)中分别定义一个同名方法, 然后按照需求实现该方法, 在 view 上用该方法代替<code>name</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># app/models/book.rb</span><br><span class="line"></span><br><span class="line">class Book &lt; Product</span><br><span class="line">validates :author_id, presence: true</span><br><span class="line"></span><br><span class="line">def full_name</span><br><span class="line">&quot;#&#123;name&#125; written by #&#123;author.name&#125;&quot;</span><br><span class="line">end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># app/models/coumputer.rb</span><br><span class="line"></span><br><span class="line">class Computer &lt; Product</span><br><span class="line">validates :cpu_id,   presence: true</span><br><span class="line">validates :maker_id, presence: true</span><br><span class="line"></span><br><span class="line">def full_name</span><br><span class="line">&quot;#&#123;name&#125;(#&#123;cpu.name&#125;/#&#123;maker.name&#125;)&quot;</span><br><span class="line">end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 在 index.html.erb 中把 &lt;td&gt;&lt;%= product.name %&gt;&lt;/td&gt; 替换为</span><br><span class="line">&lt;td&gt;&lt;%= product.full_name %&gt;&lt;/td&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>效果如下<br><img src="http://i2.tietuku.com/e8c4654e9aba8f85.png" alt=""></p>
</blockquote>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="不需要STI"><a href="#不需要STI" class="headerlink" title="不需要STI"></a>不需要STI</h3><blockquote>
<p>如果model中恰好有一个<code>type</code> 属性, 但是并不希望使用单表继承, 可以使用下面的方法禁用:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在model中 </span><br><span class="line">self.inheritance_column = nil</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Daniel Zhang" />
          <p class="site-author-name" itemprop="name">Daniel Zhang</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">104</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">104</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Daniel Zhang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"danielhexo"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
