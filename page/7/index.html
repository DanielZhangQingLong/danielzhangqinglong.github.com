<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Suche
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'uSvyVbAJs-5jfXFawgQ3','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/20/format-helper/" itemprop="url">
                  Format Helper
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-20T20:48:16+08:00" content="2015-02-20">
              2015-02-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails 为View提供了日期, 数值和文本的帮助方法, 下面就来看看这些帮助方法的使用.</p>
</blockquote>
<h2 id="文本相关"><a href="#文本相关" class="headerlink" title="文本相关"></a>文本相关</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 显示debug信息</span><br><span class="line">&lt;%= debug(params) %&gt;</span><br><span class="line">&lt;%= debug(cookies) %&gt;</span><br><span class="line"></span><br><span class="line"># 转义成HTML</span><br><span class="line">my_text = &quot;Here is some basic text...\n...with a line break.&quot;</span><br><span class="line">simple_format(my_text)</span><br><span class="line"># =&gt; &quot;&lt;p&gt;Here is some basic text...\n&lt;br /&gt;...with a line break.&lt;/p&gt;&quot;</span><br><span class="line"></span><br><span class="line"># 高亮</span><br><span class="line">&lt;%= highlight( &quot;This is Daniel&quot;, &quot;Daniel&quot;  ) %&gt;</span><br><span class="line"></span><br><span class="line"># 指定高亮的格式</span><br><span class="line">&lt;%= highlight(&quot;This is Daniel, I am a brilliant boy! This is true&quot;, [&apos;Daniel&apos;, &apos;am&apos;], highlighter: &apos;    &lt;a href=&quot;search?q=\1&quot;&gt;\1&lt;/a&gt;&apos;) %&gt;</span><br><span class="line"></span><br><span class="line"># 省略</span><br><span class="line">&lt;%= truncate(&quot;This is something I hated that people who drank the fucking wine&quot;, lenth: 8) %&gt;</span><br><span class="line"></span><br><span class="line"># 掐头去尾省略</span><br><span class="line"> &lt;%= excerpt(&quot;西望大家不要再喝完酒后批评别人了&quot;, &quot;喝完酒&quot;, radius: 2) %&gt;</span><br><span class="line"></span><br><span class="line"># 英文复数变形</span><br><span class="line">&lt;%= pluralize(1, &apos;person&apos;) %&gt; # =&gt; 1 person</span><br><span class="line">&lt;%= pluralize(2, &apos;person&apos;) %&gt; # =&gt; 2 people</span><br></pre></td></tr></table></figure>
<h2 id="数值相关"><a href="#数值相关" class="headerlink" title="数值相关"></a>数值相关</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 货币</span><br><span class="line"></span><br><span class="line">&lt;%= number_to_currency( 1234.56  ) %&gt; #=&gt; $1,234.56 </span><br><span class="line">&lt;%= number_to_currency( 1234.56, unit: &quot;¥&quot;, precision: 0  ) %&gt; #=&gt; ¥1,235</span><br><span class="line"></span><br><span class="line"># Byte</span><br><span class="line">&lt;%= number_to_human_size( 1200  ) %&gt; #=&gt; 1.17 KB</span><br><span class="line"></span><br><span class="line"># 百分数</span><br><span class="line">&lt;%= number_to_percentage( 66.666666, precision: 1  ) %&gt; #=&gt; 66.7%</span><br><span class="line"></span><br><span class="line"># 数字3位分割</span><br><span class="line">&lt;%= number_with_delimiter( 1234567890  ) %&gt; #=&gt; 1,234,567,890</span><br><span class="line">&lt;%= number_with_delimiter( 1234567890, delimiter: &quot;_&quot;  ) %&gt; #=&gt; 1_234_567_890</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 四舍五入</span><br><span class="line">&lt;%= number_with_precision( 12.3456, precision: 2  ) %&gt; #=&gt; 12.35</span><br></pre></td></tr></table></figure>
<h2 id="日期时间相关"><a href="#日期时间相关" class="headerlink" title="日期时间相关"></a>日期时间相关</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 从现在开始多久前</span><br><span class="line">&lt;%= time_ago_in_words(3.minutes.from_now)  %&gt;   # =&gt; 3 minutes</span><br><span class="line">&lt;%= time_ago_in_words(3.minutes.ago)  %&gt;            # =&gt; 3 minutes</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/17/view-helper/" itemprop="url">
                  Rails中View Helper总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-17T09:25:20+08:00" content="2015-02-17">
              2015-02-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>View Helper提供了form, select, check_box等等一系列的页面元素, 这篇文章进行总结</p>
</blockquote>
<h2 id="超链接-link-to"><a href="#超链接-link-to" class="headerlink" title="超链接(link_to)"></a>超链接(link_to)</h2><h3 id="基本使用方法"><a href="#基本使用方法" class="headerlink" title="基本使用方法"></a>基本使用方法</h3><blockquote>
<p><code>link_to</code>会生成 a 标签</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">link_to(name = nil, options = nil, html_options = nil, &amp;block)</span><br></pre></td></tr></table></figure>
<h4 id="可以指定的options"><a href="#可以指定的options" class="headerlink" title="可以指定的options"></a>可以指定的options</h4><ul>
<li><code>method:</code> 指定<code>:get</code>, ‘:post’, <code>:patch</code>, <code>:delete</code> 代表生成的链接发给服务器的请求使用GET, POST 等HTTP方法.</li>
<li><code>remote: true</code> 像server发送Ajax请求(默认值是false)</li>
<li><code>data: { confirm: &quot;Are you sure to delete?&quot; }</code> 弹出确认对话框</li>
</ul>
<h4 id="link-to经常使用的方法"><a href="#link-to经常使用的方法" class="headerlink" title="link_to经常使用的方法"></a><code>link_to</code>经常使用的方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># HTML属性指定(class)</span><br><span class="line">link_to &quot;Profile&quot;, profile_path(@profile), class: &quot;btn btn-large&quot;, id: &quot;profile#&#123;@profile.id&#125;&quot;</span><br><span class="line">#=&gt; &lt;a class=&quot;btn btn-large&quot; href=&quot;/profiles/1&quot; id=&quot;profiles1&quot;&gt;Profile&lt;/a&gt;</span><br><span class="line"></span><br><span class="line"># 添加查询(?=xxx)</span><br><span class="line">link_to &quot;Profile&quot;, profile_path(@profile, q: &quot;list&quot;)</span><br><span class="line">#=&gt; &lt;a href=&quot;/profiles/1?q=list&quot;&gt;Profile&lt;/a&gt;</span><br><span class="line"></span><br><span class="line"># 指定格式</span><br><span class="line">link_to &quot;Profile&quot;, profile_path(@profile, format: &apos;csv&apos;)</span><br><span class="line"></span><br><span class="line"># 使用block环绕一些元素 </span><br><span class="line"># 这样更加灵活地将链接内容显示在页面</span><br><span class="line">link_to @profile do</span><br><span class="line">  &lt;strong&gt;&lt;%= @profile.name&gt;&lt;/strong&gt; -- &lt;span&gt;Check it out!&lt;/span&gt;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># =&gt;  &lt;a href=&quot;/profiles/1&quot;&gt;</span><br><span class="line">        &lt;strong&gt;Daniel&lt;/strong&gt; -- &lt;span&gt;Check it out!&lt;/span&gt;</span><br><span class="line">      &lt;/a&gt;</span><br></pre></td></tr></table></figure>
<h4 id="link-to-if更加条件显示链接"><a href="#link-to-if更加条件显示链接" class="headerlink" title="link_to_if更加条件显示链接"></a><code>link_to_if</code>更加条件显示链接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">link_to_if(current_user.admin?, &quot;管理员&quot;, admin_path)</span><br></pre></td></tr></table></figure>
<h2 id="img-tag"><a href="#img-tag" class="headerlink" title="img_tag"></a>img_tag</h2><p>###基本使用方法</p>
<blockquote>
<p>生成img 标签, 也就是需要在页面显示图片时使用:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image_tag(source, options=&#123;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h3><ul>
<li><p><code>source</code> 表示图片文件的具体位置, 可以使用绝对路径和相对路径, 如果你直接指定文件名, 那么rails会默认去assets/images中寻找该图片文件.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例: &lt;%= image_tag &apos;picture.png&apos; %&gt;</span><br><span class="line">#=&gt; &lt;img src=&quot;/images/picture.png&quot; alt=&quot;Picture&quot;&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>alt</code> 加入无法显示图片, alt的文本内容会显示出来.</p>
</li>
<li><code>size</code> 指定图片的长度和高度.</li>
</ul>
<blockquote>
<p>还可以指定html的id属性class属性等等</p>
</blockquote>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= image_tag &apos;http://i2.tietuku.com/09b177fc2e10b2dd.png&apos;, alt: &quot;Picture&quot; %&gt;</span><br><span class="line"># =&gt; &lt;img alt=&quot;Picture&quot; src=&quot;http://i2.tietuku.com/09b177fc2e10b2dd.png&quot;&gt;</span><br><span class="line"></span><br><span class="line">image_tag(&quot;picture.png&quot;, size: &quot;50x40&quot;, alt: &quot;Home Image&quot;)</span><br><span class="line"># =&gt; &lt;img src=&quot;/images/picture.png&quot; width=&quot;50&quot; height=&quot;40&quot; alt=&quot;Home Image&quot; /&gt;</span><br><span class="line"></span><br><span class="line">image_tag(&quot;/gallery/picture.png&quot;, size: &quot;200&quot;)</span><br><span class="line"># =&gt; &lt;img src=&quot;/gallery/picture.png&quot; width=&quot;200&quot; height=&quot;200&quot; alt=&quot;Picture&quot; /&gt;</span><br><span class="line"></span><br><span class="line">image_tag(&quot;picture.png&quot;, class: &quot;menu_img&quot;)</span><br><span class="line"># =&gt; &lt;img alt=&quot;Picture&quot; class=&quot;main_img&quot; src=&quot;/images/picture.png&quot; /&gt;</span><br></pre></td></tr></table></figure>
<h2 id="FORM-form-for-form-tag"><a href="#FORM-form-for-form-tag" class="headerlink" title="FORM - form_for form_tag"></a>FORM - <code>form_for</code> <code>form_tag</code></h2><h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><ul>
<li><code>form_for</code> : 我们在创建或者更新Model时, 需要生成依附于这样的Model的表单, 这时使用<code>form_for</code>, 由于表单依附于Model实体, 当发生验证错误时候, 我们可以将错误消息和错误的具体位置在页面表示出来</li>
<li><code>form_tag</code> : 只是单纯地输出表单, 比如我们可以要搜索, 需要提交表单给一个Controller的某个action.不依附于Model, 所以也就进行validation.(可以先这么理解, 我以后写一篇文章介绍两者区别), 其block内部需要使用<code>label_tag</code>这样的xxx_tag方法来生成表单元素<br>&gt;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">form_for(record, options = &#123;&#125; &amp;block)</span><br><span class="line">form_tag(url_for_options = &#123;&#125;&lt; options = &#123;&#125;, &amp;block)</span><br></pre></td></tr></table></figure>
<h3 id="Option"><a href="#Option" class="headerlink" title="Option"></a>Option</h3><ul>
<li><code>url</code> 指提交到的那个url, 对于<code>form_for</code>, 由于Model会自动生成URL, 所以此项不是必须的; 对于<code>form_tag</code>来说, 是必须指定的, 当然, 也可以通过<code>controller</code>, <code>action</code>间接指定url.</li>
<li><code>method</code> 指定HTTP方法, 类似于<code>link_to</code></li>
<li><code>remote</code> Ajax相关, 设置true后, 会通过Ajax来submit.</li>
<li><code>html</code> 指定form的HTML属性, <code>class</code>, <code>role</code>等<blockquote>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_for @user, remote: true, :html =&gt; &#123; :class =&gt; &quot;form-horizontal&quot;, :role =&gt; &quot;form&quot;  &#125; do |f| %&gt;</span><br><span class="line"></span><br><span class="line">  # 指定user的属性</span><br><span class="line">  &lt;%= f.text_field :name %&gt;</span><br><span class="line">  &lt;%= f.number_field :age %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;%= f.submit %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果需要嵌套Model:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># config/routes.rb</span><br><span class="line"># resources :users do</span><br><span class="line">    resources :comments</span><br><span class="line"># end</span><br><span class="line"></span><br><span class="line"># 需要给form_for 方法传入数组</span><br><span class="line"></span><br><span class="line">&lt;%= form_for [@users, @comments] do |f| %&gt;</span><br><span class="line">  &lt;%= f.text_field :content %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>form_tag</code> :</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_tag(:action =&gt; &quot;create&quot;) do%&gt;</span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">  &lt;%= label_tag &apos;title&apos; %&gt;</span><br><span class="line">  &lt;%= text_field_tag &apos;title&apos; %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">  &lt;%= label_tag &apos;content&apos; %&gt;</span><br><span class="line">  &lt;%= text_field_tag &apos;content&apos; %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">  &lt;%= submit_tag &quot;作成&quot; %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="嵌套其他Model的表单fields-for"><a href="#嵌套其他Model的表单fields-for" class="headerlink" title="嵌套其他Model的表单fields_for"></a>嵌套其他Model的表单<code>fields_for</code></h2><blockquote>
<p>如果在Model中使用<code>has_one``has_many</code>去关联其他的Model, 那么在页面表单中就需要使用<code>fields_for</code>来关联这些来自于其他Model的字段, 下面例子说明了在表单中如何把Address的字段嵌入User.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_for @user do |f| %&gt;</span><br><span class="line">  &lt;%= f.fields_for :address do |address_fields| %&gt;</span><br><span class="line">    Street: &lt;%= address_fields.text_field :street %&gt;</span><br><span class="line">    Zip Code: &lt;%= address_fields.text_field :zip_code %&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br><span class="line"></span><br><span class="line"># 在 app/models/user.rb中:</span><br><span class="line"></span><br><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  has_many :addresses</span><br><span class="line">  accepts_nested_attributes_for :addresses</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="生成label的方法-label和label-tag"><a href="#生成label的方法-label和label-tag" class="headerlink" title="生成label的方法 label和label_tag"></a>生成label的方法 <code>label</code>和<code>label_tag</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= f.label(:name, &quot;名字&quot;) %&gt;</span><br><span class="line">#=&gt; &lt;label for=&quot;user_name&quot;&gt;名字&lt;/label&gt;</span><br><span class="line"></span><br><span class="line">&lt;%= label_for(:user, &quot;名字&quot;) %&gt;</span><br><span class="line">#=&gt; &lt;label for=&quot;user&quot;&gt;姓名&lt;/label&gt;</span><br></pre></td></tr></table></figure>
<h2 id="文本框-text-field和text-field-tag"><a href="#文本框-text-field和text-field-tag" class="headerlink" title="文本框- text_field和text_field_tag"></a>文本框- <code>text_field</code>和<code>text_field_tag</code></h2><blockquote>
<p>在页面上生成文本输入框, <code>&lt;input type=&quot;text&quot;&gt;</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= f.text_field :name %&gt;</span><br><span class="line">#=&gt; &lt;input type=&quot;text&quot; name=&quot;user[name]&quot; id=&quot;user_name&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;%= text_field_tag &quot;user[name]&quot;, &quot;值&quot; %&gt;</span><br><span class="line">#=&gt; &lt;input type=&quot;text&quot; name=&quot;user[name]&quot; id=&quot;user_name&quot; value=&quot;值&quot;&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Option-1"><a href="#Option-1" class="headerlink" title="Option"></a>Option</h3><ul>
<li><code>:disabled</code> : true代表文本框变灰不可以输入</li>
<li><code>:size</code> 设定文本框的长度</li>
<li><code>:maxlength</code> 可以输入的最多字数</li>
<li><code>:placeholder</code> 页面被加载后自动出现在输入框中的文字, 用户输入时会消失</li>
<li>其他一些html的属性</li>
</ul>
<h3 id="一些其他类型的输入框"><a href="#一些其他类型的输入框" class="headerlink" title="一些其他类型的输入框"></a>一些其他类型的输入框</h3><ul>
<li><code>email_field / email_field_tag</code></li>
<li><code>password_field / password_field_tag</code></li>
<li><code>search_field / search_field_tag</code></li>
<li><code>number_field / number_field_tag</code></li>
</ul>
<h3 id="输入日期时间-date-field-time-field-datetime-field"><a href="#输入日期时间-date-field-time-field-datetime-field" class="headerlink" title="输入日期时间- date_field/time_field/datetime_field"></a>输入日期时间- <code>date_field/time_field/datetime_field</code></h3><blockquote>
<p>效果如下:<br><img src="http://i2.tietuku.com/f2f5d504930df9cf.png" alt=""></p>
</blockquote>
<h3 id="选择日期时间-date-select-time-select-datetime-select"><a href="#选择日期时间-date-select-time-select-datetime-select" class="headerlink" title="选择日期时间 - date_select / time_select / datetime_select"></a>选择日期时间 - <code>date_select / time_select / datetime_select</code></h3><p><img src="http://i2.tietuku.com/884bd4cc71002787.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= f.time_select :updated_at %&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>对应的HTML:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;hidden&quot; id=&quot;profile_updated_at_1i&quot; name=&quot;profile[updated_at(1i)]&quot; value=&quot;2015&quot; /&gt;</span><br><span class="line">&lt;input type=&quot;hidden&quot; id=&quot;profile_updated_at_2i&quot; name=&quot;profile[updated_at(2i)]&quot; value=&quot;2&quot; /&gt;</span><br><span class="line">&lt;input type=&quot;hidden&quot; id=&quot;profile_updated_at_3i&quot; name=&quot;profile[updated_at(3i)]&quot; value=&quot;17&quot; /&gt;</span><br><span class="line">&lt;select id=&quot;profile_updated_at_4i&quot; name=&quot;profile[updated_at(4i)]&quot;&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>submit后, 封装在params中:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Parameters: &#123;&quot;utf8&quot;=&gt;&quot;✓&quot;,</span><br><span class="line">&quot;authenticity_token&quot;=&gt;&quot;WJhATdPc1LEzIpL9r1KG15uYp9TGKdZHV0oYFNjz8jHHDuyn4uuV4do0/7EumsNwHHzuUzt/5Ip5eXpzivxywg==&quot;,</span><br><span class="line">&quot;profile&quot;=&gt;&#123;&quot;updated_at(1i)&quot;=&gt;&quot;2015&quot;, &quot;updated_at(2i)&quot;=&gt;&quot;2&quot;, &quot;updated_at(3i)&quot;=&gt;&quot;17&quot;, &quot;updated_at(4i)&quot;=&gt;&quot;06&quot;, &quot;updated_at(5i)&quot;=&gt;&quot;53&quot;&#125;,</span><br><span class="line">&quot;commit&quot;=&gt;&quot;Create Profile&quot;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意, 虽然在页面上没有选择年月日, 但是不难看出在HTML源码和params中都有看到年月日一并在发送给了server.如果我指定<code>ignore_date: true</code>, 那么年月日就不会发送给server. 如果没有年月日就会发生异常, 所以, 必须有<code>date_select</code>在表单中.<br><code>date_select</code>和<code>date_time_select</code>道理相同, 我就不一一说明了</p>
</blockquote>
<h2 id="文件上传-file-field-file-field-tag"><a href="#文件上传-file-field-file-field-tag" class="headerlink" title="文件上传- file_field/file_field_tag"></a>文件上传- <code>file_field/file_field_tag</code></h2><p><img src="http://i2.tietuku.com/f2d00300cacb6914.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> # 对于form_tag提交的表单, 需要设置multipart: true, form_for则不需要</span><br><span class="line">&lt;%= form_tag &apos;/upload&apos;, multipart: true do %&gt;</span><br><span class="line">  &lt;label for=&quot;file&quot;&gt;File to Upload&lt;/label&gt; &lt;%= file_field_tag &quot;file&quot; %&gt;</span><br><span class="line">    &lt;%= submit_tag %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="text-area-text-area-tag"><a href="#text-area-text-area-tag" class="headerlink" title="text_area / text_area_tag"></a><code>text_area / text_area_tag</code></h2><blockquote>
<p>该标签对应的Model的属性类型是text</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= text_area_tag &quot;post[content]&quot;, &quot;很长的文章&quot;, size: &quot;200x200&quot; %&gt;</span><br><span class="line">#=&gt; &lt;textarea name=&quot;post[content]&quot; id=&quot;post_content&quot; cols=&quot;200&quot; rows=&quot;200&quot;&gt;很长的文章&lt;/textarea&gt;</span><br></pre></td></tr></table></figure>
<h2 id="下拉列表-select-select-tag-collection-select"><a href="#下拉列表-select-select-tag-collection-select" class="headerlink" title="下拉列表 select / select_tag / collection_select"></a>下拉列表 <code>select / select_tag / collection_select</code></h2><blockquote>
<p>一下三种方法产生的页面效果是一样的:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= f.select :prefecture_id, Prefecture.all.map &#123; |p| [p.name, p.id]  &#125; %&gt;</span><br><span class="line">&lt;%= select_tag &quot;address[prefeture_id]&quot;, options_from_collection_for_select(Prefecture.all, :id, :name) %&gt;</span><br><span class="line">&lt;%= f.collection_select :prefecture_id, Prefecture.all, :id, :name %&gt;</span><br><span class="line"></span><br><span class="line"># =&gt;</span><br><span class="line"># &lt;select name=&quot;address[prefecture_id]&quot; id=&quot;address_prefecture_id&quot;&gt;</span><br><span class="line">#   &lt;option value=&quot;1&quot;&gt;北京&lt;/option&gt;</span><br><span class="line">#   &lt;option value=&quot;2&quot;&gt;上海&lt;/option&gt;</span><br><span class="line">#   &lt;option value=&quot;3&quot;&gt;哈尔滨&lt;/option&gt;</span><br><span class="line"># &lt;/select&gt;</span><br></pre></td></tr></table></figure>
<h2 id="check-box-check-box-tag-collection-check-boxes"><a href="#check-box-check-box-tag-collection-check-boxes" class="headerlink" title="check_box / check_box_tag / collection_check_boxes"></a><code>check_box / check_box_tag / collection_check_boxes</code></h2><h3 id="一个check-box"><a href="#一个check-box" class="headerlink" title="一个check_box"></a>一个check_box</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= f.label :remember_me, &quot;REMEMBER_ME&quot; %&gt;</span><br><span class="line">&lt;%= f.check_box :remember_me %&gt;</span><br><span class="line"></span><br><span class="line"># =&gt; </span><br><span class="line"># &lt;label for=&quot;profile_remember_me&quot;&gt;REMEMBER_ME&lt;/label&gt;</span><br><span class="line"># &lt;input type=&quot;checkbox&quot; value=&quot;1&quot; name=&quot;profile[remember_me]&quot; id=&quot;profile_remember_me&quot;&gt;</span><br><span class="line">    </span><br><span class="line"># OR</span><br><span class="line"></span><br><span class="line">&lt;%= check_box_tag &quot;profile[remember_me]&quot;%&gt;</span><br><span class="line">&lt;%= label_tag &quot;profile[remember_me]&quot;, &quot;记住我&quot; %&gt;</span><br></pre></td></tr></table></figure>
<h3 id="多个-check-box"><a href="#多个-check-box" class="headerlink" title="多个 check_box"></a>多个 check_box</h3><blockquote>
<p>Category和Product 有多对多的关系</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;% Category.all.each do |category| %&gt;</span><br><span class="line">  &lt;%= check_box_tag &quot;product[category_ids][]&quot;, category.id, @product.categories.include?(category), id: &quot;product_category_ids_#&#123;category.id&#125;&quot; %&gt;</span><br><span class="line">    &lt;%= label_tag &quot;product[category_ids][#&#123;category.id&#125;]&quot;, category.name %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br><span class="line"></span><br><span class="line">#=&gt; </span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;input type=&quot;checkbox&quot; name=&quot;product[category_ids][]&quot; id=&quot;product_category_ids_1&quot; value=&quot;1&quot; checked=&quot;checked&quot; /&gt;</span><br><span class="line">&lt;label for=&quot;Category_0&quot;&gt;Category#0&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;checkbox&quot; name=&quot;product[category_ids][]&quot; id=&quot;product_category_ids_2&quot; value=&quot;2&quot; checked=&quot;checked&quot; /&gt;</span><br><span class="line">&lt;label for=&quot;Category_1&quot;&gt;Category#1&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;checkbox&quot; name=&quot;product[category_ids][]&quot; id=&quot;product_category_ids_3&quot; value=&quot;3&quot; checked=&quot;checked&quot; /&gt;</span><br><span class="line">&lt;label for=&quot;Category_2&quot;&gt;Category#2&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;checkbox&quot; name=&quot;product[category_ids][]&quot; id=&quot;product_category_ids_4&quot; value=&quot;4&quot; /&gt;</span><br><span class="line">&lt;label for=&quot;Category_3&quot;&gt;Category#3&lt;/label&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后我们分析一下提交后params集合的参数情况</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">params</span><br><span class="line"># 选择0个box</span><br><span class="line">&quot;product&quot;=&gt;&#123;&quot;name&quot;=&gt;&quot;&quot;&#125;</span><br><span class="line"># 选择2个</span><br><span class="line">&quot;product&quot;=&gt;&#123;&quot;name&quot;=&gt;&quot;&quot;, category_ids&quot;=&gt;[&quot;1&quot;, &quot;2&quot;]&#125;&quot;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>还需要注意StrongParameters:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def product_params</span><br><span class="line">  # 注意category_ids: []</span><br><span class="line">  params.require(:product).permit(:name, category_ids: [])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Parameter和SQL语句</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Parameters: &#123;&quot;utf8&quot;=&gt;&quot;✓&quot;, &quot;authenticity_token&quot;=&gt;&quot;cGk3YzhN3JGSROg+MKdVFj8hois/WQck5mwop/0j2oTv/5uJCXqdwXtShXKxbxCxuMXrrMIPNenIX0rAryxadw==&quot;, &quot;product&quot;=&gt;&#123;&quot;name&quot;=&gt;&quot;iMac&quot;, &quot;category_ids&quot;=&gt;[&quot;1&quot;, &quot;2&quot;]&#125;, &quot;commit&quot;=&gt;&quot;Create Product&quot;&#125;</span><br><span class="line">  Category Load (0.2ms)  SELECT &quot;categories&quot;.* FROM &quot;categories&quot; WHERE &quot;categories&quot;.&quot;id&quot; IN (1, 2)</span><br><span class="line">  (0.0ms)  begin transaction</span><br><span class="line">  SQL (0.2ms)  INSERT INTO &quot;products&quot; (&quot;name&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (?, ?, ?)  [[&quot;name&quot;, &quot;iMac&quot;], [&quot;created_at&quot;, &quot;2015-02-17 10:05:04.921510&quot;], [&quot;updated_at&quot;, &quot;2015-02-17 10:05:04.921510&quot;]]</span><br><span class="line">  SQL (0.1ms)  INSERT INTO &quot;categories_products&quot; (&quot;category_id&quot;, &quot;product_id&quot;) VALUES (?, ?)  [[&quot;category_id&quot;, 1], [&quot;product_id&quot;, 2]]</span><br><span class="line">  SQL (0.0ms)  INSERT INTO &quot;categories_products&quot; (&quot;category_id&quot;, &quot;product_id&quot;) VALUES (?, ?)  [[&quot;category_id&quot;, 2], [&quot;product_id&quot;, 2]]</span><br><span class="line">(0.6ms)  commit transaction</span><br></pre></td></tr></table></figure>
<blockquote>
<p>rails还提供了更为简单的方法:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= f.collection_check_boxes :category_ids, Category.all, :id, :name %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="radio-button-radio-button-tag"><a href="#radio-button-radio-button-tag" class="headerlink" title="radio_button, radio_button_tag"></a><code>radio_button, radio_button_tag</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">%= f.label :rate %&gt;&lt;br&gt;</span><br><span class="line">&lt;%= f.radio_button :rate, 1 %&gt; &lt;%= f.label :rate_1, 1 %&gt;</span><br><span class="line">&lt;%= f.radio_button :rate, 2 %&gt; &lt;%= f.label :rate_2, 2 %&gt;</span><br><span class="line">&lt;%= f.radio_button :rate, 3 %&gt; &lt;%= f.label :rate_3, 3 %&gt;</span><br><span class="line">&lt;%= f.radio_button :rate, 4 %&gt; &lt;%= f.label :rate_4, 4 %&gt;</span><br><span class="line">&lt;%= f.radio_button :rate, 5 %&gt; &lt;%= f.label :rate_5, 5 %&gt;</span><br><span class="line"># =&gt;</span><br><span class="line">&lt;label for=&quot;product_rate&quot;&gt;Rate&lt;/label&gt;&lt;br&gt;</span><br><span class="line">&lt;input type=&quot;radio&quot; value=&quot;1&quot; name=&quot;product[rate]&quot; id=&quot;product_rate_1&quot;&gt; &lt;label for=&quot;product_rate_1&quot;&gt;1&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;radio&quot; value=&quot;2&quot; name=&quot;product[rate]&quot; id=&quot;product_rate_2&quot;&gt; &lt;label for=&quot;product_rate_2&quot;&gt;2&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;radio&quot; value=&quot;3&quot; name=&quot;product[rate]&quot; id=&quot;product_rate_3&quot;&gt; &lt;label for=&quot;product_rate_3&quot;&gt;3&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;radio&quot; value=&quot;4&quot; name=&quot;product[rate]&quot; id=&quot;product_rate_4&quot;&gt; &lt;label for=&quot;product_rate_4&quot;&gt;4&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;radio&quot; value=&quot;5&quot; name=&quot;product[rate]&quot; id=&quot;product_rate_5&quot;&gt; &lt;label for=&quot;product_rate_5&quot;&gt;5&lt;/label&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>同样也有<code>collection_xx</code>版本的方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= f.collection_radio_buttons :maker_id, Maker.all, :id, :name %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="hidden-field-hidden-field-tag"><a href="#hidden-field-hidden-field-tag" class="headerlink" title="hidden_field / hidden_field_tag"></a>hidden_field / hidden_field_tag</h2><blockquote>
<p>不显示在页面上, 有些信息没有必要给用户看到</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;%= f.hidden_field :lock_version %&gt;</span><br><span class="line">#=&gt; &lt;input type=&quot;hidden&quot; name=&quot;product[lock_version]&quot; id=&quot;product_lock_version&quot; value=&quot;1&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;%= hidden_field_tag &quot;product[lock_version]&quot;, @product.lock_version %&gt;</span><br><span class="line">#=&gt; &lt;input type=&quot;hidden&quot; name=&quot;product[lock_version]&quot; id=&quot;product_lock_version&quot; value=&quot;1&quot;&gt;</span><br></pre></td></tr></table></figure>
<h2 id="submit-submit-tag"><a href="#submit-submit-tag" class="headerlink" title="submit / submit_tag"></a>submit / submit_tag</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= f.submit &quot;注册&quot; %&gt;</span><br><span class="line">#=&gt; &lt;input type=&quot;submit&quot; name=&quot;commit&quot; value=&quot;注册&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;%= submit_tag &quot;Search&quot; %&gt;</span><br><span class="line">#=&gt; &lt;input type=&quot;submit&quot; name=&quot;commit&quot; value=&quot;Search&quot;&gt;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/16/form-for/" itemprop="url">
                  关于form_for
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-16T21:29:09+08:00" content="2015-02-16">
              2015-02-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><code>form_for</code>是一个非常重要的方法, 用户填写的表单中的信息就是通过该方法处理的, 对于form_for的处理涉及到Controller, View, Model.</p>
</blockquote>
<h2 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h2><ul>
<li>在Controller的new方法或者edit方法生成实例变量, 比如: <code>@user = User.new</code></li>
<li>在View中使用<code>form_for</code>方法使用model对象(@user)的各个字段生成一个form</li>
<li>用户点击submit按钮提交, 刚刚页面输入的各字段就会被以hash的形式封装进<code>params</code>中, 然后传给Controller.</li>
<li>Controller的create方法或者update方法就会就会使用params变量创建或者更新model</li>
</ul>
<h2 id="以新建用户为例"><a href="#以新建用户为例" class="headerlink" title="以新建用户为例"></a>以新建用户为例</h2><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><blockquote>
<p>现有一个实体叫做User, 还有2个属性<code>name</code>和<code>email</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># app/models/user.rb</span><br><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="在Controller的new方法中生成user的实例变量"><a href="#在Controller的new方法中生成user的实例变量" class="headerlink" title="在Controller的new方法中生成user的实例变量"></a>在Controller的new方法中生成user的实例变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/users_controller.rb</span><br><span class="line"></span><br><span class="line">def new</span><br><span class="line">  # 新建一个空的Model对象@user, 主要是在View中使用.</span><br><span class="line">  # 如果Controller中没有明确的指出`render xxx.html.erb`或`redirect_to xxx.html.erb`, 那么默认就是当前方法名, 这里是new, 需要渲染的视图是`new.html.erb`</span><br><span class="line">  @user = User.new</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="在View中使用form-for方法创建表单"><a href="#在View中使用form-for方法创建表单" class="headerlink" title="在View中使用form_for方法创建表单"></a>在View中使用<code>form_for</code>方法创建表单</h3><blockquote>
<p><code>form_for</code>方法接收@user为参数, 生成users表的name和email字段的label和text_field这些页面元素 </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_for @user do |f| %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">  &lt;%= f.label :name, &quot;Name&quot; %&gt;</span><br><span class="line">  &lt;%= f.text_field :name %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">  &lt;%= f.label :email, &quot;Email&quot; %&gt;</span><br><span class="line">  &lt;%= f.text_field :email %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">  &lt;%= f.submit &quot;Submit&quot; %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>像这样:<br><img src="http://i2.tietuku.com/fa25e83f8c10aae2.png" alt=""></p>
<p>这是部分html代码, 注意input表情的name属性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;label for=&quot;user_name&quot;&gt;Name&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;user[name]&quot; id=&quot;user_name&quot;&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h3><blockquote>
<p>我们输入这些文本框, 然后点击submit, 查看log信息,看看这些值是如何被封装以及如何在Controller中获取的.</p>
</blockquote>
<p><img src="http://i2.tietuku.com/09b177fc2e10b2dd.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">params = </span><br><span class="line">&#123;</span><br><span class="line">user: &#123;   # params[:user] #=&gt; &#123; name: &quot;daniel&quot;, email: &quot;shangrenzhidao@126.com&quot; &#125;</span><br><span class="line">    name: &quot;daniel&quot;, # params[:user][:name] # =&gt; &quot;daniel&quot;</span><br><span class="line">    email: &quot;shangrenzhidao@126.com&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="接收参数-保存到数据库"><a href="#接收参数-保存到数据库" class="headerlink" title="接收参数, 保存到数据库"></a>接收参数, 保存到数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class UsersController &lt; ApplicationController</span><br><span class="line">  def new</span><br><span class="line">    @user = User.new</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def create</span><br><span class="line">    @user = User.new(user_params)</span><br><span class="line">    if @user.save</span><br><span class="line">      # 相当于 user_path(@user)</span><br><span class="line">      redirect_to @user, notice: &quot;创建成功&quot;</span><br><span class="line">    else</span><br><span class="line">      render :new</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def show</span><br><span class="line">    @user = User.find(params[:id])</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">    def user_params</span><br><span class="line">      params.require(:user).permit(:name, :email)</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/15/migration/" itemprop="url">
                  Rails migration
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-15T16:14:52+08:00" content="2015-02-15">
              2015-02-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails的migration可以对数据库表进行修改, 比如添加或者删除列, 添加索引, 加NULL限制, 更改列名等等. 以下就对migration进行总结.</p>
</blockquote>
<h2 id="Migration的基础"><a href="#Migration的基础" class="headerlink" title="Migration的基础"></a>Migration的基础</h2><h3 id="创建migration文件"><a href="#创建migration文件" class="headerlink" title="创建migration文件"></a>创建migration文件</h3><blockquote>
<p>migration可以说是管理数据库schema的基础.<br>有两种方法来创建migration文件, 一个是”手动直接创建”, 另一个是<code>rails g model</code>间接创建.<br>实际上我们在创建一个model <code>rails g model</code>也会生成对应的migration, 然后我们使用<code>rake db:migrate</code>创建数据库, 之后如果需要修改表, 比如添加自动, 加约束, 那么就需要使用<code>rails g migration</code>了.</p>
</blockquote>
<h4 id="通过生成model创建migration"><a href="#通过生成model创建migration" class="headerlink" title="通过生成model创建migration"></a>通过生成model创建migration</h4><blockquote>
<p>生成Article model, 同时生成对应的migration, Article中有String类型的title 和 Text类型的content.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ rails g model Article title content:text</span><br><span class="line">invoke  active_record</span><br><span class="line">create    db/migrate/20150215104136_create_articles.rb</span><br><span class="line">create    app/models/article.rb</span><br><span class="line">invoke    test_unit</span><br><span class="line">create      test/models/article_test.rb</span><br><span class="line">create      test/fixtures/articles.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>migration 文件在<code>db/migrate</code>目录下, 而且为了防止生成的migration名字冲突, 将生成migration的时刻加入到了migration的文件名中, 降低了同名文件的概率.<br>那么我们来看看刚刚生成的migration文件, 需要继承<code>ActiveRecord::Migration</code>, 而且需要有<code>change</code>方法, 或者有<code>up</code>和<code>down</code>方法.<br>方法中, 可以创建一个表或者添加/删除列. 本例中使用<code>create_table</code>方法创建了一个叫做<code>articles</code>的方法, 在block中添加列.<br>timestamps实际上是生成了两个列: 记录创建时刻<code>created_at</code>记录被更新的时刻<code>updated_at</code>, 这两个列我们在创建或者更新属性的时候不需要添加, rails会自动更新这两个列的值.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># db/migrate/20150215104136_create_articles.rb</span><br><span class="line"></span><br><span class="line">class CreateArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    create_table :articles do |t|</span><br><span class="line">      t.string :title</span><br><span class="line">      t.text :content</span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>up</code>和<code>down</code>方法同时定义可以取代<code>change</code>方法, <code>up</code>方法在<code>rake db:migrate</code>执行时被执行, <code>down</code>方法在<code>rake db:rollback</code>执行时被执行.<br>使用<code>change</code>方法时, 我们应该可以推断出实现逻辑是可逆的, 如果我不确定实现的逻辑是否可逆, 那么就使用<code>up/down</code>方法, 下面的代码使用<code>up/down</code>替代了<code>change</code>方法:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class CreateArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def up</span><br><span class="line">    create_table :articles do |t|</span><br><span class="line">      t.string :title</span><br><span class="line">      t.text :content</span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def down</span><br><span class="line">    drop_table :articles</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h4 id="直接生成migration文件"><a href="#直接生成migration文件" class="headerlink" title="直接生成migration文件"></a>直接生成migration文件</h4><blockquote>
<p>有时候需要为已生成的表修改结构, 这时候就需要使用migration文件了.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rails g migration create_articles title:string content:text</span><br><span class="line"></span><br><span class="line">  invoke  active_record</span><br><span class="line">  create    db/migrate/&#123;current_time&#125;_create_articles.rb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>生成了与<code>rails g model</code>相同的migration文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># db/migrate/20150215104136_create_articles.rb</span><br><span class="line"></span><br><span class="line">class CreateArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    create_table :articles do |t|</span><br><span class="line">      t.string :title</span><br><span class="line">      t.text :content</span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="移植命令rake-db-migrate"><a href="#移植命令rake-db-migrate" class="headerlink" title="移植命令rake db:migrate"></a>移植命令<code>rake db:migrate</code></h3><blockquote>
<p><code>rake db:migrate</code>命令执行后, <strong><em>没有被移植的所有migration文件, 会被执行</em></strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rake db:migrate</span><br><span class="line"></span><br><span class="line"># 可以指定环境(生产, 开发或者测试等等)</span><br><span class="line">$ rake db:migrate RAILS_ENV=test</span><br><span class="line">$ rake db:migrate RAILS_ENV=production</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果了刚刚实行的migration, 可以使用<code>rake db:rollback</code>命令回退一步, 注意必须要有<code>down</code>方法.(使用change的请忽略)</p>
<p>如果要将数据库回到最初状态可以使用:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rake db:migrate VERSION=0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果想要删除数据库所有的表和数据, 就需要使用到<code>schema.rb</code>了, 有时候migration把数据库弄得很乱, 又不知道该如何修复, 那么干脆就重置数据库:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 数据库将被重置</span><br><span class="line">$ rake db:reset</span><br></pre></td></tr></table></figure>
<h3 id="查看migrate的使用记录"><a href="#查看migrate的使用记录" class="headerlink" title="查看migrate的使用记录"></a>查看migrate的使用记录</h3><blockquote>
<p>有时候我们需要查看使用了那些migrate, up状态还是down状态, 需要使用<code>rake db:migrate:status</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ rake db:migrate:status</span><br><span class="line"></span><br><span class="line"># up代表执行的是up方法(rake db:migrate),down方法, 表示运行的命令时rake db:rollback</span><br><span class="line">database: /Users/daniel/workspace/web_dev/backend/my_own_project/rails_basic/migration_test/db/development.sqlite3</span><br><span class="line"></span><br><span class="line"> Status   Migration ID    Migration Name</span><br><span class="line"> --------------------------------------------------</span><br><span class="line">    up     20150215104136  Create articles</span><br></pre></td></tr></table></figure>
<h3 id="批量导入数据"><a href="#批量导入数据" class="headerlink" title="批量导入数据"></a>批量导入数据</h3><blockquote>
<p>在开发时, 我们往往需要一些初始化数据, 一个个从页面提交固然可以, 但是, 这样做太麻烦, rails提供了更为简洁的方法:<br>可以在db/seeds.rb中创建对象, 然后运行<code>rake db:seed</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.times do |i|</span><br><span class="line">  Article.create!( title: &quot;T#&#123;i&#125;&quot; , content: &quot;C#&#123;i&#125;&quot; )</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后运行:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rake db:seed</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样数据就被保存的db中作为初始数据了.</p>
</blockquote>
<h3 id="migration中可以使用的数据类型"><a href="#migration中可以使用的数据类型" class="headerlink" title="migration中可以使用的数据类型"></a>migration中可以使用的数据类型</h3><blockquote>
<p><code>rails g model</code>和<code>rails g migration</code>可以使用的数据类型如下:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">integer 整数</span><br><span class="line">float 浮点小数</span><br><span class="line">decimal 高精度小数</span><br><span class="line"></span><br><span class="line">string </span><br><span class="line">text</span><br><span class="line">binary</span><br><span class="line"></span><br><span class="line">datetime</span><br><span class="line">timestamp</span><br><span class="line">date</span><br><span class="line">time</span><br><span class="line"></span><br><span class="line">boolean</span><br><span class="line"></span><br><span class="line">primary_key</span><br><span class="line">references</span><br></pre></td></tr></table></figure>
<h2 id="Migration的方法总结"><a href="#Migration的方法总结" class="headerlink" title="Migration的方法总结"></a>Migration的方法总结</h2><h3 id="添加列-add-column"><a href="#添加列-add-column" class="headerlink" title="添加列(add_column)"></a>添加列(add_column)</h3><blockquote>
<p>向<code>articles</code>表中添加<code>user_id</code>列.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rails g migration add_user_id_to_articles user_id:integer</span><br><span class="line"></span><br><span class="line">invoke  active_record</span><br><span class="line">create    db/migrate/20150216050907_add_user_id_to_articles.rb</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class AddUserIdToArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    add_column :articles, :user_id, :integer</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>add_column</code>还可以指定下面的选项:</p>
</blockquote>
<ul>
<li>null(null_allowed): true 指的是该列允许是空值</li>
<li>limit: size 指的是对字段限定长度, 如果是string类型或者text类型的size代表字符个数, 如果是binary类型或者integer类型那么size就代表字节数</li>
<li>default: 设定默认值</li>
</ul>
<blockquote>
<p>如果类型是<code>decimal</code>, 还可以追加精确度选项, <code>precision: [num], scale: [num]</code>, precision表示一共保留几位有效数字, scale表示其中保留几位小数.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">precision: 5, scale: 2 # =&gt; 一共保留5位有效数字, 保留2位小数. 所以范围是 -999.99~999.99</span><br></pre></td></tr></table></figure>
<h3 id="删除列"><a href="#删除列" class="headerlink" title="删除列"></a>删除列</h3><blockquote>
<p>删除使用的方法是<code>remove_column</code>, 比如: 删除user_id这一列</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ rails g migration remove_user_id_from_articles user_id</span><br><span class="line"></span><br><span class="line">invoke  active_record</span><br><span class="line">create    db/migrate/20150216055403_remove_user_id_from_articles.rb</span><br><span class="line"></span><br><span class="line"># 生成的文件</span><br><span class="line">class RemoveUserIdFromArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    remove_column :articles, :user_id, :string</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="改变数据类型"><a href="#改变数据类型" class="headerlink" title="改变数据类型"></a>改变数据类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rails g migration change_datatype_title_of_articles</span><br><span class="line"></span><br><span class="line">invoke  active_record</span><br><span class="line">create    db/migrate/20150216061727_change_datatype_title_of_articles.rb</span><br><span class="line"></span><br><span class="line">class ChangeDatatypeTitleOfArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    change_column :articles, :title, :text</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>change_column</code>方法也可以指定各种选项, 这里不多说了.</p>
</blockquote>
<h3 id="索引及唯一性限制条件的添加与删除"><a href="#索引及唯一性限制条件的添加与删除" class="headerlink" title="索引及唯一性限制条件的添加与删除"></a>索引及唯一性限制条件的添加与删除</h3><blockquote>
<p>可以使用<code>add_index</code>方法向表的某一列添加索引. 下面的例子是为title字段添加索引</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class AddTitleIndexToArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    # 唯一性约束</span><br><span class="line">    add_index :articles, :title, unique: true</span><br><span class="line">    add_index :articles, :title</span><br><span class="line">    # 设定复合索引</span><br><span class="line">    add_index :articles, [:title, :created_at]</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="是否允许为NULL"><a href="#是否允许为NULL" class="headerlink" title="是否允许为NULL"></a>是否允许为NULL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">change_column_null(:users, :nickname, false) # =&gt; 不允许 :nickname NULL</span><br><span class="line">change_column_null(:users, :nickname, true) # =&gt; 允许 :nickname NULL</span><br></pre></td></tr></table></figure>
<h3 id="设定默认值"><a href="#设定默认值" class="headerlink" title="设定默认值"></a>设定默认值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change_column_default :suppliers, :qualification, &apos;new&apos;</span><br></pre></td></tr></table></figure>
<h3 id="修改列名"><a href="#修改列名" class="headerlink" title="修改列名"></a>修改列名</h3><blockquote>
<p>列名也是可以修改的, 使用<code>rename_column</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class RenameTitleToTimuInArticles &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    # rename_column(:table_name, :old_column_name, :new_column_name)</span><br><span class="line">    rename_column :articles, :title, :timu</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="创建表-create-table"><a href="#创建表-create-table" class="headerlink" title="创建表(create_table)"></a>创建表(create_table)</h3><blockquote>
<p>创建<code>users</code>表</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">rails g migration create_users name:string email:string</span><br><span class="line">  invoke  active_record</span><br><span class="line">  create    db/migrate/20150216073226_create_users.rb</span><br><span class="line"></span><br><span class="line">class CreateUsers &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    create_table :users do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.string :email</span><br><span class="line"></span><br><span class="line">      # 如果没有生成时间戳, 自行加上</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h3><blockquote>
<p>使用<code>drop_table</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class DropUsers &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    drop_table :users</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要注意: 删除表和删除列都是不可逆的, 也就是说不可以使用<code>rake db:rollback</code>撤销刚刚的变更.如果想使用<code>rollback</code>就需要使用<code>up/down</code>取代change方法了:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class DropUsers &lt; ActiveRecord::Migration</span><br><span class="line">  def up</span><br><span class="line">    drop_table :users</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def down</span><br><span class="line">    create_table :users do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.string :email</span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="改变表名-rename-table"><a href="#改变表名-rename-table" class="headerlink" title="改变表名(rename_table)"></a>改变表名(rename_table)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rails g migration rename_artiles_to_posts</span><br><span class="line">  invoke  active_record</span><br><span class="line">  create    db/migrate/20150216075545_rename_artiles_to_posts.rb</span><br><span class="line"></span><br><span class="line">class RenameArtilesToPosts &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    rename_table :articles, :posts</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="生成环境下初始化数据库"><a href="#生成环境下初始化数据库" class="headerlink" title="生成环境下初始化数据库"></a>生成环境下初始化数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rails g migration insert_initial_categories_into_categories</span><br><span class="line">class InsertInitialCategoriesIntoCategories &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    contents = %w(交通费 电话费 水费 燃气费)</span><br><span class="line">    contents.each do |content|</span><br><span class="line">      Article.create content: content</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/15/model-callback/" itemprop="url">
                  Model中的回调方法(CallBack)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-15T14:27:57+08:00" content="2015-02-15">
              2015-02-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>ActiveRecord中, 在model的校验, 创建, 更新和删除前后可以插入一些预处理或后处理的回调方法(Callbacks)</p>
</blockquote>
<h2 id="简单介绍callback"><a href="#简单介绍callback" class="headerlink" title="简单介绍callback"></a>简单介绍callback</h2><blockquote>
<p>简单来说, 就是在执行某个方法之前(或之后)先去执行另外一个方法. <code>before_save</code> <code>after_save</code>这种在<code>save</code>之前, 之后执行的方法.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  before_create :create_remember_token</span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">    def create_remember_token</span><br><span class="line">      User.remember_token = User.encrypt(User.new_remember_token)</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="ActiveRecord的Callback方法一览"><a href="#ActiveRecord的Callback方法一览" class="headerlink" title="ActiveRecord的Callback方法一览"></a>ActiveRecord的Callback方法一览</h2><blockquote>
<p>按照被调用的先后顺序排列:</p>
</blockquote>
<h3 id="创建对象"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象</h3><ul>
<li>before_validation</li>
<li>after_validation</li>
<li>before_save</li>
<li>around_save</li>
<li>before_create</li>
<li>around_create</li>
<li>after_create</li>
<li>after_save</li>
</ul>
<h3 id="更新对象"><a href="#更新对象" class="headerlink" title="更新对象"></a>更新对象</h3><ul>
<li>before_validation</li>
<li>after_validation</li>
<li>before_save</li>
<li>around_save</li>
<li>before_update</li>
<li>around_update</li>
<li>after_update</li>
<li>after_save</li>
</ul>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><ul>
<li>before_destroy</li>
<li>around_destroy</li>
<li>after_destroy</li>
<li>after_save</li>
</ul>
<h3 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a>实例化</h3><ul>
<li>after_initialize </li>
</ul>
<h3 id="从数据库加载记录后"><a href="#从数据库加载记录后" class="headerlink" title="从数据库加载记录后"></a>从数据库加载记录后</h3><ul>
<li>after_find </li>
</ul>
<h3 id="设定了touch"><a href="#设定了touch" class="headerlink" title="设定了touch"></a>设定了touch</h3><ul>
<li>after_touch</li>
</ul>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/15/scope-model/" itemprop="url">
                  Rails Model的Scope的使用方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-15T09:59:29+08:00" content="2015-02-15">
              2015-02-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Model 的Scope可以把一些共同的查询定义成model的类方法, 这样一来, 就不需要写复杂查询了, 而且程序的可读性也大大提高了.</p>
</blockquote>
<ul>
<li><code>scope</code>可以定义范围.</li>
<li><code>default_scope</code>可以定义默认的范围</li>
</ul>
<h2 id="scope声明"><a href="#scope声明" class="headerlink" title="scope声明"></a>scope声明</h2><blockquote>
<p>下面的两种定义查询的方法是等价的:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 使用scope方法定义</span><br><span class="line"></span><br><span class="line">class Post &lt; ActiveRecord::Base</span><br><span class="line">  scope :published, -&gt; &#123; where(published: true) &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 或者使用类方法定义</span><br><span class="line"></span><br><span class="line">class Post &lt; ActiveRecord::Base</span><br><span class="line">  def self.published</span><br><span class="line">    where(published: true)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以直接以类方法的形式调用:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Post.published</span><br><span class="line">category = Category.first</span><br><span class="line">category.posts.published</span><br></pre></td></tr></table></figure>
<h2 id="scope-方法的参数"><a href="#scope-方法的参数" class="headerlink" title="scope 方法的参数"></a>scope 方法的参数</h2><blockquote>
<p>scope方法也可以接收参数, 更准确来讲是scope方法的proc的参数</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># app/modes/post.rb</span><br><span class="line">class Post &lt; ActiveRecord::Base</span><br><span class="line">  scope :created_before, -&gt;(time) &#123; where(&quot;created_at &lt; ?&quot;, time)  &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">Post.created_before(Time.local(2011)) #=&gt; 2011年之前所有的数据</span><br></pre></td></tr></table></figure>
<h2 id="scope-的合并查询"><a href="#scope-的合并查询" class="headerlink" title="scope 的合并查询"></a>scope 的合并查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># app/models/user.rb</span><br><span class="line"></span><br><span class="line"># app/models/user.rb</span><br><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  scope :inactive, -&gt; &#123; where state: &apos;inactive&apos;  &#125;</span><br><span class="line">  scope :finished, -&gt; &#123; where state: &apos;finished&apos;  &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 使用方法</span><br><span class="line">User.inactive.finished</span><br><span class="line"># =&gt; SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &apos;inactive&apos; AND &quot;users&quot;.&quot;state&quot; = &apos;finished&apos;</span><br></pre></td></tr></table></figure>
<h2 id="default-scope设定"><a href="#default-scope设定" class="headerlink" title="default_scope设定"></a><code>default_scope</code>设定</h2><blockquote>
<p><code>default_scope</code>相当于是对整个查询的限定. 比如下面的例子, 我需要查询所有没有退会的会员, 乃至后面的查询都是建立在此查询的基础之上的:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Customer &lt; ActiveRecord::Base</span><br><span class="line">  default_scope &#123; where(&quot;removed_at is NULL&quot;) &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">Customer.all</span><br><span class="line"># =&gt; SELECT &quot;customers&quot;.* FROM &quot;customers&quot; WHERE (removed_at IS NULL)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/15/mac-mysql-install/" itemprop="url">
                  OSX下使用Homebrew安装MySQL数据库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-15T07:29:30+08:00" content="2015-02-15">
              2015-02-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用Homebrew安装MySQL"><a href="#使用Homebrew安装MySQL" class="headerlink" title="使用Homebrew安装MySQL"></a>使用Homebrew安装MySQL</h2><blockquote>
<p>首先安装MySQL</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install mysql</span><br></pre></td></tr></table></figure>
<blockquote>
<p>确认安装成功:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew info mysql</span><br></pre></td></tr></table></figure>
<blockquote>
<p>初始化数据库:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ unset TMPDIR</span><br><span class="line">$ mysql_install_db --verbose --user=`whoami` --basedir=&quot;$(brew --prefix mysql)&quot;\</span><br><span class="line">                                             --datadir=/usr/local/var/mysql\</span><br><span class="line">                                             --tmpdir=/tmp</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果出现了下面的错误:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mysql.server start&lt;br /&gt;Starting MySQL</span><br><span class="line">.. ERROR! The server quit without updating PID file (/usr/local/var/mysql/daniel.my-home.pid).</span><br></pre></td></tr></table></figure>
<blockquote>
<p>很明显, 没有 /usr/local/var/mysql的权限, 所以使用chown将该目录的权限更改为<code>_mysql:_mysql</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -R _mysql:_mysql /usr/local/var/mysql</span><br></pre></td></tr></table></figure>
<blockquote>
<p>修改MySQL密码和系统管理员密码(可选)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysqladmin -u root password &apos;password&apos;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样就可以使用MySQL了.<br>登录MySQL, 删除没有必要的数据和不安全的用户:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; drop database test;</span><br><span class="line">mysql &gt; use mysql;</span><br><span class="line">mysql &gt; delete from user where password=&quot;&quot;;</span><br><span class="line">mysql &gt; flush privileges;</span><br><span class="line">mysql &gt; exit;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>设置登录OSX时自动启动MySQL(可选)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -sfv /usr/local/opt/mysql/*.plist ~/Library/LaunchAgents</span><br><span class="line">launchctl load ~/Library/LaunchAgents/homebrew.mxcl.mysql.plist</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/14/validate-error/" itemprop="url">
                  Rails 中model的校验错误消息相关
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-14T22:11:54+08:00" content="2015-02-14">
              2015-02-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Model的校验错误消息对象errors的使用方法"><a href="#Model的校验错误消息对象errors的使用方法" class="headerlink" title="Model的校验错误消息对象errors的使用方法"></a>Model的校验错误消息对象<code>errors</code>的使用方法</h2><blockquote>
<p>Model中发生了验证错误时, 具体的错误信息会被保存在<code>errors</code>对象中, 而且, 可以通过<code>full_messages</code>取出所以错误消息的数组, 看下面的例子:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/models/product.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  validate <span class="symbol">:name</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发生验证错误</span></span><br><span class="line">&gt; product = Product.new</span><br><span class="line">&gt; =&gt; #&lt;Product id: nil, name: nil, price: nil, discontinued: nil, created_at: nil, updated_at: nil&gt;</span><br><span class="line">&gt; &gt; product.valid?</span><br><span class="line">&gt; =&gt; <span class="literal">false</span></span><br><span class="line">&gt; &gt; product.errors.messages</span><br><span class="line">&gt; =&gt; &#123;<span class="symbol">:name=&gt;</span>[<span class="string">"can't be blank"</span>]&#125;</span><br><span class="line">&gt; &gt; product.errors.full_messages</span><br><span class="line">&gt; =&gt; [<span class="string">"Name can't be blank"</span>]</span><br><span class="line">&gt; &gt; product.save</span><br><span class="line">&gt; =&gt; <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 未发生验证错误</span></span><br><span class="line">product = Product.new( <span class="symbol">name:</span> <span class="string">"Pname"</span>  )</span><br><span class="line">=&gt; #&lt;Product id: nil, name: "Pname", price: nil, discontinued: nil, created_at: nil, updated_at: nil&gt;</span><br><span class="line"><span class="meta">irb(main):017:0&gt;</span> product.valid?</span><br><span class="line">=&gt; true</span><br><span class="line">&gt; product.errors.messages</span><br><span class="line">&gt; =&gt; &#123;&#125;</span><br><span class="line">&gt; &gt; product.errors.full_messages</span><br><span class="line">&gt; =&gt; []</span><br><span class="line">&gt; &gt; product.save</span><br><span class="line">&gt; =&gt; <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="添加错误消息到model"><a href="#添加错误消息到model" class="headerlink" title="添加错误消息到model"></a>添加错误消息到model</h2><blockquote>
<p>使用 <code>errors.add</code>和<code>errors[:base]</code> 可以自己添加错误消息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line"></span><br><span class="line">validate :add_error_sample</span><br><span class="line"></span><br><span class="line">  def add_error_sample</span><br><span class="line">    if name.blank?</span><br><span class="line">      errors.add(:name, &quot;is empty!&quot;)</span><br><span class="line">      errors[:base] &lt;&lt; &quot;for all columns errors&quot;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如下图, errors[:base]是公共错误信息, 只要有验证错误, 它就会被显示<br><img src="http://i2.tietuku.com/9bba27b8227d8572.png" alt=""></p>
<p>我们也可以清除这些错误信息:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">product = Product.new</span><br><span class="line">product.valid? # =&gt; false</span><br><span class="line">product.errors.full_messages # =&gt; [&quot;Name can&apos;t be blank&quot;]</span><br><span class="line">product.errors.clear</span><br><span class="line">product.erros.empty? # =&gt; true</span><br></pre></td></tr></table></figure>
<h2 id="在视图中显示错误消息"><a href="#在视图中显示错误消息" class="headerlink" title="在视图中显示错误消息"></a>在视图中显示错误消息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if @product.errors.any? %&gt;</span><br><span class="line">  &lt;div id=&quot;error_explanation&quot;&gt;</span><br><span class="line">    &lt;h2&gt;&lt;%= pluralize(@product.errors.count, &quot;error&quot;) %&gt; prohibited this product from being saved:&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">    &lt;% @product.errors.full_messages.each do |message| %&gt;</span><br><span class="line">    &lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;</span><br><span class="line">    &lt;% end %&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h2><ol>
<li>在config/locales/ 下添加 <code>zh-CN.yml</code></li>
<li>在 config/application.rb 添加 <code>config.i18n.default_locale = :&quot;zh-CN&quot;</code></li>
<li>重启服务器<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># config/locales/zh-CN.yml</span><br><span class="line">zh-CN:</span><br><span class="line">  attributes:</span><br><span class="line">      name: &quot;名字&quot;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>效果如下:<br><img src="http://i2.tietuku.com/104e8ee52c2ae9ac.png" alt=""></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/13/validation/" itemprop="url">
                  对Model校验
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-13T08:13:21+08:00" content="2015-02-13">
              2015-02-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Rails中, 我们可以将用户输入数据在被保存到数据库前进行校验, 成为Validation.</p>
</blockquote>
<h2 id="Rails校验流程"><a href="#Rails校验流程" class="headerlink" title="Rails校验流程"></a>Rails校验流程</h2><blockquote>
<p>我要一步步说明Rails的校验流程</p>
</blockquote>
<h3 id="使用validates方法-对Model进行校验的条件的设定"><a href="#使用validates方法-对Model进行校验的条件的设定" class="headerlink" title="使用validates方法, 对Model进行校验的条件的设定"></a>使用validates方法, 对Model进行校验的条件的设定</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># app/models/product.rb</span><br><span class="line"></span><br><span class="line">class Product &lt; ActiveRecord::Base</span><br><span class="line">  # title必须存在</span><br><span class="line">  validates :title, presence: true</span><br><span class="line">  # price的值为integer类型, 取值范围大于0</span><br><span class="line">  validates :price, numericality: &#123; only_integer: true, greater_than_or_equal_to: 0 &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="在controller中保存或更新model"><a href="#在controller中保存或更新model" class="headerlink" title="在controller中保存或更新model"></a>在controller中保存或更新model</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def create</span><br><span class="line">  # product_params 以hash形式封装了用户在表单中输入的值</span><br><span class="line">¦ @product = Product.new(product_params)</span><br><span class="line"></span><br><span class="line">¦ respond_to do |format|</span><br><span class="line">    # 在保存前Product 类会参照验证定义.</span><br><span class="line">    # 未发生验证错误, 则将记录保存到数据库, 否则再次渲染new action</span><br><span class="line">¦ ¦ if @product.save</span><br><span class="line">¦ ¦ ¦ format.html &#123; redirect_to @product, notice: &apos;Product was successfully created.&apos;  &#125;</span><br><span class="line">¦ ¦ ¦ format.json &#123; render :show, status: :created, location: @product  &#125;</span><br><span class="line">¦ ¦ else</span><br><span class="line">¦ ¦ ¦ format.html &#123; render :new  &#125;</span><br><span class="line">¦ ¦ ¦ format.json &#123; render json: @product.errors, status: :unprocessable_entity  &#125;</span><br><span class="line">¦ ¦ end</span><br><span class="line">¦ end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="验证错误会被保存在errors中"><a href="#验证错误会被保存在errors中" class="headerlink" title="验证错误会被保存在errors中"></a>验证错误会被保存在<code>errors</code>中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_for(@product) do |f| %&gt;</span><br><span class="line">  &lt;% if @product.errors.any? %&gt;</span><br><span class="line">  &lt;div id=&quot;error_explanation&quot;&gt;</span><br><span class="line">  &lt;!-- 取出错误消息， 显示在页面上 --&gt;</span><br><span class="line">  &lt;h2&gt;&lt;%= pluralize(@product.errors.count, &quot;error&quot;) %&gt; prohibited this product from being saved:&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">  &lt;ul&gt;</span><br><span class="line">  &lt;% @product.errors.full_messages.each do |message| %&gt;</span><br><span class="line">  &lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">  &lt;%= f.label :title %&gt;&lt;br&gt;</span><br><span class="line">  &lt;%= f.text_field :title %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">  &lt;%= f.label :price %&gt;&lt;br&gt;</span><br><span class="line">  &lt;%= f.number_field :price %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">  &lt;%= f.submit %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="定义验证"><a href="#定义验证" class="headerlink" title="定义验证"></a>定义验证</h2><h3 id="存在性检查"><a href="#存在性检查" class="headerlink" title="存在性检查"></a>存在性检查</h3><blockquote>
<p>使用<code>prensence</code> 对字段进行非空检查.<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">validates <span class="symbol">:name</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RSpec检查的方法</span></span><br><span class="line"></span><br><span class="line">it &#123; is_expected.to validate_presence_of(<span class="symbol">:name</span>) &#125;</span><br></pre></td></tr></table></figure></p>
<p>boolean类型的验证, 使用inclusion 选项</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 其实即使保持字符串也是可以的, ruby会作为true来处理</span></span><br><span class="line">validates <span class="symbol">:flag</span>, <span class="symbol">inclusion:</span> &#123; <span class="symbol">in:</span> [<span class="literal">true</span>, flase] &#125;</span><br></pre></td></tr></table></figure>
<h2 id="唯一性验证"><a href="#唯一性验证" class="headerlink" title="唯一性验证"></a>唯一性验证</h2><blockquote>
<p>使用<code>uniqueness</code>选项检查属性值是否唯一</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validates <span class="symbol">:email</span>, <span class="symbol">uniqueness:</span> <span class="literal">true</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">it &#123; is_expected.to validate_uniqueness_of(<span class="symbol">:email</span>) &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要注意的是: 如果服务器的并发很高时, 比如在注册新用户时, 连续两次点击创建按钮, 还是有可能跳过rails的验证在数据库中创建两条相同的记录.<br>这时候有必要再加一道防线: 数据库中添加唯一性索引:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rails g migration add_index_to_users_email</span><br><span class="line"># db/migrate/YYYYMNDDHHMMSS_add_index_to_users_email.rb</span><br><span class="line"></span><br><span class="line">class AddIndexToUsersEmail &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    add_index :users, :email, unique: true</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure></p>
<p>当然也可以对多个属性的唯一性, 比如用户发表不可以发表相同题目的文章:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  belongs_to <span class="symbol">:user</span></span><br><span class="line">  validates <span class="symbol">:title</span>, <span class="symbol">uniqueness:</span> &#123; <span class="symbol">scope:</span> [<span class="symbol">:user_id</span>] &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rspec</span></span><br><span class="line">it &#123; is_expected.to validate_uniqueness_of(<span class="symbol">:title</span>).scoped_to(<span class="symbol">:user_id</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># db migration</span></span><br><span class="line">add_index <span class="symbol">:articles</span>, [<span class="symbol">:title</span>, <span class="symbol">:user_id</span>], <span class="symbol">uniqueness:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>一般在验证Email时, 都是统一转化为小写, 再进行唯一性检查:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  before_save &#123; <span class="keyword">self</span>.downcase! &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="长度检查-length"><a href="#长度检查-length" class="headerlink" title="长度检查(length)"></a>长度检查(length)</h3><blockquote>
<p>使用<code>length</code>进行长度验证</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">validates <span class="symbol">:name</span>, <span class="symbol">length:</span> &#123; <span class="symbol">minumum:</span> <span class="number">2</span> &#125;</span><br><span class="line">validates <span class="symbol">:bio</span>, <span class="symbol">length:</span> &#123; <span class="symbol">maximum:</span> <span class="number">500</span> &#125;</span><br><span class="line">validates <span class="symbol">:password</span>, <span class="symbol">length:</span> &#123; <span class="symbol">in:</span> <span class="number">6</span>..<span class="number">20</span> &#125;</span><br><span class="line">validates <span class="symbol">:registration_number</span>, <span class="symbol">length:</span> &#123; <span class="symbol">is:</span> <span class="number">5</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># rspec</span></span><br><span class="line">it &#123; is_expected_to ensure_length_of(<span class="symbol">:name</span>).is_at_least(<span class="number">2</span>) &#125;</span><br><span class="line">it &#123; is_expected_to ensure_length_of(<span class="symbol">:bio</span>).is_at_most(<span class="number">500</span>) &#125;</span><br><span class="line">it &#123; is_expected_to ensure_length_of(<span class="symbol">:password</span>).is_at_least(<span class="number">6</span>).is_at_most(<span class="number">20</span>) &#125;</span><br><span class="line">it &#123; is_expected_to ensure_length_of(<span class="symbol">:registration_number</span>).is_equal_to(<span class="number">6</span>) &#125;</span><br></pre></td></tr></table></figure>
<h3 id="格式检查-format"><a href="#格式检查-format" class="headerlink" title="格式检查(format)"></a>格式检查(format)</h3><blockquote>
<p>使用<code>format</code> option可以对格式进行检查, 一般使用正则表达式比较多一些:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">VALID_EMAIL_REGEX =  <span class="regexp">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span></span><br><span class="line">validates <span class="symbol">:email</span>, <span class="symbol">format:</span> &#123; <span class="symbol">with:</span> VALID_EMAIL_REGEX &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># rspec</span></span><br><span class="line"></span><br><span class="line">it <span class="string">"valid emails"</span> <span class="keyword">do</span></span><br><span class="line">  valid_emails = <span class="string">%w(</span><br><span class="line">    user@foo.COM</span><br><span class="line">    A_US-ER@f.b.org</span><br><span class="line">    frst.lst@foo.jp</span><br><span class="line">    a+b@baz.cn</span><br><span class="line">  )</span></span><br><span class="line">  is_expected_to allow_value(*valid_emails).<span class="keyword">for</span>(<span class="symbol">:email</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">it <span class="string">"invalid emails"</span> <span class="keyword">do</span></span><br><span class="line">  invalid_emails = <span class="string">%w(</span><br><span class="line">    user@foo,com</span><br><span class="line">    user_at_foo.org</span><br><span class="line">    example.user@foo.</span><br><span class="line">    foo@bar_baz.com</span><br><span class="line">    foo@bar+baz.com</span><br><span class="line">    foo@bar..com</span><br><span class="line">  )</span></span><br><span class="line">  is_expected_not_to allow_value(*invalid_emails).<span class="keyword">for</span>(<span class="symbol">:email</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="数值检查"><a href="#数值检查" class="headerlink" title="数值检查"></a>数值检查</h3><blockquote>
<p><code>numericality</code>选项可以对数值类型进行验证</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  validates <span class="symbol">:points</span>, <span class="symbol">numericality:</span> <span class="literal">true</span> <span class="comment"># 整数或者小数有效</span></span><br><span class="line">  validates <span class="symbol">:counts</span>, <span class="symbol">numericality:</span> &#123; <span class="symbol">only_integer:</span> <span class="literal">true</span> &#125; <span class="comment"># 只有整数有效</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rspec</span></span><br><span class="line"></span><br><span class="line">it &#123; is_expected.to validate_numericality_of(<span class="symbol">:points</span>) &#125;</span><br><span class="line">it &#123; is_expected.to validate_numericality_of(<span class="symbol">:counts</span>).only_integer &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>only_integer: true</code>指定后, 可以追加下面选项来对数值本身进行限制</p>
</blockquote>
<ul>
<li>greater_than</li>
<li>greater_than_or_equal_to</li>
<li>equal_to</li>
<li>less_than</li>
<li>less_than_or_equal_to</li>
<li>odd</li>
<li><p>even</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">validates :counts, numericality: &#123;</span><br><span class="line"> only_integer: true, greater_than_or_equal_to: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># rspec</span><br><span class="line">it &#123; is_expected.to validate_numericality_of(:counts).only_integer.is_greater_or_equal_to(0) &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="包含在集合内的验证"><a href="#包含在集合内的验证" class="headerlink" title="包含在集合内的验证"></a>包含在集合内的验证</h3><blockquote>
<p><code>inclusion</code> option中使用<code>in</code>来定义一个集合, 指定的值需要包含在集合内(属于集合的元素之一)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validates :size, inclusion: &#123; in: %w(small medium large) &#125;</span><br><span class="line"></span><br><span class="line"># rspec</span><br><span class="line">it &#123; is_expected.to ensure_inclusion_of(:size).in_array(%w(small medium large)) &#125;</span><br></pre></td></tr></table></figure>
<h3 id="不包含在集合内的验证"><a href="#不包含在集合内的验证" class="headerlink" title="不包含在集合内的验证"></a>不包含在集合内的验证</h3><blockquote>
<p><code>exclusion</code>option指定属性不应该是集合中的元素, 同样, 集合使用<code>in</code>定义</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validates :subdomain, exclusion: &#123; in: %(www us cn jp) &#125;</span><br><span class="line"></span><br><span class="line"># rspec</span><br><span class="line">it &#123; is_expected.to ensure_exclusion_of(:subdomain).in_array(%(www us cn jp)) &#125;</span><br></pre></td></tr></table></figure>
<h2 id="跳过验证"><a href="#跳过验证" class="headerlink" title="跳过验证"></a>跳过验证</h2><blockquote>
<p>以下方法需要先通过验证才可以成功保存到数据库中</p>
</blockquote>
<ul>
<li>create</li>
<li>create!</li>
<li>save</li>
<li>save!</li>
<li>update</li>
<li>update!</li>
</ul>
<blockquote>
<p>如果不要经过验证, 可以使用<code>validate</code> option<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save(<span class="symbol">valiate:</span> <span class="literal">false</span>)</span><br></pre></td></tr></table></figure></p>
<p>或者使用以下方法也同样可以绕过验证:</p>
</blockquote>
<ul>
<li>decrement!</li>
<li>decrement_counter</li>
<li>increment!</li>
<li>increment_counter</li>
<li>toggle!</li>
<li>update_all</li>
<li>update_attribute</li>
<li>update_column</li>
<li>update_columns</li>
<li>update_counters</li>
</ul>
<blockquote>
<p>这些方法都是直接使用SQL更新数据库, 未经过ActiveRecord</p>
</blockquote>
<h2 id="定义校验条件"><a href="#定义校验条件" class="headerlink" title="定义校验条件"></a>定义校验条件</h2><blockquote>
<p>有些验证需要在某种特定的情况下才会发生, 这时候就需要使用带有条件的验证了, 可以指定<code>if</code>或<code>unless</code>选项.比如下面的例子, 当使用银行卡支付时才会验证卡号存在:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Order &lt; ActiveRecord::Base</span><br><span class="line">  validates :card_number, presence: true, if: :paid_with_card?</span><br><span class="line"></span><br><span class="line">  def paid_with_card?</span><br><span class="line">    payment_type == &quot;card&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="保存前确定数值是否有效"><a href="#保存前确定数值是否有效" class="headerlink" title="保存前确定数值是否有效"></a>保存前确定数值是否有效</h2><blockquote>
<p>我们可以使用<code>valid?</code> <code>invalid?</code> 检查要保存的属性值是否有效(能否通过验证), 如果调用完该方法返回的结果是false, rails就会把错误消息设定到当前对象的errors中:</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># app/models/article.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  validates <span class="symbol">:title</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">article = Article.new(<span class="symbol">title:</span> <span class="literal">nil</span>)</span><br><span class="line">article.valid?</span><br><span class="line"></span><br><span class="line"><span class="comment"># =&gt; false # 这时候向errors中添加错误消息</span></span><br><span class="line"></span><br><span class="line">article.errors.full_messages</span><br><span class="line"><span class="comment"># =&gt; ["Title can't be blank"]</span></span><br><span class="line"></span><br><span class="line">article = Article.new(<span class="symbol">title:</span> <span class="literal">nil</span>)</span><br><span class="line">article.invalid?</span><br><span class="line"></span><br><span class="line"><span class="comment"># =&gt; true # 这时候向errors中添加错误信息</span></span><br><span class="line"></span><br><span class="line">article.errors.full_messages</span><br><span class="line"><span class="comment"># =&gt; ["Title can't be blank"]</span></span><br></pre></td></tr></table></figure>
<h2 id="定义自己的验证类和方法"><a href="#定义自己的验证类和方法" class="headerlink" title="定义自己的验证类和方法"></a>定义自己的验证类和方法</h2><blockquote>
<p>当rails提供的验证方法无法满足需求时, 可以自己定义一些验证</p>
</blockquote>
<h3 id="定制化校验方法-ValidatE"><a href="#定制化校验方法-ValidatE" class="headerlink" title="定制化校验方法(ValidatE)"></a>定制化校验方法(ValidatE)</h3><blockquote>
<p><code>validate</code>(注意是原形) 可以创建自己的校验方法. 我们可以定义自己的方法进行校验逻辑的实现, 然后将方法名symbol化, 作为参数传递给<code>validate</code><br>需要注意的是: 验证错误消息需要自己添加上.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># app/models/invoice.rb</span><br><span class="line">class Invoice &lt; ActiveRecord::Base</span><br><span class="line">  validate :expiration_date_cannot_be_in_the_past,</span><br><span class="line">  :discount_cannot_be_greater_than_total_value</span><br><span class="line"></span><br><span class="line">  def expiration_date_cannot_be_in_the_past</span><br><span class="line">  if expiration_date.present? &amp;&amp; expiration_date &lt; Date.today</span><br><span class="line">  errors.add(:expiration_date, &quot;can&apos;t be in the past&quot;)</span><br><span class="line">  end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def discount_cannot_be_greater_than_total_value</span><br><span class="line">  if discount &gt; total_value</span><br><span class="line">  errors.add(:discount, &quot;can&apos;t be greater than total value&quot;)</span><br><span class="line">  end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="定制化校验类-Validator"><a href="#定制化校验类-Validator" class="headerlink" title="定制化校验类(Validator)"></a>定制化校验类(Validator)</h3><blockquote>
<p>通过继承<code>ActiveModel::Validator</code> 创建自己的验证类, 并且, 我们必须实现<code>validate</code>方法, 然后把自己的验证类Mixin进Model类中</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class MyValidator &lt; ActiveModel::Validator</span><br><span class="line">  def validate(record)</span><br><span class="line">    unless record.name.starts_with? &apos;X&apos;</span><br><span class="line">      record.errors[:name] &lt;&lt; &apos;Need a name starting with X please!&apos;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # app/models/person.rb</span><br><span class="line">  class Person</span><br><span class="line"></span><br><span class="line">    include ActiveModel::Validations</span><br><span class="line">    validates_with MyValidator</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/12/accept-nested-attributes-for/" itemprop="url">
                  在表单中提交相关实体
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-02-12T08:18:53+08:00" content="2015-02-12">
              2015-02-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index">
                    <span itemprop="name">Rails</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在Rails中, 我们可以通过使用<code>accepts_nested_attributes_for</code>简单地将一对多的model通过表单一起提交. 比如说: 某人有多个地址(家庭地址, 公司地址等等) 这种一对多的关系. 我想通过一个表达提交用户的同时提交若干个地址.</p>
</blockquote>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><blockquote>
<p>生成项目:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails new accepts_nested_attributes_for_test</span><br><span class="line">cd accepts_nested_attributes_for_test</span><br></pre></td></tr></table></figure></p>
<p>使用scaffold生成user:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g scaffold User username age:integer</span><br></pre></td></tr></table></figure>
<blockquote>
<p>生成Address model<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g model Address zipcode city street tel user_id:integer</span><br></pre></td></tr></table></figure></p>
<p>移植</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>添加关联关系, user 对 address 是一对多的关系:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># app/models/user.rb</span><br><span class="line"></span><br><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  has_many :addresses</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/models/address.rb</span><br><span class="line"></span><br><span class="line">class Address &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :user</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="实现嵌套表单"><a href="#实现嵌套表单" class="headerlink" title="实现嵌套表单"></a>实现嵌套表单</h2><blockquote>
<p>ActiveRecord提供了accepts_nested_attributes_for 方法来处理嵌套表单, 我们把这个方法加入到user model以后, 在user中就会自动添加一个方法<code>addresses_attributes=</code>, 由此, 我们可以对Address进行添加,修改和删除了.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># app/models/user.rb</span><br><span class="line"></span><br><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  has_many :addresses</span><br><span class="line">  accepts_nested_attributes_for :addresses</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># app/models/address.rb</span><br><span class="line"></span><br><span class="line">class Address &lt; ActiveRecord::Base</span><br><span class="line">  belongs_to :user</span><br><span class="line">  # 不可以对user_id进行验证, 否则会无法存入数据库, 因为params中并没有user_id</span><br><span class="line">  validates :user_id, presence: true</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接下来处理表单, 使用<code>fields_for</code> 把输入的参数嵌入到请求参数中.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">¦ &lt;%= f.label :username %&gt;&lt;br&gt;</span><br><span class="line">¦ &lt;%= f.text_field :username %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">¦ &lt;%= f.label :age %&gt;&lt;br&gt;</span><br><span class="line">¦ &lt;%= f.number_field :age %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">¦ &lt;%= f.label :addresses, &quot;Address&quot; %&gt;</span><br><span class="line">¦ &lt;%= f.fields_for :addresses do |addresses_form| %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :zipcode, &quot;zipcode&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :zipcode %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :city, &quot;city&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :city %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :street, &quot;street&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :street %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :tel, &quot;Telephone Number&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :tel %&gt; &lt;br/&gt;</span><br><span class="line">¦ &lt;% end %&gt;</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">¦ &lt;%= f.submit %&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接下来, 在User的Controller中的new action中中准备好供表单使用的数据. 新建一个与用户相关联的Address对象, 作为<code>fields_for</code>的参数.<br>还需要将address属性加入到StrongParameters的允许列表中. 写法是view中的<code>fields_for</code>方法的参数(addresses) 与<code>_attributes</code>拼接而成. 也就是<code>addresses_attributes</code>, 其内部属性使用数组表示.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/users_controller.rb</span><br><span class="line"></span><br><span class="line">def new</span><br><span class="line">  @user = User.new</span><br><span class="line">  @user.addresses.build</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Strong Parameters</span><br><span class="line"></span><br><span class="line">def user_params</span><br><span class="line">  params.require(:user).permit(</span><br><span class="line">    :username,</span><br><span class="line">    :age,</span><br><span class="line">    addresses_attributes: [:id, :zipcode, :city, :street, :tel]</span><br><span class="line">  )</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如下图新建用户:<br><img src="http://i2.tietuku.com/63b34f8f063814c8.png" alt=""></p>
<p>点击提交后, 产生的参数和执行的sql语句:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Processing by UsersController#create as HTML</span><br><span class="line">  Parameters: &#123;&quot;utf8&quot;=&gt;&quot;✓&quot;, &quot;authenticity_token&quot;=&gt;&quot;gAoS9H1E0orttTcXOte5voqnEhwY/QROIA3noJLp84o=&quot;, &quot;user&quot;=&gt;&#123;&quot;username&quot;=&gt;&quot;daniel&quot;, &quot;age&quot;=&gt;&quot;22&quot;, &quot;addresses_attributes&quot;=&gt;&#123;&quot;0&quot;=&gt;&#123;&quot;zipcode&quot;=&gt;&quot;100101&quot;, &quot;city&quot;=&gt;&quot;北京&quot;, &quot;street&quot;=&gt;&quot;北辰西路1号院5号&quot;, &quot;tel&quot;=&gt;&quot;1223423&quot;&#125;&#125;&#125;, &quot;commit&quot;=&gt;&quot;Create User&quot;&#125;</span><br><span class="line">     (0.1ms)  begin transaction</span><br><span class="line">       SQL (13.0ms)  INSERT INTO &quot;users&quot; (&quot;age&quot;, &quot;created_at&quot;, &quot;updated_at&quot;, &quot;username&quot;) VALUES (?, ?, ?, ?)  [[&quot;age&quot;, 22], [&quot;created_at&quot;, &quot;2015-02-12 05:51:59.128755&quot;], [&quot;updated_at&quot;, &quot;2015-02-12 05:51:59.128755&quot;], [&quot;username&quot;, &quot;daniel&quot;]]</span><br><span class="line">         SQL (0.1ms)  INSERT INTO &quot;addresses&quot; (&quot;city&quot;, &quot;created_at&quot;, &quot;street&quot;, &quot;tel&quot;, &quot;updated_at&quot;, &quot;user_id&quot;, &quot;zipcode&quot;) VALUES (?, ?, ?, ?, ?, ?, ?)  [[&quot;city&quot;, &quot;北京&quot;], [&quot;created_at&quot;, &quot;2015-02-12 05:51:59.184579&quot;], [&quot;street&quot;, &quot;北辰西路1号院5号&quot;], [&quot;tel&quot;, &quot;1223423&quot;], [&quot;updated_at&quot;, &quot;2015-02-12 05:51:59.184579&quot;], [&quot;user_id&quot;, 1], [&quot;zipcode&quot;, &quot;100101&quot;]]</span><br></pre></td></tr></table></figure></p>
<p><code>accepts_nested_attributes_for</code>和<code>fields_for</code>可以逆向生成user和address, 访问编辑页面,可以发现表单中的数据可以自动填充回来:</p>
</blockquote>
<p><img src="http://i2.tietuku.com/d13fc866f9f8b7dc.png" alt=""></p>
<h2 id="删除nested-model"><a href="#删除nested-model" class="headerlink" title="删除nested model"></a>删除nested model</h2><blockquote>
<p><code>accepts_nested_attributes_for</code>方法还可以简单地删除User相关的address model. 下面就在编辑用户的页面添加一个CheckBox来加入删除地址的功能</p>
<p>首先, 在user model中加入<code>allow_destroy: true</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  has_many :addresses</span><br><span class="line">  accepts_nested_attributes_for :addresses, allow_destroy: true</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>接下来在表单view中加入删除checkbox. 表单中check_box方法的参数 <code>:_destroy</code> 当单选框被点击时, 其值会被设置为1, 然后”_destroy” =&gt; “1”会被封装到params中, <code>accepts_nested_attributes_for</code>会根据_destroy的值决定是否删除address对象. 大概就是这个意思, 不对之处请多指正.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># app/views/users/_form.html.erb</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">¦ &lt;%= f.label :addresses, &quot;Address&quot; %&gt; &lt;br/&gt;</span><br><span class="line">¦ &lt;%= f.fields_for :addresses do |addresses_form| %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :zipcode, &quot;zipcode&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :zipcode %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :city, &quot;city&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :city %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :street, &quot;street&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :street %&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">¦ ¦ &lt;%= addresses_form.label :tel, &quot;Telephone Number&quot; %&gt;</span><br><span class="line">¦ ¦ &lt;%= addresses_form.text_field :tel %&gt; &lt;br/&gt;</span><br><span class="line">¦ ¦ &lt;% if @user.persisted? %&gt;</span><br><span class="line">¦ ¦ ¦ &lt;%= addresses_form.check_box :_destroy %&gt;</span><br><span class="line">¦ ¦ ¦ &lt;%= addresses_form.label :_destroy, &quot;DELETE&quot; %&gt; &lt;br/&gt;</span><br><span class="line">¦ ¦ &lt;% end %&gt;</span><br><span class="line">¦ &lt;% end %&gt;</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<p>最后, 还要在StrongParameters中设置_destroy</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># app/controllers/users_controller.rb</span><br><span class="line"></span><br><span class="line">private</span><br><span class="line"></span><br><span class="line">def user_params</span><br><span class="line">  params.require(:user).permit(</span><br><span class="line">  :username,</span><br><span class="line">  :age,</span><br><span class="line">  addresses_attributes: [:id, :zipcode, :city, :street, :tel, :_destroy]</span><br><span class="line"></span><br><span class="line">  )</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>删除:<br><img src="http://i2.tietuku.com/63f5e698387ae183.png" alt=""><br>删除后:<br><img src="http://i2.tietuku.com/651115caa7f68117.png" alt=""></p>
</blockquote>
<h2 id="相关Model的验证"><a href="#相关Model的验证" class="headerlink" title="相关Model的验证"></a>相关Model的验证</h2><blockquote>
<p>下面就添加验证:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validates :zipcode, presence: true</span><br><span class="line">validates :city, presence: true</span><br><span class="line">validates :street, presence: true</span><br><span class="line">validates :tel, presence: true</span><br></pre></td></tr></table></figure></p>
<p>如果我们不填写这几项, 页面会是这样的.<br><img src="http://i2.tietuku.com/79bc3f2175ed7052.png" alt=""></p>
<p>那么如果某人不想提交地址, 他连用户都无法创建, 这不符合逻辑, 这时候就需要<code>reject_if</code>了选项了, 它会更具条件决定是否执行验证方法. 比如下面的例子:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果不输入邮编, 就不会执行Address Model中的验证</span></span><br><span class="line">accepts_nested_attributes_for <span class="symbol">:address</span>, <span class="symbol">allow_destroy:</span> <span class="literal">true</span>, <span class="symbol">reject_if:</span> proc &#123; <span class="params">|attributes|</span> attributes[<span class="string">'zipcode'</span>].blank? &#125;</span><br></pre></td></tr></table></figure></p>
<p>那么我们可以这样修改user model</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/models/user.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  has_many <span class="symbol">:addresses</span></span><br><span class="line">  <span class="comment"># 如果地址全都不填写, 就不会执行验证.</span></span><br><span class="line">  accepts_nested_attributes_for <span class="symbol">:addresses</span>, <span class="symbol">allow_destroy:</span> <span class="literal">true</span>, <span class="symbol">reject_if:</span> <span class="symbol">:all_blank</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># user 还会继续验证</span></span><br><span class="line">  validates <span class="symbol">:username</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line">  validates <span class="symbol">:age</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>下面是address 栏位中什么都不写的视图:<br><img src="http://i2.tietuku.com/f5618fac5bba5664.png" alt=""></p>
</blockquote>
<h2 id="添加或者删除项目"><a href="#添加或者删除项目" class="headerlink" title="添加或者删除项目"></a>添加或者删除项目</h2><blockquote>
<p>用户可能会需要多个地址, 有时候也需要删除地址, 这时候就需要使用Ajax了.</p>
<p>首先需要让jQuery和turbolink共存, 使用<code>jquery-turbolinks</code> gem.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;gem &apos;jquery-turbolinks&apos;&quot; &gt;&gt; Gemfile</span><br><span class="line">bundle install</span><br><span class="line"></span><br><span class="line"># app/assets/javascripts/application.js</span><br><span class="line">...</span><br><span class="line">//= require jquery</span><br><span class="line">//= require jquery.turbolinks</span><br><span class="line">//= require jquery_ujs</span><br></pre></td></tr></table></figure></p>
<p>将address 相关的自动抽取成单独的局部视图</p>
</blockquote>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;fieldset&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.label <span class="symbol">:zipcode</span>, <span class="string">"zipcode"</span> </span>%&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.text_field <span class="symbol">:zipcode</span> </span>%&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">&lt;%=<span class="ruby"> f.label <span class="symbol">:city</span>, <span class="string">"city"</span> </span>%&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.text_field <span class="symbol">:city</span> </span>%&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">&lt;%=<span class="ruby"> f.label <span class="symbol">:street</span>, <span class="string">"street"</span> </span>%&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.text_field <span class="symbol">:street</span> </span>%&gt; &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">&lt;%=<span class="ruby"> f.label <span class="symbol">:tel</span>, <span class="string">"Telephone Number"</span> </span>%&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.text_field <span class="symbol">:tel</span> </span>%&gt; &lt;br/&gt;</span><br><span class="line">&lt;%=<span class="ruby"> f.hidden_field <span class="symbol">:_destroy</span> </span>%&gt;</span><br><span class="line">&lt;%=<span class="ruby"> link_to <span class="string">"DELETE"</span>, <span class="string">"#"</span>, <span class="class"><span class="keyword">class</span>: "<span class="title">remove_field</span>" </span></span>%&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>调用上面的局部视图, 然后创建一个添加的超链接, 注意这里使用了自定义的helper<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># app/views/users/_form.html.erb</span><br><span class="line">&lt;div class=&quot;field&quot;&gt;</span><br><span class="line">&lt;%= f.label :addresses, &quot;住所&quot; %&gt;&lt;br /&gt;</span><br><span class="line">&lt;%= f.fields_for :addresses do |builder| %&gt;</span><br><span class="line">&lt;%= render &quot;address_fields&quot;, f: builder %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br><span class="line">&lt;%= link_to_add_fields &quot;住所追加&quot;, f, :addresses %&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<p>实现helper <code>link_to_add_fields</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># app/helpers/application_helper.rb</span><br><span class="line">module ApplicationHelper</span><br><span class="line">  def link_to_add_fields(name, f, association)</span><br><span class="line">    new_object = f.object.send(association).klass.new</span><br><span class="line">    id = new_object.object_id</span><br><span class="line">    # 拼接</span><br><span class="line">    fields = f.fields_for(association, new_object, child_index: id) do |builder|</span><br><span class="line">      render(association.to_s.singularize + &quot;_fields&quot;, f: builder)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    link_to(name, &apos;#&apos;, class: &quot;add_fields&quot;, data: &#123;id: id, fields: fields.gsub(&quot;\n&quot;, &quot;&quot;)&#125;)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最后使用CoffeeScript来完成Ajax部分, 添加和删除功能:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># app/assets/javascripts/user.js.coffee</span><br><span class="line">$ -&gt;</span><br><span class="line">  $(&apos;form&apos;).on &apos;click&apos;, &apos;.remove_fields&apos;, (event) -&gt;</span><br><span class="line">  $(this).prev(&apos;input[type=hidden]&apos;).val(&apos;1&apos;)</span><br><span class="line">  $(this).closest(&apos;fieldset&apos;).hide()</span><br><span class="line">  event.preventDefault()</span><br><span class="line"></span><br><span class="line">  $(&apos;form&apos;).on &apos;click&apos;, &apos;.add_fields&apos;, (event) -&gt;</span><br><span class="line">  time = new Date().getTime()</span><br><span class="line">  regexp = new RegExp($(this).data(&apos;id&apos;), &apos;g&apos;)</span><br><span class="line">  $(this).before($(this).data(&apos;fields&apos;).replace(regexp, time))</span><br><span class="line">  event.preventDefault()</span><br></pre></td></tr></table></figure></p>
</blockquote>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/default_avatar.jpg"
               alt="John Doe" />
          <p class="site-author-name" itemprop="name">John Doe</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">106</span>
              <span class="site-state-item-name">Artikel</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">Kategorien</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">104</span>
                <span class="site-state-item-name">Tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>

<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  

</body>
</html>
